<html>
<head>
<title>_formlayout.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #cc7832;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_formlayout.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
formlayout 
========== 
 
Module creating Qt form dialogs/layouts to edit various type of parameters 
 
 
formlayout License Agreement (MIT License) 
------------------------------------------ 
 
Copyright (c) 2009 Pierre Raybaut 
 
Permission is hereby granted, free of charge, to any person 
obtaining a copy of this software and associated documentation 
files (the &quot;Software&quot;), to deal in the Software without 
restriction, including without limitation the rights to use, 
copy, modify, merge, publish, distribute, sublicense, and/or sell 
copies of the Software, and to permit persons to whom the 
Software is furnished to do so, subject to the following 
conditions: 
 
The above copyright notice and this permission notice shall be 
included in all copies or substantial portions of the Software. 
 
THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, 
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES 
OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND 
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT 
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, 
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING 
FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR 
OTHER DEALINGS IN THE SOFTWARE. 
&quot;&quot;&quot;</span>

<span class="s2"># History:</span>
<span class="s2"># 1.0.10: added float validator</span>
<span class="s2">#         (disable &quot;Ok&quot; and &quot;Apply&quot; button when not valid)</span>
<span class="s2"># 1.0.7: added support for &quot;Apply&quot; button</span>
<span class="s2"># 1.0.6: code cleaning</span>

<span class="s1">__version__ = </span><span class="s3">'1.0.10'</span>
<span class="s1">__license__ = __doc__</span>

<span class="s4">import </span><span class="s1">copy</span>
<span class="s4">import </span><span class="s1">datetime</span>
<span class="s4">import </span><span class="s1">logging</span>
<span class="s4">from </span><span class="s1">numbers </span><span class="s4">import </span><span class="s1">Integral</span><span class="s4">, </span><span class="s1">Real</span>

<span class="s4">from </span><span class="s1">matplotlib </span><span class="s4">import </span><span class="s1">_api</span><span class="s4">, </span><span class="s1">colors </span><span class="s4">as </span><span class="s1">mcolors</span>
<span class="s4">from </span><span class="s1">matplotlib.backends.qt_compat </span><span class="s4">import </span><span class="s1">(</span>
    <span class="s1">QtGui</span><span class="s4">, </span><span class="s1">QtWidgets</span><span class="s4">, </span><span class="s1">QtCore</span><span class="s4">, </span><span class="s1">_enum</span><span class="s4">, </span><span class="s1">_to_int)</span>

<span class="s1">_log = logging.getLogger(__name__)</span>

<span class="s1">BLACKLIST = {</span><span class="s3">&quot;title&quot;</span><span class="s4">, </span><span class="s3">&quot;label&quot;</span><span class="s1">}</span>


<span class="s4">class </span><span class="s1">ColorButton(QtWidgets.QPushButton):</span>
    <span class="s0">&quot;&quot;&quot; 
    Color choosing push button 
    &quot;&quot;&quot;</span>
    <span class="s1">colorChanged = QtCore.Signal(QtGui.QColor)</span>

    <span class="s4">def </span><span class="s1">__init__(self</span><span class="s4">, </span><span class="s1">parent=</span><span class="s4">None</span><span class="s1">):</span>
        <span class="s1">super().__init__(parent)</span>
        <span class="s1">self.setFixedSize(</span><span class="s5">20</span><span class="s4">, </span><span class="s5">20</span><span class="s1">)</span>
        <span class="s1">self.setIconSize(QtCore.QSize(</span><span class="s5">12</span><span class="s4">, </span><span class="s5">12</span><span class="s1">))</span>
        <span class="s1">self.clicked.connect(self.choose_color)</span>
        <span class="s1">self._color = QtGui.QColor()</span>

    <span class="s4">def </span><span class="s1">choose_color(self):</span>
        <span class="s1">color = QtWidgets.QColorDialog.getColor(</span>
            <span class="s1">self._color</span><span class="s4">, </span><span class="s1">self.parentWidget()</span><span class="s4">, </span><span class="s3">&quot;&quot;</span><span class="s4">,</span>
            <span class="s1">_enum(</span><span class="s3">&quot;QtWidgets.QColorDialog.ColorDialogOption&quot;</span><span class="s1">).ShowAlphaChannel)</span>
        <span class="s4">if </span><span class="s1">color.isValid():</span>
            <span class="s1">self.set_color(color)</span>

    <span class="s4">def </span><span class="s1">get_color(self):</span>
        <span class="s4">return </span><span class="s1">self._color</span>

    <span class="s1">@QtCore.Slot(QtGui.QColor)</span>
    <span class="s4">def </span><span class="s1">set_color(self</span><span class="s4">, </span><span class="s1">color):</span>
        <span class="s4">if </span><span class="s1">color != self._color:</span>
            <span class="s1">self._color = color</span>
            <span class="s1">self.colorChanged.emit(self._color)</span>
            <span class="s1">pixmap = QtGui.QPixmap(self.iconSize())</span>
            <span class="s1">pixmap.fill(color)</span>
            <span class="s1">self.setIcon(QtGui.QIcon(pixmap))</span>

    <span class="s1">color = QtCore.Property(QtGui.QColor</span><span class="s4">, </span><span class="s1">get_color</span><span class="s4">, </span><span class="s1">set_color)</span>


<span class="s4">def </span><span class="s1">to_qcolor(color):</span>
    <span class="s0">&quot;&quot;&quot;Create a QColor from a matplotlib color&quot;&quot;&quot;</span>
    <span class="s1">qcolor = QtGui.QColor()</span>
    <span class="s4">try</span><span class="s1">:</span>
        <span class="s1">rgba = mcolors.to_rgba(color)</span>
    <span class="s4">except </span><span class="s1">ValueError:</span>
        <span class="s1">_api.warn_external(</span><span class="s3">f'Ignoring invalid color </span><span class="s4">{</span><span class="s1">color</span><span class="s4">!r}</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s4">return </span><span class="s1">qcolor  </span><span class="s2"># return invalid QColor</span>
    <span class="s1">qcolor.setRgbF(*rgba)</span>
    <span class="s4">return </span><span class="s1">qcolor</span>


<span class="s4">class </span><span class="s1">ColorLayout(QtWidgets.QHBoxLayout):</span>
    <span class="s0">&quot;&quot;&quot;Color-specialized QLineEdit layout&quot;&quot;&quot;</span>
    <span class="s4">def </span><span class="s1">__init__(self</span><span class="s4">, </span><span class="s1">color</span><span class="s4">, </span><span class="s1">parent=</span><span class="s4">None</span><span class="s1">):</span>
        <span class="s1">super().__init__()</span>
        <span class="s4">assert </span><span class="s1">isinstance(color</span><span class="s4">, </span><span class="s1">QtGui.QColor)</span>
        <span class="s1">self.lineedit = QtWidgets.QLineEdit(</span>
            <span class="s1">mcolors.to_hex(color.getRgbF()</span><span class="s4">, </span><span class="s1">keep_alpha=</span><span class="s4">True</span><span class="s1">)</span><span class="s4">, </span><span class="s1">parent)</span>
        <span class="s1">self.lineedit.editingFinished.connect(self.update_color)</span>
        <span class="s1">self.addWidget(self.lineedit)</span>
        <span class="s1">self.colorbtn = ColorButton(parent)</span>
        <span class="s1">self.colorbtn.color = color</span>
        <span class="s1">self.colorbtn.colorChanged.connect(self.update_text)</span>
        <span class="s1">self.addWidget(self.colorbtn)</span>

    <span class="s4">def </span><span class="s1">update_color(self):</span>
        <span class="s1">color = self.text()</span>
        <span class="s1">qcolor = to_qcolor(color)  </span><span class="s2"># defaults to black if not qcolor.isValid()</span>
        <span class="s1">self.colorbtn.color = qcolor</span>

    <span class="s4">def </span><span class="s1">update_text(self</span><span class="s4">, </span><span class="s1">color):</span>
        <span class="s1">self.lineedit.setText(mcolors.to_hex(color.getRgbF()</span><span class="s4">, </span><span class="s1">keep_alpha=</span><span class="s4">True</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">text(self):</span>
        <span class="s4">return </span><span class="s1">self.lineedit.text()</span>


<span class="s4">def </span><span class="s1">font_is_installed(font):</span>
    <span class="s0">&quot;&quot;&quot;Check if font is installed&quot;&quot;&quot;</span>
    <span class="s4">return </span><span class="s1">[fam </span><span class="s4">for </span><span class="s1">fam </span><span class="s4">in </span><span class="s1">QtGui.QFontDatabase().families()</span>
            <span class="s4">if </span><span class="s1">str(fam) == font]</span>


<span class="s4">def </span><span class="s1">tuple_to_qfont(tup):</span>
    <span class="s0">&quot;&quot;&quot; 
    Create a QFont from tuple: 
        (family [string], size [int], italic [bool], bold [bool]) 
    &quot;&quot;&quot;</span>
    <span class="s4">if not </span><span class="s1">(isinstance(tup</span><span class="s4">, </span><span class="s1">tuple) </span><span class="s4">and </span><span class="s1">len(tup) == </span><span class="s5">4</span>
            <span class="s4">and </span><span class="s1">font_is_installed(tup[</span><span class="s5">0</span><span class="s1">])</span>
            <span class="s4">and </span><span class="s1">isinstance(tup[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">, </span><span class="s1">Integral)</span>
            <span class="s4">and </span><span class="s1">isinstance(tup[</span><span class="s5">2</span><span class="s1">]</span><span class="s4">, </span><span class="s1">bool)</span>
            <span class="s4">and </span><span class="s1">isinstance(tup[</span><span class="s5">3</span><span class="s1">]</span><span class="s4">, </span><span class="s1">bool)):</span>
        <span class="s4">return None</span>
    <span class="s1">font = QtGui.QFont()</span>
    <span class="s1">family</span><span class="s4">, </span><span class="s1">size</span><span class="s4">, </span><span class="s1">italic</span><span class="s4">, </span><span class="s1">bold = tup</span>
    <span class="s1">font.setFamily(family)</span>
    <span class="s1">font.setPointSize(size)</span>
    <span class="s1">font.setItalic(italic)</span>
    <span class="s1">font.setBold(bold)</span>
    <span class="s4">return </span><span class="s1">font</span>


<span class="s4">def </span><span class="s1">qfont_to_tuple(font):</span>
    <span class="s4">return </span><span class="s1">(str(font.family())</span><span class="s4">, </span><span class="s1">int(font.pointSize())</span><span class="s4">,</span>
            <span class="s1">font.italic()</span><span class="s4">, </span><span class="s1">font.bold())</span>


<span class="s4">class </span><span class="s1">FontLayout(QtWidgets.QGridLayout):</span>
    <span class="s0">&quot;&quot;&quot;Font selection&quot;&quot;&quot;</span>
    <span class="s4">def </span><span class="s1">__init__(self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">, </span><span class="s1">parent=</span><span class="s4">None</span><span class="s1">):</span>
        <span class="s1">super().__init__()</span>
        <span class="s1">font = tuple_to_qfont(value)</span>
        <span class="s4">assert </span><span class="s1">font </span><span class="s4">is not None</span>

        <span class="s2"># Font family</span>
        <span class="s1">self.family = QtWidgets.QFontComboBox(parent)</span>
        <span class="s1">self.family.setCurrentFont(font)</span>
        <span class="s1">self.addWidget(self.family</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">)</span>

        <span class="s2"># Font size</span>
        <span class="s1">self.size = QtWidgets.QComboBox(parent)</span>
        <span class="s1">self.size.setEditable(</span><span class="s4">True</span><span class="s1">)</span>
        <span class="s1">sizelist = [*range(</span><span class="s5">6</span><span class="s4">, </span><span class="s5">12</span><span class="s1">)</span><span class="s4">, </span><span class="s1">*range(</span><span class="s5">12</span><span class="s4">, </span><span class="s5">30</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s5">36</span><span class="s4">, </span><span class="s5">48</span><span class="s4">, </span><span class="s5">72</span><span class="s1">]</span>
        <span class="s1">size = font.pointSize()</span>
        <span class="s4">if </span><span class="s1">size </span><span class="s4">not in </span><span class="s1">sizelist:</span>
            <span class="s1">sizelist.append(size)</span>
            <span class="s1">sizelist.sort()</span>
        <span class="s1">self.size.addItems([str(s) </span><span class="s4">for </span><span class="s1">s </span><span class="s4">in </span><span class="s1">sizelist])</span>
        <span class="s1">self.size.setCurrentIndex(sizelist.index(size))</span>
        <span class="s1">self.addWidget(self.size</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>

        <span class="s2"># Italic or not</span>
        <span class="s1">self.italic = QtWidgets.QCheckBox(self.tr(</span><span class="s3">&quot;Italic&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s1">parent)</span>
        <span class="s1">self.italic.setChecked(font.italic())</span>
        <span class="s1">self.addWidget(self.italic</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span>

        <span class="s2"># Bold or not</span>
        <span class="s1">self.bold = QtWidgets.QCheckBox(self.tr(</span><span class="s3">&quot;Bold&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s1">parent)</span>
        <span class="s1">self.bold.setChecked(font.bold())</span>
        <span class="s1">self.addWidget(self.bold</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s4">def </span><span class="s1">get_font(self):</span>
        <span class="s1">font = self.family.currentFont()</span>
        <span class="s1">font.setItalic(self.italic.isChecked())</span>
        <span class="s1">font.setBold(self.bold.isChecked())</span>
        <span class="s1">font.setPointSize(int(self.size.currentText()))</span>
        <span class="s4">return </span><span class="s1">qfont_to_tuple(font)</span>


<span class="s4">def </span><span class="s1">is_edit_valid(edit):</span>
    <span class="s1">text = edit.text()</span>
    <span class="s1">state = edit.validator().validate(text</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s4">return </span><span class="s1">state == _enum(</span><span class="s3">&quot;QtGui.QDoubleValidator.State&quot;</span><span class="s1">).Acceptable</span>


<span class="s4">class </span><span class="s1">FormWidget(QtWidgets.QWidget):</span>
    <span class="s1">update_buttons = QtCore.Signal()</span>

    <span class="s4">def </span><span class="s1">__init__(self</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">comment=</span><span class="s3">&quot;&quot;</span><span class="s4">, </span><span class="s1">with_margin=</span><span class="s4">False, </span><span class="s1">parent=</span><span class="s4">None</span><span class="s1">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Parameters 
        ---------- 
        data : list of (label, value) pairs 
            The data to be edited in the form. 
        comment : str, optional 
        with_margin : bool, default: False 
            If False, the form elements reach to the border of the widget. 
            This is the desired behavior if the FormWidget is used as a widget 
            alongside with other widgets such as a QComboBox, which also do 
            not have a margin around them. 
            However, a margin can be desired if the FormWidget is the only 
            widget within a container, e.g. a tab in a QTabWidget. 
        parent : QWidget or None 
            The parent widget. 
        &quot;&quot;&quot;</span>
        <span class="s1">super().__init__(parent)</span>
        <span class="s1">self.data = copy.deepcopy(data)</span>
        <span class="s1">self.widgets = []</span>
        <span class="s1">self.formlayout = QtWidgets.QFormLayout(self)</span>
        <span class="s4">if not </span><span class="s1">with_margin:</span>
            <span class="s1">self.formlayout.setContentsMargins(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s4">if </span><span class="s1">comment:</span>
            <span class="s1">self.formlayout.addRow(QtWidgets.QLabel(comment))</span>
            <span class="s1">self.formlayout.addRow(QtWidgets.QLabel(</span><span class="s3">&quot; &quot;</span><span class="s1">))</span>

    <span class="s4">def </span><span class="s1">get_dialog(self):</span>
        <span class="s0">&quot;&quot;&quot;Return FormDialog instance&quot;&quot;&quot;</span>
        <span class="s1">dialog = self.parent()</span>
        <span class="s4">while not </span><span class="s1">isinstance(dialog</span><span class="s4">, </span><span class="s1">QtWidgets.QDialog):</span>
            <span class="s1">dialog = dialog.parent()</span>
        <span class="s4">return </span><span class="s1">dialog</span>

    <span class="s4">def </span><span class="s1">setup(self):</span>
        <span class="s4">for </span><span class="s1">label</span><span class="s4">, </span><span class="s1">value </span><span class="s4">in </span><span class="s1">self.data:</span>
            <span class="s4">if </span><span class="s1">label </span><span class="s4">is None and </span><span class="s1">value </span><span class="s4">is None</span><span class="s1">:</span>
                <span class="s2"># Separator: (None, None)</span>
                <span class="s1">self.formlayout.addRow(QtWidgets.QLabel(</span><span class="s3">&quot; &quot;</span><span class="s1">)</span><span class="s4">,</span>
                                       <span class="s1">QtWidgets.QLabel(</span><span class="s3">&quot; &quot;</span><span class="s1">))</span>
                <span class="s1">self.widgets.append(</span><span class="s4">None</span><span class="s1">)</span>
                <span class="s4">continue</span>
            <span class="s4">elif </span><span class="s1">label </span><span class="s4">is None</span><span class="s1">:</span>
                <span class="s2"># Comment</span>
                <span class="s1">self.formlayout.addRow(QtWidgets.QLabel(value))</span>
                <span class="s1">self.widgets.append(</span><span class="s4">None</span><span class="s1">)</span>
                <span class="s4">continue</span>
            <span class="s4">elif </span><span class="s1">tuple_to_qfont(value) </span><span class="s4">is not None</span><span class="s1">:</span>
                <span class="s1">field = FontLayout(value</span><span class="s4">, </span><span class="s1">self)</span>
            <span class="s4">elif </span><span class="s1">(label.lower() </span><span class="s4">not in </span><span class="s1">BLACKLIST</span>
                  <span class="s4">and </span><span class="s1">mcolors.is_color_like(value)):</span>
                <span class="s1">field = ColorLayout(to_qcolor(value)</span><span class="s4">, </span><span class="s1">self)</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">str):</span>
                <span class="s1">field = QtWidgets.QLineEdit(value</span><span class="s4">, </span><span class="s1">self)</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">(list</span><span class="s4">, </span><span class="s1">tuple)):</span>
                <span class="s4">if </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">tuple):</span>
                    <span class="s1">value = list(value)</span>
                <span class="s2"># Note: get() below checks the type of value[0] in self.data so</span>
                <span class="s2"># it is essential that value gets modified in-place.</span>
                <span class="s2"># This means that the code is actually broken in the case where</span>
                <span class="s2"># value is a tuple, but fortunately we always pass a list...</span>
                <span class="s1">selindex = value.pop(</span><span class="s5">0</span><span class="s1">)</span>
                <span class="s1">field = QtWidgets.QComboBox(self)</span>
                <span class="s4">if </span><span class="s1">isinstance(value[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(list</span><span class="s4">, </span><span class="s1">tuple)):</span>
                    <span class="s1">keys = [key </span><span class="s4">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">_val </span><span class="s4">in </span><span class="s1">value]</span>
                    <span class="s1">value = [val </span><span class="s4">for </span><span class="s1">_key</span><span class="s4">, </span><span class="s1">val </span><span class="s4">in </span><span class="s1">value]</span>
                <span class="s4">else</span><span class="s1">:</span>
                    <span class="s1">keys = value</span>
                <span class="s1">field.addItems(value)</span>
                <span class="s4">if </span><span class="s1">selindex </span><span class="s4">in </span><span class="s1">value:</span>
                    <span class="s1">selindex = value.index(selindex)</span>
                <span class="s4">elif </span><span class="s1">selindex </span><span class="s4">in </span><span class="s1">keys:</span>
                    <span class="s1">selindex = keys.index(selindex)</span>
                <span class="s4">elif not </span><span class="s1">isinstance(selindex</span><span class="s4">, </span><span class="s1">Integral):</span>
                    <span class="s1">_log.warning(</span>
                        <span class="s3">&quot;index '%s' is invalid (label: %s, value: %s)&quot;</span><span class="s4">,</span>
                        <span class="s1">selindex</span><span class="s4">, </span><span class="s1">label</span><span class="s4">, </span><span class="s1">value)</span>
                    <span class="s1">selindex = </span><span class="s5">0</span>
                <span class="s1">field.setCurrentIndex(selindex)</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">bool):</span>
                <span class="s1">field = QtWidgets.QCheckBox(self)</span>
                <span class="s1">field.setChecked(value)</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">Integral):</span>
                <span class="s1">field = QtWidgets.QSpinBox(self)</span>
                <span class="s1">field.setRange(-</span><span class="s5">10</span><span class="s1">**</span><span class="s5">9</span><span class="s4">, </span><span class="s5">10</span><span class="s1">**</span><span class="s5">9</span><span class="s1">)</span>
                <span class="s1">field.setValue(value)</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">Real):</span>
                <span class="s1">field = QtWidgets.QLineEdit(repr(value)</span><span class="s4">, </span><span class="s1">self)</span>
                <span class="s1">field.setCursorPosition(</span><span class="s5">0</span><span class="s1">)</span>
                <span class="s1">field.setValidator(QtGui.QDoubleValidator(field))</span>
                <span class="s1">field.validator().setLocale(QtCore.QLocale(</span><span class="s3">&quot;C&quot;</span><span class="s1">))</span>
                <span class="s1">dialog = self.get_dialog()</span>
                <span class="s1">dialog.register_float_field(field)</span>
                <span class="s1">field.textChanged.connect(</span><span class="s4">lambda </span><span class="s1">text: dialog.update_buttons())</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">datetime.datetime):</span>
                <span class="s1">field = QtWidgets.QDateTimeEdit(self)</span>
                <span class="s1">field.setDateTime(value)</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">datetime.date):</span>
                <span class="s1">field = QtWidgets.QDateEdit(self)</span>
                <span class="s1">field.setDate(value)</span>
            <span class="s4">else</span><span class="s1">:</span>
                <span class="s1">field = QtWidgets.QLineEdit(repr(value)</span><span class="s4">, </span><span class="s1">self)</span>
            <span class="s1">self.formlayout.addRow(label</span><span class="s4">, </span><span class="s1">field)</span>
            <span class="s1">self.widgets.append(field)</span>

    <span class="s4">def </span><span class="s1">get(self):</span>
        <span class="s1">valuelist = []</span>
        <span class="s4">for </span><span class="s1">index</span><span class="s4">, </span><span class="s1">(label</span><span class="s4">, </span><span class="s1">value) </span><span class="s4">in </span><span class="s1">enumerate(self.data):</span>
            <span class="s1">field = self.widgets[index]</span>
            <span class="s4">if </span><span class="s1">label </span><span class="s4">is None</span><span class="s1">:</span>
                <span class="s2"># Separator / Comment</span>
                <span class="s4">continue</span>
            <span class="s4">elif </span><span class="s1">tuple_to_qfont(value) </span><span class="s4">is not None</span><span class="s1">:</span>
                <span class="s1">value = field.get_font()</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">str) </span><span class="s4">or </span><span class="s1">mcolors.is_color_like(value):</span>
                <span class="s1">value = str(field.text())</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">(list</span><span class="s4">, </span><span class="s1">tuple)):</span>
                <span class="s1">index = int(field.currentIndex())</span>
                <span class="s4">if </span><span class="s1">isinstance(value[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(list</span><span class="s4">, </span><span class="s1">tuple)):</span>
                    <span class="s1">value = value[index][</span><span class="s5">0</span><span class="s1">]</span>
                <span class="s4">else</span><span class="s1">:</span>
                    <span class="s1">value = value[index]</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">bool):</span>
                <span class="s1">value = field.isChecked()</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">Integral):</span>
                <span class="s1">value = int(field.value())</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">Real):</span>
                <span class="s1">value = float(str(field.text()))</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">datetime.datetime):</span>
                <span class="s1">datetime_ = field.dateTime()</span>
                <span class="s4">if </span><span class="s1">hasattr(datetime_</span><span class="s4">, </span><span class="s3">&quot;toPyDateTime&quot;</span><span class="s1">):</span>
                    <span class="s1">value = datetime_.toPyDateTime()</span>
                <span class="s4">else</span><span class="s1">:</span>
                    <span class="s1">value = datetime_.toPython()</span>
            <span class="s4">elif </span><span class="s1">isinstance(value</span><span class="s4">, </span><span class="s1">datetime.date):</span>
                <span class="s1">date_ = field.date()</span>
                <span class="s4">if </span><span class="s1">hasattr(date_</span><span class="s4">, </span><span class="s3">&quot;toPyDate&quot;</span><span class="s1">):</span>
                    <span class="s1">value = date_.toPyDate()</span>
                <span class="s4">else</span><span class="s1">:</span>
                    <span class="s1">value = date_.toPython()</span>
            <span class="s4">else</span><span class="s1">:</span>
                <span class="s1">value = eval(str(field.text()))</span>
            <span class="s1">valuelist.append(value)</span>
        <span class="s4">return </span><span class="s1">valuelist</span>


<span class="s4">class </span><span class="s1">FormComboWidget(QtWidgets.QWidget):</span>
    <span class="s1">update_buttons = QtCore.Signal()</span>

    <span class="s4">def </span><span class="s1">__init__(self</span><span class="s4">, </span><span class="s1">datalist</span><span class="s4">, </span><span class="s1">comment=</span><span class="s3">&quot;&quot;</span><span class="s4">, </span><span class="s1">parent=</span><span class="s4">None</span><span class="s1">):</span>
        <span class="s1">super().__init__(parent)</span>
        <span class="s1">layout = QtWidgets.QVBoxLayout()</span>
        <span class="s1">self.setLayout(layout)</span>
        <span class="s1">self.combobox = QtWidgets.QComboBox()</span>
        <span class="s1">layout.addWidget(self.combobox)</span>

        <span class="s1">self.stackwidget = QtWidgets.QStackedWidget(self)</span>
        <span class="s1">layout.addWidget(self.stackwidget)</span>
        <span class="s1">self.combobox.currentIndexChanged.connect(</span>
            <span class="s1">self.stackwidget.setCurrentIndex)</span>

        <span class="s1">self.widgetlist = []</span>
        <span class="s4">for </span><span class="s1">data</span><span class="s4">, </span><span class="s1">title</span><span class="s4">, </span><span class="s1">comment </span><span class="s4">in </span><span class="s1">datalist:</span>
            <span class="s1">self.combobox.addItem(title)</span>
            <span class="s1">widget = FormWidget(data</span><span class="s4">, </span><span class="s1">comment=comment</span><span class="s4">, </span><span class="s1">parent=self)</span>
            <span class="s1">self.stackwidget.addWidget(widget)</span>
            <span class="s1">self.widgetlist.append(widget)</span>

    <span class="s4">def </span><span class="s1">setup(self):</span>
        <span class="s4">for </span><span class="s1">widget </span><span class="s4">in </span><span class="s1">self.widgetlist:</span>
            <span class="s1">widget.setup()</span>

    <span class="s4">def </span><span class="s1">get(self):</span>
        <span class="s4">return </span><span class="s1">[widget.get() </span><span class="s4">for </span><span class="s1">widget </span><span class="s4">in </span><span class="s1">self.widgetlist]</span>


<span class="s4">class </span><span class="s1">FormTabWidget(QtWidgets.QWidget):</span>
    <span class="s1">update_buttons = QtCore.Signal()</span>

    <span class="s4">def </span><span class="s1">__init__(self</span><span class="s4">, </span><span class="s1">datalist</span><span class="s4">, </span><span class="s1">comment=</span><span class="s3">&quot;&quot;</span><span class="s4">, </span><span class="s1">parent=</span><span class="s4">None</span><span class="s1">):</span>
        <span class="s1">super().__init__(parent)</span>
        <span class="s1">layout = QtWidgets.QVBoxLayout()</span>
        <span class="s1">self.tabwidget = QtWidgets.QTabWidget()</span>
        <span class="s1">layout.addWidget(self.tabwidget)</span>
        <span class="s1">layout.setContentsMargins(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">self.setLayout(layout)</span>
        <span class="s1">self.widgetlist = []</span>
        <span class="s4">for </span><span class="s1">data</span><span class="s4">, </span><span class="s1">title</span><span class="s4">, </span><span class="s1">comment </span><span class="s4">in </span><span class="s1">datalist:</span>
            <span class="s4">if </span><span class="s1">len(data[</span><span class="s5">0</span><span class="s1">]) == </span><span class="s5">3</span><span class="s1">:</span>
                <span class="s1">widget = FormComboWidget(data</span><span class="s4">, </span><span class="s1">comment=comment</span><span class="s4">, </span><span class="s1">parent=self)</span>
            <span class="s4">else</span><span class="s1">:</span>
                <span class="s1">widget = FormWidget(data</span><span class="s4">, </span><span class="s1">with_margin=</span><span class="s4">True, </span><span class="s1">comment=comment</span><span class="s4">,</span>
                                    <span class="s1">parent=self)</span>
            <span class="s1">index = self.tabwidget.addTab(widget</span><span class="s4">, </span><span class="s1">title)</span>
            <span class="s1">self.tabwidget.setTabToolTip(index</span><span class="s4">, </span><span class="s1">comment)</span>
            <span class="s1">self.widgetlist.append(widget)</span>

    <span class="s4">def </span><span class="s1">setup(self):</span>
        <span class="s4">for </span><span class="s1">widget </span><span class="s4">in </span><span class="s1">self.widgetlist:</span>
            <span class="s1">widget.setup()</span>

    <span class="s4">def </span><span class="s1">get(self):</span>
        <span class="s4">return </span><span class="s1">[widget.get() </span><span class="s4">for </span><span class="s1">widget </span><span class="s4">in </span><span class="s1">self.widgetlist]</span>


<span class="s4">class </span><span class="s1">FormDialog(QtWidgets.QDialog):</span>
    <span class="s0">&quot;&quot;&quot;Form Dialog&quot;&quot;&quot;</span>
    <span class="s4">def </span><span class="s1">__init__(self</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">title=</span><span class="s3">&quot;&quot;</span><span class="s4">, </span><span class="s1">comment=</span><span class="s3">&quot;&quot;</span><span class="s4">,</span>
                 <span class="s1">icon=</span><span class="s4">None, </span><span class="s1">parent=</span><span class="s4">None, </span><span class="s1">apply=</span><span class="s4">None</span><span class="s1">):</span>
        <span class="s1">super().__init__(parent)</span>

        <span class="s1">self.apply_callback = apply</span>

        <span class="s2"># Form</span>
        <span class="s4">if </span><span class="s1">isinstance(data[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s4">, </span><span class="s1">(list</span><span class="s4">, </span><span class="s1">tuple)):</span>
            <span class="s1">self.formwidget = FormTabWidget(data</span><span class="s4">, </span><span class="s1">comment=comment</span><span class="s4">,</span>
                                            <span class="s1">parent=self)</span>
        <span class="s4">elif </span><span class="s1">len(data[</span><span class="s5">0</span><span class="s1">]) == </span><span class="s5">3</span><span class="s1">:</span>
            <span class="s1">self.formwidget = FormComboWidget(data</span><span class="s4">, </span><span class="s1">comment=comment</span><span class="s4">,</span>
                                              <span class="s1">parent=self)</span>
        <span class="s4">else</span><span class="s1">:</span>
            <span class="s1">self.formwidget = FormWidget(data</span><span class="s4">, </span><span class="s1">comment=comment</span><span class="s4">,</span>
                                         <span class="s1">parent=self)</span>
        <span class="s1">layout = QtWidgets.QVBoxLayout()</span>
        <span class="s1">layout.addWidget(self.formwidget)</span>

        <span class="s1">self.float_fields = []</span>
        <span class="s1">self.formwidget.setup()</span>

        <span class="s2"># Button box</span>
        <span class="s1">self.bbox = bbox = QtWidgets.QDialogButtonBox(</span>
            <span class="s1">QtWidgets.QDialogButtonBox.StandardButton(</span>
                <span class="s1">_to_int(</span>
                    <span class="s1">_enum(</span><span class="s3">&quot;QtWidgets.QDialogButtonBox.StandardButton&quot;</span><span class="s1">).Ok) |</span>
                <span class="s1">_to_int(</span>
                    <span class="s1">_enum(</span><span class="s3">&quot;QtWidgets.QDialogButtonBox.StandardButton&quot;</span><span class="s1">).Cancel)</span>
            <span class="s1">))</span>
        <span class="s1">self.formwidget.update_buttons.connect(self.update_buttons)</span>
        <span class="s4">if </span><span class="s1">self.apply_callback </span><span class="s4">is not None</span><span class="s1">:</span>
            <span class="s1">apply_btn = bbox.addButton(</span>
                <span class="s1">_enum(</span><span class="s3">&quot;QtWidgets.QDialogButtonBox.StandardButton&quot;</span><span class="s1">).Apply)</span>
            <span class="s1">apply_btn.clicked.connect(self.apply)</span>

        <span class="s1">bbox.accepted.connect(self.accept)</span>
        <span class="s1">bbox.rejected.connect(self.reject)</span>
        <span class="s1">layout.addWidget(bbox)</span>

        <span class="s1">self.setLayout(layout)</span>

        <span class="s1">self.setWindowTitle(title)</span>
        <span class="s4">if not </span><span class="s1">isinstance(icon</span><span class="s4">, </span><span class="s1">QtGui.QIcon):</span>
            <span class="s1">icon = QtWidgets.QWidget().style().standardIcon(</span>
                <span class="s1">QtWidgets.QStyle.SP_MessageBoxQuestion)</span>
        <span class="s1">self.setWindowIcon(icon)</span>

    <span class="s4">def </span><span class="s1">register_float_field(self</span><span class="s4">, </span><span class="s1">field):</span>
        <span class="s1">self.float_fields.append(field)</span>

    <span class="s4">def </span><span class="s1">update_buttons(self):</span>
        <span class="s1">valid = </span><span class="s4">True</span>
        <span class="s4">for </span><span class="s1">field </span><span class="s4">in </span><span class="s1">self.float_fields:</span>
            <span class="s4">if not </span><span class="s1">is_edit_valid(field):</span>
                <span class="s1">valid = </span><span class="s4">False</span>
        <span class="s4">for </span><span class="s1">btn_type </span><span class="s4">in </span><span class="s1">[</span><span class="s3">&quot;Ok&quot;</span><span class="s4">, </span><span class="s3">&quot;Apply&quot;</span><span class="s1">]:</span>
            <span class="s1">btn = self.bbox.button(</span>
                <span class="s1">getattr(_enum(</span><span class="s3">&quot;QtWidgets.QDialogButtonBox.StandardButton&quot;</span><span class="s1">)</span><span class="s4">,</span>
                        <span class="s1">btn_type))</span>
            <span class="s4">if </span><span class="s1">btn </span><span class="s4">is not None</span><span class="s1">:</span>
                <span class="s1">btn.setEnabled(valid)</span>

    <span class="s4">def </span><span class="s1">accept(self):</span>
        <span class="s1">self.data = self.formwidget.get()</span>
        <span class="s1">self.apply_callback(self.data)</span>
        <span class="s1">super().accept()</span>

    <span class="s4">def </span><span class="s1">reject(self):</span>
        <span class="s1">self.data = </span><span class="s4">None</span>
        <span class="s1">super().reject()</span>

    <span class="s4">def </span><span class="s1">apply(self):</span>
        <span class="s1">self.apply_callback(self.formwidget.get())</span>

    <span class="s4">def </span><span class="s1">get(self):</span>
        <span class="s0">&quot;&quot;&quot;Return form result&quot;&quot;&quot;</span>
        <span class="s4">return </span><span class="s1">self.data</span>


<span class="s4">def </span><span class="s1">fedit(data</span><span class="s4">, </span><span class="s1">title=</span><span class="s3">&quot;&quot;</span><span class="s4">, </span><span class="s1">comment=</span><span class="s3">&quot;&quot;</span><span class="s4">, </span><span class="s1">icon=</span><span class="s4">None, </span><span class="s1">parent=</span><span class="s4">None, </span><span class="s1">apply=</span><span class="s4">None</span><span class="s1">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Create form dialog 
 
    data: datalist, datagroup 
    title: str 
    comment: str 
    icon: QIcon instance 
    parent: parent QWidget 
    apply: apply callback (function) 
 
    datalist: list/tuple of (field_name, field_value) 
    datagroup: list/tuple of (datalist *or* datagroup, title, comment) 
 
    -&gt; one field for each member of a datalist 
    -&gt; one tab for each member of a top-level datagroup 
    -&gt; one page (of a multipage widget, each page can be selected with a combo 
       box) for each member of a datagroup inside a datagroup 
 
    Supported types for field_value: 
      - int, float, str, bool 
      - colors: in Qt-compatible text form, i.e. in hex format or name 
                (red, ...) (automatically detected from a string) 
      - list/tuple: 
          * the first element will be the selected index (or value) 
          * the other elements can be couples (key, value) or only values 
    &quot;&quot;&quot;</span>

    <span class="s2"># Create a QApplication instance if no instance currently exists</span>
    <span class="s2"># (e.g., if the module is used directly from the interpreter)</span>
    <span class="s4">if </span><span class="s1">QtWidgets.QApplication.startingUp():</span>
        <span class="s1">_app = QtWidgets.QApplication([])</span>
    <span class="s1">dialog = FormDialog(data</span><span class="s4">, </span><span class="s1">title</span><span class="s4">, </span><span class="s1">comment</span><span class="s4">, </span><span class="s1">icon</span><span class="s4">, </span><span class="s1">parent</span><span class="s4">, </span><span class="s1">apply)</span>

    <span class="s4">if </span><span class="s1">parent </span><span class="s4">is not None</span><span class="s1">:</span>
        <span class="s4">if </span><span class="s1">hasattr(parent</span><span class="s4">, </span><span class="s3">&quot;_fedit_dialog&quot;</span><span class="s1">):</span>
            <span class="s1">parent._fedit_dialog.close()</span>
        <span class="s1">parent._fedit_dialog = dialog</span>

    <span class="s1">dialog.show()</span>


<span class="s4">if </span><span class="s1">__name__ == </span><span class="s3">&quot;__main__&quot;</span><span class="s1">:</span>

    <span class="s1">_app = QtWidgets.QApplication([])</span>

    <span class="s4">def </span><span class="s1">create_datalist_example():</span>
        <span class="s4">return </span><span class="s1">[(</span><span class="s3">'str'</span><span class="s4">, </span><span class="s3">'this is a string'</span><span class="s1">)</span><span class="s4">,</span>
                <span class="s1">(</span><span class="s3">'list'</span><span class="s4">, </span><span class="s1">[</span><span class="s5">0</span><span class="s4">, </span><span class="s3">'1'</span><span class="s4">, </span><span class="s3">'3'</span><span class="s4">, </span><span class="s3">'4'</span><span class="s1">])</span><span class="s4">,</span>
                <span class="s1">(</span><span class="s3">'list2'</span><span class="s4">, </span><span class="s1">[</span><span class="s3">'--'</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'none'</span><span class="s4">, </span><span class="s3">'None'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'--'</span><span class="s4">, </span><span class="s3">'Dashed'</span><span class="s1">)</span><span class="s4">,</span>
                           <span class="s1">(</span><span class="s3">'-.'</span><span class="s4">, </span><span class="s3">'DashDot'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'-'</span><span class="s4">, </span><span class="s3">'Solid'</span><span class="s1">)</span><span class="s4">,</span>
                           <span class="s1">(</span><span class="s3">'steps'</span><span class="s4">, </span><span class="s3">'Steps'</span><span class="s1">)</span><span class="s4">, </span><span class="s1">(</span><span class="s3">':'</span><span class="s4">, </span><span class="s3">'Dotted'</span><span class="s1">)])</span><span class="s4">,</span>
                <span class="s1">(</span><span class="s3">'float'</span><span class="s4">, </span><span class="s5">1.2</span><span class="s1">)</span><span class="s4">,</span>
                <span class="s1">(</span><span class="s4">None, </span><span class="s3">'Other:'</span><span class="s1">)</span><span class="s4">,</span>
                <span class="s1">(</span><span class="s3">'int'</span><span class="s4">, </span><span class="s5">12</span><span class="s1">)</span><span class="s4">,</span>
                <span class="s1">(</span><span class="s3">'font'</span><span class="s4">, </span><span class="s1">(</span><span class="s3">'Arial'</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, False, True</span><span class="s1">))</span><span class="s4">,</span>
                <span class="s1">(</span><span class="s3">'color'</span><span class="s4">, </span><span class="s3">'#123409'</span><span class="s1">)</span><span class="s4">,</span>
                <span class="s1">(</span><span class="s3">'bool'</span><span class="s4">, True</span><span class="s1">)</span><span class="s4">,</span>
                <span class="s1">(</span><span class="s3">'date'</span><span class="s4">, </span><span class="s1">datetime.date(</span><span class="s5">2010</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">10</span><span class="s1">))</span><span class="s4">,</span>
                <span class="s1">(</span><span class="s3">'datetime'</span><span class="s4">, </span><span class="s1">datetime.datetime(</span><span class="s5">2010</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">10</span><span class="s1">))</span><span class="s4">,</span>
                <span class="s1">]</span>

    <span class="s4">def </span><span class="s1">create_datagroup_example():</span>
        <span class="s1">datalist = create_datalist_example()</span>
        <span class="s4">return </span><span class="s1">((datalist</span><span class="s4">, </span><span class="s3">&quot;Category 1&quot;</span><span class="s4">, </span><span class="s3">&quot;Category 1 comment&quot;</span><span class="s1">)</span><span class="s4">,</span>
                <span class="s1">(datalist</span><span class="s4">, </span><span class="s3">&quot;Category 2&quot;</span><span class="s4">, </span><span class="s3">&quot;Category 2 comment&quot;</span><span class="s1">)</span><span class="s4">,</span>
                <span class="s1">(datalist</span><span class="s4">, </span><span class="s3">&quot;Category 3&quot;</span><span class="s4">, </span><span class="s3">&quot;Category 3 comment&quot;</span><span class="s1">))</span>

    <span class="s2"># --------- datalist example</span>
    <span class="s1">datalist = create_datalist_example()</span>

    <span class="s4">def </span><span class="s1">apply_test(data):</span>
        <span class="s1">print(</span><span class="s3">&quot;data:&quot;</span><span class="s4">, </span><span class="s1">data)</span>
    <span class="s1">fedit(datalist</span><span class="s4">, </span><span class="s1">title=</span><span class="s3">&quot;Example&quot;</span><span class="s4">,</span>
          <span class="s1">comment=</span><span class="s3">&quot;This is just an &lt;b&gt;example&lt;/b&gt;.&quot;</span><span class="s4">,</span>
          <span class="s1">apply=apply_test)</span>

    <span class="s1">_app.exec()</span>

    <span class="s2"># --------- datagroup example</span>
    <span class="s1">datagroup = create_datagroup_example()</span>
    <span class="s1">fedit(datagroup</span><span class="s4">, </span><span class="s3">&quot;Global title&quot;</span><span class="s4">,</span>
          <span class="s1">apply=apply_test)</span>
    <span class="s1">_app.exec()</span>

    <span class="s2"># --------- datagroup inside a datagroup example</span>
    <span class="s1">datalist = create_datalist_example()</span>
    <span class="s1">datagroup = create_datagroup_example()</span>
    <span class="s1">fedit(((datagroup</span><span class="s4">, </span><span class="s3">&quot;Title 1&quot;</span><span class="s4">, </span><span class="s3">&quot;Tab 1 comment&quot;</span><span class="s1">)</span><span class="s4">,</span>
           <span class="s1">(datalist</span><span class="s4">, </span><span class="s3">&quot;Title 2&quot;</span><span class="s4">, </span><span class="s3">&quot;Tab 2 comment&quot;</span><span class="s1">)</span><span class="s4">,</span>
           <span class="s1">(datalist</span><span class="s4">, </span><span class="s3">&quot;Title 3&quot;</span><span class="s4">, </span><span class="s3">&quot;Tab 3 comment&quot;</span><span class="s1">))</span><span class="s4">,</span>
          <span class="s3">&quot;Global title&quot;</span><span class="s4">,</span>
          <span class="s1">apply=apply_test)</span>
    <span class="s1">_app.exec()</span>
</pre>
</body>
</html>