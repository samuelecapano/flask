<html>
<head>
<title>test_image.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #808080;}
.s5 { color: #6897bb;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_image.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">contextlib </span><span class="s0">import </span><span class="s1">ExitStack</span>
<span class="s0">from </span><span class="s1">copy </span><span class="s0">import </span><span class="s1">copy</span>
<span class="s0">import </span><span class="s1">io</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">urllib.request</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_array_equal</span>
<span class="s0">from </span><span class="s1">PIL </span><span class="s0">import </span><span class="s1">Image</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">colors</span><span class="s0">, </span><span class="s1">image </span><span class="s0">as </span><span class="s1">mimage</span><span class="s0">, </span><span class="s1">patches</span><span class="s0">, </span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span><span class="s0">, </span><span class="s1">style</span><span class="s0">, </span><span class="s1">rcParams)</span>
<span class="s0">from </span><span class="s1">matplotlib.image </span><span class="s0">import </span><span class="s1">(AxesImage</span><span class="s0">, </span><span class="s1">BboxImage</span><span class="s0">, </span><span class="s1">FigureImage</span><span class="s0">,</span>
                              <span class="s1">NonUniformImage</span><span class="s0">, </span><span class="s1">PcolorImage)</span>
<span class="s0">from </span><span class="s1">matplotlib.testing.decorators </span><span class="s0">import </span><span class="s1">check_figures_equal</span><span class="s0">, </span><span class="s1">image_comparison</span>
<span class="s0">from </span><span class="s1">matplotlib.transforms </span><span class="s0">import </span><span class="s1">Bbox</span><span class="s0">, </span><span class="s1">Affine2D</span><span class="s0">, </span><span class="s1">TransformedBbox</span>
<span class="s0">import </span><span class="s1">matplotlib.ticker </span><span class="s0">as </span><span class="s1">mticker</span>

<span class="s0">import </span><span class="s1">pytest</span>


<span class="s1">@image_comparison([</span><span class="s2">'image_interps'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">style=</span><span class="s2">'mpl20'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_image_interps():</span>
    <span class="s3">&quot;&quot;&quot;Make the basic nearest, bilinear and bicubic interps.&quot;&quot;&quot;</span>
    <span class="s4"># Remove this line when this test image is regenerated.</span>
    <span class="s1">plt.rcParams[</span><span class="s2">'text.kerning_factor'</span><span class="s1">] = </span><span class="s5">6</span>

    <span class="s1">X = np.arange(</span><span class="s5">100</span><span class="s1">).reshape(</span><span class="s5">5</span><span class="s0">, </span><span class="s5">20</span><span class="s1">)</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">(ax1</span><span class="s0">, </span><span class="s1">ax2</span><span class="s0">, </span><span class="s1">ax3) = plt.subplots(</span><span class="s5">3</span><span class="s1">)</span>
    <span class="s1">ax1.imshow(X</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s1">)</span>
    <span class="s1">ax1.set_title(</span><span class="s2">'three interpolations'</span><span class="s1">)</span>
    <span class="s1">ax1.set_ylabel(</span><span class="s2">'nearest'</span><span class="s1">)</span>

    <span class="s1">ax2.imshow(X</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'bilinear'</span><span class="s1">)</span>
    <span class="s1">ax2.set_ylabel(</span><span class="s2">'bilinear'</span><span class="s1">)</span>

    <span class="s1">ax3.imshow(X</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'bicubic'</span><span class="s1">)</span>
    <span class="s1">ax3.set_ylabel(</span><span class="s2">'bicubic'</span><span class="s1">)</span>


<span class="s1">@image_comparison([</span><span class="s2">'interp_alpha.png'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_alpha_interp():</span>
    <span class="s3">&quot;&quot;&quot;Test the interpolation of the alpha channel on RGBA images&quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">(axl</span><span class="s0">, </span><span class="s1">axr) = plt.subplots(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s4"># full green image</span>
    <span class="s1">img = np.zeros((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">4</span><span class="s1">))</span>
    <span class="s1">img[...</span><span class="s0">, </span><span class="s5">1</span><span class="s1">] = np.ones((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>
    <span class="s4"># transparent under main diagonal</span>
    <span class="s1">img[...</span><span class="s0">, </span><span class="s5">3</span><span class="s1">] = np.tril(np.ones((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.uint8))</span>
    <span class="s1">axl.imshow(img</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s1">axr.imshow(img</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">&quot;bilinear&quot;</span><span class="s1">)</span>


<span class="s1">@image_comparison([</span><span class="s2">'interp_nearest_vs_none'</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">extensions=[</span><span class="s2">'pdf'</span><span class="s0">, </span><span class="s2">'svg'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_interp_nearest_vs_none():</span>
    <span class="s3">&quot;&quot;&quot;Test the effect of &quot;nearest&quot; and &quot;none&quot; interpolation&quot;&quot;&quot;</span>
    <span class="s4"># Setting dpi to something really small makes the difference very</span>
    <span class="s4"># visible. This works fine with pdf, since the dpi setting doesn't</span>
    <span class="s4"># affect anything but images, but the agg output becomes unusably</span>
    <span class="s4"># small.</span>
    <span class="s1">rcParams[</span><span class="s2">'savefig.dpi'</span><span class="s1">] = </span><span class="s5">3</span>
    <span class="s1">X = np.array([[[</span><span class="s5">218</span><span class="s0">, </span><span class="s5">165</span><span class="s0">, </span><span class="s5">32</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">122</span><span class="s0">, </span><span class="s5">103</span><span class="s0">, </span><span class="s5">238</span><span class="s1">]]</span><span class="s0">,</span>
                  <span class="s1">[[</span><span class="s5">127</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">255</span><span class="s0">, </span><span class="s5">99</span><span class="s0">, </span><span class="s5">71</span><span class="s1">]]]</span><span class="s0">, </span><span class="s1">dtype=np.uint8)</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">(ax1</span><span class="s0">, </span><span class="s1">ax2) = plt.subplots(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">ax1.imshow(X</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'none'</span><span class="s1">)</span>
    <span class="s1">ax1.set_title(</span><span class="s2">'interpolation none'</span><span class="s1">)</span>
    <span class="s1">ax2.imshow(X</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s1">)</span>
    <span class="s1">ax2.set_title(</span><span class="s2">'interpolation nearest'</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">'suppressComposite'</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s1">@image_comparison([</span><span class="s2">'figimage'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">extensions=[</span><span class="s2">'png'</span><span class="s0">, </span><span class="s2">'pdf'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_figimage(suppressComposite):</span>
    <span class="s1">fig = plt.figure(figsize=(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dpi=</span><span class="s5">100</span><span class="s1">)</span>
    <span class="s1">fig.suppressComposite = suppressComposite</span>
    <span class="s1">x</span><span class="s0">, </span><span class="s1">y = np.ix_(np.arange(</span><span class="s5">100</span><span class="s1">) / </span><span class="s5">100.0</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s5">100</span><span class="s1">) / </span><span class="s5">100</span><span class="s1">)</span>
    <span class="s1">z = np.sin(x**</span><span class="s5">2 </span><span class="s1">+ y**</span><span class="s5">2 </span><span class="s1">- x*y)</span>
    <span class="s1">c = np.sin(</span><span class="s5">20</span><span class="s1">*x**</span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">50</span><span class="s1">*y**</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">img = z + c/</span><span class="s5">5</span>

    <span class="s1">fig.figimage(img</span><span class="s0">, </span><span class="s1">xo=</span><span class="s5">0</span><span class="s0">, </span><span class="s1">yo=</span><span class="s5">0</span><span class="s0">, </span><span class="s1">origin=</span><span class="s2">'lower'</span><span class="s1">)</span>
    <span class="s1">fig.figimage(img[::-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">xo=</span><span class="s5">0</span><span class="s0">, </span><span class="s1">yo=</span><span class="s5">100</span><span class="s0">, </span><span class="s1">origin=</span><span class="s2">'lower'</span><span class="s1">)</span>
    <span class="s1">fig.figimage(img[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">xo=</span><span class="s5">100</span><span class="s0">, </span><span class="s1">yo=</span><span class="s5">0</span><span class="s0">, </span><span class="s1">origin=</span><span class="s2">'lower'</span><span class="s1">)</span>
    <span class="s1">fig.figimage(img[::-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">::-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">xo=</span><span class="s5">100</span><span class="s0">, </span><span class="s1">yo=</span><span class="s5">100</span><span class="s0">, </span><span class="s1">origin=</span><span class="s2">'lower'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_image_python_io():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.plot([</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">])</span>
    <span class="s1">buffer = io.BytesIO()</span>
    <span class="s1">fig.savefig(buffer)</span>
    <span class="s1">buffer.seek(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">plt.imread(buffer)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;img_size, fig_size, interpolation&quot;</span><span class="s0">,</span>
    <span class="s1">[(</span><span class="s5">5</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s2">&quot;hanning&quot;</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># data larger than figure.</span>
     <span class="s1">(</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s2">&quot;nearest&quot;</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># exact resample.</span>
     <span class="s1">(</span><span class="s5">5</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s2">&quot;nearest&quot;</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># double sample.</span>
     <span class="s1">(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">2.9</span><span class="s0">, </span><span class="s2">&quot;hanning&quot;</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># &lt;3 upsample.</span>
     <span class="s1">(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">9.1</span><span class="s0">, </span><span class="s2">&quot;nearest&quot;</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># &gt;3 upsample.</span>
     <span class="s1">])</span>
<span class="s1">@check_figures_equal(extensions=[</span><span class="s2">'png'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_imshow_antialiased(fig_test</span><span class="s0">, </span><span class="s1">fig_ref</span><span class="s0">,</span>
                            <span class="s1">img_size</span><span class="s0">, </span><span class="s1">fig_size</span><span class="s0">, </span><span class="s1">interpolation):</span>
    <span class="s1">np.random.seed(</span><span class="s5">19680801</span><span class="s1">)</span>
    <span class="s1">dpi = plt.rcParams[</span><span class="s2">&quot;savefig.dpi&quot;</span><span class="s1">]</span>
    <span class="s1">A = np.random.rand(int(dpi * img_size)</span><span class="s0">, </span><span class="s1">int(dpi * img_size))</span>
    <span class="s0">for </span><span class="s1">fig </span><span class="s0">in </span><span class="s1">[fig_test</span><span class="s0">, </span><span class="s1">fig_ref]:</span>
        <span class="s1">fig.set_size_inches(fig_size</span><span class="s0">, </span><span class="s1">fig_size)</span>
    <span class="s1">ax = fig_test.subplots()</span>
    <span class="s1">ax.set_position([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">])</span>
    <span class="s1">ax.imshow(A</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'antialiased'</span><span class="s1">)</span>
    <span class="s1">ax = fig_ref.subplots()</span>
    <span class="s1">ax.set_position([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">])</span>
    <span class="s1">ax.imshow(A</span><span class="s0">, </span><span class="s1">interpolation=interpolation)</span>


<span class="s1">@check_figures_equal(extensions=[</span><span class="s2">'png'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_imshow_zoom(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s4"># should be less than 3 upsample, so should be nearest...</span>
    <span class="s1">np.random.seed(</span><span class="s5">19680801</span><span class="s1">)</span>
    <span class="s1">dpi = plt.rcParams[</span><span class="s2">&quot;savefig.dpi&quot;</span><span class="s1">]</span>
    <span class="s1">A = np.random.rand(int(dpi * </span><span class="s5">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">int(dpi * </span><span class="s5">3</span><span class="s1">))</span>
    <span class="s0">for </span><span class="s1">fig </span><span class="s0">in </span><span class="s1">[fig_test</span><span class="s0">, </span><span class="s1">fig_ref]:</span>
        <span class="s1">fig.set_size_inches(</span><span class="s5">2.9</span><span class="s0">, </span><span class="s5">2.9</span><span class="s1">)</span>
    <span class="s1">ax = fig_test.subplots()</span>
    <span class="s1">ax.imshow(A</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'antialiased'</span><span class="s1">)</span>
    <span class="s1">ax.set_xlim([</span><span class="s5">10</span><span class="s0">, </span><span class="s5">20</span><span class="s1">])</span>
    <span class="s1">ax.set_ylim([</span><span class="s5">10</span><span class="s0">, </span><span class="s5">20</span><span class="s1">])</span>
    <span class="s1">ax = fig_ref.subplots()</span>
    <span class="s1">ax.imshow(A</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s1">)</span>
    <span class="s1">ax.set_xlim([</span><span class="s5">10</span><span class="s0">, </span><span class="s5">20</span><span class="s1">])</span>
    <span class="s1">ax.set_ylim([</span><span class="s5">10</span><span class="s0">, </span><span class="s5">20</span><span class="s1">])</span>


<span class="s1">@check_figures_equal()</span>
<span class="s0">def </span><span class="s1">test_imshow_pil(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s1">style.use(</span><span class="s2">&quot;default&quot;</span><span class="s1">)</span>
    <span class="s1">png_path = Path(__file__).parent / </span><span class="s2">&quot;baseline_images/pngsuite/basn3p04.png&quot;</span>
    <span class="s1">tiff_path = Path(__file__).parent / </span><span class="s2">&quot;baseline_images/test_image/uint16.tif&quot;</span>
    <span class="s1">axs = fig_test.subplots(</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">axs[</span><span class="s5">0</span><span class="s1">].imshow(Image.open(png_path))</span>
    <span class="s1">axs[</span><span class="s5">1</span><span class="s1">].imshow(Image.open(tiff_path))</span>
    <span class="s1">axs = fig_ref.subplots(</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">axs[</span><span class="s5">0</span><span class="s1">].imshow(plt.imread(png_path))</span>
    <span class="s1">axs[</span><span class="s5">1</span><span class="s1">].imshow(plt.imread(tiff_path))</span>


<span class="s0">def </span><span class="s1">test_imread_pil_uint16():</span>
    <span class="s1">img = plt.imread(os.path.join(os.path.dirname(__file__)</span><span class="s0">,</span>
                     <span class="s2">'baseline_images'</span><span class="s0">, </span><span class="s2">'test_image'</span><span class="s0">, </span><span class="s2">'uint16.tif'</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">img.dtype == np.uint16</span>
    <span class="s0">assert </span><span class="s1">np.sum(img) == </span><span class="s5">134184960</span>


<span class="s0">def </span><span class="s1">test_imread_fspath():</span>
    <span class="s1">img = plt.imread(</span>
        <span class="s1">Path(__file__).parent / </span><span class="s2">'baseline_images/test_image/uint16.tif'</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">img.dtype == np.uint16</span>
    <span class="s0">assert </span><span class="s1">np.sum(img) == </span><span class="s5">134184960</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;fmt&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;png&quot;</span><span class="s0">, </span><span class="s2">&quot;jpg&quot;</span><span class="s0">, </span><span class="s2">&quot;jpeg&quot;</span><span class="s0">, </span><span class="s2">&quot;tiff&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_imsave(fmt):</span>
    <span class="s1">has_alpha = fmt </span><span class="s0">not in </span><span class="s1">[</span><span class="s2">&quot;jpg&quot;</span><span class="s0">, </span><span class="s2">&quot;jpeg&quot;</span><span class="s1">]</span>

    <span class="s4"># The goal here is that the user can specify an output logical DPI</span>
    <span class="s4"># for the image, but this will not actually add any extra pixels</span>
    <span class="s4"># to the image, it will merely be used for metadata purposes.</span>

    <span class="s4"># So we do the traditional case (dpi == 1), and the new case (dpi</span>
    <span class="s4"># == 100) and read the resulting PNG files back in and make sure</span>
    <span class="s4"># the data is 100% identical.</span>
    <span class="s1">np.random.seed(</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s4"># The height of 1856 pixels was selected because going through creating an</span>
    <span class="s4"># actual dpi=100 figure to save the image to a Pillow-provided format would</span>
    <span class="s4"># cause a rounding error resulting in a final image of shape 1855.</span>
    <span class="s1">data = np.random.rand(</span><span class="s5">1856</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s1">buff_dpi1 = io.BytesIO()</span>
    <span class="s1">plt.imsave(buff_dpi1</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">format=fmt</span><span class="s0">, </span><span class="s1">dpi=</span><span class="s5">1</span><span class="s1">)</span>

    <span class="s1">buff_dpi100 = io.BytesIO()</span>
    <span class="s1">plt.imsave(buff_dpi100</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">format=fmt</span><span class="s0">, </span><span class="s1">dpi=</span><span class="s5">100</span><span class="s1">)</span>

    <span class="s1">buff_dpi1.seek(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">arr_dpi1 = plt.imread(buff_dpi1</span><span class="s0">, </span><span class="s1">format=fmt)</span>

    <span class="s1">buff_dpi100.seek(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">arr_dpi100 = plt.imread(buff_dpi100</span><span class="s0">, </span><span class="s1">format=fmt)</span>

    <span class="s0">assert </span><span class="s1">arr_dpi1.shape == (</span><span class="s5">1856</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3 </span><span class="s1">+ has_alpha)</span>
    <span class="s0">assert </span><span class="s1">arr_dpi100.shape == (</span><span class="s5">1856</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3 </span><span class="s1">+ has_alpha)</span>

    <span class="s1">assert_array_equal(arr_dpi1</span><span class="s0">, </span><span class="s1">arr_dpi100)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;fmt&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;png&quot;</span><span class="s0">, </span><span class="s2">&quot;pdf&quot;</span><span class="s0">, </span><span class="s2">&quot;ps&quot;</span><span class="s0">, </span><span class="s2">&quot;eps&quot;</span><span class="s0">, </span><span class="s2">&quot;svg&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_imsave_fspath(fmt):</span>
    <span class="s1">plt.imsave(Path(os.devnull)</span><span class="s0">, </span><span class="s1">np.array([[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">format=fmt)</span>


<span class="s0">def </span><span class="s1">test_imsave_color_alpha():</span>
    <span class="s4"># Test that imsave accept arrays with ndim=3 where the third dimension is</span>
    <span class="s4"># color and alpha without raising any exceptions, and that the data is</span>
    <span class="s4"># acceptably preserved through a save/read roundtrip.</span>
    <span class="s1">np.random.seed(</span><span class="s5">1</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">origin </span><span class="s0">in </span><span class="s1">[</span><span class="s2">'lower'</span><span class="s0">, </span><span class="s2">'upper'</span><span class="s1">]:</span>
        <span class="s1">data = np.random.rand(</span><span class="s5">16</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s1">buff = io.BytesIO()</span>
        <span class="s1">plt.imsave(buff</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">origin=origin</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;png&quot;</span><span class="s1">)</span>

        <span class="s1">buff.seek(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">arr_buf = plt.imread(buff)</span>

        <span class="s4"># Recreate the float -&gt; uint8 conversion of the data</span>
        <span class="s4"># We can only expect to be the same with 8 bits of precision,</span>
        <span class="s4"># since that's what the PNG file used.</span>
        <span class="s1">data = (</span><span class="s5">255</span><span class="s1">*data).astype(</span><span class="s2">'uint8'</span><span class="s1">)</span>
        <span class="s0">if </span><span class="s1">origin == </span><span class="s2">'lower'</span><span class="s1">:</span>
            <span class="s1">data = data[::-</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">arr_buf = (</span><span class="s5">255</span><span class="s1">*arr_buf).astype(</span><span class="s2">'uint8'</span><span class="s1">)</span>

        <span class="s1">assert_array_equal(data</span><span class="s0">, </span><span class="s1">arr_buf)</span>


<span class="s0">def </span><span class="s1">test_imsave_pil_kwargs_png():</span>
    <span class="s0">from </span><span class="s1">PIL.PngImagePlugin </span><span class="s0">import </span><span class="s1">PngInfo</span>
    <span class="s1">buf = io.BytesIO()</span>
    <span class="s1">pnginfo = PngInfo()</span>
    <span class="s1">pnginfo.add_text(</span><span class="s2">&quot;Software&quot;</span><span class="s0">, </span><span class="s2">&quot;test&quot;</span><span class="s1">)</span>
    <span class="s1">plt.imsave(buf</span><span class="s0">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">]]</span><span class="s0">,</span>
               <span class="s1">format=</span><span class="s2">&quot;png&quot;</span><span class="s0">, </span><span class="s1">pil_kwargs={</span><span class="s2">&quot;pnginfo&quot;</span><span class="s1">: pnginfo})</span>
    <span class="s1">im = Image.open(buf)</span>
    <span class="s0">assert </span><span class="s1">im.info[</span><span class="s2">&quot;Software&quot;</span><span class="s1">] == </span><span class="s2">&quot;test&quot;</span>


<span class="s0">def </span><span class="s1">test_imsave_pil_kwargs_tiff():</span>
    <span class="s0">from </span><span class="s1">PIL.TiffTags </span><span class="s0">import </span><span class="s1">TAGS_V2 </span><span class="s0">as </span><span class="s1">TAGS</span>
    <span class="s1">buf = io.BytesIO()</span>
    <span class="s1">pil_kwargs = {</span><span class="s2">&quot;description&quot;</span><span class="s1">: </span><span class="s2">&quot;test image&quot;</span><span class="s1">}</span>
    <span class="s1">plt.imsave(buf</span><span class="s0">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;tiff&quot;</span><span class="s0">, </span><span class="s1">pil_kwargs=pil_kwargs)</span>
    <span class="s0">assert </span><span class="s1">len(pil_kwargs) == </span><span class="s5">1</span>
    <span class="s1">im = Image.open(buf)</span>
    <span class="s1">tags = {TAGS[k].name: v </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">im.tag_v2.items()}</span>
    <span class="s0">assert </span><span class="s1">tags[</span><span class="s2">&quot;ImageDescription&quot;</span><span class="s1">] == </span><span class="s2">&quot;test image&quot;</span>


<span class="s1">@image_comparison([</span><span class="s2">'image_alpha'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_image_alpha():</span>
    <span class="s1">np.random.seed(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">Z = np.random.rand(</span><span class="s5">6</span><span class="s0">, </span><span class="s5">6</span><span class="s1">)</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">(ax1</span><span class="s0">, </span><span class="s1">ax2</span><span class="s0">, </span><span class="s1">ax3) = plt.subplots(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>
    <span class="s1">ax1.imshow(Z</span><span class="s0">, </span><span class="s1">alpha=</span><span class="s5">1.0</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'none'</span><span class="s1">)</span>
    <span class="s1">ax2.imshow(Z</span><span class="s0">, </span><span class="s1">alpha=</span><span class="s5">0.5</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'none'</span><span class="s1">)</span>
    <span class="s1">ax3.imshow(Z</span><span class="s0">, </span><span class="s1">alpha=</span><span class="s5">0.5</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_cursor_data():</span>
    <span class="s0">from </span><span class="s1">matplotlib.backend_bases </span><span class="s0">import </span><span class="s1">MouseEvent</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">im = ax.imshow(np.arange(</span><span class="s5">100</span><span class="s1">).reshape(</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">origin=</span><span class="s2">'upper'</span><span class="s1">)</span>

    <span class="s1">x</span><span class="s0">, </span><span class="s1">y = </span><span class="s5">4</span><span class="s0">, </span><span class="s5">4</span>
    <span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp = ax.transData.transform([x</span><span class="s0">, </span><span class="s1">y])</span>

    <span class="s1">event = MouseEvent(</span><span class="s2">'motion_notify_event'</span><span class="s0">, </span><span class="s1">fig.canvas</span><span class="s0">, </span><span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp)</span>
    <span class="s0">assert </span><span class="s1">im.get_cursor_data(event) == </span><span class="s5">44</span>

    <span class="s4"># Now try for a point outside the image</span>
    <span class="s4"># Tests issue #4957</span>
    <span class="s1">x</span><span class="s0">, </span><span class="s1">y = </span><span class="s5">10.1</span><span class="s0">, </span><span class="s5">4</span>
    <span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp = ax.transData.transform([x</span><span class="s0">, </span><span class="s1">y])</span>

    <span class="s1">event = MouseEvent(</span><span class="s2">'motion_notify_event'</span><span class="s0">, </span><span class="s1">fig.canvas</span><span class="s0">, </span><span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp)</span>
    <span class="s0">assert </span><span class="s1">im.get_cursor_data(event) </span><span class="s0">is None</span>

    <span class="s4"># Hmm, something is wrong here... I get 0, not None...</span>
    <span class="s4"># But, this works further down in the tests with extents flipped</span>
    <span class="s4"># x, y = 0.1, -0.1</span>
    <span class="s4"># xdisp, ydisp = ax.transData.transform([x, y])</span>
    <span class="s4"># event = MouseEvent('motion_notify_event', fig.canvas, xdisp, ydisp)</span>
    <span class="s4"># z = im.get_cursor_data(event)</span>
    <span class="s4"># assert z is None, &quot;Did not get None, got %d&quot; % z</span>

    <span class="s1">ax.clear()</span>
    <span class="s4"># Now try with the extents flipped.</span>
    <span class="s1">im = ax.imshow(np.arange(</span><span class="s5">100</span><span class="s1">).reshape(</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">origin=</span><span class="s2">'lower'</span><span class="s1">)</span>

    <span class="s1">x</span><span class="s0">, </span><span class="s1">y = </span><span class="s5">4</span><span class="s0">, </span><span class="s5">4</span>
    <span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp = ax.transData.transform([x</span><span class="s0">, </span><span class="s1">y])</span>

    <span class="s1">event = MouseEvent(</span><span class="s2">'motion_notify_event'</span><span class="s0">, </span><span class="s1">fig.canvas</span><span class="s0">, </span><span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp)</span>
    <span class="s0">assert </span><span class="s1">im.get_cursor_data(event) == </span><span class="s5">44</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">im = ax.imshow(np.arange(</span><span class="s5">100</span><span class="s1">).reshape(</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0.5</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0.5</span><span class="s1">])</span>

    <span class="s1">x</span><span class="s0">, </span><span class="s1">y = </span><span class="s5">0.25</span><span class="s0">, </span><span class="s5">0.25</span>
    <span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp = ax.transData.transform([x</span><span class="s0">, </span><span class="s1">y])</span>

    <span class="s1">event = MouseEvent(</span><span class="s2">'motion_notify_event'</span><span class="s0">, </span><span class="s1">fig.canvas</span><span class="s0">, </span><span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp)</span>
    <span class="s0">assert </span><span class="s1">im.get_cursor_data(event) == </span><span class="s5">55</span>

    <span class="s4"># Now try for a point outside the image</span>
    <span class="s4"># Tests issue #4957</span>
    <span class="s1">x</span><span class="s0">, </span><span class="s1">y = </span><span class="s5">0.75</span><span class="s0">, </span><span class="s5">0.25</span>
    <span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp = ax.transData.transform([x</span><span class="s0">, </span><span class="s1">y])</span>

    <span class="s1">event = MouseEvent(</span><span class="s2">'motion_notify_event'</span><span class="s0">, </span><span class="s1">fig.canvas</span><span class="s0">, </span><span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp)</span>
    <span class="s0">assert </span><span class="s1">im.get_cursor_data(event) </span><span class="s0">is None</span>

    <span class="s1">x</span><span class="s0">, </span><span class="s1">y = </span><span class="s5">0.01</span><span class="s0">, </span><span class="s1">-</span><span class="s5">0.01</span>
    <span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp = ax.transData.transform([x</span><span class="s0">, </span><span class="s1">y])</span>

    <span class="s1">event = MouseEvent(</span><span class="s2">'motion_notify_event'</span><span class="s0">, </span><span class="s1">fig.canvas</span><span class="s0">, </span><span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp)</span>
    <span class="s0">assert </span><span class="s1">im.get_cursor_data(event) </span><span class="s0">is None</span>

    <span class="s4"># Now try with additional transform applied to the image artist</span>
    <span class="s1">trans = Affine2D().scale(</span><span class="s5">2</span><span class="s1">).rotate(</span><span class="s5">0.5</span><span class="s1">)</span>
    <span class="s1">im = ax.imshow(np.arange(</span><span class="s5">100</span><span class="s1">).reshape(</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">,</span>
                   <span class="s1">transform=trans + ax.transData)</span>
    <span class="s1">x</span><span class="s0">, </span><span class="s1">y = </span><span class="s5">3</span><span class="s0">, </span><span class="s5">10</span>
    <span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp = ax.transData.transform([x</span><span class="s0">, </span><span class="s1">y])</span>
    <span class="s1">event = MouseEvent(</span><span class="s2">'motion_notify_event'</span><span class="s0">, </span><span class="s1">fig.canvas</span><span class="s0">, </span><span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp)</span>
    <span class="s0">assert </span><span class="s1">im.get_cursor_data(event) == </span><span class="s5">44</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;data, text&quot;</span><span class="s0">, </span><span class="s1">[</span>
        <span class="s1">([[</span><span class="s5">10001</span><span class="s0">, </span><span class="s5">10000</span><span class="s1">]]</span><span class="s0">, </span><span class="s2">&quot;[10001.000]&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([[</span><span class="s5">.123</span><span class="s0">, </span><span class="s5">.987</span><span class="s1">]]</span><span class="s0">, </span><span class="s2">&quot;[0.123]&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([[np.nan</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s2">&quot;[]&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">+</span><span class="s5">1e-15</span><span class="s1">]]</span><span class="s0">, </span><span class="s2">&quot;[1.0000000000000000]&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([[-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s2">&quot;[-1.0000000000000000]&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_format_cursor_data(data</span><span class="s0">, </span><span class="s1">text):</span>
    <span class="s0">from </span><span class="s1">matplotlib.backend_bases </span><span class="s0">import </span><span class="s1">MouseEvent</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">im = ax.imshow(data)</span>

    <span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp = ax.transData.transform([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">event = MouseEvent(</span><span class="s2">'motion_notify_event'</span><span class="s0">, </span><span class="s1">fig.canvas</span><span class="s0">, </span><span class="s1">xdisp</span><span class="s0">, </span><span class="s1">ydisp)</span>
    <span class="s0">assert </span><span class="s1">im.format_cursor_data(im.get_cursor_data(event)) == text</span>


<span class="s1">@image_comparison([</span><span class="s2">'image_clip'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">style=</span><span class="s2">'mpl20'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_image_clip():</span>
    <span class="s1">d = [[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s1">]]</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">im = ax.imshow(d)</span>
    <span class="s1">patch = patches.Circle((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">radius=</span><span class="s5">1</span><span class="s0">, </span><span class="s1">transform=ax.transData)</span>
    <span class="s1">im.set_clip_path(patch)</span>


<span class="s1">@image_comparison([</span><span class="s2">'image_cliprect'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">style=</span><span class="s2">'mpl20'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_image_cliprect():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">d = [[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s1">]]</span>

    <span class="s1">im = ax.imshow(d</span><span class="s0">, </span><span class="s1">extent=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>

    <span class="s1">rect = patches.Rectangle(</span>
        <span class="s1">xy=(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">width=</span><span class="s5">2</span><span class="s0">, </span><span class="s1">height=</span><span class="s5">2</span><span class="s0">, </span><span class="s1">transform=im.axes.transData)</span>
    <span class="s1">im.set_clip_path(rect)</span>


<span class="s1">@image_comparison([</span><span class="s2">'imshow'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True, </span><span class="s1">style=</span><span class="s2">'mpl20'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_imshow():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">arr = np.arange(</span><span class="s5">100</span><span class="s1">).reshape((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">))</span>
    <span class="s1">ax.imshow(arr</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">&quot;bilinear&quot;</span><span class="s0">, </span><span class="s1">extent=(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">ax.set_xlim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>
    <span class="s1">ax.set_ylim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>


<span class="s1">@check_figures_equal(extensions=[</span><span class="s2">'png'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_imshow_10_10_1(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s4"># 10x10x1 should be the same as 10x10</span>
    <span class="s1">arr = np.arange(</span><span class="s5">100</span><span class="s1">).reshape((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s5">1</span><span class="s1">))</span>
    <span class="s1">ax = fig_ref.subplots()</span>
    <span class="s1">ax.imshow(arr[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">&quot;bilinear&quot;</span><span class="s0">, </span><span class="s1">extent=(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">ax.set_xlim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>
    <span class="s1">ax.set_ylim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>

    <span class="s1">ax = fig_test.subplots()</span>
    <span class="s1">ax.imshow(arr</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">&quot;bilinear&quot;</span><span class="s0">, </span><span class="s1">extent=(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">ax.set_xlim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>
    <span class="s1">ax.set_ylim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_imshow_10_10_2():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">arr = np.arange(</span><span class="s5">200</span><span class="s1">).reshape((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">ax.imshow(arr)</span>


<span class="s0">def </span><span class="s1">test_imshow_10_10_5():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">arr = np.arange(</span><span class="s5">500</span><span class="s1">).reshape((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">ax.imshow(arr)</span>


<span class="s1">@image_comparison([</span><span class="s2">'no_interpolation_origin'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_no_interpolation_origin():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">axs = plt.subplots(</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">axs[</span><span class="s5">0</span><span class="s1">].imshow(np.arange(</span><span class="s5">100</span><span class="s1">).reshape((</span><span class="s5">2</span><span class="s0">, </span><span class="s5">50</span><span class="s1">))</span><span class="s0">, </span><span class="s1">origin=</span><span class="s2">&quot;lower&quot;</span><span class="s0">,</span>
                  <span class="s1">interpolation=</span><span class="s2">'none'</span><span class="s1">)</span>
    <span class="s1">axs[</span><span class="s5">1</span><span class="s1">].imshow(np.arange(</span><span class="s5">100</span><span class="s1">).reshape((</span><span class="s5">2</span><span class="s0">, </span><span class="s5">50</span><span class="s1">))</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'none'</span><span class="s1">)</span>


<span class="s1">@image_comparison([</span><span class="s2">'image_shift'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True, </span><span class="s1">extensions=[</span><span class="s2">'pdf'</span><span class="s0">, </span><span class="s2">'svg'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_image_shift():</span>
    <span class="s1">imgData = [[</span><span class="s5">1 </span><span class="s1">/ x + </span><span class="s5">1 </span><span class="s1">/ y </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">100</span><span class="s1">)] </span><span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">100</span><span class="s1">)]</span>
    <span class="s1">tMin = </span><span class="s5">734717.945208</span>
    <span class="s1">tMax = </span><span class="s5">734717.946366</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow(imgData</span><span class="s0">, </span><span class="s1">norm=colors.LogNorm()</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'none'</span><span class="s0">,</span>
              <span class="s1">extent=(tMin</span><span class="s0">, </span><span class="s1">tMax</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">100</span><span class="s1">))</span>
    <span class="s1">ax.set_aspect(</span><span class="s2">'auto'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_image_edges():</span>
    <span class="s1">fig = plt.figure(figsize=[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">])</span>
    <span class="s1">ax = fig.add_axes([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">frameon=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s1">data = np.tile(np.arange(</span><span class="s5">12</span><span class="s1">)</span><span class="s0">, </span><span class="s5">15</span><span class="s1">).reshape(</span><span class="s5">20</span><span class="s0">, </span><span class="s5">9</span><span class="s1">)</span>

    <span class="s1">im = ax.imshow(data</span><span class="s0">, </span><span class="s1">origin=</span><span class="s2">'upper'</span><span class="s0">, </span><span class="s1">extent=[-</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s1">-</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">interpolation=</span><span class="s2">'none'</span><span class="s0">, </span><span class="s1">cmap=</span><span class="s2">'gray'</span><span class="s1">)</span>

    <span class="s1">x = y = </span><span class="s5">2</span>
    <span class="s1">ax.set_xlim([-x</span><span class="s0">, </span><span class="s1">x])</span>
    <span class="s1">ax.set_ylim([-y</span><span class="s0">, </span><span class="s1">y])</span>

    <span class="s1">ax.set_xticks([])</span>
    <span class="s1">ax.set_yticks([])</span>

    <span class="s1">buf = io.BytesIO()</span>
    <span class="s1">fig.savefig(buf</span><span class="s0">, </span><span class="s1">facecolor=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>

    <span class="s1">buf.seek(</span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">im = plt.imread(buf)</span>
    <span class="s1">r</span><span class="s0">, </span><span class="s1">g</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">a = sum(im[:</span><span class="s0">, </span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">r</span><span class="s0">, </span><span class="s1">g</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">a = sum(im[:</span><span class="s0">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">])</span>

    <span class="s0">assert </span><span class="s1">g != </span><span class="s5">100</span><span class="s0">, </span><span class="s2">'Expected a non-green edge - but sadly, it was.'</span>


<span class="s1">@image_comparison([</span><span class="s2">'image_composite_background'</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">remove_text=</span><span class="s0">True, </span><span class="s1">style=</span><span class="s2">'mpl20'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_image_composite_background():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">arr = np.arange(</span><span class="s5">12</span><span class="s1">).reshape(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>
    <span class="s1">ax.imshow(arr</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">15</span><span class="s0">, </span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">ax.imshow(arr</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">4</span><span class="s0">, </span><span class="s5">6</span><span class="s0">, </span><span class="s5">15</span><span class="s0">, </span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">ax.set_facecolor((</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0.5</span><span class="s1">))</span>
    <span class="s1">ax.set_xlim([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">12</span><span class="s1">])</span>


<span class="s1">@image_comparison([</span><span class="s2">'image_composite_alpha'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_image_composite_alpha():</span>
    <span class="s3">&quot;&quot;&quot; 
    Tests that the alpha value is recognized and correctly applied in the 
    process of compositing images together. 
    &quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">arr = np.zeros((</span><span class="s5">11</span><span class="s0">, </span><span class="s5">21</span><span class="s0">, </span><span class="s5">4</span><span class="s1">))</span>
    <span class="s1">arr[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s5">0</span><span class="s1">] = </span><span class="s5">1</span>
    <span class="s1">arr[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s5">3</span><span class="s1">] = np.concatenate(</span>
        <span class="s1">(np.arange(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1.1</span><span class="s0">, </span><span class="s5">0.1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0.1</span><span class="s1">)[::-</span><span class="s5">1</span><span class="s1">]))</span>
    <span class="s1">arr2 = np.zeros((</span><span class="s5">21</span><span class="s0">, </span><span class="s5">11</span><span class="s0">, </span><span class="s5">4</span><span class="s1">))</span>
    <span class="s1">arr2[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s5">0</span><span class="s1">] = </span><span class="s5">1</span>
    <span class="s1">arr2[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s5">1</span><span class="s1">] = </span><span class="s5">1</span>
    <span class="s1">arr2[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s5">3</span><span class="s1">] = np.concatenate(</span>
        <span class="s1">(np.arange(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1.1</span><span class="s0">, </span><span class="s5">0.1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0.1</span><span class="s1">)[::-</span><span class="s5">1</span><span class="s1">]))[:</span><span class="s0">, </span><span class="s1">np.newaxis]</span>
    <span class="s1">ax.imshow(arr</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">alpha=</span><span class="s5">0.3</span><span class="s1">)</span>
    <span class="s1">ax.imshow(arr</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">alpha=</span><span class="s5">0.6</span><span class="s1">)</span>
    <span class="s1">ax.imshow(arr</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">ax.imshow(arr2</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">])</span>
    <span class="s1">ax.imshow(arr2</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">alpha=</span><span class="s5">0.6</span><span class="s1">)</span>
    <span class="s1">ax.imshow(arr2</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">alpha=</span><span class="s5">0.3</span><span class="s1">)</span>
    <span class="s1">ax.set_facecolor((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0.5</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">))</span>
    <span class="s1">ax.set_xlim([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s1">])</span>
    <span class="s1">ax.set_ylim([</span><span class="s5">5</span><span class="s0">, </span><span class="s5">0</span><span class="s1">])</span>


<span class="s1">@check_figures_equal(extensions=[</span><span class="s2">&quot;pdf&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_clip_path_disables_compositing(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s1">t = np.arange(</span><span class="s5">9</span><span class="s1">).reshape((</span><span class="s5">3</span><span class="s0">, </span><span class="s5">3</span><span class="s1">))</span>
    <span class="s0">for </span><span class="s1">fig </span><span class="s0">in </span><span class="s1">[fig_test</span><span class="s0">, </span><span class="s1">fig_ref]:</span>
        <span class="s1">ax = fig.add_subplot()</span>
        <span class="s1">ax.imshow(t</span><span class="s0">, </span><span class="s1">clip_path=(mpl.path.Path([(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)])</span><span class="s0">,</span>
                                <span class="s1">ax.transData))</span>
        <span class="s1">ax.imshow(t</span><span class="s0">, </span><span class="s1">clip_path=(mpl.path.Path([(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)])</span><span class="s0">,</span>
                                <span class="s1">ax.transData))</span>
    <span class="s1">fig_ref.suppressComposite = </span><span class="s0">True</span>


<span class="s1">@image_comparison([</span><span class="s2">'rasterize_10dpi'</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">extensions=[</span><span class="s2">'pdf'</span><span class="s0">, </span><span class="s2">'svg'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True, </span><span class="s1">style=</span><span class="s2">'mpl20'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rasterize_dpi():</span>
    <span class="s4"># This test should check rasterized rendering with high output resolution.</span>
    <span class="s4"># It plots a rasterized line and a normal image with imshow.  So it will</span>
    <span class="s4"># catch when images end up in the wrong place in case of non-standard dpi</span>
    <span class="s4"># setting.  Instead of high-res rasterization I use low-res.  Therefore</span>
    <span class="s4"># the fact that the resolution is non-standard is easily checked by</span>
    <span class="s4"># image_comparison.</span>
    <span class="s1">img = np.asarray([[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s1">]])</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">axs = plt.subplots(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s1">figsize=(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">1</span><span class="s1">))</span>

    <span class="s1">axs[</span><span class="s5">0</span><span class="s1">].imshow(img)</span>

    <span class="s1">axs[</span><span class="s5">1</span><span class="s1">].plot([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">linewidth=</span><span class="s5">20.</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">axs[</span><span class="s5">1</span><span class="s1">].set(xlim=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ylim=(-</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>

    <span class="s1">axs[</span><span class="s5">2</span><span class="s1">].plot([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">linewidth=</span><span class="s5">20.</span><span class="s1">)</span>
    <span class="s1">axs[</span><span class="s5">2</span><span class="s1">].set(xlim=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ylim=(-</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>

    <span class="s4"># Low-dpi PDF rasterization errors prevent proper image comparison tests.</span>
    <span class="s4"># Hide detailed structures like the axes spines.</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs:</span>
        <span class="s1">ax.set_xticks([])</span>
        <span class="s1">ax.set_yticks([])</span>
        <span class="s1">ax.spines[:].set_visible(</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s1">rcParams[</span><span class="s2">'savefig.dpi'</span><span class="s1">] = </span><span class="s5">10</span>


<span class="s1">@image_comparison([</span><span class="s2">'bbox_image_inverted'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True, </span><span class="s1">style=</span><span class="s2">'mpl20'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_bbox_image_inverted():</span>
    <span class="s4"># This is just used to produce an image to feed to BboxImage</span>
    <span class="s1">image = np.arange(</span><span class="s5">100</span><span class="s1">).reshape((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">))</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">bbox_im = BboxImage(</span>
        <span class="s1">TransformedBbox(Bbox([[</span><span class="s5">100</span><span class="s0">, </span><span class="s5">100</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">ax.transData)</span><span class="s0">,</span>
        <span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s1">)</span>
    <span class="s1">bbox_im.set_data(image)</span>
    <span class="s1">bbox_im.set_clip_on(</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">ax.set_xlim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">100</span><span class="s1">)</span>
    <span class="s1">ax.set_ylim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">100</span><span class="s1">)</span>
    <span class="s1">ax.add_artist(bbox_im)</span>

    <span class="s1">image = np.identity(</span><span class="s5">10</span><span class="s1">)</span>

    <span class="s1">bbox_im = BboxImage(TransformedBbox(Bbox([[</span><span class="s5">0.1</span><span class="s0">, </span><span class="s5">0.2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0.3</span><span class="s0">, </span><span class="s5">0.25</span><span class="s1">]])</span><span class="s0">,</span>
                                        <span class="s1">ax.figure.transFigure)</span><span class="s0">,</span>
                        <span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s1">)</span>
    <span class="s1">bbox_im.set_data(image)</span>
    <span class="s1">bbox_im.set_clip_on(</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">ax.add_artist(bbox_im)</span>


<span class="s0">def </span><span class="s1">test_get_window_extent_for_AxisImage():</span>
    <span class="s4"># Create a figure of known size (1000x1000 pixels), place an image</span>
    <span class="s4"># object at a given location and check that get_window_extent()</span>
    <span class="s4"># returns the correct bounding box values (in pixels).</span>

    <span class="s1">im = np.array([[</span><span class="s5">0.25</span><span class="s0">, </span><span class="s5">0.75</span><span class="s0">, </span><span class="s5">1.0</span><span class="s0">, </span><span class="s5">0.75</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0.1</span><span class="s0">, </span><span class="s5">0.65</span><span class="s0">, </span><span class="s5">0.5</span><span class="s0">, </span><span class="s5">0.4</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[</span><span class="s5">0.6</span><span class="s0">, </span><span class="s5">0.3</span><span class="s0">, </span><span class="s5">0.0</span><span class="s0">, </span><span class="s5">0.2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0.7</span><span class="s0">, </span><span class="s5">0.9</span><span class="s0">, </span><span class="s5">0.4</span><span class="s0">, </span><span class="s5">0.6</span><span class="s1">]])</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots(figsize=(</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dpi=</span><span class="s5">100</span><span class="s1">)</span>
    <span class="s1">ax.set_position([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">])</span>
    <span class="s1">ax.set_xlim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">ax.set_ylim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">im_obj = ax.imshow(</span>
        <span class="s1">im</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">0.4</span><span class="s0">, </span><span class="s5">0.7</span><span class="s0">, </span><span class="s5">0.2</span><span class="s0">, </span><span class="s5">0.9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s1">)</span>

    <span class="s1">fig.canvas.draw()</span>
    <span class="s1">renderer = fig.canvas.renderer</span>
    <span class="s1">im_bbox = im_obj.get_window_extent(renderer)</span>

    <span class="s1">assert_array_equal(im_bbox.get_points()</span><span class="s0">, </span><span class="s1">[[</span><span class="s5">400</span><span class="s0">, </span><span class="s5">200</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">700</span><span class="s0">, </span><span class="s5">900</span><span class="s1">]])</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots(figsize=(</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dpi=</span><span class="s5">100</span><span class="s1">)</span>
    <span class="s1">ax.set_position([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">])</span>
    <span class="s1">ax.set_xlim(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">ax.set_ylim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">im_obj = ax.imshow(</span>
        <span class="s1">im</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">0.4</span><span class="s0">, </span><span class="s5">0.7</span><span class="s0">, </span><span class="s5">0.2</span><span class="s0">, </span><span class="s5">0.9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s0">,</span>
        <span class="s1">transform=ax.transAxes)</span>

    <span class="s1">fig.canvas.draw()</span>
    <span class="s1">renderer = fig.canvas.renderer</span>
    <span class="s1">im_bbox = im_obj.get_window_extent(renderer)</span>

    <span class="s1">assert_array_equal(im_bbox.get_points()</span><span class="s0">, </span><span class="s1">[[</span><span class="s5">400</span><span class="s0">, </span><span class="s5">200</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">700</span><span class="s0">, </span><span class="s5">900</span><span class="s1">]])</span>


<span class="s1">@image_comparison([</span><span class="s2">'zoom_and_clip_upper_origin.png'</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">remove_text=</span><span class="s0">True, </span><span class="s1">style=</span><span class="s2">'mpl20'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_zoom_and_clip_upper_origin():</span>
    <span class="s1">image = np.arange(</span><span class="s5">100</span><span class="s1">)</span>
    <span class="s1">image = image.reshape((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">))</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow(image)</span>
    <span class="s1">ax.set_ylim(</span><span class="s5">2.0</span><span class="s0">, </span><span class="s1">-</span><span class="s5">0.5</span><span class="s1">)</span>
    <span class="s1">ax.set_xlim(-</span><span class="s5">0.5</span><span class="s0">, </span><span class="s5">2.0</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_nonuniformimage_setcmap():</span>
    <span class="s1">ax = plt.gca()</span>
    <span class="s1">im = NonUniformImage(ax)</span>
    <span class="s1">im.set_cmap(</span><span class="s2">'Blues'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_nonuniformimage_setnorm():</span>
    <span class="s1">ax = plt.gca()</span>
    <span class="s1">im = NonUniformImage(ax)</span>
    <span class="s1">im.set_norm(plt.Normalize())</span>


<span class="s0">def </span><span class="s1">test_jpeg_2d():</span>
    <span class="s4"># smoke test that mode-L pillow images work.</span>
    <span class="s1">imd = np.ones((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">'uint8'</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">10</span><span class="s1">):</span>
        <span class="s1">imd[i</span><span class="s0">, </span><span class="s1">:] = np.linspace(</span><span class="s5">0.0</span><span class="s0">, </span><span class="s5">1.0</span><span class="s0">, </span><span class="s5">10</span><span class="s1">) * </span><span class="s5">255</span>
    <span class="s1">im = Image.new(</span><span class="s2">'L'</span><span class="s0">, </span><span class="s1">(</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">))</span>
    <span class="s1">im.putdata(imd.flatten())</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow(im)</span>


<span class="s0">def </span><span class="s1">test_jpeg_alpha():</span>
    <span class="s1">plt.figure(figsize=(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dpi=</span><span class="s5">300</span><span class="s1">)</span>
    <span class="s4"># Create an image that is all black, with a gradient from 0-1 in</span>
    <span class="s4"># the alpha channel from left to right.</span>
    <span class="s1">im = np.zeros((</span><span class="s5">300</span><span class="s0">, </span><span class="s5">300</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">im[...</span><span class="s0">, </span><span class="s5">3</span><span class="s1">] = np.linspace(</span><span class="s5">0.0</span><span class="s0">, </span><span class="s5">1.0</span><span class="s0">, </span><span class="s5">300</span><span class="s1">)</span>

    <span class="s1">plt.figimage(im)</span>

    <span class="s1">buff = io.BytesIO()</span>
    <span class="s1">plt.savefig(buff</span><span class="s0">, </span><span class="s1">facecolor=</span><span class="s2">&quot;red&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'jpg'</span><span class="s0">, </span><span class="s1">dpi=</span><span class="s5">300</span><span class="s1">)</span>

    <span class="s1">buff.seek(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">image = Image.open(buff)</span>

    <span class="s4"># If this fails, there will be only one color (all black). If this</span>
    <span class="s4"># is working, we should have all 256 shades of grey represented.</span>
    <span class="s1">num_colors = len(image.getcolors(</span><span class="s5">256</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s5">175 </span><span class="s1">&lt;= num_colors &lt;= </span><span class="s5">210</span>
    <span class="s4"># The fully transparent part should be red.</span>
    <span class="s1">corner_pixel = image.getpixel((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">corner_pixel == (</span><span class="s5">254</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_axesimage_setdata():</span>
    <span class="s1">ax = plt.gca()</span>
    <span class="s1">im = AxesImage(ax)</span>
    <span class="s1">z = np.arange(</span><span class="s5">12</span><span class="s0">, </span><span class="s1">dtype=float).reshape((</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s1">))</span>
    <span class="s1">im.set_data(z)</span>
    <span class="s1">z[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">] = </span><span class="s5">9.9</span>
    <span class="s0">assert </span><span class="s1">im._A[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">] == </span><span class="s5">0</span><span class="s0">, </span><span class="s2">'value changed'</span>


<span class="s0">def </span><span class="s1">test_figureimage_setdata():</span>
    <span class="s1">fig = plt.gcf()</span>
    <span class="s1">im = FigureImage(fig)</span>
    <span class="s1">z = np.arange(</span><span class="s5">12</span><span class="s0">, </span><span class="s1">dtype=float).reshape((</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s1">))</span>
    <span class="s1">im.set_data(z)</span>
    <span class="s1">z[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">] = </span><span class="s5">9.9</span>
    <span class="s0">assert </span><span class="s1">im._A[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">] == </span><span class="s5">0</span><span class="s0">, </span><span class="s2">'value changed'</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;image_cls,x,y,a&quot;</span><span class="s0">, </span><span class="s1">[</span>
        <span class="s1">(NonUniformImage</span><span class="s0">,</span>
         <span class="s1">np.arange(</span><span class="s5">3.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s5">12.</span><span class="s1">).reshape((</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(PcolorImage</span><span class="s0">,</span>
         <span class="s1">np.arange(</span><span class="s5">3.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s5">6.</span><span class="s1">).reshape((</span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)))</span><span class="s0">,</span>
    <span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_setdata_xya(image_cls</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">a):</span>
    <span class="s1">ax = plt.gca()</span>
    <span class="s1">im = image_cls(ax)</span>
    <span class="s1">im.set_data(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">a)</span>
    <span class="s1">x[</span><span class="s5">0</span><span class="s1">] = y[</span><span class="s5">0</span><span class="s1">] = a[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">] = </span><span class="s5">9.9</span>
    <span class="s0">assert </span><span class="s1">im._A[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">] == im._Ax[</span><span class="s5">0</span><span class="s1">] == im._Ay[</span><span class="s5">0</span><span class="s1">] == </span><span class="s5">0</span><span class="s0">, </span><span class="s2">'value changed'</span>
    <span class="s1">im.set_data(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">a.reshape((*a.shape</span><span class="s0">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">)))  </span><span class="s4"># Just a smoketest.</span>


<span class="s0">def </span><span class="s1">test_minimized_rasterized():</span>
    <span class="s4"># This ensures that the rasterized content in the colorbars is</span>
    <span class="s4"># only as thick as the colorbar, and doesn't extend to other parts</span>
    <span class="s4"># of the image.  See #5814.  While the original bug exists only</span>
    <span class="s4"># in Postscript, the best way to detect it is to generate SVG</span>
    <span class="s4"># and then parse the output to make sure the two colorbar images</span>
    <span class="s4"># are the same size.</span>
    <span class="s0">from </span><span class="s1">xml.etree </span><span class="s0">import </span><span class="s1">ElementTree</span>

    <span class="s1">np.random.seed(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">data = np.random.rand(</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">p1 = ax[</span><span class="s5">0</span><span class="s1">].pcolormesh(data)</span>
    <span class="s1">p2 = ax[</span><span class="s5">1</span><span class="s1">].pcolormesh(data)</span>

    <span class="s1">plt.colorbar(p1</span><span class="s0">, </span><span class="s1">ax=ax[</span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">plt.colorbar(p2</span><span class="s0">, </span><span class="s1">ax=ax[</span><span class="s5">1</span><span class="s1">])</span>

    <span class="s1">buff = io.BytesIO()</span>
    <span class="s1">plt.savefig(buff</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'svg'</span><span class="s1">)</span>

    <span class="s1">buff = io.BytesIO(buff.getvalue())</span>
    <span class="s1">tree = ElementTree.parse(buff)</span>
    <span class="s1">width = </span><span class="s0">None</span>
    <span class="s0">for </span><span class="s1">image </span><span class="s0">in </span><span class="s1">tree.iter(</span><span class="s2">'image'</span><span class="s1">):</span>
        <span class="s0">if </span><span class="s1">width </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">width = image[</span><span class="s2">'width'</span><span class="s1">]</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">if </span><span class="s1">image[</span><span class="s2">'width'</span><span class="s1">] != width:</span>
                <span class="s0">assert False</span>


<span class="s0">def </span><span class="s1">test_load_from_url():</span>
    <span class="s1">path = Path(__file__).parent / </span><span class="s2">&quot;baseline_images/pngsuite/basn3p04.png&quot;</span>
    <span class="s1">url = (</span><span class="s2">'file:'</span>
           <span class="s1">+ (</span><span class="s2">'///' </span><span class="s0">if </span><span class="s1">sys.platform == </span><span class="s2">'win32' </span><span class="s0">else </span><span class="s2">''</span><span class="s1">)</span>
           <span class="s1">+ path.resolve().as_posix())</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Please open the URL&quot;</span><span class="s1">):</span>
        <span class="s1">plt.imread(url)</span>
    <span class="s0">with </span><span class="s1">urllib.request.urlopen(url) </span><span class="s0">as </span><span class="s1">file:</span>
        <span class="s1">plt.imread(file)</span>


<span class="s1">@image_comparison([</span><span class="s2">'log_scale_image'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_log_scale_image():</span>
    <span class="s1">Z = np.zeros((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">))</span>
    <span class="s1">Z[::</span><span class="s5">2</span><span class="s1">] = </span><span class="s5">1</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow(Z</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">100</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">100</span><span class="s1">]</span><span class="s0">, </span><span class="s1">cmap=</span><span class="s2">'viridis'</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">1</span><span class="s0">, </span><span class="s1">vmin=-</span><span class="s5">1</span><span class="s0">,</span>
              <span class="s1">aspect=</span><span class="s2">'auto'</span><span class="s1">)</span>
    <span class="s1">ax.set(yscale=</span><span class="s2">'log'</span><span class="s1">)</span>


<span class="s4"># Increased tolerance is needed for PDF test to avoid failure. After the PDF</span>
<span class="s4"># backend was modified to use indexed color, there are ten pixels that differ</span>
<span class="s4"># due to how the subpixel calculation is done when converting the PDF files to</span>
<span class="s4"># PNG images.</span>
<span class="s1">@image_comparison([</span><span class="s2">'rotate_image'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True, </span><span class="s1">tol=</span><span class="s5">0.35</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rotate_image():</span>
    <span class="s1">delta = </span><span class="s5">0.25</span>
    <span class="s1">x = y = np.arange(-</span><span class="s5">3.0</span><span class="s0">, </span><span class="s5">3.0</span><span class="s0">, </span><span class="s1">delta)</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">Y = np.meshgrid(x</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">Z1 = np.exp(-(X**</span><span class="s5">2 </span><span class="s1">+ Y**</span><span class="s5">2</span><span class="s1">) / </span><span class="s5">2</span><span class="s1">) / (</span><span class="s5">2 </span><span class="s1">* np.pi)</span>
    <span class="s1">Z2 = (np.exp(-(((X - </span><span class="s5">1</span><span class="s1">) / </span><span class="s5">1.5</span><span class="s1">)**</span><span class="s5">2 </span><span class="s1">+ ((Y - </span><span class="s5">1</span><span class="s1">) / </span><span class="s5">0.5</span><span class="s1">)**</span><span class="s5">2</span><span class="s1">) / </span><span class="s5">2</span><span class="s1">) /</span>
          <span class="s1">(</span><span class="s5">2 </span><span class="s1">* np.pi * </span><span class="s5">0.5 </span><span class="s1">* </span><span class="s5">1.5</span><span class="s1">))</span>
    <span class="s1">Z = Z2 - Z1  </span><span class="s4"># difference of Gaussians</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax1 = plt.subplots(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">im1 = ax1.imshow(Z</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'none'</span><span class="s0">, </span><span class="s1">cmap=</span><span class="s2">'viridis'</span><span class="s0">,</span>
                     <span class="s1">origin=</span><span class="s2">'lower'</span><span class="s0">,</span>
                     <span class="s1">extent=[-</span><span class="s5">2</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s1">-</span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">clip_on=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">trans_data2 = Affine2D().rotate_deg(</span><span class="s5">30</span><span class="s1">) + ax1.transData</span>
    <span class="s1">im1.set_transform(trans_data2)</span>

    <span class="s4"># display intended extent of the image</span>
    <span class="s1">x1</span><span class="s0">, </span><span class="s1">x2</span><span class="s0">, </span><span class="s1">y1</span><span class="s0">, </span><span class="s1">y2 = im1.get_extent()</span>

    <span class="s1">ax1.plot([x1</span><span class="s0">, </span><span class="s1">x2</span><span class="s0">, </span><span class="s1">x2</span><span class="s0">, </span><span class="s1">x1</span><span class="s0">, </span><span class="s1">x1]</span><span class="s0">, </span><span class="s1">[y1</span><span class="s0">, </span><span class="s1">y1</span><span class="s0">, </span><span class="s1">y2</span><span class="s0">, </span><span class="s1">y2</span><span class="s0">, </span><span class="s1">y1]</span><span class="s0">, </span><span class="s2">&quot;r--&quot;</span><span class="s0">, </span><span class="s1">lw=</span><span class="s5">3</span><span class="s0">,</span>
             <span class="s1">transform=trans_data2)</span>

    <span class="s1">ax1.set_xlim(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>
    <span class="s1">ax1.set_ylim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_image_preserve_size():</span>
    <span class="s1">buff = io.BytesIO()</span>

    <span class="s1">im = np.zeros((</span><span class="s5">481</span><span class="s0">, </span><span class="s5">321</span><span class="s1">))</span>
    <span class="s1">plt.imsave(buff</span><span class="s0">, </span><span class="s1">im</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;png&quot;</span><span class="s1">)</span>

    <span class="s1">buff.seek(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">img = plt.imread(buff)</span>

    <span class="s0">assert </span><span class="s1">img.shape[:</span><span class="s5">2</span><span class="s1">] == im.shape</span>


<span class="s0">def </span><span class="s1">test_image_preserve_size2():</span>
    <span class="s1">n = </span><span class="s5">7</span>
    <span class="s1">data = np.identity(n</span><span class="s0">, </span><span class="s1">float)</span>

    <span class="s1">fig = plt.figure(figsize=(n</span><span class="s0">, </span><span class="s1">n)</span><span class="s0">, </span><span class="s1">frameon=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s1">ax = plt.Axes(fig</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0.0</span><span class="s0">, </span><span class="s5">0.0</span><span class="s0">, </span><span class="s5">1.0</span><span class="s0">, </span><span class="s5">1.0</span><span class="s1">])</span>
    <span class="s1">ax.set_axis_off()</span>
    <span class="s1">fig.add_axes(ax)</span>
    <span class="s1">ax.imshow(data</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s0">, </span><span class="s1">origin=</span><span class="s2">'lower'</span><span class="s0">, </span><span class="s1">aspect=</span><span class="s2">'auto'</span><span class="s1">)</span>
    <span class="s1">buff = io.BytesIO()</span>
    <span class="s1">fig.savefig(buff</span><span class="s0">, </span><span class="s1">dpi=</span><span class="s5">1</span><span class="s1">)</span>

    <span class="s1">buff.seek(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">img = plt.imread(buff)</span>

    <span class="s0">assert </span><span class="s1">img.shape == (</span><span class="s5">7</span><span class="s0">, </span><span class="s5">7</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>

    <span class="s1">assert_array_equal(np.asarray(img[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">bool)</span><span class="s0">,</span>
                       <span class="s1">np.identity(n</span><span class="s0">, </span><span class="s1">bool)[::-</span><span class="s5">1</span><span class="s1">])</span>


<span class="s1">@image_comparison([</span><span class="s2">'mask_image_over_under.png'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True, </span><span class="s1">tol=</span><span class="s5">1.0</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_mask_image_over_under():</span>
    <span class="s4"># Remove this line when this test image is regenerated.</span>
    <span class="s1">plt.rcParams[</span><span class="s2">'pcolormesh.snap'</span><span class="s1">] = </span><span class="s0">False</span>

    <span class="s1">delta = </span><span class="s5">0.025</span>
    <span class="s1">x = y = np.arange(-</span><span class="s5">3.0</span><span class="s0">, </span><span class="s5">3.0</span><span class="s0">, </span><span class="s1">delta)</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">Y = np.meshgrid(x</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">Z1 = np.exp(-(X**</span><span class="s5">2 </span><span class="s1">+ Y**</span><span class="s5">2</span><span class="s1">) / </span><span class="s5">2</span><span class="s1">) / (</span><span class="s5">2 </span><span class="s1">* np.pi)</span>
    <span class="s1">Z2 = (np.exp(-(((X - </span><span class="s5">1</span><span class="s1">) / </span><span class="s5">1.5</span><span class="s1">)**</span><span class="s5">2 </span><span class="s1">+ ((Y - </span><span class="s5">1</span><span class="s1">) / </span><span class="s5">0.5</span><span class="s1">)**</span><span class="s5">2</span><span class="s1">) / </span><span class="s5">2</span><span class="s1">) /</span>
          <span class="s1">(</span><span class="s5">2 </span><span class="s1">* np.pi * </span><span class="s5">0.5 </span><span class="s1">* </span><span class="s5">1.5</span><span class="s1">))</span>
    <span class="s1">Z = </span><span class="s5">10</span><span class="s1">*(Z2 - Z1)  </span><span class="s4"># difference of Gaussians</span>

    <span class="s1">palette = plt.cm.gray.with_extremes(over=</span><span class="s2">'r'</span><span class="s0">, </span><span class="s1">under=</span><span class="s2">'g'</span><span class="s0">, </span><span class="s1">bad=</span><span class="s2">'b'</span><span class="s1">)</span>
    <span class="s1">Zm = np.ma.masked_where(Z &gt; </span><span class="s5">1.2</span><span class="s0">, </span><span class="s1">Z)</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">(ax1</span><span class="s0">, </span><span class="s1">ax2) = plt.subplots(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">im = ax1.imshow(Zm</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'bilinear'</span><span class="s0">,</span>
                    <span class="s1">cmap=palette</span><span class="s0">,</span>
                    <span class="s1">norm=colors.Normalize(vmin=-</span><span class="s5">1.0</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">1.0</span><span class="s0">, </span><span class="s1">clip=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">origin=</span><span class="s2">'lower'</span><span class="s0">, </span><span class="s1">extent=[-</span><span class="s5">3</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s1">-</span><span class="s5">3</span><span class="s0">, </span><span class="s5">3</span><span class="s1">])</span>
    <span class="s1">ax1.set_title(</span><span class="s2">'Green=low, Red=high, Blue=bad'</span><span class="s1">)</span>
    <span class="s1">fig.colorbar(im</span><span class="s0">, </span><span class="s1">extend=</span><span class="s2">'both'</span><span class="s0">, </span><span class="s1">orientation=</span><span class="s2">'horizontal'</span><span class="s0">,</span>
                 <span class="s1">ax=ax1</span><span class="s0">, </span><span class="s1">aspect=</span><span class="s5">10</span><span class="s1">)</span>

    <span class="s1">im = ax2.imshow(Zm</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s0">,</span>
                    <span class="s1">cmap=palette</span><span class="s0">,</span>
                    <span class="s1">norm=colors.BoundaryNorm([-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">-</span><span class="s5">0.5</span><span class="s0">, </span><span class="s1">-</span><span class="s5">0.2</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0.2</span><span class="s0">, </span><span class="s5">0.5</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">,</span>
                                             <span class="s1">ncolors=</span><span class="s5">256</span><span class="s0">, </span><span class="s1">clip=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">origin=</span><span class="s2">'lower'</span><span class="s0">, </span><span class="s1">extent=[-</span><span class="s5">3</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s1">-</span><span class="s5">3</span><span class="s0">, </span><span class="s5">3</span><span class="s1">])</span>
    <span class="s1">ax2.set_title(</span><span class="s2">'With BoundaryNorm'</span><span class="s1">)</span>
    <span class="s1">fig.colorbar(im</span><span class="s0">, </span><span class="s1">extend=</span><span class="s2">'both'</span><span class="s0">, </span><span class="s1">spacing=</span><span class="s2">'proportional'</span><span class="s0">,</span>
                 <span class="s1">orientation=</span><span class="s2">'horizontal'</span><span class="s0">, </span><span class="s1">ax=ax2</span><span class="s0">, </span><span class="s1">aspect=</span><span class="s5">10</span><span class="s1">)</span>


<span class="s1">@image_comparison([</span><span class="s2">'mask_image'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_mask_image():</span>
    <span class="s4"># Test mask image two ways: Using nans and using a masked array.</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">(ax1</span><span class="s0">, </span><span class="s1">ax2) = plt.subplots(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s1">A = np.ones((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>
    <span class="s1">A[</span><span class="s5">1</span><span class="s1">:</span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s1">:</span><span class="s5">2</span><span class="s1">] = np.nan</span>

    <span class="s1">ax1.imshow(A</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s1">)</span>

    <span class="s1">A = np.zeros((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=bool)</span>
    <span class="s1">A[</span><span class="s5">1</span><span class="s1">:</span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s1">:</span><span class="s5">2</span><span class="s1">] = </span><span class="s0">True</span>
    <span class="s1">A = np.ma.masked_array(np.ones((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.uint16)</span><span class="s0">, </span><span class="s1">A)</span>

    <span class="s1">ax2.imshow(A</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_mask_image_all():</span>
    <span class="s4"># Test behavior with an image that is entirely masked does not warn</span>
    <span class="s1">data = np.full((</span><span class="s5">2</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nan)</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow(data)</span>
    <span class="s1">fig.canvas.draw_idle()  </span><span class="s4"># would emit a warning</span>


<span class="s1">@image_comparison([</span><span class="s2">'imshow_endianess.png'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_imshow_endianess():</span>
    <span class="s1">x = np.arange(</span><span class="s5">10</span><span class="s1">)</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">Y = np.meshgrid(x</span><span class="s0">, </span><span class="s1">x)</span>
    <span class="s1">Z = np.hypot(X - </span><span class="s5">5</span><span class="s0">, </span><span class="s1">Y - </span><span class="s5">5</span><span class="s1">)</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">(ax1</span><span class="s0">, </span><span class="s1">ax2) = plt.subplots(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s1">kwargs = dict(origin=</span><span class="s2">&quot;lower&quot;</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s0">, </span><span class="s1">cmap=</span><span class="s2">'viridis'</span><span class="s1">)</span>

    <span class="s1">ax1.imshow(Z.astype(</span><span class="s2">'&lt;f8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">**kwargs)</span>
    <span class="s1">ax2.imshow(Z.astype(</span><span class="s2">'&gt;f8'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">**kwargs)</span>


<span class="s1">@image_comparison([</span><span class="s2">'imshow_masked_interpolation'</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">tol=</span><span class="s5">0 </span><span class="s0">if </span><span class="s1">platform.machine() == </span><span class="s2">'x86_64' </span><span class="s0">else </span><span class="s5">0.01</span><span class="s0">,</span>
                  <span class="s1">remove_text=</span><span class="s0">True, </span><span class="s1">style=</span><span class="s2">'mpl20'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_imshow_masked_interpolation():</span>

    <span class="s1">cmap = mpl.colormaps[</span><span class="s2">'viridis'</span><span class="s1">].with_extremes(over=</span><span class="s2">'r'</span><span class="s0">, </span><span class="s1">under=</span><span class="s2">'b'</span><span class="s0">, </span><span class="s1">bad=</span><span class="s2">'k'</span><span class="s1">)</span>

    <span class="s1">N = </span><span class="s5">20</span>
    <span class="s1">n = colors.Normalize(vmin=</span><span class="s5">0</span><span class="s0">, </span><span class="s1">vmax=N*N-</span><span class="s5">1</span><span class="s1">)</span>

    <span class="s1">data = np.arange(N*N</span><span class="s0">, </span><span class="s1">dtype=float).reshape(N</span><span class="s0">, </span><span class="s1">N)</span>

    <span class="s1">data[</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s1">] = -</span><span class="s5">1</span>
    <span class="s4"># This will cause crazy ringing for the higher-order</span>
    <span class="s4"># interpolations</span>
    <span class="s1">data[</span><span class="s5">15</span><span class="s0">, </span><span class="s5">5</span><span class="s1">] = </span><span class="s5">1e5</span>

    <span class="s4"># data[3, 3] = np.nan</span>

    <span class="s1">data[</span><span class="s5">15</span><span class="s0">, </span><span class="s5">15</span><span class="s1">] = np.inf</span>

    <span class="s1">mask = np.zeros_like(data).astype(</span><span class="s2">'bool'</span><span class="s1">)</span>
    <span class="s1">mask[</span><span class="s5">5</span><span class="s0">, </span><span class="s5">15</span><span class="s1">] = </span><span class="s0">True</span>

    <span class="s1">data = np.ma.masked_array(data</span><span class="s0">, </span><span class="s1">mask)</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax_grid = plt.subplots(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">6</span><span class="s1">)</span>
    <span class="s1">interps = sorted(mimage._interpd_)</span>
    <span class="s1">interps.remove(</span><span class="s2">'antialiased'</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">interp</span><span class="s0">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">zip(interps</span><span class="s0">, </span><span class="s1">ax_grid.ravel()):</span>
        <span class="s1">ax.set_title(interp)</span>
        <span class="s1">ax.imshow(data</span><span class="s0">, </span><span class="s1">norm=n</span><span class="s0">, </span><span class="s1">cmap=cmap</span><span class="s0">, </span><span class="s1">interpolation=interp)</span>
        <span class="s1">ax.axis(</span><span class="s2">'off'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_imshow_no_warn_invalid():</span>
    <span class="s1">plt.imshow([[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">3</span><span class="s0">, </span><span class="s1">np.nan]])  </span><span class="s4"># Check that no warning is emitted.</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">'dtype'</span><span class="s0">, </span><span class="s1">[np.dtype(s) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s2">'u2 u4 i2 i4 i8 f4 f8'</span><span class="s1">.split()])</span>
<span class="s0">def </span><span class="s1">test_imshow_clips_rgb_to_valid_range(dtype):</span>
    <span class="s1">arr = np.arange(</span><span class="s5">300</span><span class="s0">, </span><span class="s1">dtype=dtype).reshape((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s5">3</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">dtype.kind != </span><span class="s2">'u'</span><span class="s1">:</span>
        <span class="s1">arr -= </span><span class="s5">10</span>
    <span class="s1">too_low = arr &lt; </span><span class="s5">0</span>
    <span class="s1">too_high = arr &gt; </span><span class="s5">255</span>
    <span class="s0">if </span><span class="s1">dtype.kind == </span><span class="s2">'f'</span><span class="s1">:</span>
        <span class="s1">arr = arr / </span><span class="s5">255</span>
    <span class="s1">_</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">out = ax.imshow(arr).get_array()</span>
    <span class="s0">assert </span><span class="s1">(out[too_low] == </span><span class="s5">0</span><span class="s1">).all()</span>
    <span class="s0">if </span><span class="s1">dtype.kind == </span><span class="s2">'f'</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">(out[too_high] == </span><span class="s5">1</span><span class="s1">).all()</span>
        <span class="s0">assert </span><span class="s1">out.dtype.kind == </span><span class="s2">'f'</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">(out[too_high] == </span><span class="s5">255</span><span class="s1">).all()</span>
        <span class="s0">assert </span><span class="s1">out.dtype == np.uint8</span>


<span class="s1">@image_comparison([</span><span class="s2">'imshow_flatfield.png'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True, </span><span class="s1">style=</span><span class="s2">'mpl20'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_imshow_flatfield():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">im = ax.imshow(np.ones((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s1">)</span>
    <span class="s1">im.set_clim(</span><span class="s5">.5</span><span class="s0">, </span><span class="s5">1.5</span><span class="s1">)</span>


<span class="s1">@image_comparison([</span><span class="s2">'imshow_bignumbers.png'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True, </span><span class="s1">style=</span><span class="s2">'mpl20'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_imshow_bignumbers():</span>
    <span class="s1">rcParams[</span><span class="s2">'image.interpolation'</span><span class="s1">] = </span><span class="s2">'nearest'</span>
    <span class="s4"># putting a big number in an array of integers shouldn't</span>
    <span class="s4"># ruin the dynamic range of the resolved bits.</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">img = np.array([[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">1e12</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">3</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=np.uint64)</span>
    <span class="s1">pc = ax.imshow(img)</span>
    <span class="s1">pc.set_clim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>


<span class="s1">@image_comparison([</span><span class="s2">'imshow_bignumbers_real.png'</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">remove_text=</span><span class="s0">True, </span><span class="s1">style=</span><span class="s2">'mpl20'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_imshow_bignumbers_real():</span>
    <span class="s1">rcParams[</span><span class="s2">'image.interpolation'</span><span class="s1">] = </span><span class="s2">'nearest'</span>
    <span class="s4"># putting a big number in an array of integers shouldn't</span>
    <span class="s4"># ruin the dynamic range of the resolved bits.</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">img = np.array([[</span><span class="s5">2.</span><span class="s0">, </span><span class="s5">1.</span><span class="s0">, </span><span class="s5">1.e22</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">4.</span><span class="s0">, </span><span class="s5">1.</span><span class="s0">, </span><span class="s5">3.</span><span class="s1">]])</span>
    <span class="s1">pc = ax.imshow(img)</span>
    <span class="s1">pc.set_clim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;make_norm&quot;</span><span class="s0">,</span>
    <span class="s1">[colors.Normalize</span><span class="s0">,</span>
     <span class="s1">colors.LogNorm</span><span class="s0">,</span>
     <span class="s0">lambda</span><span class="s1">: colors.SymLogNorm(</span><span class="s5">1</span><span class="s1">)</span><span class="s0">,</span>
     <span class="s0">lambda</span><span class="s1">: colors.PowerNorm(</span><span class="s5">1</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_empty_imshow(make_norm):</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">,</span>
                      <span class="s1">match=</span><span class="s2">&quot;Attempting to set identical low and high xlims&quot;</span><span class="s1">):</span>
        <span class="s1">im = ax.imshow([[]]</span><span class="s0">, </span><span class="s1">norm=make_norm())</span>
    <span class="s1">im.set_extent([-</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s1">-</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s1">])</span>
    <span class="s1">fig.canvas.draw()</span>

    <span class="s0">with </span><span class="s1">pytest.raises(RuntimeError):</span>
        <span class="s1">im.make_image(fig.canvas.get_renderer())</span>


<span class="s0">def </span><span class="s1">test_imshow_float16():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow(np.zeros((</span><span class="s5">3</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.float16))</span>
    <span class="s4"># Ensure that drawing doesn't cause crash.</span>
    <span class="s1">fig.canvas.draw()</span>


<span class="s0">def </span><span class="s1">test_imshow_float128():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow(np.zeros((</span><span class="s5">3</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.longdouble))</span>
    <span class="s0">with </span><span class="s1">(ExitStack() </span><span class="s0">if </span><span class="s1">np.can_cast(np.longdouble</span><span class="s0">, </span><span class="s1">np.float64</span><span class="s0">, </span><span class="s2">&quot;equiv&quot;</span><span class="s1">)</span>
          <span class="s0">else </span><span class="s1">pytest.warns(UserWarning)):</span>
        <span class="s4"># Ensure that drawing doesn't cause crash.</span>
        <span class="s1">fig.canvas.draw()</span>


<span class="s0">def </span><span class="s1">test_imshow_bool():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow(np.array([[</span><span class="s0">True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=bool))</span>


<span class="s0">def </span><span class="s1">test_full_invalid():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow(np.full((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nan))</span>

    <span class="s1">fig.canvas.draw()</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;fmt,counted&quot;</span><span class="s0">,</span>
                         <span class="s1">[(</span><span class="s2">&quot;ps&quot;</span><span class="s0">, </span><span class="s6">b&quot; colorimage&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;svg&quot;</span><span class="s0">, </span><span class="s6">b&quot;&lt;image&quot;</span><span class="s1">)])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;composite_image,count&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s0">True, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">False, </span><span class="s5">2</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_composite(fmt</span><span class="s0">, </span><span class="s1">counted</span><span class="s0">, </span><span class="s1">composite_image</span><span class="s0">, </span><span class="s1">count):</span>
    <span class="s4"># Test that figures can be saved with and without combining multiple images</span>
    <span class="s4"># (on a single set of axes) into a single composite image.</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">Y = np.meshgrid(np.arange(-</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(-</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">1</span><span class="s1">))</span>
    <span class="s1">Z = np.sin(Y ** </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.set_xlim(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>
    <span class="s1">ax.imshow(Z</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">])</span>
    <span class="s1">ax.imshow(Z[::-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">])</span>
    <span class="s1">plt.rcParams[</span><span class="s2">'image.composite_image'</span><span class="s1">] = composite_image</span>
    <span class="s1">buf = io.BytesIO()</span>
    <span class="s1">fig.savefig(buf</span><span class="s0">, </span><span class="s1">format=fmt)</span>
    <span class="s0">assert </span><span class="s1">buf.getvalue().count(counted) == count</span>


<span class="s0">def </span><span class="s1">test_relim():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow([[</span><span class="s5">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">extent=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">))</span>
    <span class="s1">ax.relim()</span>
    <span class="s1">ax.autoscale()</span>
    <span class="s0">assert </span><span class="s1">ax.get_xlim() == ax.get_ylim() == (</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_unclipped():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.set_axis_off()</span>
    <span class="s1">im = ax.imshow([[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">aspect=</span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">extent=(-</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s1">-</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">,</span>
                   <span class="s1">cmap=</span><span class="s2">'gray'</span><span class="s0">, </span><span class="s1">clip_on=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">ax.set(xlim=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ylim=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">))</span>
    <span class="s1">fig.canvas.draw()</span>
    <span class="s4"># The unclipped image should fill the *entire* figure and be black.</span>
    <span class="s4"># Ignore alpha for this comparison.</span>
    <span class="s0">assert </span><span class="s1">(np.array(fig.canvas.buffer_rgba())[...</span><span class="s0">, </span><span class="s1">:</span><span class="s5">3</span><span class="s1">] == </span><span class="s5">0</span><span class="s1">).all()</span>


<span class="s0">def </span><span class="s1">test_respects_bbox():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">axs = plt.subplots(</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs:</span>
        <span class="s1">ax.set_axis_off()</span>
    <span class="s1">im = axs[</span><span class="s5">1</span><span class="s1">].imshow([[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">aspect=</span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">extent=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">))</span>
    <span class="s1">im.set_clip_path(</span><span class="s0">None</span><span class="s1">)</span>
    <span class="s4"># Make the image invisible in axs[1], but visible in axs[0] if we pan</span>
    <span class="s4"># axs[1] up.</span>
    <span class="s1">im.set_clip_box(axs[</span><span class="s5">0</span><span class="s1">].bbox)</span>
    <span class="s1">buf_before = io.BytesIO()</span>
    <span class="s1">fig.savefig(buf_before</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;rgba&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">{*buf_before.getvalue()} == {</span><span class="s5">0xff</span><span class="s1">}  </span><span class="s4"># All white.</span>
    <span class="s1">axs[</span><span class="s5">1</span><span class="s1">].set(ylim=(-</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
    <span class="s1">buf_after = io.BytesIO()</span>
    <span class="s1">fig.savefig(buf_after</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;rgba&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">buf_before.getvalue() != buf_after.getvalue()  </span><span class="s4"># Not all white.</span>


<span class="s0">def </span><span class="s1">test_image_cursor_formatting():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s4"># Create a dummy image to be able to call format_cursor_data</span>
    <span class="s1">im = ax.imshow(np.zeros((</span><span class="s5">4</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)))</span>

    <span class="s1">data = np.ma.masked_array([</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">mask=[</span><span class="s0">True</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">im.format_cursor_data(data) == </span><span class="s2">'[]'</span>

    <span class="s1">data = np.ma.masked_array([</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">mask=[</span><span class="s0">False</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">im.format_cursor_data(data) == </span><span class="s2">'[0]'</span>

    <span class="s1">data = np.nan</span>
    <span class="s0">assert </span><span class="s1">im.format_cursor_data(data) == </span><span class="s2">'[nan]'</span>


<span class="s1">@check_figures_equal()</span>
<span class="s0">def </span><span class="s1">test_image_array_alpha(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s3">&quot;&quot;&quot;Per-pixel alpha channel test.&quot;&quot;&quot;</span>
    <span class="s1">x = np.linspace(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">xx</span><span class="s0">, </span><span class="s1">yy = np.meshgrid(x</span><span class="s0">, </span><span class="s1">x)</span>

    <span class="s1">zz = np.exp(- </span><span class="s5">3 </span><span class="s1">* ((xx - </span><span class="s5">0.5</span><span class="s1">) ** </span><span class="s5">2</span><span class="s1">) + (yy - </span><span class="s5">0.7 </span><span class="s1">** </span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">alpha = zz / zz.max()</span>

    <span class="s1">cmap = mpl.colormaps[</span><span class="s2">'viridis'</span><span class="s1">]</span>
    <span class="s1">ax = fig_test.add_subplot()</span>
    <span class="s1">ax.imshow(zz</span><span class="s0">, </span><span class="s1">alpha=alpha</span><span class="s0">, </span><span class="s1">cmap=cmap</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s1">)</span>

    <span class="s1">ax = fig_ref.add_subplot()</span>
    <span class="s1">rgba = cmap(colors.Normalize()(zz))</span>
    <span class="s1">rgba[...</span><span class="s0">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">] = alpha</span>
    <span class="s1">ax.imshow(rgba</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_image_array_alpha_validation():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;alpha must be a float, two-d&quot;</span><span class="s1">):</span>
        <span class="s1">plt.imshow(np.zeros((</span><span class="s5">2</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">alpha=[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">])</span>


<span class="s1">@mpl.style.context(</span><span class="s2">'mpl20'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_exact_vmin():</span>
    <span class="s1">cmap = copy(mpl.colormaps[</span><span class="s2">&quot;autumn_r&quot;</span><span class="s1">])</span>
    <span class="s1">cmap.set_under(color=</span><span class="s2">&quot;lightgrey&quot;</span><span class="s1">)</span>

    <span class="s4"># make the image exactly 190 pixels wide</span>
    <span class="s1">fig = plt.figure(figsize=(</span><span class="s5">1.9</span><span class="s0">, </span><span class="s5">0.1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dpi=</span><span class="s5">100</span><span class="s1">)</span>
    <span class="s1">ax = fig.add_axes([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">])</span>

    <span class="s1">data = np.array(</span>
        <span class="s1">[[-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">-</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">43</span><span class="s0">, </span><span class="s5">79</span><span class="s0">, </span><span class="s5">95</span><span class="s0">, </span><span class="s5">66</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s1">-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">-</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">34</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">dtype=float</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">im = ax.imshow(data</span><span class="s0">, </span><span class="s1">aspect=</span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">cmap=cmap</span><span class="s0">, </span><span class="s1">vmin=</span><span class="s5">0</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">100</span><span class="s1">)</span>
    <span class="s1">ax.axis(</span><span class="s2">&quot;off&quot;</span><span class="s1">)</span>
    <span class="s1">fig.canvas.draw()</span>

    <span class="s4"># get the RGBA slice from the image</span>
    <span class="s1">from_image = im.make_image(fig.canvas.renderer)[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s4"># expand the input to be 190 long and run through norm / cmap</span>
    <span class="s1">direct_computation = (</span>
        <span class="s1">im.cmap(im.norm((data * ([[</span><span class="s5">1</span><span class="s1">]] * </span><span class="s5">10</span><span class="s1">)).T.ravel())) * </span><span class="s5">255</span>
    <span class="s1">).astype(int)</span>

    <span class="s4"># check than the RBGA values are the same</span>
    <span class="s0">assert </span><span class="s1">np.all(from_image == direct_computation)</span>


<span class="s4"># A basic ndarray subclass that implements a quantity</span>
<span class="s4"># It does not implement an entire unit system or all quantity math.</span>
<span class="s4"># There is just enough implemented to test handling of ndarray</span>
<span class="s4"># subclasses.</span>
<span class="s0">class </span><span class="s1">QuantityND(np.ndarray):</span>
    <span class="s0">def </span><span class="s1">__new__(cls</span><span class="s0">, </span><span class="s1">input_array</span><span class="s0">, </span><span class="s1">units):</span>
        <span class="s1">obj = np.asarray(input_array).view(cls)</span>
        <span class="s1">obj.units = units</span>
        <span class="s0">return </span><span class="s1">obj</span>

    <span class="s0">def </span><span class="s1">__array_finalize__(self</span><span class="s0">, </span><span class="s1">obj):</span>
        <span class="s1">self.units = getattr(obj</span><span class="s0">, </span><span class="s2">&quot;units&quot;</span><span class="s0">, None</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">__getitem__(self</span><span class="s0">, </span><span class="s1">item):</span>
        <span class="s1">units = getattr(self</span><span class="s0">, </span><span class="s2">&quot;units&quot;</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s1">ret = super(QuantityND</span><span class="s0">, </span><span class="s1">self).__getitem__(item)</span>
        <span class="s0">if </span><span class="s1">isinstance(ret</span><span class="s0">, </span><span class="s1">QuantityND) </span><span class="s0">or </span><span class="s1">units </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">ret = QuantityND(ret</span><span class="s0">, </span><span class="s1">units)</span>
        <span class="s0">return </span><span class="s1">ret</span>

    <span class="s0">def </span><span class="s1">__array_ufunc__(self</span><span class="s0">, </span><span class="s1">ufunc</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">*inputs</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s1">func = getattr(ufunc</span><span class="s0">, </span><span class="s1">method)</span>
        <span class="s0">if </span><span class="s2">&quot;out&quot; </span><span class="s0">in </span><span class="s1">kwargs:</span>
            <span class="s0">return </span><span class="s1">NotImplemented</span>
        <span class="s0">if </span><span class="s1">len(inputs) == </span><span class="s5">1</span><span class="s1">:</span>
            <span class="s1">i0 = inputs[</span><span class="s5">0</span><span class="s1">]</span>
            <span class="s1">unit = getattr(i0</span><span class="s0">, </span><span class="s2">&quot;units&quot;</span><span class="s0">, </span><span class="s2">&quot;dimensionless&quot;</span><span class="s1">)</span>
            <span class="s1">out_arr = func(np.asarray(i0)</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s0">elif </span><span class="s1">len(inputs) == </span><span class="s5">2</span><span class="s1">:</span>
            <span class="s1">i0 = inputs[</span><span class="s5">0</span><span class="s1">]</span>
            <span class="s1">i1 = inputs[</span><span class="s5">1</span><span class="s1">]</span>
            <span class="s1">u0 = getattr(i0</span><span class="s0">, </span><span class="s2">&quot;units&quot;</span><span class="s0">, </span><span class="s2">&quot;dimensionless&quot;</span><span class="s1">)</span>
            <span class="s1">u1 = getattr(i1</span><span class="s0">, </span><span class="s2">&quot;units&quot;</span><span class="s0">, </span><span class="s2">&quot;dimensionless&quot;</span><span class="s1">)</span>
            <span class="s1">u0 = u1 </span><span class="s0">if </span><span class="s1">u0 </span><span class="s0">is None else </span><span class="s1">u0</span>
            <span class="s1">u1 = u0 </span><span class="s0">if </span><span class="s1">u1 </span><span class="s0">is None else </span><span class="s1">u1</span>
            <span class="s0">if </span><span class="s1">ufunc </span><span class="s0">in </span><span class="s1">[np.add</span><span class="s0">, </span><span class="s1">np.subtract]:</span>
                <span class="s0">if </span><span class="s1">u0 != u1:</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span>
                <span class="s1">unit = u0</span>
            <span class="s0">elif </span><span class="s1">ufunc == np.multiply:</span>
                <span class="s1">unit = </span><span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">u0</span><span class="s0">}</span><span class="s2">*</span><span class="s0">{</span><span class="s1">u1</span><span class="s0">}</span><span class="s2">&quot;</span>
            <span class="s0">elif </span><span class="s1">ufunc == np.divide:</span>
                <span class="s1">unit = </span><span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">u0</span><span class="s0">}</span><span class="s2">/(</span><span class="s0">{</span><span class="s1">u1</span><span class="s0">}</span><span class="s2">)&quot;</span>
            <span class="s0">elif </span><span class="s1">ufunc </span><span class="s0">in </span><span class="s1">(np.greater</span><span class="s0">, </span><span class="s1">np.greater_equal</span><span class="s0">,</span>
                           <span class="s1">np.equal</span><span class="s0">, </span><span class="s1">np.not_equal</span><span class="s0">,</span>
                           <span class="s1">np.less</span><span class="s0">, </span><span class="s1">np.less_equal):</span>
                <span class="s4"># Comparisons produce unitless booleans for output</span>
                <span class="s1">unit = </span><span class="s0">None</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s0">return </span><span class="s1">NotImplemented</span>
            <span class="s1">out_arr = func(i0.view(np.ndarray)</span><span class="s0">, </span><span class="s1">i1.view(np.ndarray)</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">return </span><span class="s1">NotImplemented</span>
        <span class="s0">if </span><span class="s1">unit </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">out_arr = np.array(out_arr)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">out_arr = QuantityND(out_arr</span><span class="s0">, </span><span class="s1">unit)</span>
        <span class="s0">return </span><span class="s1">out_arr</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">v(self):</span>
        <span class="s0">return </span><span class="s1">self.view(np.ndarray)</span>


<span class="s0">def </span><span class="s1">test_quantitynd():</span>
    <span class="s1">q = QuantityND([</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;m&quot;</span><span class="s1">)</span>
    <span class="s1">q0</span><span class="s0">, </span><span class="s1">q1 = q[:]</span>
    <span class="s0">assert </span><span class="s1">np.all(q.v == np.asarray([</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]))</span>
    <span class="s0">assert </span><span class="s1">q.units == </span><span class="s2">&quot;m&quot;</span>
    <span class="s0">assert </span><span class="s1">np.all((q0 + q1).v == np.asarray([</span><span class="s5">3</span><span class="s1">]))</span>
    <span class="s0">assert </span><span class="s1">(q0 * q1).units == </span><span class="s2">&quot;m*m&quot;</span>
    <span class="s0">assert </span><span class="s1">(q1 / q0).units == </span><span class="s2">&quot;m/(m)&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">q0 + QuantityND(</span><span class="s5">1</span><span class="s0">, </span><span class="s2">&quot;s&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_imshow_quantitynd():</span>
    <span class="s4"># generate a dummy ndarray subclass</span>
    <span class="s1">arr = QuantityND(np.ones((</span><span class="s5">2</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span><span class="s0">, </span><span class="s2">&quot;m&quot;</span><span class="s1">)</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow(arr)</span>
    <span class="s4"># executing the draw should not raise an exception</span>
    <span class="s1">fig.canvas.draw()</span>


<span class="s1">@check_figures_equal(extensions=[</span><span class="s2">'png'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_norm_change(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s4"># LogNorm should not mask anything invalid permanently.</span>
    <span class="s1">data = np.full((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s1">data[</span><span class="s5">0</span><span class="s1">:</span><span class="s5">2</span><span class="s0">, </span><span class="s1">:] = -</span><span class="s5">1</span>

    <span class="s1">masked_data = np.ma.array(data</span><span class="s0">, </span><span class="s1">mask=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">masked_data.mask[</span><span class="s5">0</span><span class="s1">:</span><span class="s5">2</span><span class="s0">, </span><span class="s5">0</span><span class="s1">:</span><span class="s5">2</span><span class="s1">] = </span><span class="s0">True</span>

    <span class="s1">cmap = mpl.colormaps[</span><span class="s2">'viridis'</span><span class="s1">].with_extremes(under=</span><span class="s2">'w'</span><span class="s1">)</span>

    <span class="s1">ax = fig_test.subplots()</span>
    <span class="s1">im = ax.imshow(data</span><span class="s0">, </span><span class="s1">norm=colors.LogNorm(vmin=</span><span class="s5">0.5</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">1</span><span class="s1">)</span><span class="s0">,</span>
                   <span class="s1">extent=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s0">, </span><span class="s1">cmap=cmap)</span>
    <span class="s1">im.set_norm(colors.Normalize(vmin=-</span><span class="s5">2</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">im = ax.imshow(masked_data</span><span class="s0">, </span><span class="s1">norm=colors.LogNorm(vmin=</span><span class="s5">0.5</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">1</span><span class="s1">)</span><span class="s0">,</span>
                   <span class="s1">extent=(</span><span class="s5">5</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s0">, </span><span class="s1">cmap=cmap)</span>
    <span class="s1">im.set_norm(colors.Normalize(vmin=-</span><span class="s5">2</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">ax.set(xlim=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ylim=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">10</span><span class="s1">))</span>

    <span class="s1">ax = fig_ref.subplots()</span>
    <span class="s1">ax.imshow(data</span><span class="s0">, </span><span class="s1">norm=colors.Normalize(vmin=-</span><span class="s5">2</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">2</span><span class="s1">)</span><span class="s0">,</span>
              <span class="s1">extent=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s0">, </span><span class="s1">cmap=cmap)</span>
    <span class="s1">ax.imshow(masked_data</span><span class="s0">, </span><span class="s1">norm=colors.Normalize(vmin=-</span><span class="s5">2</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">2</span><span class="s1">)</span><span class="s0">,</span>
              <span class="s1">extent=(</span><span class="s5">5</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s0">, </span><span class="s1">cmap=cmap)</span>
    <span class="s1">ax.set(xlim=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ylim=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">10</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">'x'</span><span class="s0">, </span><span class="s1">[-</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">])</span>
<span class="s1">@check_figures_equal(extensions=[</span><span class="s2">'png'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_huge_range_log(fig_test</span><span class="s0">, </span><span class="s1">fig_ref</span><span class="s0">, </span><span class="s1">x):</span>
    <span class="s4"># parametrize over bad lognorm -1 values and large range 1 -&gt; 1e20</span>
    <span class="s1">data = np.full((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s1">data[</span><span class="s5">0</span><span class="s1">:</span><span class="s5">2</span><span class="s0">, </span><span class="s1">:] = </span><span class="s5">1E20</span>

    <span class="s1">ax = fig_test.subplots()</span>
    <span class="s1">ax.imshow(data</span><span class="s0">, </span><span class="s1">norm=colors.LogNorm(vmin=</span><span class="s5">1</span><span class="s0">, </span><span class="s1">vmax=data.max())</span><span class="s0">,</span>
              <span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s0">, </span><span class="s1">cmap=</span><span class="s2">'viridis'</span><span class="s1">)</span>

    <span class="s1">data = np.full((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s1">data[</span><span class="s5">0</span><span class="s1">:</span><span class="s5">2</span><span class="s0">, </span><span class="s1">:] = </span><span class="s5">1000</span>

    <span class="s1">ax = fig_ref.subplots()</span>
    <span class="s1">cmap = mpl.colormaps[</span><span class="s2">'viridis'</span><span class="s1">].with_extremes(under=</span><span class="s2">'w'</span><span class="s1">)</span>
    <span class="s1">ax.imshow(data</span><span class="s0">, </span><span class="s1">norm=colors.Normalize(vmin=</span><span class="s5">1</span><span class="s0">, </span><span class="s1">vmax=data.max())</span><span class="s0">,</span>
              <span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s0">, </span><span class="s1">cmap=cmap)</span>


<span class="s1">@check_figures_equal()</span>
<span class="s0">def </span><span class="s1">test_spy_box(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s4"># setting up reference and test</span>
    <span class="s1">ax_test = fig_test.subplots(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>
    <span class="s1">ax_ref = fig_ref.subplots(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>

    <span class="s1">plot_data = (</span>
        <span class="s1">[[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">plot_titles = [</span><span class="s2">&quot;ones&quot;</span><span class="s0">, </span><span class="s2">&quot;zeros&quot;</span><span class="s0">, </span><span class="s2">&quot;mixed&quot;</span><span class="s1">]</span>

    <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">(z</span><span class="s0">, </span><span class="s1">title) </span><span class="s0">in </span><span class="s1">enumerate(zip(plot_data</span><span class="s0">, </span><span class="s1">plot_titles)):</span>
        <span class="s1">ax_test[i].set_title(title)</span>
        <span class="s1">ax_test[i].spy(z)</span>
        <span class="s1">ax_ref[i].set_title(title)</span>
        <span class="s1">ax_ref[i].imshow(z</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s0">,</span>
                            <span class="s1">aspect=</span><span class="s2">'equal'</span><span class="s0">, </span><span class="s1">origin=</span><span class="s2">'upper'</span><span class="s0">, </span><span class="s1">cmap=</span><span class="s2">'Greys'</span><span class="s0">,</span>
                            <span class="s1">vmin=</span><span class="s5">0</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">ax_ref[i].set_xlim(-</span><span class="s5">0.5</span><span class="s0">, </span><span class="s5">1.5</span><span class="s1">)</span>
        <span class="s1">ax_ref[i].set_ylim(</span><span class="s5">1.5</span><span class="s0">, </span><span class="s1">-</span><span class="s5">0.5</span><span class="s1">)</span>
        <span class="s1">ax_ref[i].xaxis.tick_top()</span>
        <span class="s1">ax_ref[i].title.set_y(</span><span class="s5">1.05</span><span class="s1">)</span>
        <span class="s1">ax_ref[i].xaxis.set_ticks_position(</span><span class="s2">'both'</span><span class="s1">)</span>
        <span class="s1">ax_ref[i].xaxis.set_major_locator(</span>
            <span class="s1">mticker.MaxNLocator(nbins=</span><span class="s5">9</span><span class="s0">, </span><span class="s1">steps=[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">integer=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">ax_ref[i].yaxis.set_major_locator(</span>
            <span class="s1">mticker.MaxNLocator(nbins=</span><span class="s5">9</span><span class="s0">, </span><span class="s1">steps=[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">integer=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">)</span>


<span class="s1">@image_comparison([</span><span class="s2">&quot;nonuniform_and_pcolor.png&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">style=</span><span class="s2">&quot;mpl20&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_nonuniform_and_pcolor():</span>
    <span class="s1">axs = plt.figure(figsize=(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)).subplots(</span><span class="s5">3</span><span class="s0">, </span><span class="s1">sharex=</span><span class="s0">True, </span><span class="s1">sharey=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">ax</span><span class="s0">, </span><span class="s1">interpolation </span><span class="s0">in </span><span class="s1">zip(axs</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;nearest&quot;</span><span class="s0">, </span><span class="s2">&quot;bilinear&quot;</span><span class="s1">]):</span>
        <span class="s1">im = NonUniformImage(ax</span><span class="s0">, </span><span class="s1">interpolation=interpolation)</span>
        <span class="s1">im.set_data(np.arange(</span><span class="s5">3</span><span class="s1">) ** </span><span class="s5">2</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s5">3</span><span class="s1">) ** </span><span class="s5">2</span><span class="s0">,</span>
                    <span class="s1">np.arange(</span><span class="s5">9</span><span class="s1">).reshape((</span><span class="s5">3</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)))</span>
        <span class="s1">ax.add_image(im)</span>
    <span class="s1">axs[</span><span class="s5">2</span><span class="s1">].pcolorfast(  </span><span class="s4"># PcolorImage</span>
        <span class="s1">np.arange(</span><span class="s5">4</span><span class="s1">) ** </span><span class="s5">2</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s5">4</span><span class="s1">) ** </span><span class="s5">2</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s5">9</span><span class="s1">).reshape((</span><span class="s5">3</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)))</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs:</span>
        <span class="s1">ax.set_axis_off()</span>
        <span class="s4"># NonUniformImage &quot;leaks&quot; out of extents, not PColorImage.</span>
        <span class="s1">ax.set(xlim=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">10</span><span class="s1">))</span>


<span class="s1">@image_comparison(</span>
    <span class="s1">[</span><span class="s2">'rgba_antialias.png'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">style=</span><span class="s2">'mpl20'</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True,</span>
    <span class="s1">tol=</span><span class="s5">0.007 </span><span class="s0">if </span><span class="s1">platform.machine() </span><span class="s0">in </span><span class="s1">(</span><span class="s2">'aarch64'</span><span class="s0">, </span><span class="s2">'ppc64le'</span><span class="s0">, </span><span class="s2">'s390x'</span><span class="s1">) </span><span class="s0">else </span><span class="s5">0</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rgba_antialias():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">axs = plt.subplots(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s1">figsize=(</span><span class="s5">3.5</span><span class="s0">, </span><span class="s5">3.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">sharex=</span><span class="s0">False,</span>
                            <span class="s1">sharey=</span><span class="s0">False, </span><span class="s1">constrained_layout=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">N = </span><span class="s5">250</span>
    <span class="s1">aa = np.ones((N</span><span class="s0">, </span><span class="s1">N))</span>
    <span class="s1">aa[::</span><span class="s5">2</span><span class="s0">, </span><span class="s1">:] = -</span><span class="s5">1</span>

    <span class="s1">x = np.arange(N) / N - </span><span class="s5">0.5</span>
    <span class="s1">y = np.arange(N) / N - </span><span class="s5">0.5</span>

    <span class="s1">X</span><span class="s0">, </span><span class="s1">Y = np.meshgrid(x</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">R = np.sqrt(X**</span><span class="s5">2 </span><span class="s1">+ Y**</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">f0 = </span><span class="s5">10</span>
    <span class="s1">k = </span><span class="s5">75</span>
    <span class="s4"># aliased concentric circles</span>
    <span class="s1">a = np.sin(np.pi * </span><span class="s5">2 </span><span class="s1">* (f0 * R + k * R**</span><span class="s5">2 </span><span class="s1">/ </span><span class="s5">2</span><span class="s1">))</span>

    <span class="s4"># stripes on lhs</span>
    <span class="s1">a[:int(N/</span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">:][R[:int(N/</span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">:] &lt; </span><span class="s5">0.4</span><span class="s1">] = -</span><span class="s5">1</span>
    <span class="s1">a[:int(N/</span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">:][R[:int(N/</span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">:] &lt; </span><span class="s5">0.3</span><span class="s1">] = </span><span class="s5">1</span>
    <span class="s1">aa[:</span><span class="s0">, </span><span class="s1">int(N/</span><span class="s5">2</span><span class="s1">):] = a[:</span><span class="s0">, </span><span class="s1">int(N/</span><span class="s5">2</span><span class="s1">):]</span>

    <span class="s4"># set some over/unders and NaNs</span>
    <span class="s1">aa[</span><span class="s5">20</span><span class="s1">:</span><span class="s5">50</span><span class="s0">, </span><span class="s5">20</span><span class="s1">:</span><span class="s5">50</span><span class="s1">] = np.NaN</span>
    <span class="s1">aa[</span><span class="s5">70</span><span class="s1">:</span><span class="s5">90</span><span class="s0">, </span><span class="s5">70</span><span class="s1">:</span><span class="s5">90</span><span class="s1">] = </span><span class="s5">1e6</span>
    <span class="s1">aa[</span><span class="s5">70</span><span class="s1">:</span><span class="s5">90</span><span class="s0">, </span><span class="s5">20</span><span class="s1">:</span><span class="s5">30</span><span class="s1">] = -</span><span class="s5">1e6</span>
    <span class="s1">aa[</span><span class="s5">70</span><span class="s1">:</span><span class="s5">90</span><span class="s0">, </span><span class="s5">195</span><span class="s1">:</span><span class="s5">215</span><span class="s1">] = </span><span class="s5">1e6</span>
    <span class="s1">aa[</span><span class="s5">20</span><span class="s1">:</span><span class="s5">30</span><span class="s0">, </span><span class="s5">195</span><span class="s1">:</span><span class="s5">215</span><span class="s1">] = -</span><span class="s5">1e6</span>

    <span class="s1">cmap = copy(plt.cm.RdBu_r)</span>
    <span class="s1">cmap.set_over(</span><span class="s2">'yellow'</span><span class="s1">)</span>
    <span class="s1">cmap.set_under(</span><span class="s2">'cyan'</span><span class="s1">)</span>

    <span class="s1">axs = axs.flatten()</span>
    <span class="s4"># zoom in</span>
    <span class="s1">axs[</span><span class="s5">0</span><span class="s1">].imshow(aa</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s0">, </span><span class="s1">cmap=cmap</span><span class="s0">, </span><span class="s1">vmin=-</span><span class="s5">1.2</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">1.2</span><span class="s1">)</span>
    <span class="s1">axs[</span><span class="s5">0</span><span class="s1">].set_xlim([N/</span><span class="s5">2</span><span class="s1">-</span><span class="s5">25</span><span class="s0">, </span><span class="s1">N/</span><span class="s5">2</span><span class="s1">+</span><span class="s5">25</span><span class="s1">])</span>
    <span class="s1">axs[</span><span class="s5">0</span><span class="s1">].set_ylim([N/</span><span class="s5">2</span><span class="s1">+</span><span class="s5">50</span><span class="s0">, </span><span class="s1">N/</span><span class="s5">2</span><span class="s1">-</span><span class="s5">10</span><span class="s1">])</span>

    <span class="s4"># no anti-alias</span>
    <span class="s1">axs[</span><span class="s5">1</span><span class="s1">].imshow(aa</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'nearest'</span><span class="s0">, </span><span class="s1">cmap=cmap</span><span class="s0">, </span><span class="s1">vmin=-</span><span class="s5">1.2</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">1.2</span><span class="s1">)</span>

    <span class="s4"># data antialias: Note no purples, and white in circle.  Note</span>
    <span class="s4"># that alternating red and blue stripes become white.</span>
    <span class="s1">axs[</span><span class="s5">2</span><span class="s1">].imshow(aa</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'antialiased'</span><span class="s0">, </span><span class="s1">interpolation_stage=</span><span class="s2">'data'</span><span class="s0">,</span>
                  <span class="s1">cmap=cmap</span><span class="s0">, </span><span class="s1">vmin=-</span><span class="s5">1.2</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">1.2</span><span class="s1">)</span>

    <span class="s4"># rgba antialias: Note purples at boundary with circle.  Note that</span>
    <span class="s4"># alternating red and blue stripes become purple</span>
    <span class="s1">axs[</span><span class="s5">3</span><span class="s1">].imshow(aa</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'antialiased'</span><span class="s0">, </span><span class="s1">interpolation_stage=</span><span class="s2">'rgba'</span><span class="s0">,</span>
                  <span class="s1">cmap=cmap</span><span class="s0">, </span><span class="s1">vmin=-</span><span class="s5">1.2</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">1.2</span><span class="s1">)</span>


<span class="s4"># We check for the warning with a draw() in the test, but we also need to</span>
<span class="s4"># filter the warning as it is emitted by the figure test decorator</span>
<span class="s1">@pytest.mark.filterwarnings(</span><span class="s2">r'ignore:Data with more than .* '</span>
                            <span class="s2">'cannot be accurately displayed'</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">'origin'</span><span class="s0">, </span><span class="s1">[</span><span class="s2">'upper'</span><span class="s0">, </span><span class="s2">'lower'</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">'dim, size, msg'</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">'row'</span><span class="s0">, </span><span class="s5">2</span><span class="s1">**</span><span class="s5">23</span><span class="s0">, </span><span class="s2">r'2\*\*23 columns'</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s2">'col'</span><span class="s0">, </span><span class="s5">2</span><span class="s1">**</span><span class="s5">24</span><span class="s0">, </span><span class="s2">r'2\*\*24 rows'</span><span class="s1">]])</span>
<span class="s1">@check_figures_equal(extensions=(</span><span class="s2">'png'</span><span class="s0">, </span><span class="s1">))</span>
<span class="s0">def </span><span class="s1">test_large_image(fig_test</span><span class="s0">, </span><span class="s1">fig_ref</span><span class="s0">, </span><span class="s1">dim</span><span class="s0">, </span><span class="s1">size</span><span class="s0">, </span><span class="s1">msg</span><span class="s0">, </span><span class="s1">origin):</span>
    <span class="s4"># Check that Matplotlib downsamples images that are too big for AGG</span>
    <span class="s4"># See issue #19276. Currently the fix only works for png output but not</span>
    <span class="s4"># pdf or svg output.</span>
    <span class="s1">ax_test = fig_test.subplots()</span>
    <span class="s1">ax_ref = fig_ref.subplots()</span>

    <span class="s1">array = np.zeros((</span><span class="s5">1</span><span class="s0">, </span><span class="s1">size + </span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">array[:</span><span class="s0">, </span><span class="s1">array.size // </span><span class="s5">2</span><span class="s1">:] = </span><span class="s5">1</span>
    <span class="s0">if </span><span class="s1">dim == </span><span class="s2">'col'</span><span class="s1">:</span>
        <span class="s1">array = array.T</span>
    <span class="s1">im = ax_test.imshow(array</span><span class="s0">, </span><span class="s1">vmin=</span><span class="s5">0</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">1</span><span class="s0">,</span>
                        <span class="s1">aspect=</span><span class="s2">'auto'</span><span class="s0">, </span><span class="s1">extent=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">interpolation=</span><span class="s2">'none'</span><span class="s0">,</span>
                        <span class="s1">origin=origin)</span>

    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">,</span>
                      <span class="s1">match=</span><span class="s2">f'Data with more than </span><span class="s0">{</span><span class="s1">msg</span><span class="s0">} </span><span class="s2">cannot be '</span>
                      <span class="s2">'accurately displayed.'</span><span class="s1">):</span>
        <span class="s1">fig_test.canvas.draw()</span>

    <span class="s1">array = np.zeros((</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">array[:</span><span class="s0">, </span><span class="s5">1</span><span class="s1">] = </span><span class="s5">1</span>
    <span class="s0">if </span><span class="s1">dim == </span><span class="s2">'col'</span><span class="s1">:</span>
        <span class="s1">array = array.T</span>
    <span class="s1">im = ax_ref.imshow(array</span><span class="s0">, </span><span class="s1">vmin=</span><span class="s5">0</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">1</span><span class="s0">, </span><span class="s1">aspect=</span><span class="s2">'auto'</span><span class="s0">,</span>
                       <span class="s1">extent=(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">,</span>
                       <span class="s1">interpolation=</span><span class="s2">'none'</span><span class="s0">,</span>
                       <span class="s1">origin=origin)</span>


<span class="s1">@check_figures_equal(extensions=[</span><span class="s2">&quot;png&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_str_norms(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s1">t = np.random.rand(</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">) * </span><span class="s5">.8 </span><span class="s1">+ </span><span class="s5">.1  </span><span class="s4"># between 0 and 1</span>
    <span class="s1">axts = fig_test.subplots(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>
    <span class="s1">axts[</span><span class="s5">0</span><span class="s1">].imshow(t</span><span class="s0">, </span><span class="s1">norm=</span><span class="s2">&quot;log&quot;</span><span class="s1">)</span>
    <span class="s1">axts[</span><span class="s5">1</span><span class="s1">].imshow(t</span><span class="s0">, </span><span class="s1">norm=</span><span class="s2">&quot;log&quot;</span><span class="s0">, </span><span class="s1">vmin=</span><span class="s5">.2</span><span class="s1">)</span>
    <span class="s1">axts[</span><span class="s5">2</span><span class="s1">].imshow(t</span><span class="s0">, </span><span class="s1">norm=</span><span class="s2">&quot;symlog&quot;</span><span class="s1">)</span>
    <span class="s1">axts[</span><span class="s5">3</span><span class="s1">].imshow(t</span><span class="s0">, </span><span class="s1">norm=</span><span class="s2">&quot;symlog&quot;</span><span class="s0">, </span><span class="s1">vmin=</span><span class="s5">.3</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">.7</span><span class="s1">)</span>
    <span class="s1">axts[</span><span class="s5">4</span><span class="s1">].imshow(t</span><span class="s0">, </span><span class="s1">norm=</span><span class="s2">&quot;logit&quot;</span><span class="s0">, </span><span class="s1">vmin=</span><span class="s5">.3</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">.7</span><span class="s1">)</span>
    <span class="s1">axrs = fig_ref.subplots(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>
    <span class="s1">axrs[</span><span class="s5">0</span><span class="s1">].imshow(t</span><span class="s0">, </span><span class="s1">norm=colors.LogNorm())</span>
    <span class="s1">axrs[</span><span class="s5">1</span><span class="s1">].imshow(t</span><span class="s0">, </span><span class="s1">norm=colors.LogNorm(vmin=</span><span class="s5">.2</span><span class="s1">))</span>
    <span class="s4"># same linthresh as SymmetricalLogScale's default.</span>
    <span class="s1">axrs[</span><span class="s5">2</span><span class="s1">].imshow(t</span><span class="s0">, </span><span class="s1">norm=colors.SymLogNorm(linthresh=</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">axrs[</span><span class="s5">3</span><span class="s1">].imshow(t</span><span class="s0">, </span><span class="s1">norm=colors.SymLogNorm(linthresh=</span><span class="s5">2</span><span class="s0">, </span><span class="s1">vmin=</span><span class="s5">.3</span><span class="s0">, </span><span class="s1">vmax=</span><span class="s5">.7</span><span class="s1">))</span>
    <span class="s1">axrs[</span><span class="s5">4</span><span class="s1">].imshow(t</span><span class="s0">, </span><span class="s1">norm=</span><span class="s2">&quot;logit&quot;</span><span class="s0">, </span><span class="s1">clim=(</span><span class="s5">.3</span><span class="s0">, </span><span class="s5">.7</span><span class="s1">))</span>

    <span class="s0">assert </span><span class="s1">type(axts[</span><span class="s5">0</span><span class="s1">].images[</span><span class="s5">0</span><span class="s1">].norm) == colors.LogNorm  </span><span class="s4"># Exactly that class</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">axts[</span><span class="s5">0</span><span class="s1">].imshow(t</span><span class="s0">, </span><span class="s1">norm=</span><span class="s2">&quot;foobar&quot;</span><span class="s1">)</span>
</pre>
</body>
</html>