<html>
<head>
<title>test_backend_svg.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
.s5 { color: #629755; font-style: italic;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_backend_svg.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">BytesIO</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">import </span><span class="s1">xml.etree.ElementTree</span>
<span class="s0">import </span><span class="s1">xml.parsers.expat</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib.figure </span><span class="s0">import </span><span class="s1">Figure</span>
<span class="s0">from </span><span class="s1">matplotlib.text </span><span class="s0">import </span><span class="s1">Text</span>
<span class="s0">import </span><span class="s1">matplotlib.pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">from </span><span class="s1">matplotlib.testing.decorators </span><span class="s0">import </span><span class="s1">check_figures_equal</span><span class="s0">, </span><span class="s1">image_comparison</span>
<span class="s0">from </span><span class="s1">matplotlib.testing._markers </span><span class="s0">import </span><span class="s1">needs_usetex</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">font_manager </span><span class="s0">as </span><span class="s1">fm</span>
<span class="s0">from </span><span class="s1">matplotlib.offsetbox </span><span class="s0">import </span><span class="s1">(OffsetImage</span><span class="s0">, </span><span class="s1">AnnotationBbox)</span>


<span class="s0">def </span><span class="s1">test_visibility():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>

    <span class="s1">x = np.linspace(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">4 </span><span class="s1">* np.pi</span><span class="s0">, </span><span class="s2">50</span><span class="s1">)</span>
    <span class="s1">y = np.sin(x)</span>
    <span class="s1">yerr = np.ones_like(y)</span>

    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c = ax.errorbar(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">yerr=yerr</span><span class="s0">, </span><span class="s1">fmt=</span><span class="s3">'ko'</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">artist </span><span class="s0">in </span><span class="s1">b:</span>
        <span class="s1">artist.set_visible(</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s1">)</span>
        <span class="s1">buf = fd.getvalue()</span>

    <span class="s1">parser = xml.parsers.expat.ParserCreate()</span>
    <span class="s1">parser.Parse(buf)  </span><span class="s4"># this will raise ExpatError if the svg is invalid</span>


<span class="s1">@image_comparison([</span><span class="s3">'fill_black_with_alpha.svg'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_fill_black_with_alpha():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.scatter(x=[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0.1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y=[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">'k'</span><span class="s0">, </span><span class="s1">alpha=</span><span class="s2">0.1</span><span class="s0">, </span><span class="s1">s=</span><span class="s2">10000</span><span class="s1">)</span>


<span class="s1">@image_comparison([</span><span class="s3">'noscale'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">remove_text=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_noscale():</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">Y = np.meshgrid(np.arange(-</span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(-</span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">))</span>
    <span class="s1">Z = np.sin(Y ** </span><span class="s2">2</span><span class="s1">)</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow(Z</span><span class="s0">, </span><span class="s1">cmap=</span><span class="s3">'gray'</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s3">'none'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_text_urls():</span>
    <span class="s1">fig = plt.figure()</span>

    <span class="s1">test_url = </span><span class="s3">&quot;http://test_text_urls.matplotlib.org&quot;</span>
    <span class="s1">fig.suptitle(</span><span class="s3">&quot;test_text_urls&quot;</span><span class="s0">, </span><span class="s1">url=test_url)</span>

    <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s1">)</span>
        <span class="s1">buf = fd.getvalue().decode()</span>

    <span class="s1">expected = </span><span class="s3">'&lt;a xlink:href=&quot;{0}&quot;&gt;'</span><span class="s1">.format(test_url)</span>
    <span class="s0">assert </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">buf</span>


<span class="s1">@image_comparison([</span><span class="s3">'bold_font_output.svg'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_bold_font_output():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.plot(np.arange(</span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s2">10</span><span class="s1">))</span>
    <span class="s1">ax.set_xlabel(</span><span class="s3">'nonbold-xlabel'</span><span class="s1">)</span>
    <span class="s1">ax.set_ylabel(</span><span class="s3">'bold-ylabel'</span><span class="s0">, </span><span class="s1">fontweight=</span><span class="s3">'bold'</span><span class="s1">)</span>
    <span class="s1">ax.set_title(</span><span class="s3">'bold-title'</span><span class="s0">, </span><span class="s1">fontweight=</span><span class="s3">'bold'</span><span class="s1">)</span>


<span class="s1">@image_comparison([</span><span class="s3">'bold_font_output_with_none_fonttype.svg'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_bold_font_output_with_none_fonttype():</span>
    <span class="s1">plt.rcParams[</span><span class="s3">'svg.fonttype'</span><span class="s1">] = </span><span class="s3">'none'</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.plot(np.arange(</span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s2">10</span><span class="s1">))</span>
    <span class="s1">ax.set_xlabel(</span><span class="s3">'nonbold-xlabel'</span><span class="s1">)</span>
    <span class="s1">ax.set_ylabel(</span><span class="s3">'bold-ylabel'</span><span class="s0">, </span><span class="s1">fontweight=</span><span class="s3">'bold'</span><span class="s1">)</span>
    <span class="s1">ax.set_title(</span><span class="s3">'bold-title'</span><span class="s0">, </span><span class="s1">fontweight=</span><span class="s3">'bold'</span><span class="s1">)</span>


<span class="s1">@check_figures_equal(tol=</span><span class="s2">20</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rasterized(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s1">t = np.arange(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">100</span><span class="s1">) * (</span><span class="s2">2.3</span><span class="s1">)</span>
    <span class="s1">x = np.cos(t)</span>
    <span class="s1">y = np.sin(t)</span>

    <span class="s1">ax_ref = fig_ref.subplots()</span>
    <span class="s1">ax_ref.plot(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s3">&quot;-&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;r&quot;</span><span class="s0">, </span><span class="s1">lw=</span><span class="s2">10</span><span class="s1">)</span>
    <span class="s1">ax_ref.plot(x+</span><span class="s2">1</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s3">&quot;-&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">lw=</span><span class="s2">10</span><span class="s1">)</span>

    <span class="s1">ax_test = fig_test.subplots()</span>
    <span class="s1">ax_test.plot(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s3">&quot;-&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;r&quot;</span><span class="s0">, </span><span class="s1">lw=</span><span class="s2">10</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">ax_test.plot(x+</span><span class="s2">1</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s3">&quot;-&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">lw=</span><span class="s2">10</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s1">@check_figures_equal()</span>
<span class="s0">def </span><span class="s1">test_rasterized_ordering(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s1">t = np.arange(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">100</span><span class="s1">) * (</span><span class="s2">2.3</span><span class="s1">)</span>
    <span class="s1">x = np.cos(t)</span>
    <span class="s1">y = np.sin(t)</span>

    <span class="s1">ax_ref = fig_ref.subplots()</span>
    <span class="s1">ax_ref.set_xlim(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span>
    <span class="s1">ax_ref.set_ylim(-</span><span class="s2">1.1</span><span class="s0">, </span><span class="s2">1.1</span><span class="s1">)</span>
    <span class="s1">ax_ref.plot(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s3">&quot;-&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;r&quot;</span><span class="s0">, </span><span class="s1">lw=</span><span class="s2">10</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">ax_ref.plot(x+</span><span class="s2">1</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s3">&quot;-&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">lw=</span><span class="s2">10</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">ax_ref.plot(x+</span><span class="s2">2</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s3">&quot;-&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;g&quot;</span><span class="s0">, </span><span class="s1">lw=</span><span class="s2">10</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">ax_ref.plot(x+</span><span class="s2">3</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s3">&quot;-&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;m&quot;</span><span class="s0">, </span><span class="s1">lw=</span><span class="s2">10</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">ax_test = fig_test.subplots()</span>
    <span class="s1">ax_test.set_xlim(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span>
    <span class="s1">ax_test.set_ylim(-</span><span class="s2">1.1</span><span class="s0">, </span><span class="s2">1.1</span><span class="s1">)</span>
    <span class="s1">ax_test.plot(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s3">&quot;-&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;r&quot;</span><span class="s0">, </span><span class="s1">lw=</span><span class="s2">10</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True, </span><span class="s1">zorder=</span><span class="s2">1.1</span><span class="s1">)</span>
    <span class="s1">ax_test.plot(x+</span><span class="s2">2</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s3">&quot;-&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;g&quot;</span><span class="s0">, </span><span class="s1">lw=</span><span class="s2">10</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True, </span><span class="s1">zorder=</span><span class="s2">1.3</span><span class="s1">)</span>
    <span class="s1">ax_test.plot(x+</span><span class="s2">3</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s3">&quot;-&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;m&quot;</span><span class="s0">, </span><span class="s1">lw=</span><span class="s2">10</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True, </span><span class="s1">zorder=</span><span class="s2">1.4</span><span class="s1">)</span>
    <span class="s1">ax_test.plot(x+</span><span class="s2">1</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s3">&quot;-&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">lw=</span><span class="s2">10</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">False, </span><span class="s1">zorder=</span><span class="s2">1.2</span><span class="s1">)</span>


<span class="s1">@check_figures_equal(tol=</span><span class="s2">5</span><span class="s0">, </span><span class="s1">extensions=[</span><span class="s3">'svg'</span><span class="s0">, </span><span class="s3">'pdf'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_prevent_rasterization(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s1">loc = [</span><span class="s2">0.05</span><span class="s0">, </span><span class="s2">0.05</span><span class="s1">]</span>

    <span class="s1">ax_ref = fig_ref.subplots()</span>

    <span class="s1">ax_ref.plot([loc[</span><span class="s2">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[loc[</span><span class="s2">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">marker=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;black&quot;</span><span class="s0">, </span><span class="s1">zorder=</span><span class="s2">2</span><span class="s1">)</span>

    <span class="s1">b = mpl.offsetbox.TextArea(</span><span class="s3">&quot;X&quot;</span><span class="s1">)</span>
    <span class="s1">abox = mpl.offsetbox.AnnotationBbox(b</span><span class="s0">, </span><span class="s1">loc</span><span class="s0">, </span><span class="s1">zorder=</span><span class="s2">2.1</span><span class="s1">)</span>
    <span class="s1">ax_ref.add_artist(abox)</span>

    <span class="s1">ax_test = fig_test.subplots()</span>
    <span class="s1">ax_test.plot([loc[</span><span class="s2">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[loc[</span><span class="s2">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">marker=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">&quot;black&quot;</span><span class="s0">, </span><span class="s1">zorder=</span><span class="s2">2</span><span class="s0">,</span>
                 <span class="s1">rasterized=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">b = mpl.offsetbox.TextArea(</span><span class="s3">&quot;X&quot;</span><span class="s1">)</span>
    <span class="s1">abox = mpl.offsetbox.AnnotationBbox(b</span><span class="s0">, </span><span class="s1">loc</span><span class="s0">, </span><span class="s1">zorder=</span><span class="s2">2.1</span><span class="s1">)</span>
    <span class="s1">ax_test.add_artist(abox)</span>


<span class="s0">def </span><span class="s1">test_count_bitmaps():</span>
    <span class="s0">def </span><span class="s1">count_tag(fig</span><span class="s0">, </span><span class="s1">tag):</span>
        <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
            <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s1">)</span>
            <span class="s1">buf = fd.getvalue().decode()</span>
        <span class="s0">return </span><span class="s1">buf.count(</span><span class="s3">f&quot;&lt;</span><span class="s0">{</span><span class="s1">tag</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s1">)</span>

    <span class="s4"># No rasterized elements</span>
    <span class="s1">fig1 = plt.figure()</span>
    <span class="s1">ax1 = fig1.add_subplot(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">ax1.set_axis_off()</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">5</span><span class="s1">):</span>
        <span class="s1">ax1.plot([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">n]</span><span class="s0">, </span><span class="s3">&quot;b-&quot;</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">count_tag(fig1</span><span class="s0">, </span><span class="s3">&quot;image&quot;</span><span class="s1">) == </span><span class="s2">0</span>
    <span class="s0">assert </span><span class="s1">count_tag(fig1</span><span class="s0">, </span><span class="s3">&quot;path&quot;</span><span class="s1">) == </span><span class="s2">6  </span><span class="s4"># axis patch plus lines</span>

    <span class="s4"># rasterized can be merged</span>
    <span class="s1">fig2 = plt.figure()</span>
    <span class="s1">ax2 = fig2.add_subplot(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">ax2.set_axis_off()</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">5</span><span class="s1">):</span>
        <span class="s1">ax2.plot([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">n]</span><span class="s0">, </span><span class="s3">&quot;b-&quot;</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">count_tag(fig2</span><span class="s0">, </span><span class="s3">&quot;image&quot;</span><span class="s1">) == </span><span class="s2">1</span>
    <span class="s0">assert </span><span class="s1">count_tag(fig2</span><span class="s0">, </span><span class="s3">&quot;path&quot;</span><span class="s1">) == </span><span class="s2">1  </span><span class="s4"># axis patch</span>

    <span class="s4"># rasterized can't be merged without affecting draw order</span>
    <span class="s1">fig3 = plt.figure()</span>
    <span class="s1">ax3 = fig3.add_subplot(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">ax3.set_axis_off()</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">5</span><span class="s1">):</span>
        <span class="s1">ax3.plot([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[n</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b-&quot;</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">ax3.plot([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">n]</span><span class="s0">, </span><span class="s3">&quot;b-&quot;</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">count_tag(fig3</span><span class="s0">, </span><span class="s3">&quot;image&quot;</span><span class="s1">) == </span><span class="s2">5</span>
    <span class="s0">assert </span><span class="s1">count_tag(fig3</span><span class="s0">, </span><span class="s3">&quot;path&quot;</span><span class="s1">) == </span><span class="s2">6</span>

    <span class="s4"># rasterized whole axes</span>
    <span class="s1">fig4 = plt.figure()</span>
    <span class="s1">ax4 = fig4.add_subplot(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">ax4.set_axis_off()</span>
    <span class="s1">ax4.set_rasterized(</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">5</span><span class="s1">):</span>
        <span class="s1">ax4.plot([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[n</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b-&quot;</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">ax4.plot([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">n]</span><span class="s0">, </span><span class="s3">&quot;b-&quot;</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">count_tag(fig4</span><span class="s0">, </span><span class="s3">&quot;image&quot;</span><span class="s1">) == </span><span class="s2">1</span>
    <span class="s0">assert </span><span class="s1">count_tag(fig4</span><span class="s0">, </span><span class="s3">&quot;path&quot;</span><span class="s1">) == </span><span class="s2">1</span>

    <span class="s4"># rasterized can be merged, but inhibited by suppressComposite</span>
    <span class="s1">fig5 = plt.figure()</span>
    <span class="s1">fig5.suppressComposite = </span><span class="s0">True</span>
    <span class="s1">ax5 = fig5.add_subplot(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">ax5.set_axis_off()</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">5</span><span class="s1">):</span>
        <span class="s1">ax5.plot([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">n]</span><span class="s0">, </span><span class="s3">&quot;b-&quot;</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">count_tag(fig5</span><span class="s0">, </span><span class="s3">&quot;image&quot;</span><span class="s1">) == </span><span class="s2">5</span>
    <span class="s0">assert </span><span class="s1">count_tag(fig5</span><span class="s0">, </span><span class="s3">&quot;path&quot;</span><span class="s1">) == </span><span class="s2">1  </span><span class="s4"># axis patch</span>


<span class="s4"># Use Computer Modern Sans Serif, not Helvetica (which has no \textwon).</span>
<span class="s1">@mpl.style.context(</span><span class="s3">'default'</span><span class="s1">)</span>
<span class="s1">@needs_usetex</span>
<span class="s0">def </span><span class="s1">test_unicode_won():</span>
    <span class="s1">fig = Figure()</span>
    <span class="s1">fig.text(</span><span class="s2">.5</span><span class="s0">, </span><span class="s2">.5</span><span class="s0">, </span><span class="s3">r'\textwon'</span><span class="s0">, </span><span class="s1">usetex=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s1">)</span>
        <span class="s1">buf = fd.getvalue()</span>

    <span class="s1">tree = xml.etree.ElementTree.fromstring(buf)</span>
    <span class="s1">ns = </span><span class="s3">'http://www.w3.org/2000/svg'</span>
    <span class="s1">won_id = </span><span class="s3">'SFSS3583-8e'</span>
    <span class="s0">assert </span><span class="s1">len(tree.findall(</span><span class="s3">f'.//</span><span class="s0">{{{</span><span class="s1">ns</span><span class="s0">}}}</span><span class="s3">path[@d][@id=&quot;</span><span class="s0">{</span><span class="s1">won_id</span><span class="s0">}</span><span class="s3">&quot;]'</span><span class="s1">)) == </span><span class="s2">1</span>
    <span class="s0">assert </span><span class="s3">f'#</span><span class="s0">{</span><span class="s1">won_id</span><span class="s0">}</span><span class="s3">' </span><span class="s0">in </span><span class="s1">tree.find(</span><span class="s3">f'.//</span><span class="s0">{{{</span><span class="s1">ns</span><span class="s0">}}}</span><span class="s3">use'</span><span class="s1">).attrib.values()</span>


<span class="s0">def </span><span class="s1">test_svgnone_with_data_coordinates():</span>
    <span class="s1">plt.rcParams.update({</span><span class="s3">'svg.fonttype'</span><span class="s1">: </span><span class="s3">'none'</span><span class="s0">, </span><span class="s3">'font.stretch'</span><span class="s1">: </span><span class="s3">'condensed'</span><span class="s1">})</span>
    <span class="s1">expected = </span><span class="s3">'Unlikely to appear by chance'</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.text(np.datetime64(</span><span class="s3">'2019-06-30'</span><span class="s1">)</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">ax.set_xlim(np.datetime64(</span><span class="s3">'2019-01-01'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.datetime64(</span><span class="s3">'2019-12-31'</span><span class="s1">))</span>
    <span class="s1">ax.set_ylim(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s1">)</span>
        <span class="s1">fd.seek(</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">buf = fd.read().decode()</span>

    <span class="s0">assert </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">buf </span><span class="s0">and </span><span class="s3">&quot;condensed&quot; </span><span class="s0">in </span><span class="s1">buf</span>


<span class="s0">def </span><span class="s1">test_gid():</span>
    <span class="s5">&quot;&quot;&quot;Test that object gid appears in output svg.&quot;&quot;&quot;</span>
    <span class="s0">from </span><span class="s1">matplotlib.offsetbox </span><span class="s0">import </span><span class="s1">OffsetBox</span>
    <span class="s0">from </span><span class="s1">matplotlib.axis </span><span class="s0">import </span><span class="s1">Tick</span>

    <span class="s1">fig = plt.figure()</span>

    <span class="s1">ax1 = fig.add_subplot(</span><span class="s2">131</span><span class="s1">)</span>
    <span class="s1">ax1.imshow([[</span><span class="s2">1.</span><span class="s0">, </span><span class="s2">2.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2.</span><span class="s0">, </span><span class="s2">3.</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">aspect=</span><span class="s3">&quot;auto&quot;</span><span class="s1">)</span>
    <span class="s1">ax1.scatter([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;myscatter&quot;</span><span class="s1">)</span>
    <span class="s1">ax1.plot([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;myplot&quot;</span><span class="s1">)</span>
    <span class="s1">ax1.legend()</span>
    <span class="s1">ax1a = ax1.twinx()</span>
    <span class="s1">ax1a.bar([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>

    <span class="s1">ax2 = fig.add_subplot(</span><span class="s2">132</span><span class="s0">, </span><span class="s1">projection=</span><span class="s3">&quot;polar&quot;</span><span class="s1">)</span>
    <span class="s1">ax2.plot([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1.5</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>

    <span class="s1">ax3 = fig.add_subplot(</span><span class="s2">133</span><span class="s0">, </span><span class="s1">projection=</span><span class="s3">&quot;3d&quot;</span><span class="s1">)</span>
    <span class="s1">ax3.plot([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>

    <span class="s1">fig.canvas.draw()</span>

    <span class="s1">gdic = {}</span>
    <span class="s0">for </span><span class="s1">idx</span><span class="s0">, </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">enumerate(fig.findobj(include_self=</span><span class="s0">True</span><span class="s1">)):</span>
        <span class="s0">if </span><span class="s1">obj.get_visible():</span>
            <span class="s1">gid = </span><span class="s3">f&quot;test123</span><span class="s0">{</span><span class="s1">obj.__class__.__name__</span><span class="s0">}</span><span class="s3">_</span><span class="s0">{</span><span class="s1">idx</span><span class="s0">}</span><span class="s3">&quot;</span>
            <span class="s1">gdic[gid] = obj</span>
            <span class="s1">obj.set_gid(gid)</span>

    <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s1">)</span>
        <span class="s1">buf = fd.getvalue().decode()</span>

    <span class="s0">def </span><span class="s1">include(gid</span><span class="s0">, </span><span class="s1">obj):</span>
        <span class="s4"># we need to exclude certain objects which will not appear in the svg</span>
        <span class="s0">if </span><span class="s1">isinstance(obj</span><span class="s0">, </span><span class="s1">OffsetBox):</span>
            <span class="s0">return False</span>
        <span class="s0">if </span><span class="s1">isinstance(obj</span><span class="s0">, </span><span class="s1">Text):</span>
            <span class="s0">if </span><span class="s1">obj.get_text() == </span><span class="s3">&quot;&quot;</span><span class="s1">:</span>
                <span class="s0">return False</span>
            <span class="s0">elif </span><span class="s1">obj.axes </span><span class="s0">is None</span><span class="s1">:</span>
                <span class="s0">return False</span>
        <span class="s0">if </span><span class="s1">isinstance(obj</span><span class="s0">, </span><span class="s1">plt.Line2D):</span>
            <span class="s1">xdata</span><span class="s0">, </span><span class="s1">ydata = obj.get_data()</span>
            <span class="s0">if </span><span class="s1">len(xdata) == len(ydata) == </span><span class="s2">1</span><span class="s1">:</span>
                <span class="s0">return False</span>
            <span class="s0">elif not </span><span class="s1">hasattr(obj</span><span class="s0">, </span><span class="s3">&quot;axes&quot;</span><span class="s1">) </span><span class="s0">or </span><span class="s1">obj.axes </span><span class="s0">is None</span><span class="s1">:</span>
                <span class="s0">return False</span>
        <span class="s0">if </span><span class="s1">isinstance(obj</span><span class="s0">, </span><span class="s1">Tick):</span>
            <span class="s1">loc = obj.get_loc()</span>
            <span class="s0">if </span><span class="s1">loc == </span><span class="s2">0</span><span class="s1">:</span>
                <span class="s0">return False</span>
            <span class="s1">vi = obj.get_view_interval()</span>
            <span class="s0">if </span><span class="s1">loc &lt; min(vi) </span><span class="s0">or </span><span class="s1">loc &gt; max(vi):</span>
                <span class="s0">return False</span>
        <span class="s0">return True</span>

    <span class="s0">for </span><span class="s1">gid</span><span class="s0">, </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">gdic.items():</span>
        <span class="s0">if </span><span class="s1">include(gid</span><span class="s0">, </span><span class="s1">obj):</span>
            <span class="s0">assert </span><span class="s1">gid </span><span class="s0">in </span><span class="s1">buf</span>


<span class="s0">def </span><span class="s1">test_savefig_tight():</span>
    <span class="s4"># Check that the draw-disabled renderer correctly disables open/close_group</span>
    <span class="s4"># as well.</span>
    <span class="s1">plt.savefig(BytesIO()</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;svgz&quot;</span><span class="s0">, </span><span class="s1">bbox_inches=</span><span class="s3">&quot;tight&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_url():</span>
    <span class="s4"># Test that object url appears in output svg.</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>

    <span class="s4"># collections</span>
    <span class="s1">s = ax.scatter([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">])</span>
    <span class="s1">s.set_urls([</span><span class="s3">'https://example.com/foo'</span><span class="s0">, </span><span class="s3">'https://example.com/bar'</span><span class="s0">, None</span><span class="s1">])</span>

    <span class="s4"># Line2D</span>
    <span class="s1">p</span><span class="s0">, </span><span class="s1">= plt.plot([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">6</span><span class="s0">, </span><span class="s2">5</span><span class="s1">])</span>
    <span class="s1">p.set_url(</span><span class="s3">'https://example.com/baz'</span><span class="s1">)</span>

    <span class="s1">b = BytesIO()</span>
    <span class="s1">fig.savefig(b</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s1">)</span>
    <span class="s1">b = b.getvalue()</span>
    <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">[</span><span class="s6">b'foo'</span><span class="s0">, </span><span class="s6">b'bar'</span><span class="s0">, </span><span class="s6">b'baz'</span><span class="s1">]:</span>
        <span class="s0">assert </span><span class="s6">b'https://example.com/' </span><span class="s1">+ v </span><span class="s0">in </span><span class="s1">b</span>


<span class="s0">def </span><span class="s1">test_url_tick(monkeypatch):</span>
    <span class="s1">monkeypatch.setenv(</span><span class="s3">'SOURCE_DATE_EPOCH'</span><span class="s0">, </span><span class="s3">'19680801'</span><span class="s1">)</span>

    <span class="s1">fig1</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.scatter([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">])</span>
    <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">enumerate(ax.yaxis.get_major_ticks()):</span>
        <span class="s1">tick.set_url(</span><span class="s3">f'https://example.com/</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">'</span><span class="s1">)</span>

    <span class="s1">fig2</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.scatter([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">])</span>
    <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">enumerate(ax.yaxis.get_major_ticks()):</span>
        <span class="s1">tick.label1.set_url(</span><span class="s3">f'https://example.com/</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">'</span><span class="s1">)</span>
        <span class="s1">tick.label2.set_url(</span><span class="s3">f'https://example.com/</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">'</span><span class="s1">)</span>

    <span class="s1">b1 = BytesIO()</span>
    <span class="s1">fig1.savefig(b1</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s1">)</span>
    <span class="s1">b1 = b1.getvalue()</span>

    <span class="s1">b2 = BytesIO()</span>
    <span class="s1">fig2.savefig(b2</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s1">)</span>
    <span class="s1">b2 = b2.getvalue()</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(ax.yaxis.get_major_ticks())):</span>
        <span class="s0">assert </span><span class="s3">f'https://example.com/</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">'</span><span class="s1">.encode(</span><span class="s3">'ascii'</span><span class="s1">) </span><span class="s0">in </span><span class="s1">b1</span>
    <span class="s0">assert </span><span class="s1">b1 == b2</span>


<span class="s0">def </span><span class="s1">test_svg_default_metadata(monkeypatch):</span>
    <span class="s4"># Values have been predefined for 'Creator', 'Date', 'Format', and 'Type'.</span>
    <span class="s1">monkeypatch.setenv(</span><span class="s3">'SOURCE_DATE_EPOCH'</span><span class="s0">, </span><span class="s3">'19680801'</span><span class="s1">)</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s1">)</span>
        <span class="s1">buf = fd.getvalue().decode()</span>

    <span class="s4"># Creator</span>
    <span class="s0">assert </span><span class="s1">mpl.__version__ </span><span class="s0">in </span><span class="s1">buf</span>
    <span class="s4"># Date</span>
    <span class="s0">assert </span><span class="s3">'1970-08-16' </span><span class="s0">in </span><span class="s1">buf</span>
    <span class="s4"># Format</span>
    <span class="s0">assert </span><span class="s3">'image/svg+xml' </span><span class="s0">in </span><span class="s1">buf</span>
    <span class="s4"># Type</span>
    <span class="s0">assert </span><span class="s3">'StillImage' </span><span class="s0">in </span><span class="s1">buf</span>

    <span class="s4"># Now make sure all the default metadata can be cleared.</span>
    <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s0">, </span><span class="s1">metadata={</span><span class="s3">'Date'</span><span class="s1">: </span><span class="s0">None, </span><span class="s3">'Creator'</span><span class="s1">: </span><span class="s0">None,</span>
                                                <span class="s3">'Format'</span><span class="s1">: </span><span class="s0">None, </span><span class="s3">'Type'</span><span class="s1">: </span><span class="s0">None</span><span class="s1">})</span>
        <span class="s1">buf = fd.getvalue().decode()</span>

    <span class="s4"># Creator</span>
    <span class="s0">assert </span><span class="s1">mpl.__version__ </span><span class="s0">not in </span><span class="s1">buf</span>
    <span class="s4"># Date</span>
    <span class="s0">assert </span><span class="s3">'1970-08-16' </span><span class="s0">not in </span><span class="s1">buf</span>
    <span class="s4"># Format</span>
    <span class="s0">assert </span><span class="s3">'image/svg+xml' </span><span class="s0">not in </span><span class="s1">buf</span>
    <span class="s4"># Type</span>
    <span class="s0">assert </span><span class="s3">'StillImage' </span><span class="s0">not in </span><span class="s1">buf</span>


<span class="s0">def </span><span class="s1">test_svg_clear_default_metadata(monkeypatch):</span>
    <span class="s4"># Makes sure that setting a default metadata to `None`</span>
    <span class="s4"># removes the corresponding tag from the metadata.</span>
    <span class="s1">monkeypatch.setenv(</span><span class="s3">'SOURCE_DATE_EPOCH'</span><span class="s0">, </span><span class="s3">'19680801'</span><span class="s1">)</span>

    <span class="s1">metadata_contains = {</span><span class="s3">'creator'</span><span class="s1">: mpl.__version__</span><span class="s0">, </span><span class="s3">'date'</span><span class="s1">: </span><span class="s3">'1970-08-16'</span><span class="s0">,</span>
                         <span class="s3">'format'</span><span class="s1">: </span><span class="s3">'image/svg+xml'</span><span class="s0">, </span><span class="s3">'type'</span><span class="s1">: </span><span class="s3">'StillImage'</span><span class="s1">}</span>

    <span class="s1">SVGNS = </span><span class="s3">'{http://www.w3.org/2000/svg}'</span>
    <span class="s1">RDFNS = </span><span class="s3">'{http://www.w3.org/1999/02/22-rdf-syntax-ns#}'</span>
    <span class="s1">CCNS = </span><span class="s3">'{http://creativecommons.org/ns#}'</span>
    <span class="s1">DCNS = </span><span class="s3">'{http://purl.org/dc/elements/1.1/}'</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">metadata_contains:</span>
        <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
            <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s0">, </span><span class="s1">metadata={name.title(): </span><span class="s0">None</span><span class="s1">})</span>
            <span class="s1">buf = fd.getvalue().decode()</span>

        <span class="s1">root = xml.etree.ElementTree.fromstring(buf)</span>
        <span class="s1">work</span><span class="s0">, </span><span class="s1">= root.findall(</span><span class="s3">f'./</span><span class="s0">{</span><span class="s1">SVGNS</span><span class="s0">}</span><span class="s3">metadata/</span><span class="s0">{</span><span class="s1">RDFNS</span><span class="s0">}</span><span class="s3">RDF/</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s3">Work'</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">metadata_contains:</span>
            <span class="s1">data = work.findall(</span><span class="s3">f'./</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}{</span><span class="s1">key</span><span class="s0">}</span><span class="s3">'</span><span class="s1">)</span>
            <span class="s0">if </span><span class="s1">key == name:</span>
                <span class="s4"># The one we cleared is not there</span>
                <span class="s0">assert not </span><span class="s1">data</span>
                <span class="s0">continue</span>
            <span class="s4"># Everything else should be there</span>
            <span class="s1">data</span><span class="s0">, </span><span class="s1">= data</span>
            <span class="s1">xmlstr = xml.etree.ElementTree.tostring(data</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;unicode&quot;</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">metadata_contains[key] </span><span class="s0">in </span><span class="s1">xmlstr</span>


<span class="s0">def </span><span class="s1">test_svg_clear_all_metadata():</span>
    <span class="s4"># Makes sure that setting all default metadata to `None`</span>
    <span class="s4"># removes the metadata tag from the output.</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s0">, </span><span class="s1">metadata={</span><span class="s3">'Date'</span><span class="s1">: </span><span class="s0">None, </span><span class="s3">'Creator'</span><span class="s1">: </span><span class="s0">None,</span>
                                                <span class="s3">'Format'</span><span class="s1">: </span><span class="s0">None, </span><span class="s3">'Type'</span><span class="s1">: </span><span class="s0">None</span><span class="s1">})</span>
        <span class="s1">buf = fd.getvalue().decode()</span>

    <span class="s1">SVGNS = </span><span class="s3">'{http://www.w3.org/2000/svg}'</span>

    <span class="s1">root = xml.etree.ElementTree.fromstring(buf)</span>
    <span class="s0">assert not </span><span class="s1">root.findall(</span><span class="s3">f'./</span><span class="s0">{</span><span class="s1">SVGNS</span><span class="s0">}</span><span class="s3">metadata'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_svg_metadata():</span>
    <span class="s1">single_value = [</span><span class="s3">'Coverage'</span><span class="s0">, </span><span class="s3">'Identifier'</span><span class="s0">, </span><span class="s3">'Language'</span><span class="s0">, </span><span class="s3">'Relation'</span><span class="s0">, </span><span class="s3">'Source'</span><span class="s0">,</span>
                    <span class="s3">'Title'</span><span class="s0">, </span><span class="s3">'Type'</span><span class="s1">]</span>
    <span class="s1">multi_value = [</span><span class="s3">'Contributor'</span><span class="s0">, </span><span class="s3">'Creator'</span><span class="s0">, </span><span class="s3">'Keywords'</span><span class="s0">, </span><span class="s3">'Publisher'</span><span class="s0">, </span><span class="s3">'Rights'</span><span class="s1">]</span>
    <span class="s1">metadata = {</span>
        <span class="s3">'Date'</span><span class="s1">: [datetime.date(</span><span class="s2">1968</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
                 <span class="s1">datetime.datetime(</span><span class="s2">1968</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s3">'Description'</span><span class="s1">: </span><span class="s3">'description</span><span class="s0">\n</span><span class="s3">text'</span><span class="s0">,</span>
        <span class="s1">**{k: </span><span class="s3">f'</span><span class="s0">{</span><span class="s1">k</span><span class="s0">} </span><span class="s3">foo' </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">single_value}</span><span class="s0">,</span>
        <span class="s1">**{k: [</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">k</span><span class="s0">} </span><span class="s3">bar'</span><span class="s0">, </span><span class="s3">f'</span><span class="s0">{</span><span class="s1">k</span><span class="s0">} </span><span class="s3">baz'</span><span class="s1">] </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">multi_value}</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">fig = plt.figure()</span>
    <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s0">, </span><span class="s1">metadata=metadata)</span>
        <span class="s1">buf = fd.getvalue().decode()</span>

    <span class="s1">SVGNS = </span><span class="s3">'{http://www.w3.org/2000/svg}'</span>
    <span class="s1">RDFNS = </span><span class="s3">'{http://www.w3.org/1999/02/22-rdf-syntax-ns#}'</span>
    <span class="s1">CCNS = </span><span class="s3">'{http://creativecommons.org/ns#}'</span>
    <span class="s1">DCNS = </span><span class="s3">'{http://purl.org/dc/elements/1.1/}'</span>

    <span class="s1">root = xml.etree.ElementTree.fromstring(buf)</span>
    <span class="s1">rdf</span><span class="s0">, </span><span class="s1">= root.findall(</span><span class="s3">f'./</span><span class="s0">{</span><span class="s1">SVGNS</span><span class="s0">}</span><span class="s3">metadata/</span><span class="s0">{</span><span class="s1">RDFNS</span><span class="s0">}</span><span class="s3">RDF'</span><span class="s1">)</span>

    <span class="s4"># Check things that are single entries.</span>
    <span class="s1">titles = [node.text </span><span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">root.findall(</span><span class="s3">f'./</span><span class="s0">{</span><span class="s1">SVGNS</span><span class="s0">}</span><span class="s3">title'</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">titles == [metadata[</span><span class="s3">'Title'</span><span class="s1">]]</span>
    <span class="s1">types = [node.attrib[</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">RDFNS</span><span class="s0">}</span><span class="s3">resource'</span><span class="s1">]</span>
             <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">rdf.findall(</span><span class="s3">f'./</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s3">Work/</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}</span><span class="s3">type'</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">types == [metadata[</span><span class="s3">'Type'</span><span class="s1">]]</span>
    <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'Description'</span><span class="s0">, </span><span class="s1">*single_value]:</span>
        <span class="s0">if </span><span class="s1">k == </span><span class="s3">'Type'</span><span class="s1">:</span>
            <span class="s0">continue</span>
        <span class="s1">values = [node.text</span>
                  <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">rdf.findall(</span><span class="s3">f'./</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s3">Work/</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}{</span><span class="s1">k.lower()</span><span class="s0">}</span><span class="s3">'</span><span class="s1">)]</span>
        <span class="s0">assert </span><span class="s1">values == [metadata[k]]</span>

    <span class="s4"># Check things that are multi-value entries.</span>
    <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">multi_value:</span>
        <span class="s0">if </span><span class="s1">k == </span><span class="s3">'Keywords'</span><span class="s1">:</span>
            <span class="s0">continue</span>
        <span class="s1">values = [</span>
            <span class="s1">node.text</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">rdf.findall(</span>
                <span class="s3">f'./</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s3">Work/</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}{</span><span class="s1">k.lower()</span><span class="s0">}</span><span class="s3">/</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s3">Agent/</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}</span><span class="s3">title'</span><span class="s1">)]</span>
        <span class="s0">assert </span><span class="s1">values == metadata[k]</span>

    <span class="s4"># Check special things.</span>
    <span class="s1">dates = [node.text </span><span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">rdf.findall(</span><span class="s3">f'./</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s3">Work/</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}</span><span class="s3">date'</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">dates == [</span><span class="s3">'1968-08-01/1968-08-02T01:02:03'</span><span class="s1">]</span>

    <span class="s1">values = [node.text </span><span class="s0">for </span><span class="s1">node </span><span class="s0">in</span>
              <span class="s1">rdf.findall(</span><span class="s3">f'./</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s3">Work/</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}</span><span class="s3">subject/</span><span class="s0">{</span><span class="s1">RDFNS</span><span class="s0">}</span><span class="s3">Bag/</span><span class="s0">{</span><span class="s1">RDFNS</span><span class="s0">}</span><span class="s3">li'</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">values == metadata[</span><span class="s3">'Keywords'</span><span class="s1">]</span>


<span class="s1">@image_comparison([</span><span class="s3">&quot;multi_font_aspath.svg&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">tol=</span><span class="s2">1.8</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_multi_font_type3():</span>
    <span class="s1">fp = fm.FontProperties(family=[</span><span class="s3">&quot;WenQuanYi Zen Hei&quot;</span><span class="s1">])</span>
    <span class="s0">if </span><span class="s1">Path(fm.findfont(fp)).name != </span><span class="s3">&quot;wqy-zenhei.ttc&quot;</span><span class="s1">:</span>
        <span class="s1">pytest.skip(</span><span class="s3">&quot;Font may be missing&quot;</span><span class="s1">)</span>

    <span class="s1">plt.rc(</span><span class="s3">'font'</span><span class="s0">, </span><span class="s1">family=[</span><span class="s3">'DejaVu Sans'</span><span class="s0">, </span><span class="s3">'WenQuanYi Zen Hei'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s2">27</span><span class="s1">)</span>
    <span class="s1">plt.rc(</span><span class="s3">'svg'</span><span class="s0">, </span><span class="s1">fonttype=</span><span class="s3">'path'</span><span class="s1">)</span>

    <span class="s1">fig = plt.figure()</span>
    <span class="s1">fig.text(</span><span class="s2">0.15</span><span class="s0">, </span><span class="s2">0.475</span><span class="s0">, </span><span class="s3">&quot;There are 几个汉字 in between!&quot;</span><span class="s1">)</span>


<span class="s1">@image_comparison([</span><span class="s3">&quot;multi_font_astext.svg&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_multi_font_type42():</span>
    <span class="s1">fp = fm.FontProperties(family=[</span><span class="s3">&quot;WenQuanYi Zen Hei&quot;</span><span class="s1">])</span>
    <span class="s0">if </span><span class="s1">Path(fm.findfont(fp)).name != </span><span class="s3">&quot;wqy-zenhei.ttc&quot;</span><span class="s1">:</span>
        <span class="s1">pytest.skip(</span><span class="s3">&quot;Font may be missing&quot;</span><span class="s1">)</span>

    <span class="s1">fig = plt.figure()</span>
    <span class="s1">plt.rc(</span><span class="s3">'svg'</span><span class="s0">, </span><span class="s1">fonttype=</span><span class="s3">'none'</span><span class="s1">)</span>

    <span class="s1">plt.rc(</span><span class="s3">'font'</span><span class="s0">, </span><span class="s1">family=[</span><span class="s3">'DejaVu Sans'</span><span class="s0">, </span><span class="s3">'WenQuanYi Zen Hei'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s2">27</span><span class="s1">)</span>
    <span class="s1">fig.text(</span><span class="s2">0.15</span><span class="s0">, </span><span class="s2">0.475</span><span class="s0">, </span><span class="s3">&quot;There are 几个汉字 in between!&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'metadata,error,message'</span><span class="s0">, </span><span class="s1">[</span>
    <span class="s1">({</span><span class="s3">'Date'</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">TypeError</span><span class="s0">, </span><span class="s3">&quot;Invalid type for Date metadata. Expected str&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">({</span><span class="s3">'Date'</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">TypeError</span><span class="s0">,</span>
     <span class="s3">&quot;Invalid type for Date metadata. Expected iterable&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">({</span><span class="s3">'Keywords'</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">TypeError</span><span class="s0">,</span>
     <span class="s3">&quot;Invalid type for Keywords metadata. Expected str&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">({</span><span class="s3">'Keywords'</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">TypeError</span><span class="s0">,</span>
     <span class="s3">&quot;Invalid type for Keywords metadata. Expected iterable&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">({</span><span class="s3">'Creator'</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">TypeError</span><span class="s0">,</span>
     <span class="s3">&quot;Invalid type for Creator metadata. Expected str&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">({</span><span class="s3">'Creator'</span><span class="s1">: [</span><span class="s2">1</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">TypeError</span><span class="s0">,</span>
     <span class="s3">&quot;Invalid type for Creator metadata. Expected iterable&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">({</span><span class="s3">'Title'</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">TypeError</span><span class="s0">,</span>
     <span class="s3">&quot;Invalid type for Title metadata. Expected str&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">({</span><span class="s3">'Format'</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">TypeError</span><span class="s0">,</span>
     <span class="s3">&quot;Invalid type for Format metadata. Expected str&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">({</span><span class="s3">'Foo'</span><span class="s1">: </span><span class="s3">'Bar'</span><span class="s1">}</span><span class="s0">, </span><span class="s1">ValueError</span><span class="s0">, </span><span class="s3">&quot;Unknown metadata key&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_svg_incorrect_metadata(metadata</span><span class="s0">, </span><span class="s1">error</span><span class="s0">, </span><span class="s1">message):</span>
    <span class="s0">with </span><span class="s1">pytest.raises(error</span><span class="s0">, </span><span class="s1">match=message)</span><span class="s0">, </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig = plt.figure()</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s0">, </span><span class="s1">metadata=metadata)</span>


<span class="s0">def </span><span class="s1">test_svg_escape():</span>
    <span class="s1">fig = plt.figure()</span>
    <span class="s1">fig.text(</span><span class="s2">0.5</span><span class="s0">, </span><span class="s2">0.5</span><span class="s0">, </span><span class="s3">&quot;&lt;</span><span class="s0">\'\&quot;</span><span class="s3">&amp;&gt;&quot;</span><span class="s0">, </span><span class="s1">gid=</span><span class="s3">&quot;&lt;</span><span class="s0">\'\&quot;</span><span class="s3">&amp;&gt;&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s1">)</span>
        <span class="s1">buf = fd.getvalue().decode()</span>
        <span class="s0">assert </span><span class="s3">'&amp;lt;&amp;apos;&amp;quot;&amp;amp;&amp;gt;&quot;' </span><span class="s0">in </span><span class="s1">buf</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;font_str&quot;</span><span class="s0">, </span><span class="s1">[</span>
    <span class="s3">&quot;'DejaVu Sans', 'WenQuanYi Zen Hei', 'Arial', sans-serif&quot;</span><span class="s0">,</span>
    <span class="s3">&quot;'DejaVu Serif', 'WenQuanYi Zen Hei', 'Times New Roman', serif&quot;</span><span class="s0">,</span>
    <span class="s3">&quot;'Arial', 'WenQuanYi Zen Hei', cursive&quot;</span><span class="s0">,</span>
    <span class="s3">&quot;'Impact', 'WenQuanYi Zen Hei', fantasy&quot;</span><span class="s0">,</span>
    <span class="s3">&quot;'DejaVu Sans Mono', 'WenQuanYi Zen Hei', 'Courier New', monospace&quot;</span><span class="s0">,</span>
    <span class="s4"># These do not work because the logic to get the font metrics will not find</span>
    <span class="s4"># WenQuanYi as the fallback logic stops with the first fallback font:</span>
    <span class="s4"># &quot;'DejaVu Sans Mono', 'Courier New', 'WenQuanYi Zen Hei', monospace&quot;,</span>
    <span class="s4"># &quot;'DejaVu Sans', 'Arial', 'WenQuanYi Zen Hei', sans-serif&quot;,</span>
    <span class="s4"># &quot;'DejaVu Serif', 'Times New Roman', 'WenQuanYi Zen Hei',  serif&quot;,</span>
<span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;include_generic&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_svg_font_string(font_str</span><span class="s0">, </span><span class="s1">include_generic):</span>
    <span class="s1">fp = fm.FontProperties(family=[</span><span class="s3">&quot;WenQuanYi Zen Hei&quot;</span><span class="s1">])</span>
    <span class="s0">if </span><span class="s1">Path(fm.findfont(fp)).name != </span><span class="s3">&quot;wqy-zenhei.ttc&quot;</span><span class="s1">:</span>
        <span class="s1">pytest.skip(</span><span class="s3">&quot;Font may be missing&quot;</span><span class="s1">)</span>

    <span class="s1">explicit</span><span class="s0">, </span><span class="s1">*rest</span><span class="s0">, </span><span class="s1">generic = map(</span>
        <span class="s0">lambda </span><span class="s1">x: x.strip(</span><span class="s3">&quot;'&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">font_str.split(</span><span class="s3">&quot;, &quot;</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">size = len(generic)</span>
    <span class="s0">if </span><span class="s1">include_generic:</span>
        <span class="s1">rest = rest + [generic]</span>
    <span class="s1">plt.rcParams[</span><span class="s3">f&quot;font.</span><span class="s0">{</span><span class="s1">generic</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s1">] = rest</span>
    <span class="s1">plt.rcParams[</span><span class="s3">&quot;font.size&quot;</span><span class="s1">] = size</span>
    <span class="s1">plt.rcParams[</span><span class="s3">&quot;svg.fonttype&quot;</span><span class="s1">] = </span><span class="s3">&quot;none&quot;</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s0">if </span><span class="s1">generic == </span><span class="s3">&quot;sans-serif&quot;</span><span class="s1">:</span>
        <span class="s1">generic_options = [</span><span class="s3">&quot;sans&quot;</span><span class="s0">, </span><span class="s3">&quot;sans-serif&quot;</span><span class="s0">, </span><span class="s3">&quot;sans serif&quot;</span><span class="s1">]</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">generic_options = [generic]</span>

    <span class="s0">for </span><span class="s1">generic_name </span><span class="s0">in </span><span class="s1">generic_options:</span>
        <span class="s4"># test that fallback works</span>
        <span class="s1">ax.text(</span><span class="s2">0.5</span><span class="s0">, </span><span class="s2">0.5</span><span class="s0">, </span><span class="s3">&quot;There are 几个汉字 in between!&quot;</span><span class="s0">,</span>
                <span class="s1">family=[explicit</span><span class="s0">, </span><span class="s1">generic_name]</span><span class="s0">, </span><span class="s1">ha=</span><span class="s3">&quot;center&quot;</span><span class="s1">)</span>
        <span class="s4"># test deduplication works</span>
        <span class="s1">ax.text(</span><span class="s2">0.5</span><span class="s0">, </span><span class="s2">0.1</span><span class="s0">, </span><span class="s3">&quot;There are 几个汉字 in between!&quot;</span><span class="s0">,</span>
                <span class="s1">family=[explicit</span><span class="s0">, </span><span class="s1">*rest</span><span class="s0">, </span><span class="s1">generic_name]</span><span class="s0">, </span><span class="s1">ha=</span><span class="s3">&quot;center&quot;</span><span class="s1">)</span>
    <span class="s1">ax.axis(</span><span class="s3">&quot;off&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;svg&quot;</span><span class="s1">)</span>
        <span class="s1">buf = fd.getvalue()</span>

    <span class="s1">tree = xml.etree.ElementTree.fromstring(buf)</span>
    <span class="s1">ns = </span><span class="s3">&quot;http://www.w3.org/2000/svg&quot;</span>
    <span class="s1">text_count = </span><span class="s2">0</span>
    <span class="s0">for </span><span class="s1">text_element </span><span class="s0">in </span><span class="s1">tree.findall(</span><span class="s3">f&quot;.//</span><span class="s0">{{{</span><span class="s1">ns</span><span class="s0">}}}</span><span class="s3">text&quot;</span><span class="s1">):</span>
        <span class="s1">text_count += </span><span class="s2">1</span>
        <span class="s1">font_info = dict(</span>
            <span class="s1">map(</span><span class="s0">lambda </span><span class="s1">x: x.strip()</span><span class="s0">, </span><span class="s1">_.strip().split(</span><span class="s3">&quot;:&quot;</span><span class="s1">))</span>
            <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">dict(text_element.items())[</span><span class="s3">&quot;style&quot;</span><span class="s1">].split(</span><span class="s3">&quot;;&quot;</span><span class="s1">)</span>
        <span class="s1">)[</span><span class="s3">&quot;font&quot;</span><span class="s1">]</span>

        <span class="s0">assert </span><span class="s1">font_info == </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">size</span><span class="s0">}</span><span class="s3">px </span><span class="s0">{</span><span class="s1">font_str</span><span class="s0">}</span><span class="s3">&quot;</span>
    <span class="s0">assert </span><span class="s1">text_count == len(ax.texts)</span>


<span class="s0">def </span><span class="s1">test_annotationbbox_gid():</span>
    <span class="s4"># Test that object gid appears in the AnnotationBbox</span>
    <span class="s4"># in output svg.</span>
    <span class="s1">fig = plt.figure()</span>
    <span class="s1">ax = fig.add_subplot()</span>
    <span class="s1">arr_img = np.ones((</span><span class="s2">32</span><span class="s0">, </span><span class="s2">32</span><span class="s1">))</span>
    <span class="s1">xy = (</span><span class="s2">0.3</span><span class="s0">, </span><span class="s2">0.55</span><span class="s1">)</span>

    <span class="s1">imagebox = OffsetImage(arr_img</span><span class="s0">, </span><span class="s1">zoom=</span><span class="s2">0.1</span><span class="s1">)</span>
    <span class="s1">imagebox.image.axes = ax</span>

    <span class="s1">ab = AnnotationBbox(imagebox</span><span class="s0">, </span><span class="s1">xy</span><span class="s0">,</span>
                        <span class="s1">xybox=(</span><span class="s2">120.</span><span class="s0">, </span><span class="s1">-</span><span class="s2">80.</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">xycoords=</span><span class="s3">'data'</span><span class="s0">,</span>
                        <span class="s1">boxcoords=</span><span class="s3">&quot;offset points&quot;</span><span class="s0">,</span>
                        <span class="s1">pad=</span><span class="s2">0.5</span><span class="s0">,</span>
                        <span class="s1">arrowprops=dict(</span>
                            <span class="s1">arrowstyle=</span><span class="s3">&quot;-&gt;&quot;</span><span class="s0">,</span>
                            <span class="s1">connectionstyle=</span><span class="s3">&quot;angle,angleA=0,angleB=90,rad=3&quot;</span><span class="s1">)</span>
                        <span class="s1">)</span>
    <span class="s1">ab.set_gid(</span><span class="s3">&quot;a test for issue 20044&quot;</span><span class="s1">)</span>
    <span class="s1">ax.add_artist(ab)</span>

    <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">'svg'</span><span class="s1">)</span>
        <span class="s1">buf = fd.getvalue().decode(</span><span class="s3">'utf-8'</span><span class="s1">)</span>

    <span class="s1">expected = </span><span class="s3">'&lt;g id=&quot;a test for issue 20044&quot;&gt;'</span>
    <span class="s0">assert </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">buf</span>
</pre>
</body>
</html>