<html>
<head>
<title>test_character.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_character.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">textwrap</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_array_equal</span><span class="s0">, </span><span class="s1">assert_equal</span><span class="s0">, </span><span class="s1">assert_raises</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.f2py.tests </span><span class="s0">import </span><span class="s1">util</span>


<span class="s0">class </span><span class="s1">TestCharacterString(util.F2PyTest):</span>
    <span class="s2"># options = ['--debug-capi', '--build-dir', '/tmp/test-build-f2py']</span>
    <span class="s1">suffix = </span><span class="s3">'.f90'</span>
    <span class="s1">fprefix = </span><span class="s3">'test_character_string'</span>
    <span class="s1">length_list = [</span><span class="s3">'1'</span><span class="s0">, </span><span class="s3">'3'</span><span class="s0">, </span><span class="s3">'star'</span><span class="s1">]</span>

    <span class="s1">code = </span><span class="s3">''</span>
    <span class="s0">for </span><span class="s1">length </span><span class="s0">in </span><span class="s1">length_list:</span>
        <span class="s1">fsuffix = length</span>
        <span class="s1">clength = dict(star=</span><span class="s3">'(*)'</span><span class="s1">).get(length</span><span class="s0">, </span><span class="s1">length)</span>

        <span class="s1">code += textwrap.dedent(</span><span class="s3">f&quot;&quot;&quot;</span>

        <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_input_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span><span class="s3">(c, o, n)</span>
          <span class="s3">character*</span><span class="s0">{</span><span class="s1">clength</span><span class="s0">}</span><span class="s3">, intent(in) :: c</span>
          <span class="s3">integer n</span>
          <span class="s3">!f2py integer, depend(c), intent(hide) :: n = slen(c)</span>
          <span class="s3">integer*1, dimension(n) :: o</span>
          <span class="s3">!f2py intent(out) o</span>
          <span class="s3">o = transfer(c, o)</span>
        <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_input_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span>

        <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_output_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span><span class="s3">(c, o, n)</span>
          <span class="s3">character*</span><span class="s0">{</span><span class="s1">clength</span><span class="s0">}</span><span class="s3">, intent(out) :: c</span>
          <span class="s3">integer n</span>
          <span class="s3">integer*1, dimension(n), intent(in) :: o</span>
          <span class="s3">!f2py integer, depend(o), intent(hide) :: n = len(o)</span>
          <span class="s3">c = transfer(o, c)</span>
        <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_output_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span>

        <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_array_input_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span><span class="s3">(c, o, m, n)</span>
          <span class="s3">integer m, i, n</span>
          <span class="s3">character*</span><span class="s0">{</span><span class="s1">clength</span><span class="s0">}</span><span class="s3">, intent(in), dimension(m) :: c</span>
          <span class="s3">!f2py integer, depend(c), intent(hide) :: m = len(c)</span>
          <span class="s3">!f2py integer, depend(c), intent(hide) :: n = f2py_itemsize(c)</span>
          <span class="s3">integer*1, dimension(m, n), intent(out) :: o</span>
          <span class="s3">do i=1,m</span>
            <span class="s3">o(i, :) = transfer(c(i), o(i, :))</span>
          <span class="s3">end do</span>
        <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_array_input_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span>

        <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_array_output_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span><span class="s3">(c, o, m, n)</span>
          <span class="s3">character*</span><span class="s0">{</span><span class="s1">clength</span><span class="s0">}</span><span class="s3">, intent(out), dimension(m) :: c</span>
          <span class="s3">integer n</span>
          <span class="s3">integer*1, dimension(m, n), intent(in) :: o</span>
          <span class="s3">!f2py character(f2py_len=n) :: c</span>
          <span class="s3">!f2py integer, depend(o), intent(hide) :: m = len(o)</span>
          <span class="s3">!f2py integer, depend(o), intent(hide) :: n = shape(o, 1)</span>
          <span class="s3">do i=1,m</span>
            <span class="s3">c(i) = transfer(o(i, :), c(i))</span>
          <span class="s3">end do</span>
        <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_array_output_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span>

        <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_2d_array_input_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span><span class="s3">(c, o, m1, m2, n)</span>
          <span class="s3">integer m1, m2, i, j, n</span>
          <span class="s3">character*</span><span class="s0">{</span><span class="s1">clength</span><span class="s0">}</span><span class="s3">, intent(in), dimension(m1, m2) :: c</span>
          <span class="s3">!f2py integer, depend(c), intent(hide) :: m1 = len(c)</span>
          <span class="s3">!f2py integer, depend(c), intent(hide) :: m2 = shape(c, 1)</span>
          <span class="s3">!f2py integer, depend(c), intent(hide) :: n = f2py_itemsize(c)</span>
          <span class="s3">integer*1, dimension(m1, m2, n), intent(out) :: o</span>
          <span class="s3">do i=1,m1</span>
            <span class="s3">do j=1,m2</span>
              <span class="s3">o(i, j, :) = transfer(c(i, j), o(i, j, :))</span>
            <span class="s3">end do</span>
          <span class="s3">end do</span>
        <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_2d_array_input_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span>
        <span class="s3">&quot;&quot;&quot;</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;length&quot;</span><span class="s0">, </span><span class="s1">length_list)</span>
    <span class="s0">def </span><span class="s1">test_input(self</span><span class="s0">, </span><span class="s1">length):</span>
        <span class="s1">fsuffix = {</span><span class="s3">'(*)'</span><span class="s1">: </span><span class="s3">'star'</span><span class="s1">}.get(length</span><span class="s0">, </span><span class="s1">length)</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_input_' </span><span class="s1">+ fsuffix)</span>

        <span class="s1">a = {</span><span class="s3">'1'</span><span class="s1">: </span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'3'</span><span class="s1">: </span><span class="s3">'abc'</span><span class="s0">, </span><span class="s3">'star'</span><span class="s1">: </span><span class="s3">'abcde' </span><span class="s1">* </span><span class="s4">3</span><span class="s1">}[length]</span>

        <span class="s1">assert_array_equal(f(a)</span><span class="s0">, </span><span class="s1">np.array(list(map(ord</span><span class="s0">, </span><span class="s1">a))</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'u1'</span><span class="s1">))</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;length&quot;</span><span class="s0">, </span><span class="s1">length_list[:-</span><span class="s4">1</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_output(self</span><span class="s0">, </span><span class="s1">length):</span>
        <span class="s1">fsuffix = length</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_output_' </span><span class="s1">+ fsuffix)</span>

        <span class="s1">a = {</span><span class="s3">'1'</span><span class="s1">: </span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'3'</span><span class="s1">: </span><span class="s3">'abc'</span><span class="s1">}[length]</span>

        <span class="s1">assert_array_equal(f(np.array(list(map(ord</span><span class="s0">, </span><span class="s1">a))</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'u1'</span><span class="s1">))</span><span class="s0">,</span>
                           <span class="s1">a.encode())</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;length&quot;</span><span class="s0">, </span><span class="s1">length_list)</span>
    <span class="s0">def </span><span class="s1">test_array_input(self</span><span class="s0">, </span><span class="s1">length):</span>
        <span class="s1">fsuffix = length</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_array_input_' </span><span class="s1">+ fsuffix)</span>

        <span class="s1">a = np.array([{</span><span class="s3">'1'</span><span class="s1">: </span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'3'</span><span class="s1">: </span><span class="s3">'abc'</span><span class="s0">, </span><span class="s3">'star'</span><span class="s1">: </span><span class="s3">'abcde' </span><span class="s1">* </span><span class="s4">3</span><span class="s1">}[length]</span><span class="s0">,</span>
                      <span class="s1">{</span><span class="s3">'1'</span><span class="s1">: </span><span class="s3">'A'</span><span class="s0">, </span><span class="s3">'3'</span><span class="s1">: </span><span class="s3">'ABC'</span><span class="s0">, </span><span class="s3">'star'</span><span class="s1">: </span><span class="s3">'ABCDE' </span><span class="s1">* </span><span class="s4">3</span><span class="s1">}[length]</span><span class="s0">,</span>
                      <span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'S'</span><span class="s1">)</span>

        <span class="s1">expected = np.array([[c </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">s] </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">a]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'u1'</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(f(a)</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;length&quot;</span><span class="s0">, </span><span class="s1">length_list)</span>
    <span class="s0">def </span><span class="s1">test_array_output(self</span><span class="s0">, </span><span class="s1">length):</span>
        <span class="s1">fsuffix = length</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_array_output_' </span><span class="s1">+ fsuffix)</span>

        <span class="s1">expected = np.array(</span>
            <span class="s1">[{</span><span class="s3">'1'</span><span class="s1">: </span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'3'</span><span class="s1">: </span><span class="s3">'abc'</span><span class="s0">, </span><span class="s3">'star'</span><span class="s1">: </span><span class="s3">'abcde' </span><span class="s1">* </span><span class="s4">3</span><span class="s1">}[length]</span><span class="s0">,</span>
             <span class="s1">{</span><span class="s3">'1'</span><span class="s1">: </span><span class="s3">'A'</span><span class="s0">, </span><span class="s3">'3'</span><span class="s1">: </span><span class="s3">'ABC'</span><span class="s0">, </span><span class="s3">'star'</span><span class="s1">: </span><span class="s3">'ABCDE' </span><span class="s1">* </span><span class="s4">3</span><span class="s1">}[length]]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'S'</span><span class="s1">)</span>

        <span class="s1">a = np.array([[c </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">s] </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">expected]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'u1'</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(f(a)</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;length&quot;</span><span class="s0">, </span><span class="s1">length_list)</span>
    <span class="s0">def </span><span class="s1">test_2d_array_input(self</span><span class="s0">, </span><span class="s1">length):</span>
        <span class="s1">fsuffix = length</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_2d_array_input_' </span><span class="s1">+ fsuffix)</span>

        <span class="s1">a = np.array([[{</span><span class="s3">'1'</span><span class="s1">: </span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'3'</span><span class="s1">: </span><span class="s3">'abc'</span><span class="s0">, </span><span class="s3">'star'</span><span class="s1">: </span><span class="s3">'abcde' </span><span class="s1">* </span><span class="s4">3</span><span class="s1">}[length]</span><span class="s0">,</span>
                       <span class="s1">{</span><span class="s3">'1'</span><span class="s1">: </span><span class="s3">'A'</span><span class="s0">, </span><span class="s3">'3'</span><span class="s1">: </span><span class="s3">'ABC'</span><span class="s0">, </span><span class="s3">'star'</span><span class="s1">: </span><span class="s3">'ABCDE' </span><span class="s1">* </span><span class="s4">3</span><span class="s1">}[length]]</span><span class="s0">,</span>
                      <span class="s1">[{</span><span class="s3">'1'</span><span class="s1">: </span><span class="s3">'f'</span><span class="s0">, </span><span class="s3">'3'</span><span class="s1">: </span><span class="s3">'fgh'</span><span class="s0">, </span><span class="s3">'star'</span><span class="s1">: </span><span class="s3">'fghij' </span><span class="s1">* </span><span class="s4">3</span><span class="s1">}[length]</span><span class="s0">,</span>
                       <span class="s1">{</span><span class="s3">'1'</span><span class="s1">: </span><span class="s3">'F'</span><span class="s0">, </span><span class="s3">'3'</span><span class="s1">: </span><span class="s3">'FGH'</span><span class="s0">, </span><span class="s3">'star'</span><span class="s1">: </span><span class="s3">'FGHIJ' </span><span class="s1">* </span><span class="s4">3</span><span class="s1">}[length]]]</span><span class="s0">,</span>
                     <span class="s1">dtype=</span><span class="s3">'S'</span><span class="s1">)</span>
        <span class="s1">expected = np.array([[[c </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">item] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">row] </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">a]</span><span class="s0">,</span>
                            <span class="s1">dtype=</span><span class="s3">'u1'</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(f(a)</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">class </span><span class="s1">TestCharacter(util.F2PyTest):</span>
    <span class="s2"># options = ['--debug-capi', '--build-dir', '/tmp/test-build-f2py']</span>
    <span class="s1">suffix = </span><span class="s3">'.f90'</span>
    <span class="s1">fprefix = </span><span class="s3">'test_character'</span>

    <span class="s1">code = textwrap.dedent(</span><span class="s3">f&quot;&quot;&quot;</span>
       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_input(c, o)</span>
          <span class="s3">character, intent(in) :: c</span>
          <span class="s3">integer*1 o</span>
          <span class="s3">!f2py intent(out) o</span>
          <span class="s3">o = transfer(c, o)</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_input</span>

       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_output(c, o)</span>
          <span class="s3">character :: c</span>
          <span class="s3">integer*1, intent(in) :: o</span>
          <span class="s3">!f2py intent(out) c</span>
          <span class="s3">c = transfer(o, c)</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_output</span>

       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_input_output(c, o)</span>
          <span class="s3">character, intent(in) :: c</span>
          <span class="s3">character o</span>
          <span class="s3">!f2py intent(out) o</span>
          <span class="s3">o = c</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_input_output</span>

       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_inout(c, n)</span>
          <span class="s3">character :: c, n</span>
          <span class="s3">!f2py intent(in) n</span>
          <span class="s3">!f2py intent(inout) c</span>
          <span class="s3">c = n</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_inout</span>

       <span class="s3">function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_return(o) result (c)</span>
          <span class="s3">character :: c</span>
          <span class="s3">character, intent(in) :: o</span>
          <span class="s3">c = transfer(o, c)</span>
       <span class="s3">end function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_return</span>

       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_array_input(c, o)</span>
          <span class="s3">character, intent(in) :: c(3)</span>
          <span class="s3">integer*1 o(3)</span>
          <span class="s3">!f2py intent(out) o</span>
          <span class="s3">integer i</span>
          <span class="s3">do i=1,3</span>
            <span class="s3">o(i) = transfer(c(i), o(i))</span>
          <span class="s3">end do</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_array_input</span>

       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_2d_array_input(c, o)</span>
          <span class="s3">character, intent(in) :: c(2, 3)</span>
          <span class="s3">integer*1 o(2, 3)</span>
          <span class="s3">!f2py intent(out) o</span>
          <span class="s3">integer i, j</span>
          <span class="s3">do i=1,2</span>
            <span class="s3">do j=1,3</span>
              <span class="s3">o(i, j) = transfer(c(i, j), o(i, j))</span>
            <span class="s3">end do</span>
          <span class="s3">end do</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_2d_array_input</span>

       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_array_output(c, o)</span>
          <span class="s3">character :: c(3)</span>
          <span class="s3">integer*1, intent(in) :: o(3)</span>
          <span class="s3">!f2py intent(out) c</span>
          <span class="s3">do i=1,3</span>
            <span class="s3">c(i) = transfer(o(i), c(i))</span>
          <span class="s3">end do</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_array_output</span>

       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_array_inout(c, n)</span>
          <span class="s3">character :: c(3), n(3)</span>
          <span class="s3">!f2py intent(in) n(3)</span>
          <span class="s3">!f2py intent(inout) c(3)</span>
          <span class="s3">do i=1,3</span>
            <span class="s3">c(i) = n(i)</span>
          <span class="s3">end do</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_array_inout</span>

       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_2d_array_inout(c, n)</span>
          <span class="s3">character :: c(2, 3), n(2, 3)</span>
          <span class="s3">!f2py intent(in) n(2, 3)</span>
          <span class="s3">!f2py intent(inout) c(2. 3)</span>
          <span class="s3">integer i, j</span>
          <span class="s3">do i=1,2</span>
            <span class="s3">do j=1,3</span>
              <span class="s3">c(i, j) = n(i, j)</span>
            <span class="s3">end do</span>
          <span class="s3">end do</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_2d_array_inout</span>

       <span class="s3">function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_array_return(o) result (c)</span>
          <span class="s3">character, dimension(3) :: c</span>
          <span class="s3">character, intent(in) :: o(3)</span>
          <span class="s3">do i=1,3</span>
            <span class="s3">c(i) = o(i)</span>
          <span class="s3">end do</span>
       <span class="s3">end function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_array_return</span>

       <span class="s3">function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_optional(o) result (c)</span>
          <span class="s3">character, intent(in) :: o</span>
          <span class="s3">!f2py character o = &quot;a&quot;</span>
          <span class="s3">character :: c</span>
          <span class="s3">c = o</span>
       <span class="s3">end function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_optional</span>
    <span class="s3">&quot;&quot;&quot;</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'c'</span><span class="s0">, </span><span class="s3">'S1'</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_input(self</span><span class="s0">, </span><span class="s1">dtype):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_input'</span><span class="s1">)</span>

        <span class="s1">assert_equal(f(np.array(</span><span class="s3">'a'</span><span class="s0">, </span><span class="s1">dtype=dtype))</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">'a'</span><span class="s1">))</span>
        <span class="s1">assert_equal(f(np.array(</span><span class="s5">b'a'</span><span class="s0">, </span><span class="s1">dtype=dtype))</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">'a'</span><span class="s1">))</span>
        <span class="s1">assert_equal(f(np.array([</span><span class="s3">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype))</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">'a'</span><span class="s1">))</span>
        <span class="s1">assert_equal(f(np.array(</span><span class="s3">'abc'</span><span class="s0">, </span><span class="s1">dtype=dtype))</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">'a'</span><span class="s1">))</span>
        <span class="s1">assert_equal(f(np.array([[</span><span class="s3">'a'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=dtype))</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">'a'</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_input_varia(self):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_input'</span><span class="s1">)</span>

        <span class="s1">assert_equal(f(</span><span class="s3">'a'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">'a'</span><span class="s1">))</span>
        <span class="s1">assert_equal(f(</span><span class="s5">b'a'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ord(</span><span class="s5">b'a'</span><span class="s1">))</span>
        <span class="s1">assert_equal(f(</span><span class="s3">''</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(f(</span><span class="s5">b''</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(f(</span><span class="s5">b'</span><span class="s0">\0</span><span class="s5">'</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(f(</span><span class="s3">'ab'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">'a'</span><span class="s1">))</span>
        <span class="s1">assert_equal(f(</span><span class="s5">b'ab'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">'a'</span><span class="s1">))</span>
        <span class="s1">assert_equal(f([</span><span class="s3">'a'</span><span class="s1">])</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">'a'</span><span class="s1">))</span>

        <span class="s1">assert_equal(f(np.array(</span><span class="s5">b'a'</span><span class="s1">))</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">'a'</span><span class="s1">))</span>
        <span class="s1">assert_equal(f(np.array([</span><span class="s5">b'a'</span><span class="s1">]))</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">'a'</span><span class="s1">))</span>
        <span class="s1">a = np.array(</span><span class="s3">'a'</span><span class="s1">)</span>
        <span class="s1">assert_equal(f(a)</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">'a'</span><span class="s1">))</span>
        <span class="s1">a = np.array([</span><span class="s3">'a'</span><span class="s1">])</span>
        <span class="s1">assert_equal(f(a)</span><span class="s0">, </span><span class="s1">ord(</span><span class="s3">'a'</span><span class="s1">))</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">f([])</span>
        <span class="s0">except </span><span class="s1">IndexError </span><span class="s0">as </span><span class="s1">msg:</span>
            <span class="s0">if not </span><span class="s1">str(msg).endswith(</span><span class="s3">' got 0-list'</span><span class="s1">):</span>
                <span class="s0">raise</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">SystemError(</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">f.__name__</span><span class="s0">} </span><span class="s3">should have failed on empty list'</span><span class="s1">)</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">f(</span><span class="s4">97</span><span class="s1">)</span>
        <span class="s0">except </span><span class="s1">TypeError </span><span class="s0">as </span><span class="s1">msg:</span>
            <span class="s0">if not </span><span class="s1">str(msg).endswith(</span><span class="s3">' got int instance'</span><span class="s1">):</span>
                <span class="s0">raise</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">SystemError(</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">f.__name__</span><span class="s0">} </span><span class="s3">should have failed on int value'</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'c'</span><span class="s0">, </span><span class="s3">'S1'</span><span class="s0">, </span><span class="s3">'U1'</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_array_input(self</span><span class="s0">, </span><span class="s1">dtype):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_array_input'</span><span class="s1">)</span>

        <span class="s1">assert_array_equal(f(np.array([</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'b'</span><span class="s0">, </span><span class="s3">'c'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype))</span><span class="s0">,</span>
                           <span class="s1">np.array(list(map(ord</span><span class="s0">, </span><span class="s3">'abc'</span><span class="s1">))</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'i1'</span><span class="s1">))</span>
        <span class="s1">assert_array_equal(f(np.array([</span><span class="s5">b'a'</span><span class="s0">, </span><span class="s5">b'b'</span><span class="s0">, </span><span class="s5">b'c'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype))</span><span class="s0">,</span>
                           <span class="s1">np.array(list(map(ord</span><span class="s0">, </span><span class="s3">'abc'</span><span class="s1">))</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'i1'</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_array_input_varia(self):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_array_input'</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(f([</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'b'</span><span class="s0">, </span><span class="s3">'c'</span><span class="s1">])</span><span class="s0">,</span>
                           <span class="s1">np.array(list(map(ord</span><span class="s0">, </span><span class="s3">'abc'</span><span class="s1">))</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'i1'</span><span class="s1">))</span>
        <span class="s1">assert_array_equal(f([</span><span class="s5">b'a'</span><span class="s0">, </span><span class="s5">b'b'</span><span class="s0">, </span><span class="s5">b'c'</span><span class="s1">])</span><span class="s0">,</span>
                           <span class="s1">np.array(list(map(ord</span><span class="s0">, </span><span class="s3">'abc'</span><span class="s1">))</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'i1'</span><span class="s1">))</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">f([</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'b'</span><span class="s0">, </span><span class="s3">'c'</span><span class="s0">, </span><span class="s3">'d'</span><span class="s1">])</span>
        <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">msg:</span>
            <span class="s0">if not </span><span class="s1">str(msg).endswith(</span>
                    <span class="s3">'th dimension must be fixed to 3 but got 4'</span><span class="s1">):</span>
                <span class="s0">raise</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">SystemError(</span>
                <span class="s3">f'</span><span class="s0">{</span><span class="s1">f.__name__</span><span class="s0">} </span><span class="s3">should have failed on wrong input'</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'c'</span><span class="s0">, </span><span class="s3">'S1'</span><span class="s0">, </span><span class="s3">'U1'</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_2d_array_input(self</span><span class="s0">, </span><span class="s1">dtype):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_2d_array_input'</span><span class="s1">)</span>

        <span class="s1">a = np.array([[</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'b'</span><span class="s0">, </span><span class="s3">'c'</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[</span><span class="s3">'d'</span><span class="s0">, </span><span class="s3">'e'</span><span class="s0">, </span><span class="s3">'f'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span>
        <span class="s1">expected = a.view(np.uint32 </span><span class="s0">if </span><span class="s1">dtype == </span><span class="s3">'U1' </span><span class="s0">else </span><span class="s1">np.uint8)</span>
        <span class="s1">assert_array_equal(f(a)</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s0">def </span><span class="s1">test_output(self):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_output'</span><span class="s1">)</span>

        <span class="s1">assert_equal(f(ord(</span><span class="s5">b'a'</span><span class="s1">))</span><span class="s0">, </span><span class="s5">b'a'</span><span class="s1">)</span>
        <span class="s1">assert_equal(f(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s5">b'</span><span class="s0">\0</span><span class="s5">'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_array_output(self):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_array_output'</span><span class="s1">)</span>

        <span class="s1">assert_array_equal(f(list(map(ord</span><span class="s0">, </span><span class="s3">'abc'</span><span class="s1">)))</span><span class="s0">,</span>
                           <span class="s1">np.array(list(</span><span class="s3">'abc'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'S1'</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_input_output(self):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_input_output'</span><span class="s1">)</span>

        <span class="s1">assert_equal(f(</span><span class="s5">b'a'</span><span class="s1">)</span><span class="s0">, </span><span class="s5">b'a'</span><span class="s1">)</span>
        <span class="s1">assert_equal(f(</span><span class="s3">'a'</span><span class="s1">)</span><span class="s0">, </span><span class="s5">b'a'</span><span class="s1">)</span>
        <span class="s1">assert_equal(f(</span><span class="s3">''</span><span class="s1">)</span><span class="s0">, </span><span class="s5">b'</span><span class="s0">\0</span><span class="s5">'</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'c'</span><span class="s0">, </span><span class="s3">'S1'</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_inout(self</span><span class="s0">, </span><span class="s1">dtype):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_inout'</span><span class="s1">)</span>

        <span class="s1">a = np.array(list(</span><span class="s3">'abc'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">f(a</span><span class="s0">, </span><span class="s3">'A'</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">np.array(list(</span><span class="s3">'Abc'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=a.dtype))</span>
        <span class="s1">f(a[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s3">'B'</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">np.array(list(</span><span class="s3">'ABc'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=a.dtype))</span>

        <span class="s1">a = np.array([</span><span class="s3">'abc'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">f(a</span><span class="s0">, </span><span class="s3">'A'</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">'Abc'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=a.dtype))</span>

    <span class="s0">def </span><span class="s1">test_inout_varia(self):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_inout'</span><span class="s1">)</span>
        <span class="s1">a = np.array(</span><span class="s3">'abc'</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'S3'</span><span class="s1">)</span>
        <span class="s1">f(a</span><span class="s0">, </span><span class="s3">'A'</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">np.array(</span><span class="s3">'Abc'</span><span class="s0">, </span><span class="s1">dtype=a.dtype))</span>

        <span class="s1">a = np.array([</span><span class="s3">'abc'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'S3'</span><span class="s1">)</span>
        <span class="s1">f(a</span><span class="s0">, </span><span class="s3">'A'</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">'Abc'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=a.dtype))</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">f(</span><span class="s3">'abc'</span><span class="s0">, </span><span class="s3">'A'</span><span class="s1">)</span>
        <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">msg:</span>
            <span class="s0">if not </span><span class="s1">str(msg).endswith(</span><span class="s3">' got 3-str'</span><span class="s1">):</span>
                <span class="s0">raise</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">SystemError(</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">f.__name__</span><span class="s0">} </span><span class="s3">should have failed on str value'</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'c'</span><span class="s0">, </span><span class="s3">'S1'</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_array_inout(self</span><span class="s0">, </span><span class="s1">dtype):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_array_inout'</span><span class="s1">)</span>
        <span class="s1">n = np.array([</span><span class="s3">'A'</span><span class="s0">, </span><span class="s3">'B'</span><span class="s0">, </span><span class="s3">'C'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span>

        <span class="s1">a = np.array([</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'b'</span><span class="s0">, </span><span class="s3">'c'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span>
        <span class="s1">f(a</span><span class="s0">, </span><span class="s1">n)</span>
        <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">n)</span>

        <span class="s1">a = np.array([</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'b'</span><span class="s0">, </span><span class="s3">'c'</span><span class="s0">, </span><span class="s3">'d'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">f(a[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">n)</span>
        <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'A'</span><span class="s0">, </span><span class="s3">'B'</span><span class="s0">, </span><span class="s3">'C'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype))</span>

        <span class="s1">a = np.array([[</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'b'</span><span class="s0">, </span><span class="s3">'c'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span>
        <span class="s1">f(a</span><span class="s0">, </span><span class="s1">n)</span>
        <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">np.array([[</span><span class="s3">'A'</span><span class="s0">, </span><span class="s3">'B'</span><span class="s0">, </span><span class="s3">'C'</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=dtype))</span>

        <span class="s1">a = np.array([</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'b'</span><span class="s0">, </span><span class="s3">'c'</span><span class="s0">, </span><span class="s3">'d'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">f(a</span><span class="s0">, </span><span class="s1">n)</span>
        <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">msg:</span>
            <span class="s0">if not </span><span class="s1">str(msg).endswith(</span>
                    <span class="s3">'th dimension must be fixed to 3 but got 4'</span><span class="s1">):</span>
                <span class="s0">raise</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">SystemError(</span>
                <span class="s3">f'</span><span class="s0">{</span><span class="s1">f.__name__</span><span class="s0">} </span><span class="s3">should have failed on wrong input'</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'c'</span><span class="s0">, </span><span class="s3">'S1'</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_2d_array_inout(self</span><span class="s0">, </span><span class="s1">dtype):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_2d_array_inout'</span><span class="s1">)</span>
        <span class="s1">n = np.array([[</span><span class="s3">'A'</span><span class="s0">, </span><span class="s3">'B'</span><span class="s0">, </span><span class="s3">'C'</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[</span><span class="s3">'D'</span><span class="s0">, </span><span class="s3">'E'</span><span class="s0">, </span><span class="s3">'F'</span><span class="s1">]]</span><span class="s0">,</span>
                     <span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span>
        <span class="s1">a = np.array([[</span><span class="s3">'a'</span><span class="s0">, </span><span class="s3">'b'</span><span class="s0">, </span><span class="s3">'c'</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[</span><span class="s3">'d'</span><span class="s0">, </span><span class="s3">'e'</span><span class="s0">, </span><span class="s3">'f'</span><span class="s1">]]</span><span class="s0">,</span>
                     <span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">order=</span><span class="s3">'F'</span><span class="s1">)</span>
        <span class="s1">f(a</span><span class="s0">, </span><span class="s1">n)</span>
        <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">n)</span>

    <span class="s0">def </span><span class="s1">test_return(self):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_return'</span><span class="s1">)</span>

        <span class="s1">assert_equal(f(</span><span class="s3">'a'</span><span class="s1">)</span><span class="s0">, </span><span class="s5">b'a'</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.skip(</span><span class="s3">'fortran function returning array segfaults'</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_array_return(self):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_array_return'</span><span class="s1">)</span>

        <span class="s1">a = np.array(list(</span><span class="s3">'abc'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'S1'</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(f(a)</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_optional(self):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_optional'</span><span class="s1">)</span>

        <span class="s1">assert_equal(f()</span><span class="s0">, </span><span class="s5">b&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(f(</span><span class="s5">b'B'</span><span class="s1">)</span><span class="s0">, </span><span class="s5">b&quot;B&quot;</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestMiscCharacter(util.F2PyTest):</span>
    <span class="s2"># options = ['--debug-capi', '--build-dir', '/tmp/test-build-f2py']</span>
    <span class="s1">suffix = </span><span class="s3">'.f90'</span>
    <span class="s1">fprefix = </span><span class="s3">'test_misc_character'</span>

    <span class="s1">code = textwrap.dedent(</span><span class="s3">f&quot;&quot;&quot;</span>
       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_gh18684(x, y, m)</span>
         <span class="s3">character(len=5), dimension(m), intent(in) :: x</span>
         <span class="s3">character*5, dimension(m), intent(out) :: y</span>
         <span class="s3">integer i, m</span>
         <span class="s3">!f2py integer, intent(hide), depend(x) :: m = f2py_len(x)</span>
         <span class="s3">do i=1,m</span>
           <span class="s3">y(i) = x(i)</span>
         <span class="s3">end do</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_gh18684</span>

       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_gh6308(x, i)</span>
         <span class="s3">integer i</span>
         <span class="s3">!f2py check(i&gt;=0 &amp;&amp; i&lt;12) i</span>
         <span class="s3">character*5 name, x</span>
         <span class="s3">common name(12)</span>
         <span class="s3">name(i + 1) = x</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_gh6308</span>

       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_gh4519(x)</span>
         <span class="s3">character(len=*), intent(in) :: x(:)</span>
         <span class="s3">!f2py intent(out) x</span>
         <span class="s3">integer :: i</span>
         <span class="s3">do i=1, size(x)</span>
           <span class="s3">print*, &quot;x(&quot;,i,&quot;)=&quot;, x(i)</span>
         <span class="s3">end do</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_gh4519</span>

       <span class="s3">pure function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_gh3425(x) result (y)</span>
         <span class="s3">character(len=*), intent(in) :: x</span>
         <span class="s3">character(len=len(x)) :: y</span>
         <span class="s3">integer :: i</span>
         <span class="s3">do i = 1, len(x)</span>
           <span class="s3">j = iachar(x(i:i))</span>
           <span class="s3">if (j&gt;=iachar(&quot;a&quot;) .and. j&lt;=iachar(&quot;z&quot;) ) then</span>
             <span class="s3">y(i:i) = achar(j-32)</span>
           <span class="s3">else</span>
             <span class="s3">y(i:i) = x(i:i)</span>
           <span class="s3">endif</span>
         <span class="s3">end do</span>
       <span class="s3">end function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_gh3425</span>

       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_character_bc_new(x, y, z)</span>
         <span class="s3">character, intent(in) :: x</span>
         <span class="s3">character, intent(out) :: y</span>
         <span class="s3">!f2py character, depend(x) :: y = x</span>
         <span class="s3">!f2py character, dimension((x=='a'?1:2)), depend(x), intent(out) :: z</span>
         <span class="s3">character, dimension(*) :: z</span>
         <span class="s3">!f2py character, optional, check(x == 'a' || x == 'b') :: x = 'a'</span>
         <span class="s3">!f2py callstatement (*f2py_func)(&amp;x, &amp;y, z)</span>
         <span class="s3">!f2py callprotoargument character*, character*, character*</span>
         <span class="s3">if (y.eq.x) then</span>
           <span class="s3">y = x</span>
         <span class="s3">else</span>
           <span class="s3">y = 'e'</span>
         <span class="s3">endif</span>
         <span class="s3">z(1) = 'c'</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_character_bc_new</span>

       <span class="s3">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_character_bc_old(x, y, z)</span>
         <span class="s3">character, intent(in) :: x</span>
         <span class="s3">character, intent(out) :: y</span>
         <span class="s3">!f2py character, depend(x) :: y = x[0]</span>
         <span class="s3">!f2py character, dimension((*x=='a'?1:2)), depend(x), intent(out) :: z</span>
         <span class="s3">character, dimension(*) :: z</span>
         <span class="s3">!f2py character, optional, check(*x == 'a' || x[0] == 'b') :: x = 'a'</span>
         <span class="s3">!f2py callstatement (*f2py_func)(x, y, z)</span>
         <span class="s3">!f2py callprotoargument char*, char*, char*</span>
          <span class="s3">if (y.eq.x) then</span>
           <span class="s3">y = x</span>
         <span class="s3">else</span>
           <span class="s3">y = 'e'</span>
         <span class="s3">endif</span>
         <span class="s3">z(1) = 'c'</span>
       <span class="s3">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s3">_character_bc_old</span>
    <span class="s3">&quot;&quot;&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_gh18684(self):</span>
        <span class="s2"># Test character(len=5) and character*5 usages</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_gh18684'</span><span class="s1">)</span>
        <span class="s1">x = np.array([</span><span class="s3">&quot;abcde&quot;</span><span class="s0">, </span><span class="s3">&quot;fghij&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'S5'</span><span class="s1">)</span>
        <span class="s1">y = f(x)</span>

        <span class="s1">assert_array_equal(x</span><span class="s0">, </span><span class="s1">y)</span>

    <span class="s0">def </span><span class="s1">test_gh6308(self):</span>
        <span class="s2"># Test character string array in a common block</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_gh6308'</span><span class="s1">)</span>

        <span class="s1">assert_equal(self.module._BLNK_.name.dtype</span><span class="s0">, </span><span class="s1">np.dtype(</span><span class="s3">'S5'</span><span class="s1">))</span>
        <span class="s1">assert_equal(len(self.module._BLNK_.name)</span><span class="s0">, </span><span class="s4">12</span><span class="s1">)</span>
        <span class="s1">f(</span><span class="s3">&quot;abcde&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(self.module._BLNK_.name[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">b&quot;abcde&quot;</span><span class="s1">)</span>
        <span class="s1">f(</span><span class="s3">&quot;12345&quot;</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span>
        <span class="s1">assert_equal(self.module._BLNK_.name[</span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s5">b&quot;12345&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_gh4519(self):</span>
        <span class="s2"># Test array of assumed length strings</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_gh4519'</span><span class="s1">)</span>

        <span class="s0">for </span><span class="s1">x</span><span class="s0">, </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">[</span>
                <span class="s1">(</span><span class="s3">'a'</span><span class="s0">, </span><span class="s1">dict(shape=()</span><span class="s0">, </span><span class="s1">dtype=np.dtype(</span><span class="s3">'S1'</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">'text'</span><span class="s0">, </span><span class="s1">dict(shape=()</span><span class="s0">, </span><span class="s1">dtype=np.dtype(</span><span class="s3">'S4'</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">(np.array([</span><span class="s3">'1'</span><span class="s0">, </span><span class="s3">'2'</span><span class="s0">, </span><span class="s3">'3'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s3">'S1'</span><span class="s1">)</span><span class="s0">,</span>
                 <span class="s1">dict(shape=(</span><span class="s4">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.dtype(</span><span class="s3">'S1'</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">([</span><span class="s3">'1'</span><span class="s0">, </span><span class="s3">'2'</span><span class="s0">, </span><span class="s3">'34'</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">dict(shape=(</span><span class="s4">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.dtype(</span><span class="s3">'S2'</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">([</span><span class="s3">''</span><span class="s0">, </span><span class="s3">''</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dict(shape=(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.dtype(</span><span class="s3">'S1'</span><span class="s1">)))]:</span>
            <span class="s1">r = f(x)</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">expected.items():</span>
                <span class="s1">assert_equal(getattr(r</span><span class="s0">, </span><span class="s1">k)</span><span class="s0">, </span><span class="s1">v)</span>

    <span class="s0">def </span><span class="s1">test_gh3425(self):</span>
        <span class="s2"># Test returning a copy of assumed length string</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_gh3425'</span><span class="s1">)</span>
        <span class="s2"># f is equivalent to bytes.upper</span>

        <span class="s1">assert_equal(f(</span><span class="s3">'abC'</span><span class="s1">)</span><span class="s0">, </span><span class="s5">b'ABC'</span><span class="s1">)</span>
        <span class="s1">assert_equal(f(</span><span class="s3">''</span><span class="s1">)</span><span class="s0">, </span><span class="s5">b''</span><span class="s1">)</span>
        <span class="s1">assert_equal(f(</span><span class="s3">'abC12d'</span><span class="s1">)</span><span class="s0">, </span><span class="s5">b'ABC12D'</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;state&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'new'</span><span class="s0">, </span><span class="s3">'old'</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_character_bc(self</span><span class="s0">, </span><span class="s1">state):</span>
        <span class="s1">f = getattr(self.module</span><span class="s0">, </span><span class="s1">self.fprefix + </span><span class="s3">'_character_bc_' </span><span class="s1">+ state)</span>

        <span class="s1">c</span><span class="s0">, </span><span class="s1">a = f()</span>
        <span class="s1">assert_equal(c</span><span class="s0">, </span><span class="s5">b'a'</span><span class="s1">)</span>
        <span class="s1">assert_equal(len(a)</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

        <span class="s1">c</span><span class="s0">, </span><span class="s1">a = f(</span><span class="s5">b'b'</span><span class="s1">)</span>
        <span class="s1">assert_equal(c</span><span class="s0">, </span><span class="s5">b'b'</span><span class="s1">)</span>
        <span class="s1">assert_equal(len(a)</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>

        <span class="s1">assert_raises(Exception</span><span class="s0">, lambda</span><span class="s1">: f(</span><span class="s5">b'c'</span><span class="s1">))</span>
</pre>
</body>
</html>