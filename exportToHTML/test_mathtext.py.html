<html>
<head>
<title>test_mathtext.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_mathtext.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">io</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">shlex</span>
<span class="s0">from </span><span class="s1">xml.etree </span><span class="s0">import </span><span class="s1">ElementTree </span><span class="s0">as </span><span class="s1">ET</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib.testing.decorators </span><span class="s0">import </span><span class="s1">check_figures_equal</span><span class="s0">, </span><span class="s1">image_comparison</span>
<span class="s0">import </span><span class="s1">matplotlib.pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">mathtext</span><span class="s0">, </span><span class="s1">_mathtext</span>


<span class="s2"># If test is removed, use None as placeholder</span>
<span class="s1">math_tests = [</span>
    <span class="s3">r'$a+b+\dot s+\dot{s}+\ldots$'</span><span class="s0">,</span>
    <span class="s3">r'$x\hspace{-0.2}\doteq\hspace{-0.2}y$'</span><span class="s0">,</span>
    <span class="s3">r'\$100.00 $\alpha \_$'</span><span class="s0">,</span>
    <span class="s3">r'$\frac{\$100.00}{y}$'</span><span class="s0">,</span>
    <span class="s3">r'$x   y$'</span><span class="s0">,</span>
    <span class="s3">r'$x+y\ x=y\ x&lt;y\ x:y\ x,y\ x@y$'</span><span class="s0">,</span>
    <span class="s3">r'$100\%y\ x*y\ x/y x\$y$'</span><span class="s0">,</span>
    <span class="s3">r'$x\leftarrow y\ x\forall y\ x-y$'</span><span class="s0">,</span>
    <span class="s3">r'$x \sf x \bf x {\cal X} \rm x$'</span><span class="s0">,</span>
    <span class="s3">r'$x\ x\,x\;x\quad x\qquad x\!x\hspace{ 0.5 }y$'</span><span class="s0">,</span>
    <span class="s3">r'$\{ \rm braces \}$'</span><span class="s0">,</span>
    <span class="s3">r'$\left[\left\lfloor\frac{5}{\frac{\left(3\right)}{4}} y\right)\right]$'</span><span class="s0">,</span>
    <span class="s3">r'$\left(x\right)$'</span><span class="s0">,</span>
    <span class="s3">r'$\sin(x)$'</span><span class="s0">,</span>
    <span class="s3">r'$x_2$'</span><span class="s0">,</span>
    <span class="s3">r'$x^2$'</span><span class="s0">,</span>
    <span class="s3">r'$x^2_y$'</span><span class="s0">,</span>
    <span class="s3">r'$x_y^2$'</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s3">r'$\sum _{\genfrac{}{}{0}{}{0\leq i\leq m}{0&lt;j&lt;n}}f\left(i,j\right)'</span>
     <span class="s3">r'\mathcal{R}\prod_{i=\alpha_{i+1}}^\infty a_i \sin(2 \pi f x_i)'</span>
     <span class="s3">r&quot;\sqrt[2]{\prod^\frac{x}{2\pi^2}_\infty}$&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s3">r'$x = \frac{x+\frac{5}{2}}{\frac{y+3}{8}}$'</span><span class="s0">,</span>
    <span class="s3">r'$dz/dt = \gamma x^2 + {\rm sin}(2\pi y+\phi)$'</span><span class="s0">,</span>
    <span class="s3">r'Foo: $\alpha_{i+1}^j = {\rm sin}(2\pi f_j t_i) e^{-5 t_i/\tau}$'</span><span class="s0">,</span>
    <span class="s0">None,</span>
    <span class="s3">r'Variable $i$ is good'</span><span class="s0">,</span>
    <span class="s3">r'$\Delta_i^j$'</span><span class="s0">,</span>
    <span class="s3">r'$\Delta^j_{i+1}$'</span><span class="s0">,</span>
    <span class="s3">r'$\ddot{o}\acute{e}\grave{e}\hat{O}\breve{\imath}\tilde{n}\vec{q}$'</span><span class="s0">,</span>
    <span class="s3">r&quot;$\arccos((x^i))$&quot;</span><span class="s0">,</span>
    <span class="s3">r&quot;$\gamma = \frac{x=\frac{6}{8}}{y} \delta$&quot;</span><span class="s0">,</span>
    <span class="s3">r'$\limsup_{x\to\infty}$'</span><span class="s0">,</span>
    <span class="s0">None,</span>
    <span class="s3">r&quot;$f'\quad f'''(x)\quad ''/\mathrm{yr}$&quot;</span><span class="s0">,</span>
    <span class="s3">r'$\frac{x_2888}{y}$'</span><span class="s0">,</span>
    <span class="s3">r&quot;$\sqrt[3]{\frac{X_2}{Y}}=5$&quot;</span><span class="s0">,</span>
    <span class="s0">None,</span>
    <span class="s3">r&quot;$\sqrt[3]{x}=5$&quot;</span><span class="s0">,</span>
    <span class="s3">r'$\frac{X}{\frac{X}{Y}}$'</span><span class="s0">,</span>
    <span class="s3">r&quot;$W^{3\beta}_{\delta_1 \rho_1 \sigma_2} = U^{3\beta}_{\delta_1 \rho_1} + \frac{1}{8 \pi 2} \int^{\alpha_2}_{\alpha_2} d \alpha^\prime_2 \left[\frac{ U^{2\beta}_{\delta_1 \rho_1} - \alpha^\prime_2U^{1\beta}_{\rho_1 \sigma_2} }{U^{0\beta}_{\rho_1 \sigma_2}}\right]$&quot;</span><span class="s0">,</span>
    <span class="s3">r'$\mathcal{H} = \int d \tau \left(\epsilon E^2 + \mu H^2\right)$'</span><span class="s0">,</span>
    <span class="s3">r'$\widehat{abc}\widetilde{def}$'</span><span class="s0">,</span>
    <span class="s3">'$</span><span class="s0">\\</span><span class="s3">Gamma </span><span class="s0">\\</span><span class="s3">Delta </span><span class="s0">\\</span><span class="s3">Theta </span><span class="s0">\\</span><span class="s3">Lambda </span><span class="s0">\\</span><span class="s3">Xi </span><span class="s0">\\</span><span class="s3">Pi </span><span class="s0">\\</span><span class="s3">Sigma </span><span class="s0">\\</span><span class="s3">Upsilon </span><span class="s0">\\</span><span class="s3">Phi </span><span class="s0">\\</span><span class="s3">Psi </span><span class="s0">\\</span><span class="s3">Omega$'</span><span class="s0">,</span>
    <span class="s3">'$</span><span class="s0">\\</span><span class="s3">alpha </span><span class="s0">\\</span><span class="s3">beta </span><span class="s0">\\</span><span class="s3">gamma </span><span class="s0">\\</span><span class="s3">delta </span><span class="s0">\\</span><span class="s3">epsilon </span><span class="s0">\\</span><span class="s3">zeta </span><span class="s0">\\</span><span class="s3">eta </span><span class="s0">\\</span><span class="s3">theta </span><span class="s0">\\</span><span class="s3">iota </span><span class="s0">\\</span><span class="s3">lambda </span><span class="s0">\\</span><span class="s3">mu </span><span class="s0">\\</span><span class="s3">nu </span><span class="s0">\\</span><span class="s3">xi </span><span class="s0">\\</span><span class="s3">pi </span><span class="s0">\\</span><span class="s3">kappa </span><span class="s0">\\</span><span class="s3">rho </span><span class="s0">\\</span><span class="s3">sigma </span><span class="s0">\\</span><span class="s3">tau </span><span class="s0">\\</span><span class="s3">upsilon </span><span class="s0">\\</span><span class="s3">phi </span><span class="s0">\\</span><span class="s3">chi </span><span class="s0">\\</span><span class="s3">psi$'</span><span class="s0">,</span>

    <span class="s2"># The following examples are from the MathML torture test here:</span>
    <span class="s2"># https://www-archive.mozilla.org/projects/mathml/demo/texvsmml.xhtml</span>
    <span class="s3">r'${x}^{2}{y}^{2}$'</span><span class="s0">,</span>
    <span class="s3">r'${}_{2}F_{3}$'</span><span class="s0">,</span>
    <span class="s3">r'$\frac{x+{y}^{2}}{k+1}$'</span><span class="s0">,</span>
    <span class="s3">r'$x+{y}^{\frac{2}{k+1}}$'</span><span class="s0">,</span>
    <span class="s3">r'$\frac{a}{b/2}$'</span><span class="s0">,</span>
    <span class="s3">r'${a}_{0}+\frac{1}{{a}_{1}+\frac{1}{{a}_{2}+\frac{1}{{a}_{3}+\frac{1}{{a}_{4}}}}}$'</span><span class="s0">,</span>
    <span class="s3">r'${a}_{0}+\frac{1}{{a}_{1}+\frac{1}{{a}_{2}+\frac{1}{{a}_{3}+\frac{1}{{a}_{4}}}}}$'</span><span class="s0">,</span>
    <span class="s3">r'$\binom{n}{k/2}$'</span><span class="s0">,</span>
    <span class="s3">r'$\binom{p}{2}{x}^{2}{y}^{p-2}-\frac{1}{1-x}\frac{1}{1-{x}^{2}}$'</span><span class="s0">,</span>
    <span class="s3">r'${x}^{2y}$'</span><span class="s0">,</span>
    <span class="s3">r'$\sum _{i=1}^{p}\sum _{j=1}^{q}\sum _{k=1}^{r}{a}_{ij}{b}_{jk}{c}_{ki}$'</span><span class="s0">,</span>
    <span class="s3">r'$\sqrt{1+\sqrt{1+\sqrt{1+\sqrt{1+\sqrt{1+\sqrt{1+\sqrt{1+x}}}}}}}$'</span><span class="s0">,</span>
    <span class="s3">r'$\left(\frac{{\partial }^{2}}{\partial {x}^{2}}+\frac{{\partial }^{2}}{\partial {y}^{2}}\right){|\varphi \left(x+iy\right)|}^{2}=0$'</span><span class="s0">,</span>
    <span class="s3">r'${2}^{{2}^{{2}^{x}}}$'</span><span class="s0">,</span>
    <span class="s3">r'${\int }_{1}^{x}\frac{\mathrm{dt}}{t}$'</span><span class="s0">,</span>
    <span class="s3">r'$\int {\int }_{D}\mathrm{dx} \mathrm{dy}$'</span><span class="s0">,</span>
    <span class="s2"># mathtex doesn't support array</span>
    <span class="s2"># 'mmltt18'    : r'$f\left(x\right)=\left\{\begin{array}{cc}\hfill 1/3\hfill &amp; \text{if_}0\le x\le 1;\hfill \\ \hfill 2/3\hfill &amp; \hfill \text{if_}3\le x\le 4;\hfill \\ \hfill 0\hfill &amp; \text{elsewhere.}\hfill \end{array}$',</span>
    <span class="s2"># mathtex doesn't support stackrel</span>
    <span class="s2"># 'mmltt19'    : r'$\stackrel{\stackrel{k\text{times}}{\ufe37}}{x+...+x}$',</span>
    <span class="s3">r'${y}_{{x}^{2}}$'</span><span class="s0">,</span>
    <span class="s2"># mathtex doesn't support the &quot;\text&quot; command</span>
    <span class="s2"># 'mmltt21'    : r'$\sum _{p\text{\prime}}f\left(p\right)={\int }_{t&gt;1}f\left(t\right) d\pi \left(t\right)$',</span>
    <span class="s2"># mathtex doesn't support array</span>
    <span class="s2"># 'mmltt23'    : r'$\left(\begin{array}{cc}\hfill \left(\begin{array}{cc}\hfill a\hfill &amp; \hfill b\hfill \\ \hfill c\hfill &amp; \hfill d\hfill \end{array}\right)\hfill &amp; \hfill \left(\begin{array}{cc}\hfill e\hfill &amp; \hfill f\hfill \\ \hfill g\hfill &amp; \hfill h\hfill \end{array}\right)\hfill \\ \hfill 0\hfill &amp; \hfill \left(\begin{array}{cc}\hfill i\hfill &amp; \hfill j\hfill \\ \hfill k\hfill &amp; \hfill l\hfill \end{array}\right)\hfill \end{array}\right)$',</span>
    <span class="s2"># mathtex doesn't support array</span>
    <span class="s2"># 'mmltt24'   : r'$det|\begin{array}{ccccc}\hfill {c}_{0}\hfill &amp; \hfill {c}_{1}\hfill &amp; \hfill {c}_{2}\hfill &amp; \hfill \dots \hfill &amp; \hfill {c}_{n}\hfill \\ \hfill {c}_{1}\hfill &amp; \hfill {c}_{2}\hfill &amp; \hfill {c}_{3}\hfill &amp; \hfill \dots \hfill &amp; \hfill {c}_{n+1}\hfill \\ \hfill {c}_{2}\hfill &amp; \hfill {c}_{3}\hfill &amp; \hfill {c}_{4}\hfill &amp; \hfill \dots \hfill &amp; \hfill {c}_{n+2}\hfill \\ \hfill \u22ee\hfill &amp; \hfill \u22ee\hfill &amp; \hfill \u22ee\hfill &amp; \hfill \hfill &amp; \hfill \u22ee\hfill \\ \hfill {c}_{n}\hfill &amp; \hfill {c}_{n+1}\hfill &amp; \hfill {c}_{n+2}\hfill &amp; \hfill \dots \hfill &amp; \hfill {c}_{2n}\hfill \end{array}|&gt;0$',</span>
    <span class="s3">r'${y}_{{x}_{2}}$'</span><span class="s0">,</span>
    <span class="s3">r'${x}_{92}^{31415}+\pi $'</span><span class="s0">,</span>
    <span class="s3">r'${x}_{{y}_{b}^{a}}^{{z}_{c}^{d}}$'</span><span class="s0">,</span>
    <span class="s3">r'${y}_{3}^{\prime \prime \prime }$'</span><span class="s0">,</span>
    <span class="s2"># End of the MathML torture tests.</span>

    <span class="s3">r&quot;$\left( \xi \left( 1 - \xi \right) \right)$&quot;</span><span class="s0">,  </span><span class="s2"># Bug 2969451</span>
    <span class="s3">r&quot;$\left(2 \, a=b\right)$&quot;</span><span class="s0">,  </span><span class="s2"># Sage bug #8125</span>
    <span class="s3">r&quot;$? ! &amp;$&quot;</span><span class="s0">,  </span><span class="s2"># github issue #466</span>
    <span class="s0">None,</span>
    <span class="s0">None,</span>
    <span class="s3">r&quot;$\left\Vert \frac{a}{b} \right\Vert \left\vert \frac{a}{b} \right\vert \left\| \frac{a}{b}\right\| \left| \frac{a}{b} \right| \Vert a \Vert \vert b \vert \| a \| | b |$&quot;</span><span class="s0">,</span>
    <span class="s3">r'$\mathring{A}  \AA$'</span><span class="s0">,</span>
    <span class="s3">r'$M \, M \thinspace M \/ M \&gt; M \: M \; M \ M \enspace M \quad M \qquad M \! M$'</span><span class="s0">,</span>
    <span class="s3">r'$\Cap$ $\Cup$ $\leftharpoonup$ $\barwedge$ $\rightharpoonup$'</span><span class="s0">,</span>
    <span class="s3">r'$\hspace{-0.2}\dotplus\hspace{-0.2}$ $\hspace{-0.2}\doteq\hspace{-0.2}$ $\hspace{-0.2}\doteqdot\hspace{-0.2}$ $\ddots$'</span><span class="s0">,</span>
    <span class="s3">r'$xyz^kx_kx^py^{p-2} d_i^jb_jc_kd x^j_i E^0 E^0_u$'</span><span class="s0">,  </span><span class="s2"># github issue #4873</span>
    <span class="s3">r'${xyz}^k{x}_{k}{x}^{p}{y}^{p-2} {d}_{i}^{j}{b}_{j}{c}_{k}{d} {x}^{j}_{i}{E}^{0}{E}^0_u$'</span><span class="s0">,</span>
    <span class="s3">r'${\int}_x^x x\oint_x^x x\int_{X}^{X}x\int_x x \int^x x \int_{x} x\int^{x}{\int}_{x} x{\int}^{x}_{x}x$'</span><span class="s0">,</span>
    <span class="s3">r'testing$^{123}$'</span><span class="s0">,</span>
    <span class="s0">None,</span>
    <span class="s3">r'$6-2$; $-2$; $ -2$; ${-2}$; ${  -2}$; $20^{+3}_{-2}$'</span><span class="s0">,</span>
    <span class="s3">r'$\overline{\omega}^x \frac{1}{2}_0^x$'</span><span class="s0">,  </span><span class="s2"># github issue #5444</span>
    <span class="s3">r'$,$ $.$ $1{,}234{, }567{ , }890$ and $1,234,567,890$'</span><span class="s0">,  </span><span class="s2"># github issue 5799</span>
    <span class="s3">r'$\left(X\right)_{a}^{b}$'</span><span class="s0">,  </span><span class="s2"># github issue 7615</span>
    <span class="s3">r'$\dfrac{\$100.00}{y}$'</span><span class="s0">,  </span><span class="s2"># github issue #1888</span>
<span class="s1">]</span>
<span class="s2"># 'svgastext' tests switch svg output to embed text as text (rather than as</span>
<span class="s2"># paths).</span>
<span class="s1">svgastext_math_tests = [</span>
    <span class="s3">r'$-$-'</span><span class="s0">,</span>
<span class="s1">]</span>
<span class="s2"># 'lightweight' tests test only a single fontset (dejavusans, which is the</span>
<span class="s2"># default) and only png outputs, in order to minimize the size of baseline</span>
<span class="s2"># images.</span>
<span class="s1">lightweight_math_tests = [</span>
    <span class="s3">r'$\sqrt[ab]{123}$'</span><span class="s0">,  </span><span class="s2"># github issue #8665</span>
    <span class="s3">r'$x \overset{f}{\rightarrow} \overset{f}{x} \underset{xx}{ff} \overset{xx}{ff} \underset{f}{x} \underset{f}{\leftarrow} x$'</span><span class="s0">,  </span><span class="s2"># github issue #18241</span>
    <span class="s3">r'$\sum x\quad\sum^nx\quad\sum_nx\quad\sum_n^nx\quad\prod x\quad\prod^nx\quad\prod_nx\quad\prod_n^nx$'</span><span class="s0">,  </span><span class="s2"># GitHub issue 18085</span>
    <span class="s3">r'$1.$ $2.$ $19680801.$ $a.$ $b.$ $mpl.$'</span><span class="s0">,</span>
<span class="s1">]</span>

<span class="s1">digits = </span><span class="s3">&quot;0123456789&quot;</span>
<span class="s1">uppercase = </span><span class="s3">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>
<span class="s1">lowercase = </span><span class="s3">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>
<span class="s1">uppergreek = (</span><span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">Gamma </span><span class="s0">\\</span><span class="s3">Delta </span><span class="s0">\\</span><span class="s3">Theta </span><span class="s0">\\</span><span class="s3">Lambda </span><span class="s0">\\</span><span class="s3">Xi </span><span class="s0">\\</span><span class="s3">Pi </span><span class="s0">\\</span><span class="s3">Sigma </span><span class="s0">\\</span><span class="s3">Upsilon </span><span class="s0">\\</span><span class="s3">Phi </span><span class="s0">\\</span><span class="s3">Psi &quot;</span>
              <span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">Omega&quot;</span><span class="s1">)</span>
<span class="s1">lowergreek = (</span><span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">alpha </span><span class="s0">\\</span><span class="s3">beta </span><span class="s0">\\</span><span class="s3">gamma </span><span class="s0">\\</span><span class="s3">delta </span><span class="s0">\\</span><span class="s3">epsilon </span><span class="s0">\\</span><span class="s3">zeta </span><span class="s0">\\</span><span class="s3">eta </span><span class="s0">\\</span><span class="s3">theta </span><span class="s0">\\</span><span class="s3">iota &quot;</span>
              <span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">lambda </span><span class="s0">\\</span><span class="s3">mu </span><span class="s0">\\</span><span class="s3">nu </span><span class="s0">\\</span><span class="s3">xi </span><span class="s0">\\</span><span class="s3">pi </span><span class="s0">\\</span><span class="s3">kappa </span><span class="s0">\\</span><span class="s3">rho </span><span class="s0">\\</span><span class="s3">sigma </span><span class="s0">\\</span><span class="s3">tau </span><span class="s0">\\</span><span class="s3">upsilon &quot;</span>
              <span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">phi </span><span class="s0">\\</span><span class="s3">chi </span><span class="s0">\\</span><span class="s3">psi&quot;</span><span class="s1">)</span>
<span class="s1">all = [digits</span><span class="s0">, </span><span class="s1">uppercase</span><span class="s0">, </span><span class="s1">lowercase</span><span class="s0">, </span><span class="s1">uppergreek</span><span class="s0">, </span><span class="s1">lowergreek]</span>

<span class="s2"># Use stubs to reserve space if tests are removed</span>
<span class="s2"># stub should be of the form (None, N) where N is the number of strings that</span>
<span class="s2"># used to be tested</span>
<span class="s2"># Add new tests at the end.</span>
<span class="s1">font_test_specs = [</span>
    <span class="s1">([]</span><span class="s0">, </span><span class="s1">all)</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathrm'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">all)</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathbf'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">all)</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathit'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">all)</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathtt'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[digits</span><span class="s0">, </span><span class="s1">uppercase</span><span class="s0">, </span><span class="s1">lowercase])</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s0">None, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s0">None, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s0">None, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathbb'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[digits</span><span class="s0">, </span><span class="s1">uppercase</span><span class="s0">, </span><span class="s1">lowercase</span><span class="s0">,</span>
                  <span class="s3">r'\Gamma \Pi \Sigma \gamma \pi'</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathrm'</span><span class="s0">, </span><span class="s3">'mathbb'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[digits</span><span class="s0">, </span><span class="s1">uppercase</span><span class="s0">, </span><span class="s1">lowercase</span><span class="s0">,</span>
                            <span class="s3">r'\Gamma \Pi \Sigma \gamma \pi'</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathbf'</span><span class="s0">, </span><span class="s3">'mathbb'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[digits</span><span class="s0">, </span><span class="s1">uppercase</span><span class="s0">, </span><span class="s1">lowercase</span><span class="s0">,</span>
                            <span class="s3">r'\Gamma \Pi \Sigma \gamma \pi'</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathcal'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[uppercase])</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathfrak'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[uppercase</span><span class="s0">, </span><span class="s1">lowercase])</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathbf'</span><span class="s0">, </span><span class="s3">'mathfrak'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[uppercase</span><span class="s0">, </span><span class="s1">lowercase])</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathscr'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[uppercase</span><span class="s0">, </span><span class="s1">lowercase])</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathsf'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[digits</span><span class="s0">, </span><span class="s1">uppercase</span><span class="s0">, </span><span class="s1">lowercase])</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathrm'</span><span class="s0">, </span><span class="s3">'mathsf'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[digits</span><span class="s0">, </span><span class="s1">uppercase</span><span class="s0">, </span><span class="s1">lowercase])</span><span class="s0">,</span>
    <span class="s1">([</span><span class="s3">'mathbf'</span><span class="s0">, </span><span class="s3">'mathsf'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[digits</span><span class="s0">, </span><span class="s1">uppercase</span><span class="s0">, </span><span class="s1">lowercase])</span>
    <span class="s1">]</span>

<span class="s1">font_tests = []</span>
<span class="s0">for </span><span class="s1">fonts</span><span class="s0">, </span><span class="s1">chars </span><span class="s0">in </span><span class="s1">font_test_specs:</span>
    <span class="s0">if </span><span class="s1">fonts </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">font_tests.extend([</span><span class="s0">None</span><span class="s1">] * chars)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">wrapper = </span><span class="s3">''</span><span class="s1">.join([</span>
            <span class="s3">' '</span><span class="s1">.join(fonts)</span><span class="s0">,</span>
            <span class="s3">' $'</span><span class="s0">,</span>
            <span class="s1">*(</span><span class="s3">r'\%s{' </span><span class="s1">% font </span><span class="s0">for </span><span class="s1">font </span><span class="s0">in </span><span class="s1">fonts)</span><span class="s0">,</span>
            <span class="s3">'%s'</span><span class="s0">,</span>
            <span class="s1">*(</span><span class="s3">'}' </span><span class="s0">for </span><span class="s1">font </span><span class="s0">in </span><span class="s1">fonts)</span><span class="s0">,</span>
            <span class="s3">'$'</span><span class="s0">,</span>
        <span class="s1">])</span>
        <span class="s0">for </span><span class="s1">set </span><span class="s0">in </span><span class="s1">chars:</span>
            <span class="s1">font_tests.append(wrapper % set)</span>


<span class="s1">@pytest.fixture</span>
<span class="s0">def </span><span class="s1">baseline_images(request</span><span class="s0">, </span><span class="s1">fontset</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">text):</span>
    <span class="s0">if </span><span class="s1">text </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">pytest.skip(</span><span class="s3">&quot;test has been removed&quot;</span><span class="s1">)</span>
    <span class="s0">return </span><span class="s1">[</span><span class="s3">'%s_%s_%02d' </span><span class="s1">% (request.param</span><span class="s0">, </span><span class="s1">fontset</span><span class="s0">, </span><span class="s1">index)]</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">'index, text'</span><span class="s0">, </span><span class="s1">enumerate(math_tests)</span><span class="s0">, </span><span class="s1">ids=range(len(math_tests)))</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">'fontset'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'cm'</span><span class="s0">, </span><span class="s3">'stix'</span><span class="s0">, </span><span class="s3">'stixsans'</span><span class="s0">, </span><span class="s3">'dejavusans'</span><span class="s0">, </span><span class="s3">'dejavuserif'</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'baseline_images'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'mathtext'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">indirect=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s1">@image_comparison(baseline_images=</span><span class="s0">None,</span>
                  <span class="s1">tol=</span><span class="s4">0.011 </span><span class="s0">if </span><span class="s1">platform.machine() </span><span class="s0">in </span><span class="s1">(</span><span class="s3">'ppc64le'</span><span class="s0">, </span><span class="s3">'s390x'</span><span class="s1">) </span><span class="s0">else </span><span class="s4">0</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_mathtext_rendering(baseline_images</span><span class="s0">, </span><span class="s1">fontset</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">text):</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">'mathtext.fontset'</span><span class="s1">] = fontset</span>
    <span class="s1">fig = plt.figure(figsize=(</span><span class="s4">5.25</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">))</span>
    <span class="s1">fig.text(</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s1">text</span><span class="s0">,</span>
             <span class="s1">horizontalalignment=</span><span class="s3">'center'</span><span class="s0">, </span><span class="s1">verticalalignment=</span><span class="s3">'center'</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'index, text'</span><span class="s0">, </span><span class="s1">enumerate(svgastext_math_tests)</span><span class="s0">,</span>
                         <span class="s1">ids=range(len(svgastext_math_tests)))</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'fontset'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'cm'</span><span class="s0">, </span><span class="s3">'dejavusans'</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'baseline_images'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'mathtext0'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">indirect=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s1">@image_comparison(</span>
    <span class="s1">baseline_images=</span><span class="s0">None, </span><span class="s1">extensions=[</span><span class="s3">'svg'</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">savefig_kwarg={</span><span class="s3">'metadata'</span><span class="s1">: {  </span><span class="s2"># Minimize image size.</span>
        <span class="s3">'Creator'</span><span class="s1">: </span><span class="s0">None, </span><span class="s3">'Date'</span><span class="s1">: </span><span class="s0">None, </span><span class="s3">'Format'</span><span class="s1">: </span><span class="s0">None, </span><span class="s3">'Type'</span><span class="s1">: </span><span class="s0">None</span><span class="s1">}})</span>
<span class="s0">def </span><span class="s1">test_mathtext_rendering_svgastext(baseline_images</span><span class="s0">, </span><span class="s1">fontset</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">text):</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">'mathtext.fontset'</span><span class="s1">] = fontset</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">'svg.fonttype'</span><span class="s1">] = </span><span class="s3">'none'  </span><span class="s2"># Minimize image size.</span>
    <span class="s1">fig = plt.figure(figsize=(</span><span class="s4">5.25</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">))</span>
    <span class="s1">fig.patch.set(visible=</span><span class="s0">False</span><span class="s1">)  </span><span class="s2"># Minimize image size.</span>
    <span class="s1">fig.text(</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s1">text</span><span class="s0">,</span>
             <span class="s1">horizontalalignment=</span><span class="s3">'center'</span><span class="s0">, </span><span class="s1">verticalalignment=</span><span class="s3">'center'</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'index, text'</span><span class="s0">, </span><span class="s1">enumerate(lightweight_math_tests)</span><span class="s0">,</span>
                         <span class="s1">ids=range(len(lightweight_math_tests)))</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'fontset'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'dejavusans'</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'baseline_images'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'mathtext1'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">indirect=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s1">@image_comparison(baseline_images=</span><span class="s0">None, </span><span class="s1">extensions=[</span><span class="s3">'png'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_mathtext_rendering_lightweight(baseline_images</span><span class="s0">, </span><span class="s1">fontset</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">text):</span>
    <span class="s1">fig = plt.figure(figsize=(</span><span class="s4">5.25</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">))</span>
    <span class="s1">fig.text(</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s1">text</span><span class="s0">, </span><span class="s1">math_fontfamily=fontset</span><span class="s0">,</span>
             <span class="s1">horizontalalignment=</span><span class="s3">'center'</span><span class="s0">, </span><span class="s1">verticalalignment=</span><span class="s3">'center'</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">'index, text'</span><span class="s0">, </span><span class="s1">enumerate(font_tests)</span><span class="s0">, </span><span class="s1">ids=range(len(font_tests)))</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">'fontset'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'cm'</span><span class="s0">, </span><span class="s3">'stix'</span><span class="s0">, </span><span class="s3">'stixsans'</span><span class="s0">, </span><span class="s3">'dejavusans'</span><span class="s0">, </span><span class="s3">'dejavuserif'</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'baseline_images'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'mathfont'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">indirect=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s1">@image_comparison(baseline_images=</span><span class="s0">None, </span><span class="s1">extensions=[</span><span class="s3">'png'</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">tol=</span><span class="s4">0.011 </span><span class="s0">if </span><span class="s1">platform.machine() </span><span class="s0">in </span><span class="s1">(</span><span class="s3">'ppc64le'</span><span class="s0">, </span><span class="s3">'s390x'</span><span class="s1">) </span><span class="s0">else </span><span class="s4">0</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_mathfont_rendering(baseline_images</span><span class="s0">, </span><span class="s1">fontset</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">text):</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">'mathtext.fontset'</span><span class="s1">] = fontset</span>
    <span class="s1">fig = plt.figure(figsize=(</span><span class="s4">5.25</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">))</span>
    <span class="s1">fig.text(</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s1">text</span><span class="s0">,</span>
             <span class="s1">horizontalalignment=</span><span class="s3">'center'</span><span class="s0">, </span><span class="s1">verticalalignment=</span><span class="s3">'center'</span><span class="s1">)</span>


<span class="s1">@check_figures_equal(extensions=[</span><span class="s3">&quot;png&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_short_long_accents(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s1">acc_map = _mathtext.Parser._accent_map</span>
    <span class="s1">short_accs = [s </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">acc_map </span><span class="s0">if </span><span class="s1">len(s) == </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">corresponding_long_accs = []</span>
    <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">short_accs:</span>
        <span class="s1">l</span><span class="s0">, </span><span class="s1">= [l </span><span class="s0">for </span><span class="s1">l </span><span class="s0">in </span><span class="s1">acc_map </span><span class="s0">if </span><span class="s1">len(l) &gt; </span><span class="s4">1 </span><span class="s0">and </span><span class="s1">acc_map[l] == acc_map[s]]</span>
        <span class="s1">corresponding_long_accs.append(l)</span>
    <span class="s1">fig_test.text(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">.5</span><span class="s0">, </span><span class="s3">&quot;$&quot; </span><span class="s1">+ </span><span class="s3">&quot;&quot;</span><span class="s1">.join(</span><span class="s3">rf&quot;\</span><span class="s0">{</span><span class="s1">s</span><span class="s0">}</span><span class="s3">a&quot; </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">short_accs) + </span><span class="s3">&quot;$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_ref.text(</span>
        <span class="s4">0</span><span class="s0">, </span><span class="s4">.5</span><span class="s0">, </span><span class="s3">&quot;$&quot; </span><span class="s1">+ </span><span class="s3">&quot;&quot;</span><span class="s1">.join(</span><span class="s3">fr&quot;\</span><span class="s0">{</span><span class="s1">l</span><span class="s0">} </span><span class="s3">a&quot; </span><span class="s0">for </span><span class="s1">l </span><span class="s0">in </span><span class="s1">corresponding_long_accs) + </span><span class="s3">&quot;$&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_fontinfo():</span>
    <span class="s1">fontpath = mpl.font_manager.findfont(</span><span class="s3">&quot;DejaVu Sans&quot;</span><span class="s1">)</span>
    <span class="s1">font = mpl.ft2font.FT2Font(fontpath)</span>
    <span class="s1">table = font.get_sfnt_table(</span><span class="s3">&quot;head&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">table[</span><span class="s3">'version'</span><span class="s1">] == (</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">'math, msg'</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s3">r'$\hspace{}$'</span><span class="s0">, </span><span class="s3">r'Expected \hspace{space}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\hspace{foo}$'</span><span class="s0">, </span><span class="s3">r'Expected \hspace{space}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\sinx$'</span><span class="s0">, </span><span class="s3">r'Unknown symbol: \sinx'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\dotx$'</span><span class="s0">, </span><span class="s3">r'Unknown symbol: \dotx'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\frac$'</span><span class="s0">, </span><span class="s3">r'Expected \frac{num}{den}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\frac{}{}$'</span><span class="s0">, </span><span class="s3">r'Expected \frac{num}{den}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\binom$'</span><span class="s0">, </span><span class="s3">r'Expected \binom{num}{den}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\binom{}{}$'</span><span class="s0">, </span><span class="s3">r'Expected \binom{num}{den}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\genfrac$'</span><span class="s0">,</span>
         <span class="s3">r'Expected \genfrac{ldelim}{rdelim}{rulesize}{style}{num}{den}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\genfrac{}{}{}{}{}{}$'</span><span class="s0">,</span>
         <span class="s3">r'Expected \genfrac{ldelim}{rdelim}{rulesize}{style}{num}{den}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\sqrt$'</span><span class="s0">, </span><span class="s3">r'Expected \sqrt{value}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\sqrt f$'</span><span class="s0">, </span><span class="s3">r'Expected \sqrt{value}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\overline$'</span><span class="s0">, </span><span class="s3">r'Expected \overline{body}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\overline{}$'</span><span class="s0">, </span><span class="s3">r'Expected \overline{body}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\leftF$'</span><span class="s0">, </span><span class="s3">r'Expected a delimiter'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\rightF$'</span><span class="s0">, </span><span class="s3">r'Unknown symbol: \rightF'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\left(\right$'</span><span class="s0">, </span><span class="s3">r'Expected a delimiter'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2"># PyParsing 2 uses double quotes, PyParsing 3 uses single quotes and an</span>
        <span class="s2"># extra backslash.</span>
        <span class="s1">(</span><span class="s3">r'$\left($'</span><span class="s0">, </span><span class="s1">re.compile(</span><span class="s3">r'Expected (&quot;|\'\\)\\right[&quot;\']'</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\dfrac$'</span><span class="s0">, </span><span class="s3">r'Expected \dfrac{num}{den}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\dfrac{}{}$'</span><span class="s0">, </span><span class="s3">r'Expected \dfrac{num}{den}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\overset$'</span><span class="s0">, </span><span class="s3">r'Expected \overset{annotation}{body}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\underset$'</span><span class="s0">, </span><span class="s3">r'Expected \underset{annotation}{body}'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$\foo$'</span><span class="s0">, </span><span class="s3">r'Unknown symbol: \foo'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$a^2^2$'</span><span class="s0">, </span><span class="s3">r'Double superscript'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$a_2_2$'</span><span class="s0">, </span><span class="s3">r'Double subscript'</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">r'$a^2_a^2$'</span><span class="s0">, </span><span class="s3">r'Double superscript'</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">ids=[</span>
        <span class="s3">'hspace without value'</span><span class="s0">,</span>
        <span class="s3">'hspace with invalid value'</span><span class="s0">,</span>
        <span class="s3">'function without space'</span><span class="s0">,</span>
        <span class="s3">'accent without space'</span><span class="s0">,</span>
        <span class="s3">'frac without parameters'</span><span class="s0">,</span>
        <span class="s3">'frac with empty parameters'</span><span class="s0">,</span>
        <span class="s3">'binom without parameters'</span><span class="s0">,</span>
        <span class="s3">'binom with empty parameters'</span><span class="s0">,</span>
        <span class="s3">'genfrac without parameters'</span><span class="s0">,</span>
        <span class="s3">'genfrac with empty parameters'</span><span class="s0">,</span>
        <span class="s3">'sqrt without parameters'</span><span class="s0">,</span>
        <span class="s3">'sqrt with invalid value'</span><span class="s0">,</span>
        <span class="s3">'overline without parameters'</span><span class="s0">,</span>
        <span class="s3">'overline with empty parameter'</span><span class="s0">,</span>
        <span class="s3">'left with invalid delimiter'</span><span class="s0">,</span>
        <span class="s3">'right with invalid delimiter'</span><span class="s0">,</span>
        <span class="s3">'unclosed parentheses with sizing'</span><span class="s0">,</span>
        <span class="s3">'unclosed parentheses without sizing'</span><span class="s0">,</span>
        <span class="s3">'dfrac without parameters'</span><span class="s0">,</span>
        <span class="s3">'dfrac with empty parameters'</span><span class="s0">,</span>
        <span class="s3">'overset without parameters'</span><span class="s0">,</span>
        <span class="s3">'underset without parameters'</span><span class="s0">,</span>
        <span class="s3">'unknown symbol'</span><span class="s0">,</span>
        <span class="s3">'double superscript'</span><span class="s0">,</span>
        <span class="s3">'double subscript'</span><span class="s0">,</span>
        <span class="s3">'super on sub without braces'</span>
    <span class="s1">]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_mathtext_exceptions(math</span><span class="s0">, </span><span class="s1">msg):</span>
    <span class="s1">parser = mathtext.MathTextParser(</span><span class="s3">'agg'</span><span class="s1">)</span>
    <span class="s1">match = re.escape(msg) </span><span class="s0">if </span><span class="s1">isinstance(msg</span><span class="s0">, </span><span class="s1">str) </span><span class="s0">else </span><span class="s1">msg</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=match):</span>
        <span class="s1">parser.parse(math)</span>


<span class="s0">def </span><span class="s1">test_get_unicode_index_exception():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">_mathtext.get_unicode_index(</span><span class="s3">r'\foo'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_single_minus_sign():</span>
    <span class="s1">fig = plt.figure()</span>
    <span class="s1">fig.text(</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s3">'$-$'</span><span class="s1">)</span>
    <span class="s1">fig.canvas.draw()</span>
    <span class="s1">t = np.asarray(fig.canvas.renderer.buffer_rgba())</span>
    <span class="s0">assert </span><span class="s1">(t != </span><span class="s4">0xff</span><span class="s1">).any()  </span><span class="s2"># assert that canvas is not all white.</span>


<span class="s1">@check_figures_equal(extensions=[</span><span class="s3">&quot;png&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_spaces(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s1">fig_test.text(</span><span class="s4">.5</span><span class="s0">, </span><span class="s4">.5</span><span class="s0">, </span><span class="s3">r&quot;$1\,2\&gt;3\ 4$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_ref.text(</span><span class="s4">.5</span><span class="s0">, </span><span class="s4">.5</span><span class="s0">, </span><span class="s3">r&quot;$1\/2\:3~4$&quot;</span><span class="s1">)</span>


<span class="s1">@check_figures_equal(extensions=[</span><span class="s3">&quot;png&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_operator_space(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s1">fig_test.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s3">r&quot;$\log 6$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_test.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s3">r&quot;$\log(6)$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_test.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s3">r&quot;$\arcsin 6$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_test.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s3">r&quot;$\arcsin|6|$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_test.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s3">r&quot;$\operatorname{op} 6$&quot;</span><span class="s1">)  </span><span class="s2"># GitHub issue #553</span>
    <span class="s1">fig_test.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s3">r&quot;$\operatorname{op}[6]$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_test.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s3">r&quot;$\cos^2$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_test.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.8</span><span class="s0">, </span><span class="s3">r&quot;$\log_2$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_test.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.9</span><span class="s0">, </span><span class="s3">r&quot;$\sin^2 \cos$&quot;</span><span class="s1">)  </span><span class="s2"># GitHub issue #17852</span>

    <span class="s1">fig_ref.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s3">r&quot;$\mathrm{log\,}6$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_ref.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s3">r&quot;$\mathrm{log}(6)$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_ref.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s3">r&quot;$\mathrm{arcsin\,}6$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_ref.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s3">r&quot;$\mathrm{arcsin}|6|$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_ref.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s3">r&quot;$\mathrm{op\,}6$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_ref.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s3">r&quot;$\mathrm{op}[6]$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_ref.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s3">r&quot;$\mathrm{cos}^2$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_ref.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.8</span><span class="s0">, </span><span class="s3">r&quot;$\mathrm{log}_2$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_ref.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.9</span><span class="s0">, </span><span class="s3">r&quot;$\mathrm{sin}^2 \mathrm{\,cos}$&quot;</span><span class="s1">)</span>


<span class="s1">@check_figures_equal(extensions=[</span><span class="s3">&quot;png&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_inverted_delimiters(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s1">fig_test.text(</span><span class="s4">.5</span><span class="s0">, </span><span class="s4">.5</span><span class="s0">, </span><span class="s3">r&quot;$\left)\right($&quot;</span><span class="s0">, </span><span class="s1">math_fontfamily=</span><span class="s3">&quot;dejavusans&quot;</span><span class="s1">)</span>
    <span class="s1">fig_ref.text(</span><span class="s4">.5</span><span class="s0">, </span><span class="s4">.5</span><span class="s0">, </span><span class="s3">r&quot;$)($&quot;</span><span class="s0">, </span><span class="s1">math_fontfamily=</span><span class="s3">&quot;dejavusans&quot;</span><span class="s1">)</span>


<span class="s1">@check_figures_equal(extensions=[</span><span class="s3">&quot;png&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_genfrac_displaystyle(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s1">fig_test.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s3">r&quot;$\dfrac{2x}{3y}$&quot;</span><span class="s1">)</span>

    <span class="s1">thickness = _mathtext.TruetypeFonts.get_underline_thickness(</span>
        <span class="s0">None, None, </span><span class="s1">fontsize=mpl.rcParams[</span><span class="s3">&quot;font.size&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">dpi=mpl.rcParams[</span><span class="s3">&quot;savefig.dpi&quot;</span><span class="s1">])</span>
    <span class="s1">fig_ref.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s3">r&quot;$\genfrac{}{}{%f}{0}{2x}{3y}$&quot; </span><span class="s1">% thickness)</span>


<span class="s0">def </span><span class="s1">test_mathtext_fallback_valid():</span>
    <span class="s0">for </span><span class="s1">fallback </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'cm'</span><span class="s0">, </span><span class="s3">'stix'</span><span class="s0">, </span><span class="s3">'stixsans'</span><span class="s0">, </span><span class="s3">'None'</span><span class="s1">]:</span>
        <span class="s1">mpl.rcParams[</span><span class="s3">'mathtext.fallback'</span><span class="s1">] = fallback</span>


<span class="s0">def </span><span class="s1">test_mathtext_fallback_invalid():</span>
    <span class="s0">for </span><span class="s1">fallback </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'abc'</span><span class="s0">, </span><span class="s3">''</span><span class="s1">]:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;not a valid fallback font name&quot;</span><span class="s1">):</span>
            <span class="s1">mpl.rcParams[</span><span class="s3">'mathtext.fallback'</span><span class="s1">] = fallback</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;fallback,fontlist&quot;</span><span class="s0">,</span>
    <span class="s1">[(</span><span class="s3">&quot;cm&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'DejaVu Sans'</span><span class="s0">, </span><span class="s3">'mpltest'</span><span class="s0">, </span><span class="s3">'STIXGeneral'</span><span class="s0">, </span><span class="s3">'cmr10'</span><span class="s0">, </span><span class="s3">'STIXGeneral'</span><span class="s1">])</span><span class="s0">,</span>
     <span class="s1">(</span><span class="s3">&quot;stix&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'DejaVu Sans'</span><span class="s0">, </span><span class="s3">'mpltest'</span><span class="s0">, </span><span class="s3">'STIXGeneral'</span><span class="s1">])])</span>
<span class="s0">def </span><span class="s1">test_mathtext_fallback(fallback</span><span class="s0">, </span><span class="s1">fontlist):</span>
    <span class="s1">mpl.font_manager.fontManager.addfont(</span>
        <span class="s1">str(Path(__file__).resolve().parent / </span><span class="s3">'mpltest.ttf'</span><span class="s1">))</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">&quot;svg.fonttype&quot;</span><span class="s1">] = </span><span class="s3">'none'</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">'mathtext.fontset'</span><span class="s1">] = </span><span class="s3">'custom'</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">'mathtext.rm'</span><span class="s1">] = </span><span class="s3">'mpltest'</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">'mathtext.it'</span><span class="s1">] = </span><span class="s3">'mpltest:italic'</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">'mathtext.bf'</span><span class="s1">] = </span><span class="s3">'mpltest:bold'</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">'mathtext.fallback'</span><span class="s1">] = fallback</span>

    <span class="s1">test_str = </span><span class="s3">r'a$A\AA\breve\gimel$'</span>

    <span class="s1">buff = io.BytesIO()</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">fig.text(</span><span class="s4">.5</span><span class="s0">, </span><span class="s4">.5</span><span class="s0">, </span><span class="s1">test_str</span><span class="s0">, </span><span class="s1">fontsize=</span><span class="s4">40</span><span class="s0">, </span><span class="s1">ha=</span><span class="s3">'center'</span><span class="s1">)</span>
    <span class="s1">fig.savefig(buff</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;svg&quot;</span><span class="s1">)</span>
    <span class="s1">tspans = (ET.fromstring(buff.getvalue())</span>
              <span class="s1">.findall(</span><span class="s3">&quot;.//{http://www.w3.org/2000/svg}tspan[@style]&quot;</span><span class="s1">))</span>
    <span class="s2"># Getting the last element of the style attrib is a close enough</span>
    <span class="s2"># approximation for parsing the font property.</span>
    <span class="s1">char_fonts = [shlex.split(tspan.attrib[</span><span class="s3">&quot;style&quot;</span><span class="s1">])[-</span><span class="s4">1</span><span class="s1">] </span><span class="s0">for </span><span class="s1">tspan </span><span class="s0">in </span><span class="s1">tspans]</span>
    <span class="s0">assert </span><span class="s1">char_fonts == fontlist</span>
    <span class="s1">mpl.font_manager.fontManager.ttflist.pop()</span>


<span class="s0">def </span><span class="s1">test_math_to_image(tmpdir):</span>
    <span class="s1">mathtext.math_to_image(</span><span class="s3">'$x^2$'</span><span class="s0">, </span><span class="s1">str(tmpdir.join(</span><span class="s3">'example.png'</span><span class="s1">)))</span>
    <span class="s1">mathtext.math_to_image(</span><span class="s3">'$x^2$'</span><span class="s0">, </span><span class="s1">io.BytesIO())</span>
    <span class="s1">mathtext.math_to_image(</span><span class="s3">'$x^2$'</span><span class="s0">, </span><span class="s1">io.BytesIO()</span><span class="s0">, </span><span class="s1">color=</span><span class="s3">'Maroon'</span><span class="s1">)</span>


<span class="s1">@image_comparison(baseline_images=[</span><span class="s3">'math_fontfamily_image.png'</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">savefig_kwarg={</span><span class="s3">'dpi'</span><span class="s1">: </span><span class="s4">40</span><span class="s1">})</span>
<span class="s0">def </span><span class="s1">test_math_fontfamily():</span>
    <span class="s1">fig = plt.figure(figsize=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">fig.text(</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s3">r&quot;$This\ text\ should\ have\ one\ font$&quot;</span><span class="s0">,</span>
             <span class="s1">size=</span><span class="s4">24</span><span class="s0">, </span><span class="s1">math_fontfamily=</span><span class="s3">'dejavusans'</span><span class="s1">)</span>
    <span class="s1">fig.text(</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s3">r&quot;$This\ text\ should\ have\ another$&quot;</span><span class="s0">,</span>
             <span class="s1">size=</span><span class="s4">24</span><span class="s0">, </span><span class="s1">math_fontfamily=</span><span class="s3">'stix'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_default_math_fontfamily():</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">'mathtext.fontset'</span><span class="s1">] = </span><span class="s3">'cm'</span>
    <span class="s1">test_str = </span><span class="s3">r'abc$abc\alpha$'</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>

    <span class="s1">text1 = fig.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s1">test_str</span><span class="s0">, </span><span class="s1">font=</span><span class="s3">'Arial'</span><span class="s1">)</span>
    <span class="s1">prop1 = text1.get_fontproperties()</span>
    <span class="s0">assert </span><span class="s1">prop1.get_math_fontfamily() == </span><span class="s3">'cm'</span>
    <span class="s1">text2 = fig.text(</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s1">test_str</span><span class="s0">, </span><span class="s1">fontproperties=</span><span class="s3">'Arial'</span><span class="s1">)</span>
    <span class="s1">prop2 = text2.get_fontproperties()</span>
    <span class="s0">assert </span><span class="s1">prop2.get_math_fontfamily() == </span><span class="s3">'cm'</span>

    <span class="s1">fig.draw_without_rendering()</span>


<span class="s0">def </span><span class="s1">test_argument_order():</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">'mathtext.fontset'</span><span class="s1">] = </span><span class="s3">'cm'</span>
    <span class="s1">test_str = </span><span class="s3">r'abc$abc\alpha$'</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>

    <span class="s1">text1 = fig.text(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s1">test_str</span><span class="s0">,</span>
                     <span class="s1">math_fontfamily=</span><span class="s3">'dejavusans'</span><span class="s0">, </span><span class="s1">font=</span><span class="s3">'Arial'</span><span class="s1">)</span>
    <span class="s1">prop1 = text1.get_fontproperties()</span>
    <span class="s0">assert </span><span class="s1">prop1.get_math_fontfamily() == </span><span class="s3">'dejavusans'</span>
    <span class="s1">text2 = fig.text(</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s1">test_str</span><span class="s0">,</span>
                     <span class="s1">math_fontfamily=</span><span class="s3">'dejavusans'</span><span class="s0">, </span><span class="s1">fontproperties=</span><span class="s3">'Arial'</span><span class="s1">)</span>
    <span class="s1">prop2 = text2.get_fontproperties()</span>
    <span class="s0">assert </span><span class="s1">prop2.get_math_fontfamily() == </span><span class="s3">'dejavusans'</span>
    <span class="s1">text3 = fig.text(</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s1">test_str</span><span class="s0">,</span>
                     <span class="s1">font=</span><span class="s3">'Arial'</span><span class="s0">, </span><span class="s1">math_fontfamily=</span><span class="s3">'dejavusans'</span><span class="s1">)</span>
    <span class="s1">prop3 = text3.get_fontproperties()</span>
    <span class="s0">assert </span><span class="s1">prop3.get_math_fontfamily() == </span><span class="s3">'dejavusans'</span>
    <span class="s1">text4 = fig.text(</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s1">test_str</span><span class="s0">,</span>
                     <span class="s1">fontproperties=</span><span class="s3">'Arial'</span><span class="s0">, </span><span class="s1">math_fontfamily=</span><span class="s3">'dejavusans'</span><span class="s1">)</span>
    <span class="s1">prop4 = text4.get_fontproperties()</span>
    <span class="s0">assert </span><span class="s1">prop4.get_math_fontfamily() == </span><span class="s3">'dejavusans'</span>

    <span class="s1">fig.draw_without_rendering()</span>


<span class="s0">def </span><span class="s1">test_mathtext_cmr10_minus_sign():</span>
    <span class="s2"># cmr10 does not contain a minus sign and used to issue a warning</span>
    <span class="s2"># RuntimeWarning: Glyph 8722 missing from current font.</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">'font.family'</span><span class="s1">] = </span><span class="s3">'cmr10'</span>
    <span class="s1">mpl.rcParams[</span><span class="s3">'axes.formatter.use_mathtext'</span><span class="s1">] = </span><span class="s0">True</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.plot(range(-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">range(-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
    <span class="s2"># draw to make sure we have no warnings</span>
    <span class="s1">fig.canvas.draw()</span>
</pre>
</body>
</html>