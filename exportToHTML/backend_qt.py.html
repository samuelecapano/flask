<html>
<head>
<title>backend_qt.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
backend_qt.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">functools</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">traceback</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">_api</span><span class="s0">, </span><span class="s1">backend_tools</span><span class="s0">, </span><span class="s1">cbook</span>
<span class="s0">from </span><span class="s1">matplotlib._pylab_helpers </span><span class="s0">import </span><span class="s1">Gcf</span>
<span class="s0">from </span><span class="s1">matplotlib.backend_bases </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">_Backend</span><span class="s0">, </span><span class="s1">FigureCanvasBase</span><span class="s0">, </span><span class="s1">FigureManagerBase</span><span class="s0">, </span><span class="s1">NavigationToolbar2</span><span class="s0">,</span>
    <span class="s1">TimerBase</span><span class="s0">, </span><span class="s1">cursors</span><span class="s0">, </span><span class="s1">ToolContainerBase</span><span class="s0">, </span><span class="s1">MouseButton</span><span class="s0">,</span>
    <span class="s1">CloseEvent</span><span class="s0">, </span><span class="s1">KeyEvent</span><span class="s0">, </span><span class="s1">LocationEvent</span><span class="s0">, </span><span class="s1">MouseEvent</span><span class="s0">, </span><span class="s1">ResizeEvent)</span>
<span class="s0">import </span><span class="s1">matplotlib.backends.qt_editor.figureoptions </span><span class="s0">as </span><span class="s1">figureoptions</span>
<span class="s0">from </span><span class="s1">. </span><span class="s0">import </span><span class="s1">qt_compat</span>
<span class="s0">from </span><span class="s1">.qt_compat </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">QtCore</span><span class="s0">, </span><span class="s1">QtGui</span><span class="s0">, </span><span class="s1">QtWidgets</span><span class="s0">, </span><span class="s1">__version__</span><span class="s0">, </span><span class="s1">QT_API</span><span class="s0">,</span>
    <span class="s1">_enum</span><span class="s0">, </span><span class="s1">_to_int</span><span class="s0">, </span><span class="s1">_isdeleted</span><span class="s0">, </span><span class="s1">_maybe_allow_interrupt</span>
<span class="s1">)</span>


<span class="s2"># SPECIAL_KEYS are Qt::Key that do *not* return their Unicode name</span>
<span class="s2"># instead they have manually specified names.</span>
<span class="s1">SPECIAL_KEYS = {</span>
    <span class="s1">_to_int(getattr(_enum(</span><span class="s3">&quot;QtCore.Qt.Key&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">k)): v </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">[</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Escape&quot;</span><span class="s0">, </span><span class="s3">&quot;escape&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Tab&quot;</span><span class="s0">, </span><span class="s3">&quot;tab&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Backspace&quot;</span><span class="s0">, </span><span class="s3">&quot;backspace&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Return&quot;</span><span class="s0">, </span><span class="s3">&quot;enter&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Enter&quot;</span><span class="s0">, </span><span class="s3">&quot;enter&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Insert&quot;</span><span class="s0">, </span><span class="s3">&quot;insert&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Delete&quot;</span><span class="s0">, </span><span class="s3">&quot;delete&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Pause&quot;</span><span class="s0">, </span><span class="s3">&quot;pause&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_SysReq&quot;</span><span class="s0">, </span><span class="s3">&quot;sysreq&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Clear&quot;</span><span class="s0">, </span><span class="s3">&quot;clear&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Home&quot;</span><span class="s0">, </span><span class="s3">&quot;home&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_End&quot;</span><span class="s0">, </span><span class="s3">&quot;end&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Left&quot;</span><span class="s0">, </span><span class="s3">&quot;left&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Up&quot;</span><span class="s0">, </span><span class="s3">&quot;up&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Right&quot;</span><span class="s0">, </span><span class="s3">&quot;right&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Down&quot;</span><span class="s0">, </span><span class="s3">&quot;down&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_PageUp&quot;</span><span class="s0">, </span><span class="s3">&quot;pageup&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_PageDown&quot;</span><span class="s0">, </span><span class="s3">&quot;pagedown&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Shift&quot;</span><span class="s0">, </span><span class="s3">&quot;shift&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2"># In OSX, the control and super (aka cmd/apple) keys are switched.</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Control&quot;</span><span class="s0">, </span><span class="s3">&quot;control&quot; </span><span class="s0">if </span><span class="s1">sys.platform != </span><span class="s3">&quot;darwin&quot; </span><span class="s0">else </span><span class="s3">&quot;cmd&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Meta&quot;</span><span class="s0">, </span><span class="s3">&quot;meta&quot; </span><span class="s0">if </span><span class="s1">sys.platform != </span><span class="s3">&quot;darwin&quot; </span><span class="s0">else </span><span class="s3">&quot;control&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Alt&quot;</span><span class="s0">, </span><span class="s3">&quot;alt&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_CapsLock&quot;</span><span class="s0">, </span><span class="s3">&quot;caps_lock&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_F1&quot;</span><span class="s0">, </span><span class="s3">&quot;f1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_F2&quot;</span><span class="s0">, </span><span class="s3">&quot;f2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_F3&quot;</span><span class="s0">, </span><span class="s3">&quot;f3&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_F4&quot;</span><span class="s0">, </span><span class="s3">&quot;f4&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_F5&quot;</span><span class="s0">, </span><span class="s3">&quot;f5&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_F6&quot;</span><span class="s0">, </span><span class="s3">&quot;f6&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_F7&quot;</span><span class="s0">, </span><span class="s3">&quot;f7&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_F8&quot;</span><span class="s0">, </span><span class="s3">&quot;f8&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_F9&quot;</span><span class="s0">, </span><span class="s3">&quot;f9&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_F10&quot;</span><span class="s0">, </span><span class="s3">&quot;f10&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_F10&quot;</span><span class="s0">, </span><span class="s3">&quot;f11&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_F12&quot;</span><span class="s0">, </span><span class="s3">&quot;f12&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Super_L&quot;</span><span class="s0">, </span><span class="s3">&quot;super&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Key_Super_R&quot;</span><span class="s0">, </span><span class="s3">&quot;super&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>
<span class="s1">}</span>
<span class="s2"># Define which modifier keys are collected on keyboard events.</span>
<span class="s2"># Elements are (Qt::KeyboardModifiers, Qt::Key) tuples.</span>
<span class="s2"># Order determines the modifier order (ctrl+alt+...) reported by Matplotlib.</span>
<span class="s1">_MODIFIER_KEYS = [</span>
    <span class="s1">(_to_int(getattr(_enum(</span><span class="s3">&quot;QtCore.Qt.KeyboardModifier&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">mod))</span><span class="s0">,</span>
     <span class="s1">_to_int(getattr(_enum(</span><span class="s3">&quot;QtCore.Qt.Key&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">key)))</span>
    <span class="s0">for </span><span class="s1">mod</span><span class="s0">, </span><span class="s1">key </span><span class="s0">in </span><span class="s1">[</span>
        <span class="s1">(</span><span class="s3">&quot;ControlModifier&quot;</span><span class="s0">, </span><span class="s3">&quot;Key_Control&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;AltModifier&quot;</span><span class="s0">, </span><span class="s3">&quot;Key_Alt&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;ShiftModifier&quot;</span><span class="s0">, </span><span class="s3">&quot;Key_Shift&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;MetaModifier&quot;</span><span class="s0">, </span><span class="s3">&quot;Key_Meta&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>
<span class="s1">]</span>
<span class="s1">cursord = {</span>
    <span class="s1">k: getattr(_enum(</span><span class="s3">&quot;QtCore.Qt.CursorShape&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">v) </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">[</span>
        <span class="s1">(cursors.MOVE</span><span class="s0">, </span><span class="s3">&quot;SizeAllCursor&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(cursors.HAND</span><span class="s0">, </span><span class="s3">&quot;PointingHandCursor&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(cursors.POINTER</span><span class="s0">, </span><span class="s3">&quot;ArrowCursor&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(cursors.SELECT_REGION</span><span class="s0">, </span><span class="s3">&quot;CrossCursor&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(cursors.WAIT</span><span class="s0">, </span><span class="s3">&quot;WaitCursor&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(cursors.RESIZE_HORIZONTAL</span><span class="s0">, </span><span class="s3">&quot;SizeHorCursor&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(cursors.RESIZE_VERTICAL</span><span class="s0">, </span><span class="s3">&quot;SizeVerCursor&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>
<span class="s1">}</span>


<span class="s1">@_api.caching_module_getattr</span>
<span class="s0">class </span><span class="s1">__getattr__:</span>
    <span class="s1">qApp = _api.deprecated(</span>
        <span class="s3">&quot;3.6&quot;</span><span class="s0">, </span><span class="s1">alternative=</span><span class="s3">&quot;QtWidgets.QApplication.instance()&quot;</span><span class="s1">)(</span>
            <span class="s1">property(</span><span class="s0">lambda </span><span class="s1">self: QtWidgets.QApplication.instance()))</span>


<span class="s2"># lru_cache keeps a reference to the QApplication instance, keeping it from</span>
<span class="s2"># being GC'd.</span>
<span class="s1">@functools.lru_cache(</span><span class="s4">1</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">_create_qApp():</span>
    <span class="s1">app = QtWidgets.QApplication.instance()</span>

    <span class="s2"># Create a new QApplication and configure it if none exists yet, as only</span>
    <span class="s2"># one QApplication can exist at a time.</span>
    <span class="s0">if </span><span class="s1">app </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s2"># display_is_valid returns False only if on Linux and neither X11</span>
        <span class="s2"># nor Wayland display can be opened.</span>
        <span class="s0">if not </span><span class="s1">mpl._c_internal_utils.display_is_valid():</span>
            <span class="s0">raise </span><span class="s1">RuntimeError(</span><span class="s3">'Invalid DISPLAY variable'</span><span class="s1">)</span>

        <span class="s2"># Check to make sure a QApplication from a different major version</span>
        <span class="s2"># of Qt is not instantiated in the process</span>
        <span class="s0">if </span><span class="s1">QT_API </span><span class="s0">in </span><span class="s1">{</span><span class="s3">'PyQt6'</span><span class="s0">, </span><span class="s3">'PySide6'</span><span class="s1">}:</span>
            <span class="s1">other_bindings = (</span><span class="s3">'PyQt5'</span><span class="s0">, </span><span class="s3">'PySide2'</span><span class="s1">)</span>
        <span class="s0">elif </span><span class="s1">QT_API </span><span class="s0">in </span><span class="s1">{</span><span class="s3">'PyQt5'</span><span class="s0">, </span><span class="s3">'PySide2'</span><span class="s1">}:</span>
            <span class="s1">other_bindings = (</span><span class="s3">'PyQt6'</span><span class="s0">, </span><span class="s3">'PySide6'</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">RuntimeError(</span><span class="s3">&quot;Should never be here&quot;</span><span class="s1">)</span>

        <span class="s0">for </span><span class="s1">binding </span><span class="s0">in </span><span class="s1">other_bindings:</span>
            <span class="s1">mod = sys.modules.get(</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">binding</span><span class="s0">}</span><span class="s3">.QtWidgets'</span><span class="s1">)</span>
            <span class="s0">if </span><span class="s1">mod </span><span class="s0">is not None and </span><span class="s1">mod.QApplication.instance() </span><span class="s0">is not None</span><span class="s1">:</span>
                <span class="s1">other_core = sys.modules.get(</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">binding</span><span class="s0">}</span><span class="s3">.QtCore'</span><span class="s1">)</span>
                <span class="s1">_api.warn_external(</span>
                    <span class="s3">f'Matplotlib is using </span><span class="s0">{</span><span class="s1">QT_API</span><span class="s0">} </span><span class="s3">which wraps '</span>
                    <span class="s3">f'</span><span class="s0">{</span><span class="s1">QtCore.qVersion()</span><span class="s0">} </span><span class="s3">however an instantiated '</span>
                    <span class="s3">f'QApplication from </span><span class="s0">{</span><span class="s1">binding</span><span class="s0">} </span><span class="s3">which wraps '</span>
                    <span class="s3">f'</span><span class="s0">{</span><span class="s1">other_core.qVersion()</span><span class="s0">} </span><span class="s3">exists.  Mixing Qt major '</span>
                    <span class="s3">'versions may not work as expected.'</span>
                <span class="s1">)</span>
                <span class="s0">break</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">QtWidgets.QApplication.setAttribute(</span>
                <span class="s1">QtCore.Qt.AA_EnableHighDpiScaling)</span>
        <span class="s0">except </span><span class="s1">AttributeError:  </span><span class="s2"># Only for Qt&gt;=5.6, &lt;6.</span>
            <span class="s0">pass</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">QtWidgets.QApplication.setHighDpiScaleFactorRoundingPolicy(</span>
                <span class="s1">QtCore.Qt.HighDpiScaleFactorRoundingPolicy.PassThrough)</span>
        <span class="s0">except </span><span class="s1">AttributeError:  </span><span class="s2"># Only for Qt&gt;=5.14.</span>
            <span class="s0">pass</span>
        <span class="s1">app = QtWidgets.QApplication([</span><span class="s3">&quot;matplotlib&quot;</span><span class="s1">])</span>
        <span class="s0">if </span><span class="s1">sys.platform == </span><span class="s3">&quot;darwin&quot;</span><span class="s1">:</span>
            <span class="s1">image = str(cbook._get_data_path(</span><span class="s3">'images/matplotlib.svg'</span><span class="s1">))</span>
            <span class="s1">icon = QtGui.QIcon(image)</span>
            <span class="s1">app.setWindowIcon(icon)</span>
        <span class="s1">app.lastWindowClosed.connect(app.quit)</span>
        <span class="s1">cbook._setup_new_guiapp()</span>

    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">app.setAttribute(QtCore.Qt.AA_UseHighDpiPixmaps)  </span><span class="s2"># Only for Qt&lt;6.</span>
    <span class="s0">except </span><span class="s1">AttributeError:</span>
        <span class="s0">pass</span>

    <span class="s0">return </span><span class="s1">app</span>


<span class="s0">class </span><span class="s1">TimerQT(TimerBase):</span>
    <span class="s5">&quot;&quot;&quot;Subclass of `.TimerBase` using QTimer events.&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s2"># Create a new timer and connect the timeout() signal to the</span>
        <span class="s2"># _on_timer method.</span>
        <span class="s1">self._timer = QtCore.QTimer()</span>
        <span class="s1">self._timer.timeout.connect(self._on_timer)</span>
        <span class="s1">super().__init__(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">def </span><span class="s1">__del__(self):</span>
        <span class="s2"># The check for deletedness is needed to avoid an error at animation</span>
        <span class="s2"># shutdown with PySide2.</span>
        <span class="s0">if not </span><span class="s1">_isdeleted(self._timer):</span>
            <span class="s1">self._timer_stop()</span>

    <span class="s0">def </span><span class="s1">_timer_set_single_shot(self):</span>
        <span class="s1">self._timer.setSingleShot(self._single)</span>

    <span class="s0">def </span><span class="s1">_timer_set_interval(self):</span>
        <span class="s1">self._timer.setInterval(self._interval)</span>

    <span class="s0">def </span><span class="s1">_timer_start(self):</span>
        <span class="s1">self._timer.start()</span>

    <span class="s0">def </span><span class="s1">_timer_stop(self):</span>
        <span class="s1">self._timer.stop()</span>


<span class="s0">class </span><span class="s1">FigureCanvasQT(FigureCanvasBase</span><span class="s0">, </span><span class="s1">QtWidgets.QWidget):</span>
    <span class="s1">required_interactive_framework = </span><span class="s3">&quot;qt&quot;</span>
    <span class="s1">_timer_cls = TimerQT</span>
    <span class="s1">manager_class = _api.classproperty(</span><span class="s0">lambda </span><span class="s1">cls: FigureManagerQT)</span>

    <span class="s1">buttond = {</span>
        <span class="s1">getattr(_enum(</span><span class="s3">&quot;QtCore.Qt.MouseButton&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">k): v </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">[</span>
            <span class="s1">(</span><span class="s3">&quot;LeftButton&quot;</span><span class="s0">, </span><span class="s1">MouseButton.LEFT)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;RightButton&quot;</span><span class="s0">, </span><span class="s1">MouseButton.RIGHT)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;MiddleButton&quot;</span><span class="s0">, </span><span class="s1">MouseButton.MIDDLE)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;XButton1&quot;</span><span class="s0">, </span><span class="s1">MouseButton.BACK)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;XButton2&quot;</span><span class="s0">, </span><span class="s1">MouseButton.FORWARD)</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">}</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">figure=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s1">_create_qApp()</span>
        <span class="s1">super().__init__(figure=figure)</span>

        <span class="s1">self._draw_pending = </span><span class="s0">False</span>
        <span class="s1">self._is_drawing = </span><span class="s0">False</span>
        <span class="s1">self._draw_rect_callback = </span><span class="s0">lambda </span><span class="s1">painter: </span><span class="s0">None</span>
        <span class="s1">self._in_resize_event = </span><span class="s0">False</span>

        <span class="s1">self.setAttribute(</span>
            <span class="s1">_enum(</span><span class="s3">&quot;QtCore.Qt.WidgetAttribute&quot;</span><span class="s1">).WA_OpaquePaintEvent)</span>
        <span class="s1">self.setMouseTracking(</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">self.resize(*self.get_width_height())</span>

        <span class="s1">palette = QtGui.QPalette(QtGui.QColor(</span><span class="s3">&quot;white&quot;</span><span class="s1">))</span>
        <span class="s1">self.setPalette(palette)</span>

    <span class="s0">def </span><span class="s1">_update_pixel_ratio(self):</span>
        <span class="s0">if </span><span class="s1">self._set_device_pixel_ratio(</span>
                <span class="s1">self.devicePixelRatioF() </span><span class="s0">or </span><span class="s4">1</span><span class="s1">):  </span><span class="s2"># rarely, devicePixelRatioF=0</span>
            <span class="s2"># The easiest way to resize the canvas is to emit a resizeEvent</span>
            <span class="s2"># since we implement all the logic for resizing the canvas for</span>
            <span class="s2"># that event.</span>
            <span class="s1">event = QtGui.QResizeEvent(self.size()</span><span class="s0">, </span><span class="s1">self.size())</span>
            <span class="s1">self.resizeEvent(event)</span>

    <span class="s0">def </span><span class="s1">_update_screen(self</span><span class="s0">, </span><span class="s1">screen):</span>
        <span class="s2"># Handler for changes to a window's attached screen.</span>
        <span class="s1">self._update_pixel_ratio()</span>
        <span class="s0">if </span><span class="s1">screen </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">screen.physicalDotsPerInchChanged.connect(self._update_pixel_ratio)</span>
            <span class="s1">screen.logicalDotsPerInchChanged.connect(self._update_pixel_ratio)</span>

    <span class="s0">def </span><span class="s1">showEvent(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s2"># Set up correct pixel ratio, and connect to any signal changes for it,</span>
        <span class="s2"># once the window is shown (and thus has these attributes).</span>
        <span class="s1">window = self.window().windowHandle()</span>
        <span class="s1">window.screenChanged.connect(self._update_screen)</span>
        <span class="s1">self._update_screen(window.screen())</span>

    <span class="s0">def </span><span class="s1">set_cursor(self</span><span class="s0">, </span><span class="s1">cursor):</span>
        <span class="s2"># docstring inherited</span>
        <span class="s1">self.setCursor(_api.check_getitem(cursord</span><span class="s0">, </span><span class="s1">cursor=cursor))</span>

    <span class="s0">def </span><span class="s1">mouseEventCoords(self</span><span class="s0">, </span><span class="s1">pos=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Calculate mouse coordinates in physical pixels. 
 
        Qt uses logical pixels, but the figure is scaled to physical 
        pixels for rendering.  Transform to physical pixels so that 
        all of the down-stream transforms work as expected. 
 
        Also, the origin is different and needs to be corrected. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">pos </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">pos = self.mapFromGlobal(QtGui.QCursor.pos())</span>
        <span class="s0">elif </span><span class="s1">hasattr(pos</span><span class="s0">, </span><span class="s3">&quot;position&quot;</span><span class="s1">):  </span><span class="s2"># qt6 QtGui.QEvent</span>
            <span class="s1">pos = pos.position()</span>
        <span class="s0">elif </span><span class="s1">hasattr(pos</span><span class="s0">, </span><span class="s3">&quot;pos&quot;</span><span class="s1">):  </span><span class="s2"># qt5 QtCore.QEvent</span>
            <span class="s1">pos = pos.pos()</span>
        <span class="s2"># (otherwise, it's already a QPoint)</span>
        <span class="s1">x = pos.x()</span>
        <span class="s2"># flip y so y=0 is bottom of canvas</span>
        <span class="s1">y = self.figure.bbox.height / self.device_pixel_ratio - pos.y()</span>
        <span class="s0">return </span><span class="s1">x * self.device_pixel_ratio</span><span class="s0">, </span><span class="s1">y * self.device_pixel_ratio</span>

    <span class="s0">def </span><span class="s1">enterEvent(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s2"># Force querying of the modifiers, as the cached modifier state can</span>
        <span class="s2"># have been invalidated while the window was out of focus.</span>
        <span class="s1">mods = QtWidgets.QApplication.instance().queryKeyboardModifiers()</span>
        <span class="s1">LocationEvent(</span><span class="s3">&quot;figure_enter_event&quot;</span><span class="s0">, </span><span class="s1">self</span><span class="s0">,</span>
                      <span class="s1">*self.mouseEventCoords(event)</span><span class="s0">,</span>
                      <span class="s1">modifiers=self._mpl_modifiers(mods)</span><span class="s0">,</span>
                      <span class="s1">guiEvent=event)._process()</span>

    <span class="s0">def </span><span class="s1">leaveEvent(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s1">QtWidgets.QApplication.restoreOverrideCursor()</span>
        <span class="s1">LocationEvent(</span><span class="s3">&quot;figure_leave_event&quot;</span><span class="s0">, </span><span class="s1">self</span><span class="s0">,</span>
                      <span class="s1">*self.mouseEventCoords()</span><span class="s0">,</span>
                      <span class="s1">modifiers=self._mpl_modifiers()</span><span class="s0">,</span>
                      <span class="s1">guiEvent=event)._process()</span>

    <span class="s0">def </span><span class="s1">mousePressEvent(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s1">button = self.buttond.get(event.button())</span>
        <span class="s0">if </span><span class="s1">button </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">MouseEvent(</span><span class="s3">&quot;button_press_event&quot;</span><span class="s0">, </span><span class="s1">self</span><span class="s0">,</span>
                       <span class="s1">*self.mouseEventCoords(event)</span><span class="s0">, </span><span class="s1">button</span><span class="s0">,</span>
                       <span class="s1">modifiers=self._mpl_modifiers()</span><span class="s0">,</span>
                       <span class="s1">guiEvent=event)._process()</span>

    <span class="s0">def </span><span class="s1">mouseDoubleClickEvent(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s1">button = self.buttond.get(event.button())</span>
        <span class="s0">if </span><span class="s1">button </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">MouseEvent(</span><span class="s3">&quot;button_press_event&quot;</span><span class="s0">, </span><span class="s1">self</span><span class="s0">,</span>
                       <span class="s1">*self.mouseEventCoords(event)</span><span class="s0">, </span><span class="s1">button</span><span class="s0">, </span><span class="s1">dblclick=</span><span class="s0">True,</span>
                       <span class="s1">modifiers=self._mpl_modifiers()</span><span class="s0">,</span>
                       <span class="s1">guiEvent=event)._process()</span>

    <span class="s0">def </span><span class="s1">mouseMoveEvent(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s1">MouseEvent(</span><span class="s3">&quot;motion_notify_event&quot;</span><span class="s0">, </span><span class="s1">self</span><span class="s0">,</span>
                   <span class="s1">*self.mouseEventCoords(event)</span><span class="s0">,</span>
                   <span class="s1">modifiers=self._mpl_modifiers()</span><span class="s0">,</span>
                   <span class="s1">guiEvent=event)._process()</span>

    <span class="s0">def </span><span class="s1">mouseReleaseEvent(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s1">button = self.buttond.get(event.button())</span>
        <span class="s0">if </span><span class="s1">button </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">MouseEvent(</span><span class="s3">&quot;button_release_event&quot;</span><span class="s0">, </span><span class="s1">self</span><span class="s0">,</span>
                       <span class="s1">*self.mouseEventCoords(event)</span><span class="s0">, </span><span class="s1">button</span><span class="s0">,</span>
                       <span class="s1">modifiers=self._mpl_modifiers()</span><span class="s0">,</span>
                       <span class="s1">guiEvent=event)._process()</span>

    <span class="s0">def </span><span class="s1">wheelEvent(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s2"># from QWheelEvent::pixelDelta doc: pixelDelta is sometimes not</span>
        <span class="s2"># provided (`isNull()`) and is unreliable on X11 (&quot;xcb&quot;).</span>
        <span class="s0">if </span><span class="s1">(event.pixelDelta().isNull()</span>
                <span class="s0">or </span><span class="s1">QtWidgets.QApplication.instance().platformName() == </span><span class="s3">&quot;xcb&quot;</span><span class="s1">):</span>
            <span class="s1">steps = event.angleDelta().y() / </span><span class="s4">120</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">steps = event.pixelDelta().y()</span>
        <span class="s0">if </span><span class="s1">steps:</span>
            <span class="s1">MouseEvent(</span><span class="s3">&quot;scroll_event&quot;</span><span class="s0">, </span><span class="s1">self</span><span class="s0">,</span>
                       <span class="s1">*self.mouseEventCoords(event)</span><span class="s0">, </span><span class="s1">step=steps</span><span class="s0">,</span>
                       <span class="s1">modifiers=self._mpl_modifiers()</span><span class="s0">,</span>
                       <span class="s1">guiEvent=event)._process()</span>

    <span class="s0">def </span><span class="s1">keyPressEvent(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s1">key = self._get_key(event)</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">KeyEvent(</span><span class="s3">&quot;key_press_event&quot;</span><span class="s0">, </span><span class="s1">self</span><span class="s0">,</span>
                     <span class="s1">key</span><span class="s0">, </span><span class="s1">*self.mouseEventCoords()</span><span class="s0">,</span>
                     <span class="s1">guiEvent=event)._process()</span>

    <span class="s0">def </span><span class="s1">keyReleaseEvent(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s1">key = self._get_key(event)</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">KeyEvent(</span><span class="s3">&quot;key_release_event&quot;</span><span class="s0">, </span><span class="s1">self</span><span class="s0">,</span>
                     <span class="s1">key</span><span class="s0">, </span><span class="s1">*self.mouseEventCoords()</span><span class="s0">,</span>
                     <span class="s1">guiEvent=event)._process()</span>

    <span class="s0">def </span><span class="s1">resizeEvent(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s0">if </span><span class="s1">self._in_resize_event:  </span><span class="s2"># Prevent PyQt6 recursion</span>
            <span class="s0">return</span>
        <span class="s1">self._in_resize_event = </span><span class="s0">True</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">w = event.size().width() * self.device_pixel_ratio</span>
            <span class="s1">h = event.size().height() * self.device_pixel_ratio</span>
            <span class="s1">dpival = self.figure.dpi</span>
            <span class="s1">winch = w / dpival</span>
            <span class="s1">hinch = h / dpival</span>
            <span class="s1">self.figure.set_size_inches(winch</span><span class="s0">, </span><span class="s1">hinch</span><span class="s0">, </span><span class="s1">forward=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s2"># pass back into Qt to let it finish</span>
            <span class="s1">QtWidgets.QWidget.resizeEvent(self</span><span class="s0">, </span><span class="s1">event)</span>
            <span class="s2"># emit our resize events</span>
            <span class="s1">ResizeEvent(</span><span class="s3">&quot;resize_event&quot;</span><span class="s0">, </span><span class="s1">self)._process()</span>
            <span class="s1">self.draw_idle()</span>
        <span class="s0">finally</span><span class="s1">:</span>
            <span class="s1">self._in_resize_event = </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">sizeHint(self):</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">h = self.get_width_height()</span>
        <span class="s0">return </span><span class="s1">QtCore.QSize(w</span><span class="s0">, </span><span class="s1">h)</span>

    <span class="s0">def </span><span class="s1">minumumSizeHint(self):</span>
        <span class="s0">return </span><span class="s1">QtCore.QSize(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>

    <span class="s1">@staticmethod</span>
    <span class="s0">def </span><span class="s1">_mpl_modifiers(modifiers=</span><span class="s0">None, </span><span class="s1">*</span><span class="s0">, </span><span class="s1">exclude=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s0">if </span><span class="s1">modifiers </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">modifiers = QtWidgets.QApplication.instance().keyboardModifiers()</span>
        <span class="s1">modifiers = _to_int(modifiers)</span>
        <span class="s2"># get names of the pressed modifier keys</span>
        <span class="s2"># 'control' is named 'control' when a standalone key, but 'ctrl' when a</span>
        <span class="s2"># modifier</span>
        <span class="s2"># bit twiddling to pick out modifier keys from modifiers bitmask,</span>
        <span class="s2"># if exclude is a MODIFIER, it should not be duplicated in mods</span>
        <span class="s0">return </span><span class="s1">[SPECIAL_KEYS[key].replace(</span><span class="s3">'control'</span><span class="s0">, </span><span class="s3">'ctrl'</span><span class="s1">)</span>
                <span class="s0">for </span><span class="s1">mask</span><span class="s0">, </span><span class="s1">key </span><span class="s0">in </span><span class="s1">_MODIFIER_KEYS</span>
                <span class="s0">if </span><span class="s1">exclude != key </span><span class="s0">and </span><span class="s1">modifiers &amp; mask]</span>

    <span class="s0">def </span><span class="s1">_get_key(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s1">event_key = event.key()</span>
        <span class="s1">mods = self._mpl_modifiers(exclude=event_key)</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s2"># for certain keys (enter, left, backspace, etc) use a word for the</span>
            <span class="s2"># key, rather than Unicode</span>
            <span class="s1">key = SPECIAL_KEYS[event_key]</span>
        <span class="s0">except </span><span class="s1">KeyError:</span>
            <span class="s2"># Unicode defines code points up to 0x10ffff (sys.maxunicode)</span>
            <span class="s2"># QT will use Key_Codes larger than that for keyboard keys that are</span>
            <span class="s2"># not Unicode characters (like multimedia keys)</span>
            <span class="s2"># skip these</span>
            <span class="s2"># if you really want them, you should add them to SPECIAL_KEYS</span>
            <span class="s0">if </span><span class="s1">event_key &gt; sys.maxunicode:</span>
                <span class="s0">return None</span>

            <span class="s1">key = chr(event_key)</span>
            <span class="s2"># qt delivers capitalized letters.  fix capitalization</span>
            <span class="s2"># note that capslock is ignored</span>
            <span class="s0">if </span><span class="s3">'shift' </span><span class="s0">in </span><span class="s1">mods:</span>
                <span class="s1">mods.remove(</span><span class="s3">'shift'</span><span class="s1">)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">key = key.lower()</span>

        <span class="s0">return </span><span class="s3">'+'</span><span class="s1">.join(mods + [key])</span>

    <span class="s0">def </span><span class="s1">flush_events(self):</span>
        <span class="s2"># docstring inherited</span>
        <span class="s1">QtWidgets.QApplication.instance().processEvents()</span>

    <span class="s0">def </span><span class="s1">start_event_loop(self</span><span class="s0">, </span><span class="s1">timeout=</span><span class="s4">0</span><span class="s1">):</span>
        <span class="s2"># docstring inherited</span>
        <span class="s0">if </span><span class="s1">hasattr(self</span><span class="s0">, </span><span class="s3">&quot;_event_loop&quot;</span><span class="s1">) </span><span class="s0">and </span><span class="s1">self._event_loop.isRunning():</span>
            <span class="s0">raise </span><span class="s1">RuntimeError(</span><span class="s3">&quot;Event loop already running&quot;</span><span class="s1">)</span>
        <span class="s1">self._event_loop = event_loop = QtCore.QEventLoop()</span>
        <span class="s0">if </span><span class="s1">timeout &gt; </span><span class="s4">0</span><span class="s1">:</span>
            <span class="s1">_ = QtCore.QTimer.singleShot(int(timeout * </span><span class="s4">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">event_loop.quit)</span>

        <span class="s0">with </span><span class="s1">_maybe_allow_interrupt(event_loop):</span>
            <span class="s1">qt_compat._exec(event_loop)</span>

    <span class="s0">def </span><span class="s1">stop_event_loop(self</span><span class="s0">, </span><span class="s1">event=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s2"># docstring inherited</span>
        <span class="s0">if </span><span class="s1">hasattr(self</span><span class="s0">, </span><span class="s3">&quot;_event_loop&quot;</span><span class="s1">):</span>
            <span class="s1">self._event_loop.quit()</span>

    <span class="s0">def </span><span class="s1">draw(self):</span>
        <span class="s5">&quot;&quot;&quot;Render the figure, and queue a request for a Qt draw.&quot;&quot;&quot;</span>
        <span class="s2"># The renderer draw is done here; delaying causes problems with code</span>
        <span class="s2"># that uses the result of the draw() to update plot elements.</span>
        <span class="s0">if </span><span class="s1">self._is_drawing:</span>
            <span class="s0">return</span>
        <span class="s0">with </span><span class="s1">cbook._setattr_cm(self</span><span class="s0">, </span><span class="s1">_is_drawing=</span><span class="s0">True</span><span class="s1">):</span>
            <span class="s1">super().draw()</span>
        <span class="s1">self.update()</span>

    <span class="s0">def </span><span class="s1">draw_idle(self):</span>
        <span class="s5">&quot;&quot;&quot;Queue redraw of the Agg buffer and request Qt paintEvent.&quot;&quot;&quot;</span>
        <span class="s2"># The Agg draw needs to be handled by the same thread Matplotlib</span>
        <span class="s2"># modifies the scene graph from. Post Agg draw request to the</span>
        <span class="s2"># current event loop in order to ensure thread affinity and to</span>
        <span class="s2"># accumulate multiple draw requests from event handling.</span>
        <span class="s2"># TODO: queued signal connection might be safer than singleShot</span>
        <span class="s0">if not </span><span class="s1">(getattr(self</span><span class="s0">, </span><span class="s3">'_draw_pending'</span><span class="s0">, False</span><span class="s1">) </span><span class="s0">or</span>
                <span class="s1">getattr(self</span><span class="s0">, </span><span class="s3">'_is_drawing'</span><span class="s0">, False</span><span class="s1">)):</span>
            <span class="s1">self._draw_pending = </span><span class="s0">True</span>
            <span class="s1">QtCore.QTimer.singleShot(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">self._draw_idle)</span>

    <span class="s0">def </span><span class="s1">blit(self</span><span class="s0">, </span><span class="s1">bbox=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s2"># docstring inherited</span>
        <span class="s0">if </span><span class="s1">bbox </span><span class="s0">is None and </span><span class="s1">self.figure:</span>
            <span class="s1">bbox = self.figure.bbox  </span><span class="s2"># Blit the entire canvas if bbox is None.</span>
        <span class="s2"># repaint uses logical pixels, not physical pixels like the renderer.</span>
        <span class="s1">l</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">h = [int(pt / self.device_pixel_ratio) </span><span class="s0">for </span><span class="s1">pt </span><span class="s0">in </span><span class="s1">bbox.bounds]</span>
        <span class="s1">t = b + h</span>
        <span class="s1">self.repaint(l</span><span class="s0">, </span><span class="s1">self.rect().height() - t</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">h)</span>

    <span class="s0">def </span><span class="s1">_draw_idle(self):</span>
        <span class="s0">with </span><span class="s1">self._idle_draw_cntx():</span>
            <span class="s0">if not </span><span class="s1">self._draw_pending:</span>
                <span class="s0">return</span>
            <span class="s1">self._draw_pending = </span><span class="s0">False</span>
            <span class="s0">if </span><span class="s1">self.height() &lt; </span><span class="s4">0 </span><span class="s0">or </span><span class="s1">self.width() &lt; </span><span class="s4">0</span><span class="s1">:</span>
                <span class="s0">return</span>
            <span class="s0">try</span><span class="s1">:</span>
                <span class="s1">self.draw()</span>
            <span class="s0">except </span><span class="s1">Exception:</span>
                <span class="s2"># Uncaught exceptions are fatal for PyQt5, so catch them.</span>
                <span class="s1">traceback.print_exc()</span>

    <span class="s0">def </span><span class="s1">drawRectangle(self</span><span class="s0">, </span><span class="s1">rect):</span>
        <span class="s2"># Draw the zoom rectangle to the QPainter.  _draw_rect_callback needs</span>
        <span class="s2"># to be called at the end of paintEvent.</span>
        <span class="s0">if </span><span class="s1">rect </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">x0</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">h = [int(pt / self.device_pixel_ratio) </span><span class="s0">for </span><span class="s1">pt </span><span class="s0">in </span><span class="s1">rect]</span>
            <span class="s1">x1 = x0 + w</span>
            <span class="s1">y1 = y0 + h</span>
            <span class="s0">def </span><span class="s1">_draw_rect_callback(painter):</span>
                <span class="s1">pen = QtGui.QPen(</span>
                    <span class="s1">QtGui.QColor(</span><span class="s3">&quot;black&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s4">1 </span><span class="s1">/ self.device_pixel_ratio</span>
                <span class="s1">)</span>

                <span class="s1">pen.setDashPattern([</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>
                <span class="s0">for </span><span class="s1">color</span><span class="s0">, </span><span class="s1">offset </span><span class="s0">in </span><span class="s1">[</span>
                        <span class="s1">(QtGui.QColor(</span><span class="s3">&quot;black&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">(QtGui.QColor(</span><span class="s3">&quot;white&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]:</span>
                    <span class="s1">pen.setDashOffset(offset)</span>
                    <span class="s1">pen.setColor(color)</span>
                    <span class="s1">painter.setPen(pen)</span>
                    <span class="s2"># Draw the lines from x0, y0 towards x1, y1 so that the</span>
                    <span class="s2"># dashes don't &quot;jump&quot; when moving the zoom box.</span>
                    <span class="s1">painter.drawLine(x0</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">y1)</span>
                    <span class="s1">painter.drawLine(x0</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">x1</span><span class="s0">, </span><span class="s1">y0)</span>
                    <span class="s1">painter.drawLine(x0</span><span class="s0">, </span><span class="s1">y1</span><span class="s0">, </span><span class="s1">x1</span><span class="s0">, </span><span class="s1">y1)</span>
                    <span class="s1">painter.drawLine(x1</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">x1</span><span class="s0">, </span><span class="s1">y1)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">def </span><span class="s1">_draw_rect_callback(painter):</span>
                <span class="s0">return</span>
        <span class="s1">self._draw_rect_callback = _draw_rect_callback</span>
        <span class="s1">self.update()</span>


<span class="s0">class </span><span class="s1">MainWindow(QtWidgets.QMainWindow):</span>
    <span class="s1">closing = QtCore.Signal()</span>

    <span class="s0">def </span><span class="s1">closeEvent(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s1">self.closing.emit()</span>
        <span class="s1">super().closeEvent(event)</span>


<span class="s0">class </span><span class="s1">FigureManagerQT(FigureManagerBase):</span>
    <span class="s5">&quot;&quot;&quot; 
    Attributes 
    ---------- 
    canvas : `FigureCanvas` 
        The FigureCanvas instance 
    num : int or str 
        The Figure number 
    toolbar : qt.QToolBar 
        The qt.QToolBar 
    window : qt.QMainWindow 
        The qt.QMainWindow 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">canvas</span><span class="s0">, </span><span class="s1">num):</span>
        <span class="s1">self.window = MainWindow()</span>
        <span class="s1">super().__init__(canvas</span><span class="s0">, </span><span class="s1">num)</span>
        <span class="s1">self.window.closing.connect(</span>
            <span class="s2"># The lambda prevents the event from being immediately gc'd.</span>
            <span class="s0">lambda</span><span class="s1">: CloseEvent(</span><span class="s3">&quot;close_event&quot;</span><span class="s0">, </span><span class="s1">self.canvas)._process())</span>
        <span class="s1">self.window.closing.connect(self._widgetclosed)</span>

        <span class="s0">if </span><span class="s1">sys.platform != </span><span class="s3">&quot;darwin&quot;</span><span class="s1">:</span>
            <span class="s1">image = str(cbook._get_data_path(</span><span class="s3">'images/matplotlib.svg'</span><span class="s1">))</span>
            <span class="s1">icon = QtGui.QIcon(image)</span>
            <span class="s1">self.window.setWindowIcon(icon)</span>

        <span class="s1">self.window._destroying = </span><span class="s0">False</span>

        <span class="s0">if </span><span class="s1">self.toolbar:</span>
            <span class="s1">self.window.addToolBar(self.toolbar)</span>
            <span class="s1">tbs_height = self.toolbar.sizeHint().height()</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">tbs_height = </span><span class="s4">0</span>

        <span class="s2"># resize the main window so it will display the canvas with the</span>
        <span class="s2"># requested size:</span>
        <span class="s1">cs = canvas.sizeHint()</span>
        <span class="s1">cs_height = cs.height()</span>
        <span class="s1">height = cs_height + tbs_height</span>
        <span class="s1">self.window.resize(cs.width()</span><span class="s0">, </span><span class="s1">height)</span>

        <span class="s1">self.window.setCentralWidget(self.canvas)</span>

        <span class="s0">if </span><span class="s1">mpl.is_interactive():</span>
            <span class="s1">self.window.show()</span>
            <span class="s1">self.canvas.draw_idle()</span>

        <span class="s2"># Give the keyboard focus to the figure instead of the manager:</span>
        <span class="s2"># StrongFocus accepts both tab and click to focus and will enable the</span>
        <span class="s2"># canvas to process event without clicking.</span>
        <span class="s2"># https://doc.qt.io/qt-5/qt.html#FocusPolicy-enum</span>
        <span class="s1">self.canvas.setFocusPolicy(_enum(</span><span class="s3">&quot;QtCore.Qt.FocusPolicy&quot;</span><span class="s1">).StrongFocus)</span>
        <span class="s1">self.canvas.setFocus()</span>

        <span class="s1">self.window.raise_()</span>

    <span class="s0">def </span><span class="s1">full_screen_toggle(self):</span>
        <span class="s0">if </span><span class="s1">self.window.isFullScreen():</span>
            <span class="s1">self.window.showNormal()</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">self.window.showFullScreen()</span>

    <span class="s0">def </span><span class="s1">_widgetclosed(self):</span>
        <span class="s0">if </span><span class="s1">self.window._destroying:</span>
            <span class="s0">return</span>
        <span class="s1">self.window._destroying = </span><span class="s0">True</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">Gcf.destroy(self)</span>
        <span class="s0">except </span><span class="s1">AttributeError:</span>
            <span class="s0">pass</span>
            <span class="s2"># It seems that when the python session is killed,</span>
            <span class="s2"># Gcf can get destroyed before the Gcf.destroy</span>
            <span class="s2"># line is run, leading to a useless AttributeError.</span>

    <span class="s0">def </span><span class="s1">resize(self</span><span class="s0">, </span><span class="s1">width</span><span class="s0">, </span><span class="s1">height):</span>
        <span class="s2"># The Qt methods return sizes in 'virtual' pixels so we do need to</span>
        <span class="s2"># rescale from physical to logical pixels.</span>
        <span class="s1">width = int(width / self.canvas.device_pixel_ratio)</span>
        <span class="s1">height = int(height / self.canvas.device_pixel_ratio)</span>
        <span class="s1">extra_width = self.window.width() - self.canvas.width()</span>
        <span class="s1">extra_height = self.window.height() - self.canvas.height()</span>
        <span class="s1">self.canvas.resize(width</span><span class="s0">, </span><span class="s1">height)</span>
        <span class="s1">self.window.resize(width + extra_width</span><span class="s0">, </span><span class="s1">height + extra_height)</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">start_main_loop(cls):</span>
        <span class="s1">qapp = QtWidgets.QApplication.instance()</span>
        <span class="s0">if </span><span class="s1">qapp:</span>
            <span class="s0">with </span><span class="s1">_maybe_allow_interrupt(qapp):</span>
                <span class="s1">qt_compat._exec(qapp)</span>

    <span class="s0">def </span><span class="s1">show(self):</span>
        <span class="s1">self.window.show()</span>
        <span class="s0">if </span><span class="s1">mpl.rcParams[</span><span class="s3">'figure.raise_window'</span><span class="s1">]:</span>
            <span class="s1">self.window.activateWindow()</span>
            <span class="s1">self.window.raise_()</span>

    <span class="s0">def </span><span class="s1">destroy(self</span><span class="s0">, </span><span class="s1">*args):</span>
        <span class="s2"># check for qApp first, as PySide deletes it in its atexit handler</span>
        <span class="s0">if </span><span class="s1">QtWidgets.QApplication.instance() </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s0">return</span>
        <span class="s0">if </span><span class="s1">self.window._destroying:</span>
            <span class="s0">return</span>
        <span class="s1">self.window._destroying = </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">self.toolbar:</span>
            <span class="s1">self.toolbar.destroy()</span>
        <span class="s1">self.window.close()</span>

    <span class="s0">def </span><span class="s1">get_window_title(self):</span>
        <span class="s0">return </span><span class="s1">self.window.windowTitle()</span>

    <span class="s0">def </span><span class="s1">set_window_title(self</span><span class="s0">, </span><span class="s1">title):</span>
        <span class="s1">self.window.setWindowTitle(title)</span>


<span class="s0">class </span><span class="s1">NavigationToolbar2QT(NavigationToolbar2</span><span class="s0">, </span><span class="s1">QtWidgets.QToolBar):</span>
    <span class="s1">message = QtCore.Signal(str)</span>

    <span class="s1">toolitems = [*NavigationToolbar2.toolitems]</span>
    <span class="s1">toolitems.insert(</span>
        <span class="s2"># Add 'customize' action after 'subplots'</span>
        <span class="s1">[name </span><span class="s0">for </span><span class="s1">name</span><span class="s0">, </span><span class="s1">*_ </span><span class="s0">in </span><span class="s1">toolitems].index(</span><span class="s3">&quot;Subplots&quot;</span><span class="s1">) + </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;Customize&quot;</span><span class="s0">, </span><span class="s3">&quot;Edit axis, curve and image parameters&quot;</span><span class="s0">,</span>
         <span class="s3">&quot;qt4_editor_options&quot;</span><span class="s0">, </span><span class="s3">&quot;edit_parameters&quot;</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">canvas</span><span class="s0">, </span><span class="s1">parent=</span><span class="s0">None, </span><span class="s1">coordinates=</span><span class="s0">True</span><span class="s1">):</span>
        <span class="s5">&quot;&quot;&quot;coordinates: should we show the coordinates on the right?&quot;&quot;&quot;</span>
        <span class="s1">QtWidgets.QToolBar.__init__(self</span><span class="s0">, </span><span class="s1">parent)</span>
        <span class="s1">self.setAllowedAreas(QtCore.Qt.ToolBarArea(</span>
            <span class="s1">_to_int(_enum(</span><span class="s3">&quot;QtCore.Qt.ToolBarArea&quot;</span><span class="s1">).TopToolBarArea) |</span>
            <span class="s1">_to_int(_enum(</span><span class="s3">&quot;QtCore.Qt.ToolBarArea&quot;</span><span class="s1">).BottomToolBarArea)))</span>

        <span class="s1">self.coordinates = coordinates</span>
        <span class="s1">self._actions = {}  </span><span class="s2"># mapping of toolitem method names to QActions.</span>
        <span class="s1">self._subplot_dialog = </span><span class="s0">None</span>

        <span class="s0">for </span><span class="s1">text</span><span class="s0">, </span><span class="s1">tooltip_text</span><span class="s0">, </span><span class="s1">image_file</span><span class="s0">, </span><span class="s1">callback </span><span class="s0">in </span><span class="s1">self.toolitems:</span>
            <span class="s0">if </span><span class="s1">text </span><span class="s0">is None</span><span class="s1">:</span>
                <span class="s1">self.addSeparator()</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">a = self.addAction(self._icon(image_file + </span><span class="s3">'.png'</span><span class="s1">)</span><span class="s0">,</span>
                                   <span class="s1">text</span><span class="s0">, </span><span class="s1">getattr(self</span><span class="s0">, </span><span class="s1">callback))</span>
                <span class="s1">self._actions[callback] = a</span>
                <span class="s0">if </span><span class="s1">callback </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'zoom'</span><span class="s0">, </span><span class="s3">'pan'</span><span class="s1">]:</span>
                    <span class="s1">a.setCheckable(</span><span class="s0">True</span><span class="s1">)</span>
                <span class="s0">if </span><span class="s1">tooltip_text </span><span class="s0">is not None</span><span class="s1">:</span>
                    <span class="s1">a.setToolTip(tooltip_text)</span>

        <span class="s2"># Add the (x, y) location widget at the right side of the toolbar</span>
        <span class="s2"># The stretch factor is 1 which means any resizing of the toolbar</span>
        <span class="s2"># will resize this label instead of the buttons.</span>
        <span class="s0">if </span><span class="s1">self.coordinates:</span>
            <span class="s1">self.locLabel = QtWidgets.QLabel(</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">self)</span>
            <span class="s1">self.locLabel.setAlignment(QtCore.Qt.AlignmentFlag(</span>
                <span class="s1">_to_int(_enum(</span><span class="s3">&quot;QtCore.Qt.AlignmentFlag&quot;</span><span class="s1">).AlignRight) |</span>
                <span class="s1">_to_int(_enum(</span><span class="s3">&quot;QtCore.Qt.AlignmentFlag&quot;</span><span class="s1">).AlignVCenter)))</span>
            <span class="s1">self.locLabel.setSizePolicy(QtWidgets.QSizePolicy(</span>
                <span class="s1">_enum(</span><span class="s3">&quot;QtWidgets.QSizePolicy.Policy&quot;</span><span class="s1">).Expanding</span><span class="s0">,</span>
                <span class="s1">_enum(</span><span class="s3">&quot;QtWidgets.QSizePolicy.Policy&quot;</span><span class="s1">).Ignored</span><span class="s0">,</span>
            <span class="s1">))</span>
            <span class="s1">labelAction = self.addWidget(self.locLabel)</span>
            <span class="s1">labelAction.setVisible(</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">NavigationToolbar2.__init__(self</span><span class="s0">, </span><span class="s1">canvas)</span>

    <span class="s0">def </span><span class="s1">_icon(self</span><span class="s0">, </span><span class="s1">name):</span>
        <span class="s5">&quot;&quot;&quot; 
        Construct a `.QIcon` from an image file *name*, including the extension 
        and relative to Matplotlib's &quot;images&quot; data directory. 
        &quot;&quot;&quot;</span>
        <span class="s2"># use a high-resolution icon with suffix '_large' if available</span>
        <span class="s2"># note: user-provided icons may not have '_large' versions</span>
        <span class="s1">path_regular = cbook._get_data_path(</span><span class="s3">'images'</span><span class="s0">, </span><span class="s1">name)</span>
        <span class="s1">path_large = path_regular.with_name(</span>
            <span class="s1">path_regular.name.replace(</span><span class="s3">'.png'</span><span class="s0">, </span><span class="s3">'_large.png'</span><span class="s1">))</span>
        <span class="s1">filename = str(path_large </span><span class="s0">if </span><span class="s1">path_large.exists() </span><span class="s0">else </span><span class="s1">path_regular)</span>

        <span class="s1">pm = QtGui.QPixmap(filename)</span>
        <span class="s1">pm.setDevicePixelRatio(</span>
            <span class="s1">self.devicePixelRatioF() </span><span class="s0">or </span><span class="s4">1</span><span class="s1">)  </span><span class="s2"># rarely, devicePixelRatioF=0</span>
        <span class="s0">if </span><span class="s1">self.palette().color(self.backgroundRole()).value() &lt; </span><span class="s4">128</span><span class="s1">:</span>
            <span class="s1">icon_color = self.palette().color(self.foregroundRole())</span>
            <span class="s1">mask = pm.createMaskFromColor(</span>
                <span class="s1">QtGui.QColor(</span><span class="s3">'black'</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">_enum(</span><span class="s3">&quot;QtCore.Qt.MaskMode&quot;</span><span class="s1">).MaskOutColor)</span>
            <span class="s1">pm.fill(icon_color)</span>
            <span class="s1">pm.setMask(mask)</span>
        <span class="s0">return </span><span class="s1">QtGui.QIcon(pm)</span>

    <span class="s0">def </span><span class="s1">edit_parameters(self):</span>
        <span class="s1">axes = self.canvas.figure.get_axes()</span>
        <span class="s0">if not </span><span class="s1">axes:</span>
            <span class="s1">QtWidgets.QMessageBox.warning(</span>
                <span class="s1">self.canvas.parent()</span><span class="s0">, </span><span class="s3">&quot;Error&quot;</span><span class="s0">, </span><span class="s3">&quot;There are no axes to edit.&quot;</span><span class="s1">)</span>
            <span class="s0">return</span>
        <span class="s0">elif </span><span class="s1">len(axes) == </span><span class="s4">1</span><span class="s1">:</span>
            <span class="s1">ax</span><span class="s0">, </span><span class="s1">= axes</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">titles = [</span>
                <span class="s1">ax.get_label() </span><span class="s0">or</span>
                <span class="s1">ax.get_title() </span><span class="s0">or</span>
                <span class="s1">ax.get_title(</span><span class="s3">&quot;left&quot;</span><span class="s1">) </span><span class="s0">or</span>
                <span class="s1">ax.get_title(</span><span class="s3">&quot;right&quot;</span><span class="s1">) </span><span class="s0">or</span>
                <span class="s3">&quot; - &quot;</span><span class="s1">.join(filter(</span><span class="s0">None, </span><span class="s1">[ax.get_xlabel()</span><span class="s0">, </span><span class="s1">ax.get_ylabel()])) </span><span class="s0">or</span>
                <span class="s3">f&quot;&lt;anonymous </span><span class="s0">{</span><span class="s1">type(ax).__name__</span><span class="s0">}</span><span class="s3">&gt;&quot;</span>
                <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axes]</span>
            <span class="s1">duplicate_titles = [</span>
                <span class="s1">title </span><span class="s0">for </span><span class="s1">title </span><span class="s0">in </span><span class="s1">titles </span><span class="s0">if </span><span class="s1">titles.count(title) &gt; </span><span class="s4">1</span><span class="s1">]</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">enumerate(axes):</span>
                <span class="s0">if </span><span class="s1">titles[i] </span><span class="s0">in </span><span class="s1">duplicate_titles:</span>
                    <span class="s1">titles[i] += </span><span class="s3">f&quot; (id: </span><span class="s0">{</span><span class="s1">id(ax)</span><span class="s0">:</span><span class="s3">#x</span><span class="s0">}</span><span class="s3">)&quot;  </span><span class="s2"># Deduplicate titles.</span>
            <span class="s1">item</span><span class="s0">, </span><span class="s1">ok = QtWidgets.QInputDialog.getItem(</span>
                <span class="s1">self.canvas.parent()</span><span class="s0">,</span>
                <span class="s3">'Customize'</span><span class="s0">, </span><span class="s3">'Select axes:'</span><span class="s0">, </span><span class="s1">titles</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, False</span><span class="s1">)</span>
            <span class="s0">if not </span><span class="s1">ok:</span>
                <span class="s0">return</span>
            <span class="s1">ax = axes[titles.index(item)]</span>
        <span class="s1">figureoptions.figure_edit(ax</span><span class="s0">, </span><span class="s1">self)</span>

    <span class="s0">def </span><span class="s1">_update_buttons_checked(self):</span>
        <span class="s2"># sync button checkstates to match active mode</span>
        <span class="s0">if </span><span class="s3">'pan' </span><span class="s0">in </span><span class="s1">self._actions:</span>
            <span class="s1">self._actions[</span><span class="s3">'pan'</span><span class="s1">].setChecked(self.mode.name == </span><span class="s3">'PAN'</span><span class="s1">)</span>
        <span class="s0">if </span><span class="s3">'zoom' </span><span class="s0">in </span><span class="s1">self._actions:</span>
            <span class="s1">self._actions[</span><span class="s3">'zoom'</span><span class="s1">].setChecked(self.mode.name == </span><span class="s3">'ZOOM'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">pan(self</span><span class="s0">, </span><span class="s1">*args):</span>
        <span class="s1">super().pan(*args)</span>
        <span class="s1">self._update_buttons_checked()</span>

    <span class="s0">def </span><span class="s1">zoom(self</span><span class="s0">, </span><span class="s1">*args):</span>
        <span class="s1">super().zoom(*args)</span>
        <span class="s1">self._update_buttons_checked()</span>

    <span class="s0">def </span><span class="s1">set_message(self</span><span class="s0">, </span><span class="s1">s):</span>
        <span class="s1">self.message.emit(s)</span>
        <span class="s0">if </span><span class="s1">self.coordinates:</span>
            <span class="s1">self.locLabel.setText(s)</span>

    <span class="s0">def </span><span class="s1">draw_rubberband(self</span><span class="s0">, </span><span class="s1">event</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">x1</span><span class="s0">, </span><span class="s1">y1):</span>
        <span class="s1">height = self.canvas.figure.bbox.height</span>
        <span class="s1">y1 = height - y1</span>
        <span class="s1">y0 = height - y0</span>
        <span class="s1">rect = [int(val) </span><span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s1">(x0</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">x1 - x0</span><span class="s0">, </span><span class="s1">y1 - y0)]</span>
        <span class="s1">self.canvas.drawRectangle(rect)</span>

    <span class="s0">def </span><span class="s1">remove_rubberband(self):</span>
        <span class="s1">self.canvas.drawRectangle(</span><span class="s0">None</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">configure_subplots(self):</span>
        <span class="s0">if </span><span class="s1">self._subplot_dialog </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">self._subplot_dialog = SubplotToolQt(</span>
                <span class="s1">self.canvas.figure</span><span class="s0">, </span><span class="s1">self.canvas.parent())</span>
            <span class="s1">self.canvas.mpl_connect(</span>
                <span class="s3">&quot;close_event&quot;</span><span class="s0">, lambda </span><span class="s1">e: self._subplot_dialog.reject())</span>
        <span class="s1">self._subplot_dialog.update_from_current_subplotpars()</span>
        <span class="s1">self._subplot_dialog.show()</span>
        <span class="s0">return </span><span class="s1">self._subplot_dialog</span>

    <span class="s0">def </span><span class="s1">save_figure(self</span><span class="s0">, </span><span class="s1">*args):</span>
        <span class="s1">filetypes = self.canvas.get_supported_filetypes_grouped()</span>
        <span class="s1">sorted_filetypes = sorted(filetypes.items())</span>
        <span class="s1">default_filetype = self.canvas.get_default_filetype()</span>

        <span class="s1">startpath = os.path.expanduser(mpl.rcParams[</span><span class="s3">'savefig.directory'</span><span class="s1">])</span>
        <span class="s1">start = os.path.join(startpath</span><span class="s0">, </span><span class="s1">self.canvas.get_default_filename())</span>
        <span class="s1">filters = []</span>
        <span class="s1">selectedFilter = </span><span class="s0">None</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s0">, </span><span class="s1">exts </span><span class="s0">in </span><span class="s1">sorted_filetypes:</span>
            <span class="s1">exts_list = </span><span class="s3">&quot; &quot;</span><span class="s1">.join([</span><span class="s3">'*.%s' </span><span class="s1">% ext </span><span class="s0">for </span><span class="s1">ext </span><span class="s0">in </span><span class="s1">exts])</span>
            <span class="s1">filter = </span><span class="s3">'%s (%s)' </span><span class="s1">% (name</span><span class="s0">, </span><span class="s1">exts_list)</span>
            <span class="s0">if </span><span class="s1">default_filetype </span><span class="s0">in </span><span class="s1">exts:</span>
                <span class="s1">selectedFilter = filter</span>
            <span class="s1">filters.append(filter)</span>
        <span class="s1">filters = </span><span class="s3">';;'</span><span class="s1">.join(filters)</span>

        <span class="s1">fname</span><span class="s0">, </span><span class="s1">filter = qt_compat._getSaveFileName(</span>
            <span class="s1">self.canvas.parent()</span><span class="s0">, </span><span class="s3">&quot;Choose a filename to save to&quot;</span><span class="s0">, </span><span class="s1">start</span><span class="s0">,</span>
            <span class="s1">filters</span><span class="s0">, </span><span class="s1">selectedFilter)</span>
        <span class="s0">if </span><span class="s1">fname:</span>
            <span class="s2"># Save dir for next time, unless empty str (i.e., use cwd).</span>
            <span class="s0">if </span><span class="s1">startpath != </span><span class="s3">&quot;&quot;</span><span class="s1">:</span>
                <span class="s1">mpl.rcParams[</span><span class="s3">'savefig.directory'</span><span class="s1">] = os.path.dirname(fname)</span>
            <span class="s0">try</span><span class="s1">:</span>
                <span class="s1">self.canvas.figure.savefig(fname)</span>
            <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e:</span>
                <span class="s1">QtWidgets.QMessageBox.critical(</span>
                    <span class="s1">self</span><span class="s0">, </span><span class="s3">&quot;Error saving file&quot;</span><span class="s0">, </span><span class="s1">str(e)</span><span class="s0">,</span>
                    <span class="s1">_enum(</span><span class="s3">&quot;QtWidgets.QMessageBox.StandardButton&quot;</span><span class="s1">).Ok</span><span class="s0">,</span>
                    <span class="s1">_enum(</span><span class="s3">&quot;QtWidgets.QMessageBox.StandardButton&quot;</span><span class="s1">).NoButton)</span>

    <span class="s0">def </span><span class="s1">set_history_buttons(self):</span>
        <span class="s1">can_backward = self._nav_stack._pos &gt; </span><span class="s4">0</span>
        <span class="s1">can_forward = self._nav_stack._pos &lt; len(self._nav_stack._elements) - </span><span class="s4">1</span>
        <span class="s0">if </span><span class="s3">'back' </span><span class="s0">in </span><span class="s1">self._actions:</span>
            <span class="s1">self._actions[</span><span class="s3">'back'</span><span class="s1">].setEnabled(can_backward)</span>
        <span class="s0">if </span><span class="s3">'forward' </span><span class="s0">in </span><span class="s1">self._actions:</span>
            <span class="s1">self._actions[</span><span class="s3">'forward'</span><span class="s1">].setEnabled(can_forward)</span>


<span class="s0">class </span><span class="s1">SubplotToolQt(QtWidgets.QDialog):</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">targetfig</span><span class="s0">, </span><span class="s1">parent):</span>
        <span class="s1">super().__init__()</span>
        <span class="s1">self.setWindowIcon(QtGui.QIcon(</span>
            <span class="s1">str(cbook._get_data_path(</span><span class="s3">&quot;images/matplotlib.png&quot;</span><span class="s1">))))</span>
        <span class="s1">self.setObjectName(</span><span class="s3">&quot;SubplotTool&quot;</span><span class="s1">)</span>
        <span class="s1">self._spinboxes = {}</span>
        <span class="s1">main_layout = QtWidgets.QHBoxLayout()</span>
        <span class="s1">self.setLayout(main_layout)</span>
        <span class="s0">for </span><span class="s1">group</span><span class="s0">, </span><span class="s1">spinboxes</span><span class="s0">, </span><span class="s1">buttons </span><span class="s0">in </span><span class="s1">[</span>
                <span class="s1">(</span><span class="s3">&quot;Borders&quot;</span><span class="s0">,</span>
                 <span class="s1">[</span><span class="s3">&quot;top&quot;</span><span class="s0">, </span><span class="s3">&quot;bottom&quot;</span><span class="s0">, </span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s3">&quot;right&quot;</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">[(</span><span class="s3">&quot;Export values&quot;</span><span class="s0">, </span><span class="s1">self._export_values)])</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;Spacings&quot;</span><span class="s0">,</span>
                 <span class="s1">[</span><span class="s3">&quot;hspace&quot;</span><span class="s0">, </span><span class="s3">&quot;wspace&quot;</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">[(</span><span class="s3">&quot;Tight layout&quot;</span><span class="s0">, </span><span class="s1">self._tight_layout)</span><span class="s0">,</span>
                  <span class="s1">(</span><span class="s3">&quot;Reset&quot;</span><span class="s0">, </span><span class="s1">self._reset)</span><span class="s0">,</span>
                  <span class="s1">(</span><span class="s3">&quot;Close&quot;</span><span class="s0">, </span><span class="s1">self.close)])]:</span>
            <span class="s1">layout = QtWidgets.QVBoxLayout()</span>
            <span class="s1">main_layout.addLayout(layout)</span>
            <span class="s1">box = QtWidgets.QGroupBox(group)</span>
            <span class="s1">layout.addWidget(box)</span>
            <span class="s1">inner = QtWidgets.QFormLayout(box)</span>
            <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">spinboxes:</span>
                <span class="s1">self._spinboxes[name] = spinbox = QtWidgets.QDoubleSpinBox()</span>
                <span class="s1">spinbox.setRange(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
                <span class="s1">spinbox.setDecimals(</span><span class="s4">3</span><span class="s1">)</span>
                <span class="s1">spinbox.setSingleStep(</span><span class="s4">0.005</span><span class="s1">)</span>
                <span class="s1">spinbox.setKeyboardTracking(</span><span class="s0">False</span><span class="s1">)</span>
                <span class="s1">spinbox.valueChanged.connect(self._on_value_changed)</span>
                <span class="s1">inner.addRow(name</span><span class="s0">, </span><span class="s1">spinbox)</span>
            <span class="s1">layout.addStretch(</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s0">for </span><span class="s1">name</span><span class="s0">, </span><span class="s1">method </span><span class="s0">in </span><span class="s1">buttons:</span>
                <span class="s1">button = QtWidgets.QPushButton(name)</span>
                <span class="s2"># Don't trigger on &lt;enter&gt;, which is used to input values.</span>
                <span class="s1">button.setAutoDefault(</span><span class="s0">False</span><span class="s1">)</span>
                <span class="s1">button.clicked.connect(method)</span>
                <span class="s1">layout.addWidget(button)</span>
                <span class="s0">if </span><span class="s1">name == </span><span class="s3">&quot;Close&quot;</span><span class="s1">:</span>
                    <span class="s1">button.setFocus()</span>
        <span class="s1">self._figure = targetfig</span>
        <span class="s1">self._defaults = {}</span>
        <span class="s1">self._export_values_dialog = </span><span class="s0">None</span>
        <span class="s1">self.update_from_current_subplotpars()</span>

    <span class="s0">def </span><span class="s1">update_from_current_subplotpars(self):</span>
        <span class="s1">self._defaults = {spinbox: getattr(self._figure.subplotpars</span><span class="s0">, </span><span class="s1">name)</span>
                          <span class="s0">for </span><span class="s1">name</span><span class="s0">, </span><span class="s1">spinbox </span><span class="s0">in </span><span class="s1">self._spinboxes.items()}</span>
        <span class="s1">self._reset()  </span><span class="s2"># Set spinbox current values without triggering signals.</span>

    <span class="s0">def </span><span class="s1">_export_values(self):</span>
        <span class="s2"># Explicitly round to 3 decimals (which is also the spinbox precision)</span>
        <span class="s2"># to avoid numbers of the form 0.100...001.</span>
        <span class="s1">self._export_values_dialog = QtWidgets.QDialog()</span>
        <span class="s1">layout = QtWidgets.QVBoxLayout()</span>
        <span class="s1">self._export_values_dialog.setLayout(layout)</span>
        <span class="s1">text = QtWidgets.QPlainTextEdit()</span>
        <span class="s1">text.setReadOnly(</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">layout.addWidget(text)</span>
        <span class="s1">text.setPlainText(</span>
            <span class="s3">&quot;,</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s1">.join(</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">attr</span><span class="s0">}</span><span class="s3">=</span><span class="s0">{</span><span class="s1">spinbox.value()</span><span class="s0">:</span><span class="s3">.3</span><span class="s0">}</span><span class="s3">&quot;</span>
                       <span class="s0">for </span><span class="s1">attr</span><span class="s0">, </span><span class="s1">spinbox </span><span class="s0">in </span><span class="s1">self._spinboxes.items()))</span>
        <span class="s2"># Adjust the height of the text widget to fit the whole text, plus</span>
        <span class="s2"># some padding.</span>
        <span class="s1">size = text.maximumSize()</span>
        <span class="s1">size.setHeight(</span>
            <span class="s1">QtGui.QFontMetrics(text.document().defaultFont())</span>
            <span class="s1">.size(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">text.toPlainText()).height() + </span><span class="s4">20</span><span class="s1">)</span>
        <span class="s1">text.setMaximumSize(size)</span>
        <span class="s1">self._export_values_dialog.show()</span>

    <span class="s0">def </span><span class="s1">_on_value_changed(self):</span>
        <span class="s1">spinboxes = self._spinboxes</span>
        <span class="s2"># Set all mins and maxes, so that this can also be used in _reset().</span>
        <span class="s0">for </span><span class="s1">lower</span><span class="s0">, </span><span class="s1">higher </span><span class="s0">in </span><span class="s1">[(</span><span class="s3">&quot;bottom&quot;</span><span class="s0">, </span><span class="s3">&quot;top&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">&quot;left&quot;</span><span class="s0">, </span><span class="s3">&quot;right&quot;</span><span class="s1">)]:</span>
            <span class="s1">spinboxes[higher].setMinimum(spinboxes[lower].value() + </span><span class="s4">.001</span><span class="s1">)</span>
            <span class="s1">spinboxes[lower].setMaximum(spinboxes[higher].value() - </span><span class="s4">.001</span><span class="s1">)</span>
        <span class="s1">self._figure.subplots_adjust(</span>
            <span class="s1">**{attr: spinbox.value() </span><span class="s0">for </span><span class="s1">attr</span><span class="s0">, </span><span class="s1">spinbox </span><span class="s0">in </span><span class="s1">spinboxes.items()})</span>
        <span class="s1">self._figure.canvas.draw_idle()</span>

    <span class="s0">def </span><span class="s1">_tight_layout(self):</span>
        <span class="s1">self._figure.tight_layout()</span>
        <span class="s0">for </span><span class="s1">attr</span><span class="s0">, </span><span class="s1">spinbox </span><span class="s0">in </span><span class="s1">self._spinboxes.items():</span>
            <span class="s1">spinbox.blockSignals(</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">spinbox.setValue(vars(self._figure.subplotpars)[attr])</span>
            <span class="s1">spinbox.blockSignals(</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">self._figure.canvas.draw_idle()</span>

    <span class="s0">def </span><span class="s1">_reset(self):</span>
        <span class="s0">for </span><span class="s1">spinbox</span><span class="s0">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">self._defaults.items():</span>
            <span class="s1">spinbox.setRange(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">spinbox.blockSignals(</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">spinbox.setValue(value)</span>
            <span class="s1">spinbox.blockSignals(</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">self._on_value_changed()</span>


<span class="s0">class </span><span class="s1">ToolbarQt(ToolContainerBase</span><span class="s0">, </span><span class="s1">QtWidgets.QToolBar):</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">toolmanager</span><span class="s0">, </span><span class="s1">parent=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s1">ToolContainerBase.__init__(self</span><span class="s0">, </span><span class="s1">toolmanager)</span>
        <span class="s1">QtWidgets.QToolBar.__init__(self</span><span class="s0">, </span><span class="s1">parent)</span>
        <span class="s1">self.setAllowedAreas(QtCore.Qt.ToolBarArea(</span>
            <span class="s1">_to_int(_enum(</span><span class="s3">&quot;QtCore.Qt.ToolBarArea&quot;</span><span class="s1">).TopToolBarArea) |</span>
            <span class="s1">_to_int(_enum(</span><span class="s3">&quot;QtCore.Qt.ToolBarArea&quot;</span><span class="s1">).BottomToolBarArea)))</span>
        <span class="s1">message_label = QtWidgets.QLabel(</span><span class="s3">&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">message_label.setAlignment(QtCore.Qt.AlignmentFlag(</span>
            <span class="s1">_to_int(_enum(</span><span class="s3">&quot;QtCore.Qt.AlignmentFlag&quot;</span><span class="s1">).AlignRight) |</span>
            <span class="s1">_to_int(_enum(</span><span class="s3">&quot;QtCore.Qt.AlignmentFlag&quot;</span><span class="s1">).AlignVCenter)))</span>
        <span class="s1">message_label.setSizePolicy(QtWidgets.QSizePolicy(</span>
            <span class="s1">_enum(</span><span class="s3">&quot;QtWidgets.QSizePolicy.Policy&quot;</span><span class="s1">).Expanding</span><span class="s0">,</span>
            <span class="s1">_enum(</span><span class="s3">&quot;QtWidgets.QSizePolicy.Policy&quot;</span><span class="s1">).Ignored</span><span class="s0">,</span>
        <span class="s1">))</span>
        <span class="s1">self._message_action = self.addWidget(message_label)</span>
        <span class="s1">self._toolitems = {}</span>
        <span class="s1">self._groups = {}</span>

    <span class="s0">def </span><span class="s1">add_toolitem(</span>
            <span class="s1">self</span><span class="s0">, </span><span class="s1">name</span><span class="s0">, </span><span class="s1">group</span><span class="s0">, </span><span class="s1">position</span><span class="s0">, </span><span class="s1">image_file</span><span class="s0">, </span><span class="s1">description</span><span class="s0">, </span><span class="s1">toggle):</span>

        <span class="s1">button = QtWidgets.QToolButton(self)</span>
        <span class="s0">if </span><span class="s1">image_file:</span>
            <span class="s1">button.setIcon(NavigationToolbar2QT._icon(self</span><span class="s0">, </span><span class="s1">image_file))</span>
        <span class="s1">button.setText(name)</span>
        <span class="s0">if </span><span class="s1">description:</span>
            <span class="s1">button.setToolTip(description)</span>

        <span class="s0">def </span><span class="s1">handler():</span>
            <span class="s1">self.trigger_tool(name)</span>
        <span class="s0">if </span><span class="s1">toggle:</span>
            <span class="s1">button.setCheckable(</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">button.toggled.connect(handler)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">button.clicked.connect(handler)</span>

        <span class="s1">self._toolitems.setdefault(name</span><span class="s0">, </span><span class="s1">[])</span>
        <span class="s1">self._add_to_group(group</span><span class="s0">, </span><span class="s1">name</span><span class="s0">, </span><span class="s1">button</span><span class="s0">, </span><span class="s1">position)</span>
        <span class="s1">self._toolitems[name].append((button</span><span class="s0">, </span><span class="s1">handler))</span>

    <span class="s0">def </span><span class="s1">_add_to_group(self</span><span class="s0">, </span><span class="s1">group</span><span class="s0">, </span><span class="s1">name</span><span class="s0">, </span><span class="s1">button</span><span class="s0">, </span><span class="s1">position):</span>
        <span class="s1">gr = self._groups.get(group</span><span class="s0">, </span><span class="s1">[])</span>
        <span class="s0">if not </span><span class="s1">gr:</span>
            <span class="s1">sep = self.insertSeparator(self._message_action)</span>
            <span class="s1">gr.append(sep)</span>
        <span class="s1">before = gr[position]</span>
        <span class="s1">widget = self.insertWidget(before</span><span class="s0">, </span><span class="s1">button)</span>
        <span class="s1">gr.insert(position</span><span class="s0">, </span><span class="s1">widget)</span>
        <span class="s1">self._groups[group] = gr</span>

    <span class="s0">def </span><span class="s1">toggle_toolitem(self</span><span class="s0">, </span><span class="s1">name</span><span class="s0">, </span><span class="s1">toggled):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self._toolitems:</span>
            <span class="s0">return</span>
        <span class="s0">for </span><span class="s1">button</span><span class="s0">, </span><span class="s1">handler </span><span class="s0">in </span><span class="s1">self._toolitems[name]:</span>
            <span class="s1">button.toggled.disconnect(handler)</span>
            <span class="s1">button.setChecked(toggled)</span>
            <span class="s1">button.toggled.connect(handler)</span>

    <span class="s0">def </span><span class="s1">remove_toolitem(self</span><span class="s0">, </span><span class="s1">name):</span>
        <span class="s0">for </span><span class="s1">button</span><span class="s0">, </span><span class="s1">handler </span><span class="s0">in </span><span class="s1">self._toolitems[name]:</span>
            <span class="s1">button.setParent(</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s0">del </span><span class="s1">self._toolitems[name]</span>

    <span class="s0">def </span><span class="s1">set_message(self</span><span class="s0">, </span><span class="s1">s):</span>
        <span class="s1">self.widgetForAction(self._message_action).setText(s)</span>


<span class="s1">@backend_tools._register_tool_class(FigureCanvasQT)</span>
<span class="s0">class </span><span class="s1">ConfigureSubplotsQt(backend_tools.ConfigureSubplotsBase):</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s1">super().__init__(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">self._subplot_dialog = </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">trigger(self</span><span class="s0">, </span><span class="s1">*args):</span>
        <span class="s1">NavigationToolbar2QT.configure_subplots(self)</span>


<span class="s1">@backend_tools._register_tool_class(FigureCanvasQT)</span>
<span class="s0">class </span><span class="s1">SaveFigureQt(backend_tools.SaveFigureBase):</span>
    <span class="s0">def </span><span class="s1">trigger(self</span><span class="s0">, </span><span class="s1">*args):</span>
        <span class="s1">NavigationToolbar2QT.save_figure(</span>
            <span class="s1">self._make_classic_style_pseudo_toolbar())</span>


<span class="s1">@backend_tools._register_tool_class(FigureCanvasQT)</span>
<span class="s0">class </span><span class="s1">RubberbandQt(backend_tools.RubberbandBase):</span>
    <span class="s0">def </span><span class="s1">draw_rubberband(self</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">x1</span><span class="s0">, </span><span class="s1">y1):</span>
        <span class="s1">NavigationToolbar2QT.draw_rubberband(</span>
            <span class="s1">self._make_classic_style_pseudo_toolbar()</span><span class="s0">, None, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">x1</span><span class="s0">, </span><span class="s1">y1)</span>

    <span class="s0">def </span><span class="s1">remove_rubberband(self):</span>
        <span class="s1">NavigationToolbar2QT.remove_rubberband(</span>
            <span class="s1">self._make_classic_style_pseudo_toolbar())</span>


<span class="s1">@backend_tools._register_tool_class(FigureCanvasQT)</span>
<span class="s0">class </span><span class="s1">HelpQt(backend_tools.ToolHelpBase):</span>
    <span class="s0">def </span><span class="s1">trigger(self</span><span class="s0">, </span><span class="s1">*args):</span>
        <span class="s1">QtWidgets.QMessageBox.information(</span><span class="s0">None, </span><span class="s3">&quot;Help&quot;</span><span class="s0">, </span><span class="s1">self._get_help_html())</span>


<span class="s1">@backend_tools._register_tool_class(FigureCanvasQT)</span>
<span class="s0">class </span><span class="s1">ToolCopyToClipboardQT(backend_tools.ToolCopyToClipboardBase):</span>
    <span class="s0">def </span><span class="s1">trigger(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s1">pixmap = self.canvas.grab()</span>
        <span class="s1">QtWidgets.QApplication.instance().clipboard().setPixmap(pixmap)</span>


<span class="s1">FigureManagerQT._toolbar2_class = NavigationToolbar2QT</span>
<span class="s1">FigureManagerQT._toolmanager_toolbar_class = ToolbarQt</span>


<span class="s1">@_Backend.export</span>
<span class="s0">class </span><span class="s1">_BackendQT(_Backend):</span>
    <span class="s1">backend_version = __version__</span>
    <span class="s1">FigureCanvas = FigureCanvasQT</span>
    <span class="s1">FigureManager = FigureManagerQT</span>
    <span class="s1">mainloop = FigureManagerQT.start_main_loop</span>
</pre>
</body>
</html>