<html>
<head>
<title>test_f2py2e.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_f2py2e.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">textwrap</span><span class="s0">, </span><span class="s1">re</span><span class="s0">, </span><span class="s1">sys</span><span class="s0">, </span><span class="s1">subprocess</span><span class="s0">, </span><span class="s1">shlex</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">namedtuple</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">. </span><span class="s0">import </span><span class="s1">util</span>
<span class="s0">from </span><span class="s1">numpy.f2py.f2py2e </span><span class="s0">import </span><span class="s1">main </span><span class="s0">as </span><span class="s1">f2pycli</span>

<span class="s2">#########################</span>
<span class="s2"># CLI utils and classes #</span>
<span class="s2">#########################</span>

<span class="s1">PPaths = namedtuple(</span><span class="s3">&quot;PPaths&quot;</span><span class="s0">, </span><span class="s3">&quot;finp, f90inp, pyf, wrap77, wrap90, cmodf&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">get_io_paths(fname_inp</span><span class="s0">, </span><span class="s1">mname=</span><span class="s3">&quot;untitled&quot;</span><span class="s1">):</span>
    <span class="s4">&quot;&quot;&quot;Takes in a temporary file for testing and returns the expected output and input paths 
 
    Here expected output is essentially one of any of the possible generated 
    files. 
 
    ..note:: 
 
         Since this does not actually run f2py, none of these are guaranteed to 
         exist, and module names are typically incorrect 
 
    Parameters 
    ---------- 
    fname_inp : str 
                The input filename 
    mname : str, optional 
                The name of the module, untitled by default 
 
    Returns 
    ------- 
    genp : NamedTuple PPaths 
            The possible paths which are generated, not all of which exist 
    &quot;&quot;&quot;</span>
    <span class="s1">bpath = Path(fname_inp)</span>
    <span class="s0">return </span><span class="s1">PPaths(</span>
        <span class="s1">finp=bpath.with_suffix(</span><span class="s3">&quot;.f&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">f90inp=bpath.with_suffix(</span><span class="s3">&quot;.f90&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">pyf=bpath.with_suffix(</span><span class="s3">&quot;.pyf&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">wrap77=bpath.with_name(</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">mname</span><span class="s0">}</span><span class="s3">-f2pywrappers.f&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">wrap90=bpath.with_name(</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">mname</span><span class="s0">}</span><span class="s3">-f2pywrappers2.f90&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">cmodf=bpath.with_name(</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">mname</span><span class="s0">}</span><span class="s3">module.c&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s2">##############</span>
<span class="s2"># CLI Fixtures and Tests #</span>
<span class="s2">#############</span>


<span class="s1">@pytest.fixture(scope=</span><span class="s3">&quot;session&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">hello_world_f90(tmpdir_factory):</span>
    <span class="s4">&quot;&quot;&quot;Generates a single f90 file for testing&quot;&quot;&quot;</span>
    <span class="s1">fdat = util.getpath(</span><span class="s3">&quot;tests&quot;</span><span class="s0">, </span><span class="s3">&quot;src&quot;</span><span class="s0">, </span><span class="s3">&quot;cli&quot;</span><span class="s0">, </span><span class="s3">&quot;hiworld.f90&quot;</span><span class="s1">).read_text()</span>
    <span class="s1">fn = tmpdir_factory.getbasetemp() / </span><span class="s3">&quot;hello.f90&quot;</span>
    <span class="s1">fn.write_text(fdat</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;ascii&quot;</span><span class="s1">)</span>
    <span class="s0">return </span><span class="s1">fn</span>


<span class="s1">@pytest.fixture(scope=</span><span class="s3">&quot;session&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">hello_world_f77(tmpdir_factory):</span>
    <span class="s4">&quot;&quot;&quot;Generates a single f77 file for testing&quot;&quot;&quot;</span>
    <span class="s1">fdat = util.getpath(</span><span class="s3">&quot;tests&quot;</span><span class="s0">, </span><span class="s3">&quot;src&quot;</span><span class="s0">, </span><span class="s3">&quot;cli&quot;</span><span class="s0">, </span><span class="s3">&quot;hi77.f&quot;</span><span class="s1">).read_text()</span>
    <span class="s1">fn = tmpdir_factory.getbasetemp() / </span><span class="s3">&quot;hello.f&quot;</span>
    <span class="s1">fn.write_text(fdat</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;ascii&quot;</span><span class="s1">)</span>
    <span class="s0">return </span><span class="s1">fn</span>


<span class="s1">@pytest.fixture(scope=</span><span class="s3">&quot;session&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">retreal_f77(tmpdir_factory):</span>
    <span class="s4">&quot;&quot;&quot;Generates a single f77 file for testing&quot;&quot;&quot;</span>
    <span class="s1">fdat = util.getpath(</span><span class="s3">&quot;tests&quot;</span><span class="s0">, </span><span class="s3">&quot;src&quot;</span><span class="s0">, </span><span class="s3">&quot;return_real&quot;</span><span class="s0">, </span><span class="s3">&quot;foo77.f&quot;</span><span class="s1">).read_text()</span>
    <span class="s1">fn = tmpdir_factory.getbasetemp() / </span><span class="s3">&quot;foo.f&quot;</span>
    <span class="s1">fn.write_text(fdat</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;ascii&quot;</span><span class="s1">)</span>
    <span class="s0">return </span><span class="s1">fn</span>

<span class="s1">@pytest.fixture(scope=</span><span class="s3">&quot;session&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">f2cmap_f90(tmpdir_factory):</span>
    <span class="s4">&quot;&quot;&quot;Generates a single f90 file for testing&quot;&quot;&quot;</span>
    <span class="s1">fdat = util.getpath(</span><span class="s3">&quot;tests&quot;</span><span class="s0">, </span><span class="s3">&quot;src&quot;</span><span class="s0">, </span><span class="s3">&quot;f2cmap&quot;</span><span class="s0">, </span><span class="s3">&quot;isoFortranEnvMap.f90&quot;</span><span class="s1">).read_text()</span>
    <span class="s1">f2cmap = util.getpath(</span><span class="s3">&quot;tests&quot;</span><span class="s0">, </span><span class="s3">&quot;src&quot;</span><span class="s0">, </span><span class="s3">&quot;f2cmap&quot;</span><span class="s0">, </span><span class="s3">&quot;.f2py_f2cmap&quot;</span><span class="s1">).read_text()</span>
    <span class="s1">fn = tmpdir_factory.getbasetemp() / </span><span class="s3">&quot;f2cmap.f90&quot;</span>
    <span class="s1">fmap = tmpdir_factory.getbasetemp() / </span><span class="s3">&quot;mapfile&quot;</span>
    <span class="s1">fn.write_text(fdat</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;ascii&quot;</span><span class="s1">)</span>
    <span class="s1">fmap.write_text(f2cmap</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;ascii&quot;</span><span class="s1">)</span>
    <span class="s0">return </span><span class="s1">fn</span>


<span class="s0">def </span><span class="s1">test_gen_pyf(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that a signature file is generated via the CLI 
    CLI :: -h 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">opath = Path(hello_world_f90).stem + </span><span class="s3">&quot;.pyf&quot;</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">, </span><span class="s3">f'f2py -h </span><span class="s0">{</span><span class="s1">opath</span><span class="s0">} {</span><span class="s1">ipath</span><span class="s0">}</span><span class="s3">'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()  </span><span class="s2"># Generate wrappers</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s3">&quot;Saving signatures to file&quot; </span><span class="s0">in </span><span class="s1">out</span>
        <span class="s0">assert </span><span class="s1">Path(</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">opath</span><span class="s0">}</span><span class="s3">'</span><span class="s1">).exists()</span>


<span class="s0">def </span><span class="s1">test_gen_pyf_stdout(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that a signature file can be dumped to stdout 
    CLI :: -h 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">, </span><span class="s3">f'f2py -h stdout </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">}</span><span class="s3">'</span><span class="s1">.split())</span>
    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s3">&quot;Saving signatures to file&quot; </span><span class="s0">in </span><span class="s1">out</span>
        <span class="s0">assert </span><span class="s3">&quot;function hi() ! in &quot; </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_gen_pyf_no_overwrite(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that the CLI refuses to overwrite signature files 
    CLI :: -h without --overwrite-signature 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">, </span><span class="s3">f'f2py -h faker.pyf </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">}</span><span class="s3">'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">Path(</span><span class="s3">&quot;faker.pyf&quot;</span><span class="s1">).write_text(</span><span class="s3">&quot;Fake news&quot;</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;ascii&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(SystemExit):</span>
            <span class="s1">f2pycli()  </span><span class="s2"># Refuse to overwrite</span>
            <span class="s1">_</span><span class="s0">, </span><span class="s1">err = capfd.readouterr()</span>
            <span class="s0">assert </span><span class="s3">&quot;Use --overwrite-signature to overwrite&quot; </span><span class="s0">in </span><span class="s1">err</span>


<span class="s1">@pytest.mark.xfail</span>
<span class="s0">def </span><span class="s1">test_f2py_skip(capfd</span><span class="s0">, </span><span class="s1">retreal_f77</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Tests that functions can be skipped 
    CLI :: skip: 
    &quot;&quot;&quot;</span>
    <span class="s1">foutl = get_io_paths(retreal_f77</span><span class="s0">, </span><span class="s1">mname=</span><span class="s3">&quot;test&quot;</span><span class="s1">)</span>
    <span class="s1">ipath = foutl.finp</span>
    <span class="s1">toskip = </span><span class="s3">&quot;t0 t4 t8 sd s8 s4&quot;</span>
    <span class="s1">remaining = </span><span class="s3">&quot;td s0&quot;</span>
    <span class="s1">monkeypatch.setattr(</span>
        <span class="s1">sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
        <span class="s3">f'f2py </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">-m test skip: </span><span class="s0">{</span><span class="s1">toskip</span><span class="s0">}</span><span class="s3">'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">err = capfd.readouterr()</span>
        <span class="s0">for </span><span class="s1">skey </span><span class="s0">in </span><span class="s1">toskip.split():</span>
            <span class="s0">assert </span><span class="s1">(</span>
                <span class="s3">f'buildmodule: Could not found the body of interfaced routine &quot;</span><span class="s0">{</span><span class="s1">skey</span><span class="s0">}</span><span class="s3">&quot;. Skipping.'</span>
                <span class="s0">in </span><span class="s1">err)</span>
        <span class="s0">for </span><span class="s1">rkey </span><span class="s0">in </span><span class="s1">remaining.split():</span>
            <span class="s0">assert </span><span class="s3">f'Constructing wrapper function &quot;</span><span class="s0">{</span><span class="s1">rkey</span><span class="s0">}</span><span class="s3">&quot;' </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_f2py_only(capfd</span><span class="s0">, </span><span class="s1">retreal_f77</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Test that functions can be kept by only: 
    CLI :: only: 
    &quot;&quot;&quot;</span>
    <span class="s1">foutl = get_io_paths(retreal_f77</span><span class="s0">, </span><span class="s1">mname=</span><span class="s3">&quot;test&quot;</span><span class="s1">)</span>
    <span class="s1">ipath = foutl.finp</span>
    <span class="s1">toskip = </span><span class="s3">&quot;t0 t4 t8 sd s8 s4&quot;</span>
    <span class="s1">tokeep = </span><span class="s3">&quot;td s0&quot;</span>
    <span class="s1">monkeypatch.setattr(</span>
        <span class="s1">sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
        <span class="s3">f'f2py </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">-m test only: </span><span class="s0">{</span><span class="s1">tokeep</span><span class="s0">}</span><span class="s3">'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">err = capfd.readouterr()</span>
        <span class="s0">for </span><span class="s1">skey </span><span class="s0">in </span><span class="s1">toskip.split():</span>
            <span class="s0">assert </span><span class="s1">(</span>
                <span class="s3">f'buildmodule: Could not find the body of interfaced routine &quot;</span><span class="s0">{</span><span class="s1">skey</span><span class="s0">}</span><span class="s3">&quot;. Skipping.'</span>
                <span class="s0">in </span><span class="s1">err)</span>
        <span class="s0">for </span><span class="s1">rkey </span><span class="s0">in </span><span class="s1">tokeep.split():</span>
            <span class="s0">assert </span><span class="s3">f'Constructing wrapper function &quot;</span><span class="s0">{</span><span class="s1">rkey</span><span class="s0">}</span><span class="s3">&quot;' </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_file_processing_switch(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">retreal_f77</span><span class="s0">,</span>
                                <span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Tests that it is possible to return to file processing mode 
    CLI :: : 
    BUG: numpy-gh #20520 
    &quot;&quot;&quot;</span>
    <span class="s1">foutl = get_io_paths(retreal_f77</span><span class="s0">, </span><span class="s1">mname=</span><span class="s3">&quot;test&quot;</span><span class="s1">)</span>
    <span class="s1">ipath = foutl.finp</span>
    <span class="s1">toskip = </span><span class="s3">&quot;t0 t4 t8 sd s8 s4&quot;</span>
    <span class="s1">ipath2 = Path(hello_world_f90)</span>
    <span class="s1">tokeep = </span><span class="s3">&quot;td s0 hi&quot;  </span><span class="s2"># hi is in ipath2</span>
    <span class="s1">mname = </span><span class="s3">&quot;blah&quot;</span>
    <span class="s1">monkeypatch.setattr(</span>
        <span class="s1">sys</span><span class="s0">,</span>
        <span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
        <span class="s3">f'f2py </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">-m </span><span class="s0">{</span><span class="s1">mname</span><span class="s0">} </span><span class="s3">only: </span><span class="s0">{</span><span class="s1">tokeep</span><span class="s0">} </span><span class="s3">: </span><span class="s0">{</span><span class="s1">ipath2</span><span class="s0">}</span><span class="s3">'</span><span class="s1">.split(</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">err = capfd.readouterr()</span>
        <span class="s0">for </span><span class="s1">skey </span><span class="s0">in </span><span class="s1">toskip.split():</span>
            <span class="s0">assert </span><span class="s1">(</span>
                <span class="s3">f'buildmodule: Could not find the body of interfaced routine &quot;</span><span class="s0">{</span><span class="s1">skey</span><span class="s0">}</span><span class="s3">&quot;. Skipping.'</span>
                <span class="s0">in </span><span class="s1">err)</span>
        <span class="s0">for </span><span class="s1">rkey </span><span class="s0">in </span><span class="s1">tokeep.split():</span>
            <span class="s0">assert </span><span class="s3">f'Constructing wrapper function &quot;</span><span class="s0">{</span><span class="s1">rkey</span><span class="s0">}</span><span class="s3">&quot;' </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_mod_gen_f77(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Checks the generation of files based on a module name 
    CLI :: -m 
    &quot;&quot;&quot;</span>
    <span class="s1">MNAME = </span><span class="s3">&quot;hi&quot;</span>
    <span class="s1">foutl = get_io_paths(hello_world_f90</span><span class="s0">, </span><span class="s1">mname=MNAME)</span>
    <span class="s1">ipath = foutl.f90inp</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">, </span><span class="s3">f'f2py </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">-m </span><span class="s0">{</span><span class="s1">MNAME</span><span class="s0">}</span><span class="s3">'</span><span class="s1">.split())</span>
    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>

    <span class="s2"># Always generate C module</span>
    <span class="s0">assert </span><span class="s1">Path.exists(foutl.cmodf)</span>
    <span class="s2"># File contains a function, check for F77 wrappers</span>
    <span class="s0">assert </span><span class="s1">Path.exists(foutl.wrap77)</span>


<span class="s0">def </span><span class="s1">test_lower_cmod(capfd</span><span class="s0">, </span><span class="s1">hello_world_f77</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Lowers cases by flag or when -h is present 
 
    CLI :: --[no-]lower 
    &quot;&quot;&quot;</span>
    <span class="s1">foutl = get_io_paths(hello_world_f77</span><span class="s0">, </span><span class="s1">mname=</span><span class="s3">&quot;test&quot;</span><span class="s1">)</span>
    <span class="s1">ipath = foutl.finp</span>
    <span class="s1">capshi = re.compile(</span><span class="s3">r&quot;HI\(\)&quot;</span><span class="s1">)</span>
    <span class="s1">capslo = re.compile(</span><span class="s3">r&quot;hi\(\)&quot;</span><span class="s1">)</span>
    <span class="s2"># Case I: --lower is passed</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">, </span><span class="s3">f'f2py </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">-m test --lower'</span><span class="s1">.split())</span>
    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s1">capslo.search(out) </span><span class="s0">is not None</span>
        <span class="s0">assert </span><span class="s1">capshi.search(out) </span><span class="s0">is None</span>
    <span class="s2"># Case II: --no-lower is passed</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
                        <span class="s3">f'f2py </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">-m test --no-lower'</span><span class="s1">.split())</span>
    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s1">capslo.search(out) </span><span class="s0">is None</span>
        <span class="s0">assert </span><span class="s1">capshi.search(out) </span><span class="s0">is not None</span>


<span class="s0">def </span><span class="s1">test_lower_sig(capfd</span><span class="s0">, </span><span class="s1">hello_world_f77</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Lowers cases in signature files by flag or when -h is present 
 
    CLI :: --[no-]lower -h 
    &quot;&quot;&quot;</span>
    <span class="s1">foutl = get_io_paths(hello_world_f77</span><span class="s0">, </span><span class="s1">mname=</span><span class="s3">&quot;test&quot;</span><span class="s1">)</span>
    <span class="s1">ipath = foutl.finp</span>
    <span class="s2"># Signature files</span>
    <span class="s1">capshi = re.compile(</span><span class="s3">r&quot;Block: HI&quot;</span><span class="s1">)</span>
    <span class="s1">capslo = re.compile(</span><span class="s3">r&quot;Block: hi&quot;</span><span class="s1">)</span>
    <span class="s2"># Case I: --lower is implied by -h</span>
    <span class="s2"># TODO: Clean up to prevent passing --overwrite-signature</span>
    <span class="s1">monkeypatch.setattr(</span>
        <span class="s1">sys</span><span class="s0">,</span>
        <span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
        <span class="s3">f'f2py </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">-h </span><span class="s0">{</span><span class="s1">foutl.pyf</span><span class="s0">} </span><span class="s3">-m test --overwrite-signature'</span><span class="s1">.split()</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s1">capslo.search(out) </span><span class="s0">is not None</span>
        <span class="s0">assert </span><span class="s1">capshi.search(out) </span><span class="s0">is None</span>

    <span class="s2"># Case II: --no-lower overrides -h</span>
    <span class="s1">monkeypatch.setattr(</span>
        <span class="s1">sys</span><span class="s0">,</span>
        <span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
        <span class="s3">f'f2py </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">-h </span><span class="s0">{</span><span class="s1">foutl.pyf</span><span class="s0">} </span><span class="s3">-m test --overwrite-signature --no-lower'</span>
        <span class="s1">.split()</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s1">capslo.search(out) </span><span class="s0">is None</span>
        <span class="s0">assert </span><span class="s1">capshi.search(out) </span><span class="s0">is not None</span>


<span class="s0">def </span><span class="s1">test_build_dir(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that the build directory can be specified 
 
    CLI :: --build-dir 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">mname = </span><span class="s3">&quot;blah&quot;</span>
    <span class="s1">odir = </span><span class="s3">&quot;tttmp&quot;</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
                        <span class="s3">f'f2py -m </span><span class="s0">{</span><span class="s1">mname</span><span class="s0">} {</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">--build-dir </span><span class="s0">{</span><span class="s1">odir</span><span class="s0">}</span><span class="s3">'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s3">f&quot;Wrote C/API module </span><span class="s0">\&quot;{</span><span class="s1">mname</span><span class="s0">}\&quot;</span><span class="s3">&quot; </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_overwrite(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that the build directory can be specified 
 
    CLI :: --overwrite-signature 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">monkeypatch.setattr(</span>
        <span class="s1">sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
        <span class="s3">f'f2py -h faker.pyf </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">--overwrite-signature'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">Path(</span><span class="s3">&quot;faker.pyf&quot;</span><span class="s1">).write_text(</span><span class="s3">&quot;Fake news&quot;</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s3">&quot;ascii&quot;</span><span class="s1">)</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s3">&quot;Saving signatures to file&quot; </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_latexdoc(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that TeX documentation is written out 
 
    CLI :: --latex-doc 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">mname = </span><span class="s3">&quot;blah&quot;</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
                        <span class="s3">f'f2py -m </span><span class="s0">{</span><span class="s1">mname</span><span class="s0">} {</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">--latex-doc'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s3">&quot;Documentation is saved to file&quot; </span><span class="s0">in </span><span class="s1">out</span>
        <span class="s0">with </span><span class="s1">Path(</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">mname</span><span class="s0">}</span><span class="s3">module.tex&quot;</span><span class="s1">).open() </span><span class="s0">as </span><span class="s1">otex:</span>
            <span class="s0">assert </span><span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">documentclass&quot; </span><span class="s0">in </span><span class="s1">otex.read()</span>


<span class="s0">def </span><span class="s1">test_nolatexdoc(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that TeX documentation is written out 
 
    CLI :: --no-latex-doc 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">mname = </span><span class="s3">&quot;blah&quot;</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
                        <span class="s3">f'f2py -m </span><span class="s0">{</span><span class="s1">mname</span><span class="s0">} {</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">--no-latex-doc'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s3">&quot;Documentation is saved to file&quot; </span><span class="s0">not in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_shortlatex(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that truncated documentation is written out 
 
    TODO: Test to ensure this has no effect without --latex-doc 
    CLI :: --latex-doc --short-latex 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">mname = </span><span class="s3">&quot;blah&quot;</span>
    <span class="s1">monkeypatch.setattr(</span>
        <span class="s1">sys</span><span class="s0">,</span>
        <span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
        <span class="s3">f'f2py -m </span><span class="s0">{</span><span class="s1">mname</span><span class="s0">} {</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">--latex-doc --short-latex'</span><span class="s1">.split()</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s3">&quot;Documentation is saved to file&quot; </span><span class="s0">in </span><span class="s1">out</span>
        <span class="s0">with </span><span class="s1">Path(</span><span class="s3">f&quot;./</span><span class="s0">{</span><span class="s1">mname</span><span class="s0">}</span><span class="s3">module.tex&quot;</span><span class="s1">).open() </span><span class="s0">as </span><span class="s1">otex:</span>
            <span class="s0">assert </span><span class="s3">&quot;</span><span class="s0">\\</span><span class="s3">documentclass&quot; </span><span class="s0">not in </span><span class="s1">otex.read()</span>


<span class="s0">def </span><span class="s1">test_restdoc(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that RsT documentation is written out 
 
    CLI :: --rest-doc 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">mname = </span><span class="s3">&quot;blah&quot;</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
                        <span class="s3">f'f2py -m </span><span class="s0">{</span><span class="s1">mname</span><span class="s0">} {</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">--rest-doc'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s3">&quot;ReST Documentation is saved to file&quot; </span><span class="s0">in </span><span class="s1">out</span>
        <span class="s0">with </span><span class="s1">Path(</span><span class="s3">f&quot;./</span><span class="s0">{</span><span class="s1">mname</span><span class="s0">}</span><span class="s3">module.rest&quot;</span><span class="s1">).open() </span><span class="s0">as </span><span class="s1">orst:</span>
            <span class="s0">assert </span><span class="s3">r&quot;.. -*- rest -*-&quot; </span><span class="s0">in </span><span class="s1">orst.read()</span>


<span class="s0">def </span><span class="s1">test_norestexdoc(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that TeX documentation is written out 
 
    CLI :: --no-rest-doc 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">mname = </span><span class="s3">&quot;blah&quot;</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
                        <span class="s3">f'f2py -m </span><span class="s0">{</span><span class="s1">mname</span><span class="s0">} {</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">--no-rest-doc'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s3">&quot;ReST Documentation is saved to file&quot; </span><span class="s0">not in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_debugcapi(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that debugging wrappers are written 
 
    CLI :: --debug-capi 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">mname = </span><span class="s3">&quot;blah&quot;</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
                        <span class="s3">f'f2py -m </span><span class="s0">{</span><span class="s1">mname</span><span class="s0">} {</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">--debug-capi'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s0">with </span><span class="s1">Path(</span><span class="s3">f&quot;./</span><span class="s0">{</span><span class="s1">mname</span><span class="s0">}</span><span class="s3">module.c&quot;</span><span class="s1">).open() </span><span class="s0">as </span><span class="s1">ocmod:</span>
            <span class="s0">assert </span><span class="s3">r&quot;#define DEBUGCFUNCS&quot; </span><span class="s0">in </span><span class="s1">ocmod.read()</span>


<span class="s1">@pytest.mark.xfail(reason=</span><span class="s3">&quot;Consistently fails on CI.&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_debugcapi_bld(hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that debugging wrappers work 
 
    CLI :: --debug-capi -c 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">mname = </span><span class="s3">&quot;blah&quot;</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
                        <span class="s3">f'f2py -m </span><span class="s0">{</span><span class="s1">mname</span><span class="s0">} {</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">-c --debug-capi'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">cmd_run = shlex.split(</span><span class="s3">&quot;python3 -c </span><span class="s0">\&quot;</span><span class="s3">import blah; blah.hi()</span><span class="s0">\&quot;</span><span class="s3">&quot;</span><span class="s1">)</span>
        <span class="s1">rout = subprocess.run(cmd_run</span><span class="s0">, </span><span class="s1">capture_output=</span><span class="s0">True, </span><span class="s1">encoding=</span><span class="s3">'UTF-8'</span><span class="s1">)</span>
        <span class="s1">eout = </span><span class="s3">' Hello World</span><span class="s0">\n</span><span class="s3">'</span>
        <span class="s1">eerr = textwrap.dedent(</span><span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s3">debug-capi:Python C/API function blah.hi() 
debug-capi:float hi=:output,hidden,scalar 
debug-capi:hi=0 
debug-capi:Fortran subroutine `f2pywraphi(&amp;hi)' 
debug-capi:hi=0 
debug-capi:Building return value. 
debug-capi:Python C/API function blah.hi: successful. 
debug-capi:Freeing memory. 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">rout.stdout == eout</span>
        <span class="s0">assert </span><span class="s1">rout.stderr == eerr</span>


<span class="s0">def </span><span class="s1">test_wrapfunc_def(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that fortran subroutine wrappers for F77 are included by default 
 
    CLI :: --[no]-wrap-functions 
    &quot;&quot;&quot;</span>
    <span class="s2"># Implied</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">mname = </span><span class="s3">&quot;blah&quot;</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">, </span><span class="s3">f'f2py -m </span><span class="s0">{</span><span class="s1">mname</span><span class="s0">} {</span><span class="s1">ipath</span><span class="s0">}</span><span class="s3">'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
    <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
    <span class="s0">assert </span><span class="s3">r&quot;Fortran 77 wrappers are saved to&quot; </span><span class="s0">in </span><span class="s1">out</span>

    <span class="s2"># Explicit</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
                        <span class="s3">f'f2py -m </span><span class="s0">{</span><span class="s1">mname</span><span class="s0">} {</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">--wrap-functions'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s3">r&quot;Fortran 77 wrappers are saved to&quot; </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_nowrapfunc(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensures that fortran subroutine wrappers for F77 can be disabled 
 
    CLI :: --no-wrap-functions 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">mname = </span><span class="s3">&quot;blah&quot;</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
                        <span class="s3">f'f2py -m </span><span class="s0">{</span><span class="s1">mname</span><span class="s0">} {</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">--no-wrap-functions'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s3">r&quot;Fortran 77 wrappers are saved to&quot; </span><span class="s0">not in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_inclheader(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Add to the include directories 
 
    CLI :: -include 
    TODO: Document this in the help string 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">mname = </span><span class="s3">&quot;blah&quot;</span>
    <span class="s1">monkeypatch.setattr(</span>
        <span class="s1">sys</span><span class="s0">,</span>
        <span class="s3">&quot;argv&quot;</span><span class="s0">,</span>
        <span class="s3">f'f2py -m </span><span class="s0">{</span><span class="s1">mname</span><span class="s0">} {</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">-include&lt;stdbool.h&gt; -include&lt;stdio.h&gt; '</span><span class="s1">.</span>
        <span class="s1">split()</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s0">with </span><span class="s1">Path(</span><span class="s3">f&quot;./</span><span class="s0">{</span><span class="s1">mname</span><span class="s0">}</span><span class="s3">module.c&quot;</span><span class="s1">).open() </span><span class="s0">as </span><span class="s1">ocmod:</span>
            <span class="s1">ocmr = ocmod.read()</span>
            <span class="s0">assert </span><span class="s3">&quot;#include &lt;stdbool.h&gt;&quot; </span><span class="s0">in </span><span class="s1">ocmr</span>
            <span class="s0">assert </span><span class="s3">&quot;#include &lt;stdio.h&gt;&quot; </span><span class="s0">in </span><span class="s1">ocmr</span>


<span class="s0">def </span><span class="s1">test_inclpath():</span>
    <span class="s4">&quot;&quot;&quot;Add to the include directories 
 
    CLI :: --include-paths 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_hlink():</span>
    <span class="s4">&quot;&quot;&quot;Add to the include directories 
 
    CLI :: --help-link 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_f2cmap(capfd</span><span class="s0">, </span><span class="s1">f2cmap_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Check that Fortran-to-Python KIND specs can be passed 
 
    CLI :: --f2cmap 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(f2cmap_f90)</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">, </span><span class="s3">f'f2py -m blah </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">--f2cmap mapfile'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s3">&quot;Reading f2cmap from 'mapfile' ...&quot; </span><span class="s0">in </span><span class="s1">out</span>
        <span class="s0">assert </span><span class="s3">&quot;Mapping </span><span class="s0">\&quot;</span><span class="s3">real(kind=real32)</span><span class="s0">\&quot; </span><span class="s3">to </span><span class="s0">\&quot;</span><span class="s3">float</span><span class="s0">\&quot;</span><span class="s3">&quot; </span><span class="s0">in </span><span class="s1">out</span>
        <span class="s0">assert </span><span class="s3">&quot;Mapping </span><span class="s0">\&quot;</span><span class="s3">real(kind=real64)</span><span class="s0">\&quot; </span><span class="s3">to </span><span class="s0">\&quot;</span><span class="s3">double</span><span class="s0">\&quot;</span><span class="s3">&quot; </span><span class="s0">in </span><span class="s1">out</span>
        <span class="s0">assert </span><span class="s3">&quot;Mapping </span><span class="s0">\&quot;</span><span class="s3">integer(kind=int64)</span><span class="s0">\&quot; </span><span class="s3">to </span><span class="s0">\&quot;</span><span class="s3">long_long</span><span class="s0">\&quot;</span><span class="s3">&quot; </span><span class="s0">in </span><span class="s1">out</span>
        <span class="s0">assert </span><span class="s3">&quot;Successfully applied user defined f2cmap changes&quot; </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_quiet(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Reduce verbosity 
 
    CLI :: --quiet 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">, </span><span class="s3">f'f2py -m blah </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">--quiet'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s1">len(out) == </span><span class="s5">0</span>


<span class="s0">def </span><span class="s1">test_verbose(capfd</span><span class="s0">, </span><span class="s1">hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Increase verbosity 
 
    CLI :: --verbose 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">, </span><span class="s3">f'f2py -m blah </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">--verbose'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">assert </span><span class="s3">&quot;analyzeline&quot; </span><span class="s0">in </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">test_version(capfd</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot;Ensure version 
 
    CLI :: -v 
    &quot;&quot;&quot;</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">, </span><span class="s3">'f2py -v'</span><span class="s1">.split())</span>
    <span class="s2"># TODO: f2py2e should not call sys.exit() after printing the version</span>
    <span class="s0">with </span><span class="s1">pytest.raises(SystemExit):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">_ = capfd.readouterr()</span>
        <span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
        <span class="s0">assert </span><span class="s1">np.__version__ == out.strip()</span>


<span class="s1">@pytest.mark.xfail(reason=</span><span class="s3">&quot;Consistently fails on CI.&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_npdistop(hello_world_f90</span><span class="s0">, </span><span class="s1">monkeypatch):</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c 
    &quot;&quot;&quot;</span>
    <span class="s1">ipath = Path(hello_world_f90)</span>
    <span class="s1">monkeypatch.setattr(sys</span><span class="s0">, </span><span class="s3">&quot;argv&quot;</span><span class="s0">, </span><span class="s3">f'f2py -m blah </span><span class="s0">{</span><span class="s1">ipath</span><span class="s0">} </span><span class="s3">-c'</span><span class="s1">.split())</span>

    <span class="s0">with </span><span class="s1">util.switchdir(ipath.parent):</span>
        <span class="s1">f2pycli()</span>
        <span class="s1">cmd_run = shlex.split(</span><span class="s3">&quot;python -c </span><span class="s0">\&quot;</span><span class="s3">import blah; blah.hi()</span><span class="s0">\&quot;</span><span class="s3">&quot;</span><span class="s1">)</span>
        <span class="s1">rout = subprocess.run(cmd_run</span><span class="s0">, </span><span class="s1">capture_output=</span><span class="s0">True, </span><span class="s1">encoding=</span><span class="s3">'UTF-8'</span><span class="s1">)</span>
        <span class="s1">eout = </span><span class="s3">' Hello World</span><span class="s0">\n</span><span class="s3">'</span>
        <span class="s0">assert </span><span class="s1">rout.stdout == eout</span>


<span class="s2"># Numpy distutils flags</span>
<span class="s2"># TODO: These should be tested separately</span>


<span class="s0">def </span><span class="s1">test_npd_fcompiler():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c --fcompiler 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_compiler():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c --compiler 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_help_fcompiler():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c --help-fcompiler 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_f77exec():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c --f77exec 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_f90exec():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c --f90exec 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_f77flags():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c --f77flags 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_f90flags():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c --f90flags 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_opt():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c --opt 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_arch():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c --arch 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_noopt():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c --noopt 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_noarch():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c --noarch 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_debug():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c --debug 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_link_auto():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c --link-&lt;resource&gt; 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_lib():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -c -L/path/to/lib/ -l&lt;libname&gt; 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_define():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -D&lt;define&gt; 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_undefine():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -U&lt;name&gt; 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_incl():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: -I/path/to/include/ 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_npd_linker():</span>
    <span class="s4">&quot;&quot;&quot; 
    CLI :: &lt;filename&gt;.o &lt;filename&gt;.so &lt;filename&gt;.a 
    &quot;&quot;&quot;</span>
    <span class="s2"># TODO: populate</span>
    <span class="s0">pass</span>
</pre>
</body>
</html>