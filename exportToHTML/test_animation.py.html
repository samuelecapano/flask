<html>
<head>
<title>test_animation.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
.s5 { color: #6a8759;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_animation.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">weakref</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">animation</span>
<span class="s0">from </span><span class="s1">matplotlib.testing.decorators </span><span class="s0">import </span><span class="s1">check_figures_equal</span>


<span class="s1">@pytest.fixture()</span>
<span class="s0">def </span><span class="s1">anim(request):</span>
    <span class="s2">&quot;&quot;&quot;Create a simple animation (with options).&quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">line</span><span class="s0">, </span><span class="s1">= ax.plot([]</span><span class="s0">, </span><span class="s1">[])</span>

    <span class="s1">ax.set_xlim(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">ax.set_ylim(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">init():</span>
        <span class="s1">line.set_data([]</span><span class="s0">, </span><span class="s1">[])</span>
        <span class="s0">return </span><span class="s1">line</span><span class="s0">,</span>

    <span class="s0">def </span><span class="s1">animate(i):</span>
        <span class="s1">x = np.linspace(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span>
        <span class="s1">y = np.sin(x + i)</span>
        <span class="s1">line.set_data(x</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s0">return </span><span class="s1">line</span><span class="s0">,</span>

    <span class="s4"># &quot;klass&quot; can be passed to determine the class returned by the fixture</span>
    <span class="s1">kwargs = dict(getattr(request</span><span class="s0">, </span><span class="s5">'param'</span><span class="s0">, </span><span class="s1">{}))  </span><span class="s4"># make a copy</span>
    <span class="s1">klass = kwargs.pop(</span><span class="s5">'klass'</span><span class="s0">, </span><span class="s1">animation.FuncAnimation)</span>
    <span class="s0">if </span><span class="s5">'frames' </span><span class="s0">not in </span><span class="s1">kwargs:</span>
        <span class="s1">kwargs[</span><span class="s5">'frames'</span><span class="s1">] = </span><span class="s3">5</span>
    <span class="s0">return </span><span class="s1">klass(fig=fig</span><span class="s0">, </span><span class="s1">func=animate</span><span class="s0">, </span><span class="s1">init_func=init</span><span class="s0">, </span><span class="s1">**kwargs)</span>


<span class="s0">class </span><span class="s1">NullMovieWriter(animation.AbstractMovieWriter):</span>
    <span class="s2">&quot;&quot;&quot; 
    A minimal MovieWriter.  It doesn't actually write anything. 
    It just saves the arguments that were given to the setup() and 
    grab_frame() methods as attributes, and counts how many times 
    grab_frame() is called. 
 
    This class doesn't have an __init__ method with the appropriate 
    signature, and it doesn't define an isAvailable() method, so 
    it cannot be added to the 'writers' registry. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">setup(self</span><span class="s0">, </span><span class="s1">fig</span><span class="s0">, </span><span class="s1">outfile</span><span class="s0">, </span><span class="s1">dpi</span><span class="s0">, </span><span class="s1">*args):</span>
        <span class="s1">self.fig = fig</span>
        <span class="s1">self.outfile = outfile</span>
        <span class="s1">self.dpi = dpi</span>
        <span class="s1">self.args = args</span>
        <span class="s1">self._count = </span><span class="s3">0</span>

    <span class="s0">def </span><span class="s1">grab_frame(self</span><span class="s0">, </span><span class="s1">**savefig_kwargs):</span>
        <span class="s1">self.savefig_kwargs = savefig_kwargs</span>
        <span class="s1">self._count += </span><span class="s3">1</span>

    <span class="s0">def </span><span class="s1">finish(self):</span>
        <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_null_movie_writer(anim):</span>
    <span class="s4"># Test running an animation with NullMovieWriter.</span>
    <span class="s1">plt.rcParams[</span><span class="s5">&quot;savefig.facecolor&quot;</span><span class="s1">] = </span><span class="s5">&quot;auto&quot;</span>
    <span class="s1">filename = </span><span class="s5">&quot;unused.null&quot;</span>
    <span class="s1">dpi = </span><span class="s3">50</span>
    <span class="s1">savefig_kwargs = dict(foo=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">writer = NullMovieWriter()</span>

    <span class="s1">anim.save(filename</span><span class="s0">, </span><span class="s1">dpi=dpi</span><span class="s0">, </span><span class="s1">writer=writer</span><span class="s0">,</span>
              <span class="s1">savefig_kwargs=savefig_kwargs)</span>

    <span class="s0">assert </span><span class="s1">writer.fig == plt.figure(</span><span class="s3">1</span><span class="s1">)  </span><span class="s4"># The figure used by anim fixture</span>
    <span class="s0">assert </span><span class="s1">writer.outfile == filename</span>
    <span class="s0">assert </span><span class="s1">writer.dpi == dpi</span>
    <span class="s0">assert </span><span class="s1">writer.args == ()</span>
    <span class="s4"># we enrich the savefig kwargs to ensure we composite transparent</span>
    <span class="s4"># output to an opaque background</span>
    <span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">savefig_kwargs.items():</span>
        <span class="s0">assert </span><span class="s1">writer.savefig_kwargs[k] == v</span>
    <span class="s0">assert </span><span class="s1">writer._count == anim._save_count</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">'anim'</span><span class="s0">, </span><span class="s1">[dict(klass=dict)]</span><span class="s0">, </span><span class="s1">indirect=[</span><span class="s5">'anim'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_animation_delete(anim):</span>
    <span class="s0">if </span><span class="s1">platform.python_implementation() == </span><span class="s5">'PyPy'</span><span class="s1">:</span>
        <span class="s4"># Something in the test setup fixture lingers around into the test and</span>
        <span class="s4"># breaks pytest.warns on PyPy. This garbage collection fixes it.</span>
        <span class="s4"># https://foss.heptapod.net/pypy/pypy/-/issues/3536</span>
        <span class="s1">np.testing.break_cycles()</span>
    <span class="s1">anim = animation.FuncAnimation(**anim)</span>
    <span class="s0">with </span><span class="s1">pytest.warns(Warning</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">'Animation was deleted'</span><span class="s1">):</span>
        <span class="s0">del </span><span class="s1">anim</span>
        <span class="s1">np.testing.break_cycles()</span>


<span class="s0">def </span><span class="s1">test_movie_writer_dpi_default():</span>
    <span class="s0">class </span><span class="s1">DummyMovieWriter(animation.MovieWriter):</span>
        <span class="s0">def </span><span class="s1">_run(self):</span>
            <span class="s0">pass</span>

    <span class="s4"># Test setting up movie writer with figure.dpi default.</span>
    <span class="s1">fig = plt.figure()</span>

    <span class="s1">filename = </span><span class="s5">&quot;unused.null&quot;</span>
    <span class="s1">fps = </span><span class="s3">5</span>
    <span class="s1">codec = </span><span class="s5">&quot;unused&quot;</span>
    <span class="s1">bitrate = </span><span class="s3">1</span>
    <span class="s1">extra_args = [</span><span class="s5">&quot;unused&quot;</span><span class="s1">]</span>

    <span class="s1">writer = DummyMovieWriter(fps</span><span class="s0">, </span><span class="s1">codec</span><span class="s0">, </span><span class="s1">bitrate</span><span class="s0">, </span><span class="s1">extra_args)</span>
    <span class="s1">writer.setup(fig</span><span class="s0">, </span><span class="s1">filename)</span>
    <span class="s0">assert </span><span class="s1">writer.dpi == fig.dpi</span>


<span class="s1">@animation.writers.register(</span><span class="s5">'null'</span><span class="s1">)</span>
<span class="s0">class </span><span class="s1">RegisteredNullMovieWriter(NullMovieWriter):</span>

    <span class="s4"># To be able to add NullMovieWriter to the 'writers' registry,</span>
    <span class="s4"># we must define an __init__ method with a specific signature,</span>
    <span class="s4"># and we must define the class method isAvailable().</span>
    <span class="s4"># (These methods are not actually required to use an instance</span>
    <span class="s4"># of this class as the 'writer' argument of Animation.save().)</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">fps=</span><span class="s0">None, </span><span class="s1">codec=</span><span class="s0">None, </span><span class="s1">bitrate=</span><span class="s0">None,</span>
                 <span class="s1">extra_args=</span><span class="s0">None, </span><span class="s1">metadata=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s0">pass</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">isAvailable(cls):</span>
        <span class="s0">return True</span>


<span class="s1">WRITER_OUTPUT = [</span>
    <span class="s1">(</span><span class="s5">'ffmpeg'</span><span class="s0">, </span><span class="s5">'movie.mp4'</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s5">'ffmpeg_file'</span><span class="s0">, </span><span class="s5">'movie.mp4'</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s5">'imagemagick'</span><span class="s0">, </span><span class="s5">'movie.gif'</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s5">'imagemagick_file'</span><span class="s0">, </span><span class="s5">'movie.gif'</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s5">'pillow'</span><span class="s0">, </span><span class="s5">'movie.gif'</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s5">'html'</span><span class="s0">, </span><span class="s5">'movie.html'</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s5">'null'</span><span class="s0">, </span><span class="s5">'movie.null'</span><span class="s1">)</span>
<span class="s1">]</span>


<span class="s0">def </span><span class="s1">gen_writers():</span>
    <span class="s0">for </span><span class="s1">writer</span><span class="s0">, </span><span class="s1">output </span><span class="s0">in </span><span class="s1">WRITER_OUTPUT:</span>
        <span class="s0">if not </span><span class="s1">animation.writers.is_available(writer):</span>
            <span class="s1">mark = pytest.mark.skip(</span>
                <span class="s5">f&quot;writer '</span><span class="s0">{</span><span class="s1">writer</span><span class="s0">}</span><span class="s5">' not available on this system&quot;</span><span class="s1">)</span>
            <span class="s0">yield </span><span class="s1">pytest.param(writer</span><span class="s0">, None, </span><span class="s1">output</span><span class="s0">, </span><span class="s1">marks=[mark])</span>
            <span class="s0">yield </span><span class="s1">pytest.param(writer</span><span class="s0">, None, </span><span class="s1">Path(output)</span><span class="s0">, </span><span class="s1">marks=[mark])</span>
            <span class="s0">continue</span>

        <span class="s1">writer_class = animation.writers[writer]</span>
        <span class="s0">for </span><span class="s1">frame_format </span><span class="s0">in </span><span class="s1">getattr(writer_class</span><span class="s0">, </span><span class="s5">'supported_formats'</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None</span><span class="s1">]):</span>
            <span class="s0">yield </span><span class="s1">writer</span><span class="s0">, </span><span class="s1">frame_format</span><span class="s0">, </span><span class="s1">output</span>
            <span class="s0">yield </span><span class="s1">writer</span><span class="s0">, </span><span class="s1">frame_format</span><span class="s0">, </span><span class="s1">Path(output)</span>


<span class="s4"># Smoke test for saving animations.  In the future, we should probably</span>
<span class="s4"># design more sophisticated tests which compare resulting frames a-la</span>
<span class="s4"># matplotlib.testing.image_comparison</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s5">'writer, frame_format, output'</span><span class="s0">, </span><span class="s1">gen_writers())</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s5">'anim'</span><span class="s0">, </span><span class="s1">[dict(klass=dict)]</span><span class="s0">, </span><span class="s1">indirect=[</span><span class="s5">'anim'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_save_animation_smoketest(tmpdir</span><span class="s0">, </span><span class="s1">writer</span><span class="s0">, </span><span class="s1">frame_format</span><span class="s0">, </span><span class="s1">output</span><span class="s0">, </span><span class="s1">anim):</span>
    <span class="s0">if </span><span class="s1">frame_format </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">plt.rcParams[</span><span class="s5">&quot;animation.frame_format&quot;</span><span class="s1">] = frame_format</span>
    <span class="s1">anim = animation.FuncAnimation(**anim)</span>
    <span class="s1">dpi = </span><span class="s0">None</span>
    <span class="s1">codec = </span><span class="s0">None</span>
    <span class="s0">if </span><span class="s1">writer == </span><span class="s5">'ffmpeg'</span><span class="s1">:</span>
        <span class="s4"># Issue #8253</span>
        <span class="s1">anim._fig.set_size_inches((</span><span class="s3">10.85</span><span class="s0">, </span><span class="s3">9.21</span><span class="s1">))</span>
        <span class="s1">dpi = </span><span class="s3">100.</span>
        <span class="s1">codec = </span><span class="s5">'h264'</span>

    <span class="s4"># Use temporary directory for the file-based writers, which produce a file</span>
    <span class="s4"># per frame with known names.</span>
    <span class="s0">with </span><span class="s1">tmpdir.as_cwd():</span>
        <span class="s1">anim.save(output</span><span class="s0">, </span><span class="s1">fps=</span><span class="s3">30</span><span class="s0">, </span><span class="s1">writer=writer</span><span class="s0">, </span><span class="s1">bitrate=</span><span class="s3">500</span><span class="s0">, </span><span class="s1">dpi=dpi</span><span class="s0">,</span>
                  <span class="s1">codec=codec)</span>

    <span class="s0">del </span><span class="s1">anim</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">'writer'</span><span class="s0">, </span><span class="s1">[</span>
    <span class="s1">pytest.param(</span>
        <span class="s5">'ffmpeg'</span><span class="s0">, </span><span class="s1">marks=pytest.mark.skipif(</span>
            <span class="s0">not </span><span class="s1">animation.FFMpegWriter.isAvailable()</span><span class="s0">,</span>
            <span class="s1">reason=</span><span class="s5">'Requires FFMpeg'</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span>
        <span class="s5">'imagemagick'</span><span class="s0">, </span><span class="s1">marks=pytest.mark.skipif(</span>
            <span class="s0">not </span><span class="s1">animation.ImageMagickWriter.isAvailable()</span><span class="s0">,</span>
            <span class="s1">reason=</span><span class="s5">'Requires ImageMagick'</span><span class="s1">))</span><span class="s0">,</span>
<span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s5">'html, want'</span><span class="s0">, </span><span class="s1">[</span>
    <span class="s1">(</span><span class="s5">'none'</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s5">'html5'</span><span class="s0">, </span><span class="s5">'&lt;video width'</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s5">'jshtml'</span><span class="s0">, </span><span class="s5">'&lt;script '</span><span class="s1">)</span>
<span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s5">'anim'</span><span class="s0">, </span><span class="s1">[dict(klass=dict)]</span><span class="s0">, </span><span class="s1">indirect=[</span><span class="s5">'anim'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_animation_repr_html(writer</span><span class="s0">, </span><span class="s1">html</span><span class="s0">, </span><span class="s1">want</span><span class="s0">, </span><span class="s1">anim):</span>
    <span class="s0">if </span><span class="s1">platform.python_implementation() == </span><span class="s5">'PyPy'</span><span class="s1">:</span>
        <span class="s4"># Something in the test setup fixture lingers around into the test and</span>
        <span class="s4"># breaks pytest.warns on PyPy. This garbage collection fixes it.</span>
        <span class="s4"># https://foss.heptapod.net/pypy/pypy/-/issues/3536</span>
        <span class="s1">np.testing.break_cycles()</span>
    <span class="s0">if </span><span class="s1">(writer == </span><span class="s5">'imagemagick' </span><span class="s0">and </span><span class="s1">html == </span><span class="s5">'html5'</span>
            <span class="s4"># ImageMagick delegates to ffmpeg for this format.</span>
            <span class="s0">and not </span><span class="s1">animation.FFMpegWriter.isAvailable()):</span>
        <span class="s1">pytest.skip(</span><span class="s5">'Requires FFMpeg'</span><span class="s1">)</span>
    <span class="s4"># create here rather than in the fixture otherwise we get __del__ warnings</span>
    <span class="s4"># about producing no output</span>
    <span class="s1">anim = animation.FuncAnimation(**anim)</span>
    <span class="s0">with </span><span class="s1">plt.rc_context({</span><span class="s5">'animation.writer'</span><span class="s1">: writer</span><span class="s0">,</span>
                         <span class="s5">'animation.html'</span><span class="s1">: html}):</span>
        <span class="s1">html = anim._repr_html_()</span>
    <span class="s0">if </span><span class="s1">want </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">html </span><span class="s0">is None</span>
        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning):</span>
            <span class="s0">del </span><span class="s1">anim  </span><span class="s4"># Animation was never run, so will warn on cleanup.</span>
            <span class="s1">np.testing.break_cycles()</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">want </span><span class="s0">in </span><span class="s1">html</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">'anim'</span><span class="s0">,</span>
    <span class="s1">[{</span><span class="s5">'save_count'</span><span class="s1">: </span><span class="s3">10</span><span class="s0">, </span><span class="s5">'frames'</span><span class="s1">: iter(range(</span><span class="s3">5</span><span class="s1">))}]</span><span class="s0">,</span>
    <span class="s1">indirect=[</span><span class="s5">'anim'</span><span class="s1">]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_no_length_frames(anim):</span>
    <span class="s1">anim.save(</span><span class="s5">'unused.null'</span><span class="s0">, </span><span class="s1">writer=NullMovieWriter())</span>


<span class="s0">def </span><span class="s1">test_movie_writer_registry():</span>
    <span class="s0">assert </span><span class="s1">len(animation.writers._registered) &gt; </span><span class="s3">0</span>
    <span class="s1">mpl.rcParams[</span><span class="s5">'animation.ffmpeg_path'</span><span class="s1">] = </span><span class="s5">&quot;not_available_ever_xxxx&quot;</span>
    <span class="s0">assert not </span><span class="s1">animation.writers.is_available(</span><span class="s5">&quot;ffmpeg&quot;</span><span class="s1">)</span>
    <span class="s4"># something guaranteed to be available in path and exits immediately</span>
    <span class="s1">bin = </span><span class="s5">&quot;true&quot; </span><span class="s0">if </span><span class="s1">sys.platform != </span><span class="s5">'win32' </span><span class="s0">else </span><span class="s5">&quot;where&quot;</span>
    <span class="s1">mpl.rcParams[</span><span class="s5">'animation.ffmpeg_path'</span><span class="s1">] = bin</span>
    <span class="s0">assert </span><span class="s1">animation.writers.is_available(</span><span class="s5">&quot;ffmpeg&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;method_name&quot;</span><span class="s0">,</span>
    <span class="s1">[pytest.param(</span><span class="s5">&quot;to_html5_video&quot;</span><span class="s0">, </span><span class="s1">marks=pytest.mark.skipif(</span>
        <span class="s0">not </span><span class="s1">animation.writers.is_available(mpl.rcParams[</span><span class="s5">&quot;animation.writer&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">reason=</span><span class="s5">&quot;animation writer not installed&quot;</span><span class="s1">))</span><span class="s0">,</span>
     <span class="s5">&quot;to_jshtml&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s5">'anim'</span><span class="s0">, </span><span class="s1">[dict(frames=</span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">indirect=[</span><span class="s5">'anim'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_embed_limit(method_name</span><span class="s0">, </span><span class="s1">caplog</span><span class="s0">, </span><span class="s1">tmpdir</span><span class="s0">, </span><span class="s1">anim):</span>
    <span class="s1">caplog.set_level(</span><span class="s5">&quot;WARNING&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir.as_cwd():</span>
        <span class="s0">with </span><span class="s1">mpl.rc_context({</span><span class="s5">&quot;animation.embed_limit&quot;</span><span class="s1">: </span><span class="s3">1e-6</span><span class="s1">}):  </span><span class="s4"># ~1 byte.</span>
            <span class="s1">getattr(anim</span><span class="s0">, </span><span class="s1">method_name)()</span>
    <span class="s0">assert </span><span class="s1">len(caplog.records) == </span><span class="s3">1</span>
    <span class="s1">record</span><span class="s0">, </span><span class="s1">= caplog.records</span>
    <span class="s0">assert </span><span class="s1">(record.name == </span><span class="s5">&quot;matplotlib.animation&quot;</span>
            <span class="s0">and </span><span class="s1">record.levelname == </span><span class="s5">&quot;WARNING&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;method_name&quot;</span><span class="s0">,</span>
    <span class="s1">[pytest.param(</span><span class="s5">&quot;to_html5_video&quot;</span><span class="s0">, </span><span class="s1">marks=pytest.mark.skipif(</span>
        <span class="s0">not </span><span class="s1">animation.writers.is_available(mpl.rcParams[</span><span class="s5">&quot;animation.writer&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">reason=</span><span class="s5">&quot;animation writer not installed&quot;</span><span class="s1">))</span><span class="s0">,</span>
     <span class="s5">&quot;to_jshtml&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s5">'anim'</span><span class="s0">, </span><span class="s1">[dict(frames=</span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">indirect=[</span><span class="s5">'anim'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_cleanup_temporaries(method_name</span><span class="s0">, </span><span class="s1">tmpdir</span><span class="s0">, </span><span class="s1">anim):</span>
    <span class="s0">with </span><span class="s1">tmpdir.as_cwd():</span>
        <span class="s1">getattr(anim</span><span class="s0">, </span><span class="s1">method_name)()</span>
        <span class="s0">assert </span><span class="s1">list(Path(str(tmpdir)).iterdir()) == []</span>


<span class="s1">@pytest.mark.skipif(os.name != </span><span class="s5">&quot;posix&quot;</span><span class="s0">, </span><span class="s1">reason=</span><span class="s5">&quot;requires a POSIX OS&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_failing_ffmpeg(tmpdir</span><span class="s0">, </span><span class="s1">monkeypatch</span><span class="s0">, </span><span class="s1">anim):</span>
    <span class="s2">&quot;&quot;&quot; 
    Test that we correctly raise a CalledProcessError when ffmpeg fails. 
 
    To do so, mock ffmpeg using a simple executable shell script that 
    succeeds when called with no arguments (so that it gets registered by 
    `isAvailable`), but fails otherwise, and add it to the $PATH. 
    &quot;&quot;&quot;</span>
    <span class="s0">with </span><span class="s1">tmpdir.as_cwd():</span>
        <span class="s1">monkeypatch.setenv(</span><span class="s5">&quot;PATH&quot;</span><span class="s0">, </span><span class="s5">&quot;.:&quot; </span><span class="s1">+ os.environ[</span><span class="s5">&quot;PATH&quot;</span><span class="s1">])</span>
        <span class="s1">exe_path = Path(str(tmpdir)</span><span class="s0">, </span><span class="s5">&quot;ffmpeg&quot;</span><span class="s1">)</span>
        <span class="s1">exe_path.write_bytes(</span><span class="s6">b&quot;#!/bin/sh</span><span class="s0">\n</span><span class="s6">[[ $@ -eq 0 ]]</span><span class="s0">\n</span><span class="s6">&quot;</span><span class="s1">)</span>
        <span class="s1">os.chmod(exe_path</span><span class="s0">, </span><span class="s3">0o755</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(subprocess.CalledProcessError):</span>
            <span class="s1">anim.save(</span><span class="s5">&quot;test.mpeg&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;cache_frame_data&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_funcanimation_cache_frame_data(cache_frame_data):</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">line</span><span class="s0">, </span><span class="s1">= ax.plot([]</span><span class="s0">, </span><span class="s1">[])</span>

    <span class="s0">class </span><span class="s1">Frame(dict):</span>
        <span class="s4"># this subclassing enables to use weakref.ref()</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">init():</span>
        <span class="s1">line.set_data([]</span><span class="s0">, </span><span class="s1">[])</span>
        <span class="s0">return </span><span class="s1">line</span><span class="s0">,</span>

    <span class="s0">def </span><span class="s1">animate(frame):</span>
        <span class="s1">line.set_data(frame[</span><span class="s5">'x'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">frame[</span><span class="s5">'y'</span><span class="s1">])</span>
        <span class="s0">return </span><span class="s1">line</span><span class="s0">,</span>

    <span class="s1">frames_generated = []</span>

    <span class="s0">def </span><span class="s1">frames_generator():</span>
        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">5</span><span class="s1">):</span>
            <span class="s1">x = np.linspace(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span>
            <span class="s1">y = np.random.rand(</span><span class="s3">100</span><span class="s1">)</span>

            <span class="s1">frame = Frame(x=x</span><span class="s0">, </span><span class="s1">y=y)</span>

            <span class="s4"># collect weak references to frames</span>
            <span class="s4"># to validate their references later</span>
            <span class="s1">frames_generated.append(weakref.ref(frame))</span>

            <span class="s0">yield </span><span class="s1">frame</span>

    <span class="s1">MAX_FRAMES = </span><span class="s3">100</span>
    <span class="s1">anim = animation.FuncAnimation(fig</span><span class="s0">, </span><span class="s1">animate</span><span class="s0">, </span><span class="s1">init_func=init</span><span class="s0">,</span>
                                   <span class="s1">frames=frames_generator</span><span class="s0">,</span>
                                   <span class="s1">cache_frame_data=cache_frame_data</span><span class="s0">,</span>
                                   <span class="s1">save_count=MAX_FRAMES)</span>

    <span class="s1">writer = NullMovieWriter()</span>
    <span class="s1">anim.save(</span><span class="s5">'unused.null'</span><span class="s0">, </span><span class="s1">writer=writer)</span>
    <span class="s0">assert </span><span class="s1">len(frames_generated) == </span><span class="s3">5</span>
    <span class="s1">np.testing.break_cycles()</span>
    <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">frames_generated:</span>
        <span class="s4"># If cache_frame_data is True, then the weakref should be alive;</span>
        <span class="s4"># if cache_frame_data is False, then the weakref should be dead (None).</span>
        <span class="s0">assert </span><span class="s1">(f() </span><span class="s0">is None</span><span class="s1">) != cache_frame_data</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">'return_value'</span><span class="s0">, </span><span class="s1">[</span>
    <span class="s4"># User forgot to return (returns None).</span>
    <span class="s0">None,</span>
    <span class="s4"># User returned a string.</span>
    <span class="s5">'string'</span><span class="s0">,</span>
    <span class="s4"># User returned an int.</span>
    <span class="s3">1</span><span class="s0">,</span>
    <span class="s4"># User returns a sequence of other objects, e.g., string instead of Artist.</span>
    <span class="s1">(</span><span class="s5">'string'</span><span class="s0">, </span><span class="s1">)</span><span class="s0">,</span>
    <span class="s4"># User forgot to return a sequence (handled in `animate` below.)</span>
    <span class="s5">'artist'</span><span class="s0">,</span>
<span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_draw_frame(return_value):</span>
    <span class="s4"># test _draw_frame method</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">line</span><span class="s0">, </span><span class="s1">= ax.plot([])</span>

    <span class="s0">def </span><span class="s1">animate(i):</span>
        <span class="s4"># general update func</span>
        <span class="s1">line.set_data([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">i])</span>
        <span class="s0">if </span><span class="s1">return_value == </span><span class="s5">'artist'</span><span class="s1">:</span>
            <span class="s4"># *not* a sequence</span>
            <span class="s0">return </span><span class="s1">line</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">return </span><span class="s1">return_value</span>

    <span class="s0">with </span><span class="s1">pytest.raises(RuntimeError):</span>
        <span class="s1">animation.FuncAnimation(</span>
            <span class="s1">fig</span><span class="s0">, </span><span class="s1">animate</span><span class="s0">, </span><span class="s1">blit=</span><span class="s0">True, </span><span class="s1">cache_frame_data=</span><span class="s0">False</span>
        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_exhausted_animation(tmpdir):</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>

    <span class="s0">def </span><span class="s1">update(frame):</span>
        <span class="s0">return </span><span class="s1">[]</span>

    <span class="s1">anim = animation.FuncAnimation(</span>
        <span class="s1">fig</span><span class="s0">, </span><span class="s1">update</span><span class="s0">, </span><span class="s1">frames=iter(range(</span><span class="s3">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">repeat=</span><span class="s0">False,</span>
        <span class="s1">cache_frame_data=</span><span class="s0">False</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpdir.as_cwd():</span>
        <span class="s1">anim.save(</span><span class="s5">&quot;test.gif&quot;</span><span class="s0">, </span><span class="s1">writer=</span><span class="s5">'pillow'</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">&quot;exhausted&quot;</span><span class="s1">):</span>
        <span class="s1">anim._start()</span>


<span class="s0">def </span><span class="s1">test_no_frame_warning(tmpdir):</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>

    <span class="s0">def </span><span class="s1">update(frame):</span>
        <span class="s0">return </span><span class="s1">[]</span>

    <span class="s1">anim = animation.FuncAnimation(</span>
        <span class="s1">fig</span><span class="s0">, </span><span class="s1">update</span><span class="s0">, </span><span class="s1">frames=[]</span><span class="s0">, </span><span class="s1">repeat=</span><span class="s0">False,</span>
        <span class="s1">cache_frame_data=</span><span class="s0">False</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">&quot;exhausted&quot;</span><span class="s1">):</span>
        <span class="s1">anim._start()</span>


<span class="s1">@check_figures_equal(extensions=[</span><span class="s5">&quot;png&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_animation_frame(tmpdir</span><span class="s0">, </span><span class="s1">fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s4"># Test the expected image after iterating through a few frames</span>
    <span class="s4"># we save the animation to get the iteration because we are not</span>
    <span class="s4"># in an interactive framework.</span>
    <span class="s1">ax = fig_test.add_subplot()</span>
    <span class="s1">ax.set_xlim(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">* np.pi)</span>
    <span class="s1">ax.set_ylim(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">x = np.linspace(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">* np.pi</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span>
    <span class="s1">line</span><span class="s0">, </span><span class="s1">= ax.plot([]</span><span class="s0">, </span><span class="s1">[])</span>

    <span class="s0">def </span><span class="s1">init():</span>
        <span class="s1">line.set_data([]</span><span class="s0">, </span><span class="s1">[])</span>
        <span class="s0">return </span><span class="s1">line</span><span class="s0">,</span>

    <span class="s0">def </span><span class="s1">animate(i):</span>
        <span class="s1">line.set_data(x</span><span class="s0">, </span><span class="s1">np.sin(x + i / </span><span class="s3">100</span><span class="s1">))</span>
        <span class="s0">return </span><span class="s1">line</span><span class="s0">,</span>

    <span class="s1">anim = animation.FuncAnimation(</span>
        <span class="s1">fig_test</span><span class="s0">, </span><span class="s1">animate</span><span class="s0">, </span><span class="s1">init_func=init</span><span class="s0">, </span><span class="s1">frames=</span><span class="s3">5</span><span class="s0">,</span>
        <span class="s1">blit=</span><span class="s0">True, </span><span class="s1">repeat=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir.as_cwd():</span>
        <span class="s1">anim.save(</span><span class="s5">&quot;test.gif&quot;</span><span class="s1">)</span>

    <span class="s4"># Reference figure without animation</span>
    <span class="s1">ax = fig_ref.add_subplot()</span>
    <span class="s1">ax.set_xlim(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">* np.pi)</span>
    <span class="s1">ax.set_ylim(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s4"># 5th frame's data</span>
    <span class="s1">ax.plot(x</span><span class="s0">, </span><span class="s1">np.sin(x + </span><span class="s3">4 </span><span class="s1">/ </span><span class="s3">100</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">'anim'</span><span class="s0">, </span><span class="s1">[dict(klass=dict)]</span><span class="s0">, </span><span class="s1">indirect=[</span><span class="s5">'anim'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_save_count_override_warnings_has_length(anim):</span>

    <span class="s1">save_count = </span><span class="s3">5</span>
    <span class="s1">frames = list(range(</span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">match_target = (</span>
        <span class="s5">f'You passed in an explicit </span><span class="s0">{</span><span class="s1">save_count=</span><span class="s0">} </span><span class="s5">'</span>
        <span class="s5">&quot;which is being ignored in favor of &quot;</span>
        <span class="s5">f&quot;</span><span class="s0">{</span><span class="s1">len(frames)=</span><span class="s0">}</span><span class="s5">.&quot;</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=re.escape(match_target)):</span>
        <span class="s1">anim = animation.FuncAnimation(</span>
            <span class="s1">**{**anim</span><span class="s0">, </span><span class="s5">'frames'</span><span class="s1">: frames</span><span class="s0">, </span><span class="s5">'save_count'</span><span class="s1">: save_count}</span>
        <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">anim._save_count == len(frames)</span>
    <span class="s1">anim._init_draw()</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">'anim'</span><span class="s0">, </span><span class="s1">[dict(klass=dict)]</span><span class="s0">, </span><span class="s1">indirect=[</span><span class="s5">'anim'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_save_count_override_warnings_scaler(anim):</span>
    <span class="s1">save_count = </span><span class="s3">5</span>
    <span class="s1">frames = </span><span class="s3">7</span>
    <span class="s1">match_target = (</span>
        <span class="s5">f'You passed in an explicit </span><span class="s0">{</span><span class="s1">save_count=</span><span class="s0">} </span><span class="s5">' </span><span class="s1">+</span>
        <span class="s5">&quot;which is being ignored in favor of &quot; </span><span class="s1">+</span>
        <span class="s5">f&quot;</span><span class="s0">{</span><span class="s1">frames=</span><span class="s0">}</span><span class="s5">.&quot;</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=re.escape(match_target)):</span>
        <span class="s1">anim = animation.FuncAnimation(</span>
            <span class="s1">**{**anim</span><span class="s0">, </span><span class="s5">'frames'</span><span class="s1">: frames</span><span class="s0">, </span><span class="s5">'save_count'</span><span class="s1">: save_count}</span>
        <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">anim._save_count == frames</span>
    <span class="s1">anim._init_draw()</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">'anim'</span><span class="s0">, </span><span class="s1">[dict(klass=dict)]</span><span class="s0">, </span><span class="s1">indirect=[</span><span class="s5">'anim'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_disable_cache_warning(anim):</span>
    <span class="s1">cache_frame_data = </span><span class="s0">True</span>
    <span class="s1">frames = iter(range(</span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">match_target = (</span>
        <span class="s5">f&quot;</span><span class="s0">{</span><span class="s1">frames=</span><span class="s0">!r} </span><span class="s5">which we can infer the length of, &quot;</span>
        <span class="s5">&quot;did not pass an explicit *save_count* &quot;</span>
        <span class="s5">f&quot;and passed </span><span class="s0">{</span><span class="s1">cache_frame_data=</span><span class="s0">}</span><span class="s5">.  To avoid a possibly &quot;</span>
        <span class="s5">&quot;unbounded cache, frame data caching has been disabled. &quot;</span>
        <span class="s5">&quot;To suppress this warning either pass &quot;</span>
        <span class="s5">&quot;`cache_frame_data=False` or `save_count=MAX_FRAMES`.&quot;</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=re.escape(match_target)):</span>
        <span class="s1">anim = animation.FuncAnimation(</span>
            <span class="s1">**{**anim</span><span class="s0">, </span><span class="s5">'cache_frame_data'</span><span class="s1">: cache_frame_data</span><span class="s0">, </span><span class="s5">'frames'</span><span class="s1">: frames}</span>
        <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">anim._cache_frame_data </span><span class="s0">is False</span>
    <span class="s1">anim._init_draw()</span>
</pre>
</body>
</html>