<html>
<head>
<title>plot_directive.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #808080;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
plot_directive.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
A directive for including a Matplotlib plot in a Sphinx document 
================================================================ 
 
This is a Sphinx extension providing a reStructuredText directive 
``.. plot::`` for including a plot in a Sphinx document. 
 
In HTML output, ``.. plot::`` will include a .png file with a link 
to a high-res .png and .pdf.  In LaTeX output, it will include a .pdf. 
 
The plot content may be defined in one of three ways: 
 
1. **A path to a source file** as the argument to the directive:: 
 
     .. plot:: path/to/plot.py 
 
   When a path to a source file is given, the content of the 
   directive may optionally contain a caption for the plot:: 
 
     .. plot:: path/to/plot.py 
 
        The plot caption. 
 
   Additionally, one may specify the name of a function to call (with 
   no arguments) immediately after importing the module:: 
 
     .. plot:: path/to/plot.py plot_function1 
 
2. Included as **inline content** to the directive:: 
 
     .. plot:: 
 
        import matplotlib.pyplot as plt 
        plt.plot([1, 2, 3], [4, 5, 6]) 
        plt.title(&quot;A plotting exammple&quot;) 
 
3. Using **doctest** syntax:: 
 
     .. plot:: 
 
        A plotting example: 
        &gt;&gt;&gt; import matplotlib.pyplot as plt 
        &gt;&gt;&gt; plt.plot([1, 2, 3], [4, 5, 6]) 
 
Options 
------- 
 
The ``.. plot::`` directive supports the following options: 
 
    ``:format:`` : {'python', 'doctest'} 
        The format of the input.  If unset, the format is auto-detected. 
 
    ``:include-source:`` : bool 
        Whether to display the source code. The default can be changed using 
        the ``plot_include_source`` variable in :file:`conf.py` (which itself 
        defaults to False). 
 
    ``:show-source-link:`` : bool 
        Whether to show a link to the source in HTML. The default can be 
        changed using the ``plot_html_show_source_link`` variable in 
        :file:`conf.py` (which itself defaults to True). 
 
    ``:context:`` : bool or str 
        If provided, the code will be run in the context of all previous plot 
        directives for which the ``:context:`` option was specified.  This only 
        applies to inline code plot directives, not those run from files. If 
        the ``:context: reset`` option is specified, the context is reset 
        for this and future plots, and previous figures are closed prior to 
        running the code. ``:context: close-figs`` keeps the context but closes 
        previous figures before running the code. 
 
    ``:nofigs:`` : bool 
        If specified, the code block will be run, but no figures will be 
        inserted.  This is usually useful with the ``:context:`` option. 
 
    ``:caption:`` : str 
        If specified, the option's argument will be used as a caption for the 
        figure. This overwrites the caption given in the content, when the plot 
        is generated from a file. 
 
Additionally, this directive supports all the options of the `image directive 
&lt;https://docutils.sourceforge.io/docs/ref/rst/directives.html#image&gt;`_, 
except for ``:target:`` (since plot will add its own target).  These include 
``:alt:``, ``:height:``, ``:width:``, ``:scale:``, ``:align:`` and ``:class:``. 
 
Configuration options 
--------------------- 
 
The plot directive has the following configuration options: 
 
    plot_include_source 
        Default value for the include-source option (default: False). 
 
    plot_html_show_source_link 
        Whether to show a link to the source in HTML (default: True). 
 
    plot_pre_code 
        Code that should be executed before each plot. If None (the default), 
        it will default to a string containing:: 
 
            import numpy as np 
            from matplotlib import pyplot as plt 
 
    plot_basedir 
        Base directory, to which ``plot::`` file names are relative to. 
        If None or empty (the default), file names are relative to the 
        directory where the file containing the directive is. 
 
    plot_formats 
        File formats to generate (default: ['png', 'hires.png', 'pdf']). 
        List of tuples or strings:: 
 
            [(suffix, dpi), suffix, ...] 
 
        that determine the file format and the DPI. For entries whose 
        DPI was omitted, sensible defaults are chosen. When passing from 
        the command line through sphinx_build the list should be passed as 
        suffix:dpi,suffix:dpi, ... 
 
    plot_html_show_formats 
        Whether to show links to the files in HTML (default: True). 
 
    plot_rcparams 
        A dictionary containing any non-standard rcParams that should 
        be applied before each plot (default: {}). 
 
    plot_apply_rcparams 
        By default, rcParams are applied when ``:context:`` option is not used 
        in a plot directive.  If set, this configuration option overrides this 
        behavior and applies rcParams before each plot. 
 
    plot_working_directory 
        By default, the working directory will be changed to the directory of 
        the example, so the code can get at its data files, if any.  Also its 
        path will be added to `sys.path` so it can import any helper modules 
        sitting beside it.  This configuration option can be used to specify 
        a central directory (also added to `sys.path`) where data files and 
        helper modules for all code are located. 
 
    plot_template 
        Provide a customized template for preparing restructured text. 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">contextlib</span>
<span class="s2">import </span><span class="s1">doctest</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">StringIO</span>
<span class="s2">import </span><span class="s1">itertools</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">from </span><span class="s1">os.path </span><span class="s2">import </span><span class="s1">relpath</span>
<span class="s2">from </span><span class="s1">pathlib </span><span class="s2">import </span><span class="s1">Path</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">shutil</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">textwrap</span>
<span class="s2">import </span><span class="s1">traceback</span>

<span class="s2">from </span><span class="s1">docutils.parsers.rst </span><span class="s2">import </span><span class="s1">directives</span><span class="s2">, </span><span class="s1">Directive</span>
<span class="s2">from </span><span class="s1">docutils.parsers.rst.directives.images </span><span class="s2">import </span><span class="s1">Image</span>
<span class="s2">import </span><span class="s1">jinja2  </span><span class="s3"># Sphinx dependency.</span>

<span class="s2">import </span><span class="s1">matplotlib</span>
<span class="s2">from </span><span class="s1">matplotlib.backend_bases </span><span class="s2">import </span><span class="s1">FigureManagerBase</span>
<span class="s2">import </span><span class="s1">matplotlib.pyplot </span><span class="s2">as </span><span class="s1">plt</span>
<span class="s2">from </span><span class="s1">matplotlib </span><span class="s2">import </span><span class="s1">_pylab_helpers</span><span class="s2">, </span><span class="s1">cbook</span>

<span class="s1">matplotlib.use(</span><span class="s4">&quot;agg&quot;</span><span class="s1">)</span>

<span class="s1">__version__ = </span><span class="s5">2</span>


<span class="s3"># -----------------------------------------------------------------------------</span>
<span class="s3"># Registration hook</span>
<span class="s3"># -----------------------------------------------------------------------------</span>


<span class="s2">def </span><span class="s1">_option_boolean(arg):</span>
    <span class="s2">if not </span><span class="s1">arg </span><span class="s2">or not </span><span class="s1">arg.strip():</span>
        <span class="s3"># no argument given, assume used as a flag</span>
        <span class="s2">return True</span>
    <span class="s2">elif </span><span class="s1">arg.strip().lower() </span><span class="s2">in </span><span class="s1">(</span><span class="s4">'no'</span><span class="s2">, </span><span class="s4">'0'</span><span class="s2">, </span><span class="s4">'false'</span><span class="s1">):</span>
        <span class="s2">return False</span>
    <span class="s2">elif </span><span class="s1">arg.strip().lower() </span><span class="s2">in </span><span class="s1">(</span><span class="s4">'yes'</span><span class="s2">, </span><span class="s4">'1'</span><span class="s2">, </span><span class="s4">'true'</span><span class="s1">):</span>
        <span class="s2">return True</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">raise </span><span class="s1">ValueError(</span><span class="s4">f'</span><span class="s2">{</span><span class="s1">arg</span><span class="s2">!r} </span><span class="s4">unknown boolean'</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">_option_context(arg):</span>
    <span class="s2">if </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">[</span><span class="s2">None, </span><span class="s4">'reset'</span><span class="s2">, </span><span class="s4">'close-figs'</span><span class="s1">]:</span>
        <span class="s2">return </span><span class="s1">arg</span>
    <span class="s2">raise </span><span class="s1">ValueError(</span><span class="s4">&quot;Argument should be None or 'reset' or 'close-figs'&quot;</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">_option_format(arg):</span>
    <span class="s2">return </span><span class="s1">directives.choice(arg</span><span class="s2">, </span><span class="s1">(</span><span class="s4">'python'</span><span class="s2">, </span><span class="s4">'doctest'</span><span class="s1">))</span>


<span class="s2">def </span><span class="s1">mark_plot_labels(app</span><span class="s2">, </span><span class="s1">document):</span>
    <span class="s0">&quot;&quot;&quot; 
    To make plots referenceable, we need to move the reference from the 
    &quot;htmlonly&quot; (or &quot;latexonly&quot;) node to the actual figure node itself. 
    &quot;&quot;&quot;</span>
    <span class="s2">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">explicit </span><span class="s2">in </span><span class="s1">document.nametypes.items():</span>
        <span class="s2">if not </span><span class="s1">explicit:</span>
            <span class="s2">continue</span>
        <span class="s1">labelid = document.nameids[name]</span>
        <span class="s2">if </span><span class="s1">labelid </span><span class="s2">is None</span><span class="s1">:</span>
            <span class="s2">continue</span>
        <span class="s1">node = document.ids[labelid]</span>
        <span class="s2">if </span><span class="s1">node.tagname </span><span class="s2">in </span><span class="s1">(</span><span class="s4">'html_only'</span><span class="s2">, </span><span class="s4">'latex_only'</span><span class="s1">):</span>
            <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">node:</span>
                <span class="s2">if </span><span class="s1">n.tagname == </span><span class="s4">'figure'</span><span class="s1">:</span>
                    <span class="s1">sectname = name</span>
                    <span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">n:</span>
                        <span class="s2">if </span><span class="s1">c.tagname == </span><span class="s4">'caption'</span><span class="s1">:</span>
                            <span class="s1">sectname = c.astext()</span>
                            <span class="s2">break</span>

                    <span class="s1">node[</span><span class="s4">'ids'</span><span class="s1">].remove(labelid)</span>
                    <span class="s1">node[</span><span class="s4">'names'</span><span class="s1">].remove(name)</span>
                    <span class="s1">n[</span><span class="s4">'ids'</span><span class="s1">].append(labelid)</span>
                    <span class="s1">n[</span><span class="s4">'names'</span><span class="s1">].append(name)</span>
                    <span class="s1">document.settings.env.labels[name] = \</span>
                        <span class="s1">document.settings.env.docname</span><span class="s2">, </span><span class="s1">labelid</span><span class="s2">, </span><span class="s1">sectname</span>
                    <span class="s2">break</span>


<span class="s2">class </span><span class="s1">PlotDirective(Directive):</span>
    <span class="s0">&quot;&quot;&quot;The ``.. plot::`` directive, as documented in the module's docstring.&quot;&quot;&quot;</span>

    <span class="s1">has_content = </span><span class="s2">True</span>
    <span class="s1">required_arguments = </span><span class="s5">0</span>
    <span class="s1">optional_arguments = </span><span class="s5">2</span>
    <span class="s1">final_argument_whitespace = </span><span class="s2">False</span>
    <span class="s1">option_spec = {</span>
        <span class="s4">'alt'</span><span class="s1">: directives.unchanged</span><span class="s2">,</span>
        <span class="s4">'height'</span><span class="s1">: directives.length_or_unitless</span><span class="s2">,</span>
        <span class="s4">'width'</span><span class="s1">: directives.length_or_percentage_or_unitless</span><span class="s2">,</span>
        <span class="s4">'scale'</span><span class="s1">: directives.nonnegative_int</span><span class="s2">,</span>
        <span class="s4">'align'</span><span class="s1">: Image.align</span><span class="s2">,</span>
        <span class="s4">'class'</span><span class="s1">: directives.class_option</span><span class="s2">,</span>
        <span class="s4">'include-source'</span><span class="s1">: _option_boolean</span><span class="s2">,</span>
        <span class="s4">'show-source-link'</span><span class="s1">: _option_boolean</span><span class="s2">,</span>
        <span class="s4">'format'</span><span class="s1">: _option_format</span><span class="s2">,</span>
        <span class="s4">'context'</span><span class="s1">: _option_context</span><span class="s2">,</span>
        <span class="s4">'nofigs'</span><span class="s1">: directives.flag</span><span class="s2">,</span>
        <span class="s4">'caption'</span><span class="s1">: directives.unchanged</span><span class="s2">,</span>
        <span class="s1">}</span>

    <span class="s2">def </span><span class="s1">run(self):</span>
        <span class="s0">&quot;&quot;&quot;Run the plot directive.&quot;&quot;&quot;</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">run(self.arguments</span><span class="s2">, </span><span class="s1">self.content</span><span class="s2">, </span><span class="s1">self.options</span><span class="s2">,</span>
                       <span class="s1">self.state_machine</span><span class="s2">, </span><span class="s1">self.state</span><span class="s2">, </span><span class="s1">self.lineno)</span>
        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e:</span>
            <span class="s2">raise </span><span class="s1">self.error(str(e))</span>


<span class="s2">def </span><span class="s1">_copy_css_file(app</span><span class="s2">, </span><span class="s1">exc):</span>
    <span class="s2">if </span><span class="s1">exc </span><span class="s2">is None and </span><span class="s1">app.builder.format == </span><span class="s4">'html'</span><span class="s1">:</span>
        <span class="s1">src = cbook._get_data_path(</span><span class="s4">'plot_directive/plot_directive.css'</span><span class="s1">)</span>
        <span class="s1">dst = app.outdir / Path(</span><span class="s4">'_static'</span><span class="s1">)</span>
        <span class="s1">dst.mkdir(exist_ok=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s3"># Use copyfile because we do not want to copy src's permissions.</span>
        <span class="s1">shutil.copyfile(src</span><span class="s2">, </span><span class="s1">dst / Path(</span><span class="s4">'plot_directive.css'</span><span class="s1">))</span>


<span class="s2">def </span><span class="s1">setup(app):</span>
    <span class="s1">setup.app = app</span>
    <span class="s1">setup.config = app.config</span>
    <span class="s1">setup.confdir = app.confdir</span>
    <span class="s1">app.add_directive(</span><span class="s4">'plot'</span><span class="s2">, </span><span class="s1">PlotDirective)</span>
    <span class="s1">app.add_config_value(</span><span class="s4">'plot_pre_code'</span><span class="s2">, None, True</span><span class="s1">)</span>
    <span class="s1">app.add_config_value(</span><span class="s4">'plot_include_source'</span><span class="s2">, False, True</span><span class="s1">)</span>
    <span class="s1">app.add_config_value(</span><span class="s4">'plot_html_show_source_link'</span><span class="s2">, True, True</span><span class="s1">)</span>
    <span class="s1">app.add_config_value(</span><span class="s4">'plot_formats'</span><span class="s2">, </span><span class="s1">[</span><span class="s4">'png'</span><span class="s2">, </span><span class="s4">'hires.png'</span><span class="s2">, </span><span class="s4">'pdf'</span><span class="s1">]</span><span class="s2">, True</span><span class="s1">)</span>
    <span class="s1">app.add_config_value(</span><span class="s4">'plot_basedir'</span><span class="s2">, None, True</span><span class="s1">)</span>
    <span class="s1">app.add_config_value(</span><span class="s4">'plot_html_show_formats'</span><span class="s2">, True, True</span><span class="s1">)</span>
    <span class="s1">app.add_config_value(</span><span class="s4">'plot_rcparams'</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, True</span><span class="s1">)</span>
    <span class="s1">app.add_config_value(</span><span class="s4">'plot_apply_rcparams'</span><span class="s2">, False, True</span><span class="s1">)</span>
    <span class="s1">app.add_config_value(</span><span class="s4">'plot_working_directory'</span><span class="s2">, None, True</span><span class="s1">)</span>
    <span class="s1">app.add_config_value(</span><span class="s4">'plot_template'</span><span class="s2">, None, True</span><span class="s1">)</span>
    <span class="s1">app.connect(</span><span class="s4">'doctree-read'</span><span class="s2">, </span><span class="s1">mark_plot_labels)</span>
    <span class="s1">app.add_css_file(</span><span class="s4">'plot_directive.css'</span><span class="s1">)</span>
    <span class="s1">app.connect(</span><span class="s4">'build-finished'</span><span class="s2">, </span><span class="s1">_copy_css_file)</span>
    <span class="s1">metadata = {</span><span class="s4">'parallel_read_safe'</span><span class="s1">: </span><span class="s2">True, </span><span class="s4">'parallel_write_safe'</span><span class="s1">: </span><span class="s2">True,</span>
                <span class="s4">'version'</span><span class="s1">: matplotlib.__version__}</span>
    <span class="s2">return </span><span class="s1">metadata</span>


<span class="s3"># -----------------------------------------------------------------------------</span>
<span class="s3"># Doctest handling</span>
<span class="s3"># -----------------------------------------------------------------------------</span>


<span class="s2">def </span><span class="s1">contains_doctest(text):</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s3"># check if it's valid Python as-is</span>
        <span class="s1">compile(text</span><span class="s2">, </span><span class="s4">'&lt;string&gt;'</span><span class="s2">, </span><span class="s4">'exec'</span><span class="s1">)</span>
        <span class="s2">return False</span>
    <span class="s2">except </span><span class="s1">SyntaxError:</span>
        <span class="s2">pass</span>
    <span class="s1">r = re.compile(</span><span class="s4">r'^\s*&gt;&gt;&gt;'</span><span class="s2">, </span><span class="s1">re.M)</span>
    <span class="s1">m = r.search(text)</span>
    <span class="s2">return </span><span class="s1">bool(m)</span>


<span class="s2">def </span><span class="s1">_split_code_at_show(text</span><span class="s2">, </span><span class="s1">function_name):</span>
    <span class="s0">&quot;&quot;&quot;Split code at plt.show().&quot;&quot;&quot;</span>

    <span class="s1">is_doctest = contains_doctest(text)</span>
    <span class="s2">if </span><span class="s1">function_name </span><span class="s2">is None</span><span class="s1">:</span>
        <span class="s1">parts = []</span>
        <span class="s1">part = []</span>
        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">text.split(</span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s1">):</span>
            <span class="s2">if </span><span class="s1">((</span><span class="s2">not </span><span class="s1">is_doctest </span><span class="s2">and </span><span class="s1">line.startswith(</span><span class="s4">'plt.show('</span><span class="s1">)) </span><span class="s2">or</span>
                   <span class="s1">(is_doctest </span><span class="s2">and </span><span class="s1">line.strip() == </span><span class="s4">'&gt;&gt;&gt; plt.show()'</span><span class="s1">)):</span>
                <span class="s1">part.append(line)</span>
                <span class="s1">parts.append(</span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s1">.join(part))</span>
                <span class="s1">part = []</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">part.append(line)</span>
        <span class="s2">if </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s1">.join(part).strip():</span>
            <span class="s1">parts.append(</span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s1">.join(part))</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">parts = [text]</span>
    <span class="s2">return </span><span class="s1">is_doctest</span><span class="s2">, </span><span class="s1">parts</span>


<span class="s3"># -----------------------------------------------------------------------------</span>
<span class="s3"># Template</span>
<span class="s3"># -----------------------------------------------------------------------------</span>

<span class="s1">TEMPLATE = </span><span class="s4">&quot;&quot;&quot; 
{{ source_code }} 
 
.. only:: html 
 
   {% if src_name or (html_show_formats and not multi_image) %} 
   ( 
   {%- if src_name -%} 
   :download:`Source code &lt;{{ build_dir }}/{{ src_name }}&gt;` 
   {%- endif -%} 
   {%- if html_show_formats and not multi_image -%} 
     {%- for img in images -%} 
       {%- for fmt in img.formats -%} 
         {%- if src_name or not loop.first -%}, {% endif -%} 
         :download:`{{ fmt }} &lt;{{ build_dir }}/{{ img.basename }}.{{ fmt }}&gt;` 
       {%- endfor -%} 
     {%- endfor -%} 
   {%- endif -%} 
   ) 
   {% endif %} 
 
   {% for img in images %} 
   .. figure:: {{ build_dir }}/{{ img.basename }}.{{ default_fmt }} 
      {% for option in options -%} 
      {{ option }} 
      {% endfor %} 
 
      {% if html_show_formats and multi_image -%} 
        ( 
        {%- for fmt in img.formats -%} 
        {%- if not loop.first -%}, {% endif -%} 
        :download:`{{ fmt }} &lt;{{ build_dir }}/{{ img.basename }}.{{ fmt }}&gt;` 
        {%- endfor -%} 
        ) 
      {%- endif -%} 
 
      {{ caption }}  {# appropriate leading whitespace added beforehand #} 
   {% endfor %} 
 
.. only:: not html 
 
   {% for img in images %} 
   .. figure:: {{ build_dir }}/{{ img.basename }}.* 
      {% for option in options -%} 
      {{ option }} 
      {% endfor -%} 
 
      {{ caption }}  {# appropriate leading whitespace added beforehand #} 
   {% endfor %} 
 
&quot;&quot;&quot;</span>

<span class="s1">exception_template = </span><span class="s4">&quot;&quot;&quot; 
.. only:: html 
 
   [`source code &lt;%(linkdir)s/%(basename)s.py&gt;`__] 
 
Exception occurred rendering plot. 
 
&quot;&quot;&quot;</span>

<span class="s3"># the context of the plot for all directives specified with the</span>
<span class="s3"># :context: option</span>
<span class="s1">plot_context = dict()</span>


<span class="s2">class </span><span class="s1">ImageFile:</span>
    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">basename</span><span class="s2">, </span><span class="s1">dirname):</span>
        <span class="s1">self.basename = basename</span>
        <span class="s1">self.dirname = dirname</span>
        <span class="s1">self.formats = []</span>

    <span class="s2">def </span><span class="s1">filename(self</span><span class="s2">, </span><span class="s1">format):</span>
        <span class="s2">return </span><span class="s1">os.path.join(self.dirname</span><span class="s2">, </span><span class="s4">&quot;%s.%s&quot; </span><span class="s1">% (self.basename</span><span class="s2">, </span><span class="s1">format))</span>

    <span class="s2">def </span><span class="s1">filenames(self):</span>
        <span class="s2">return </span><span class="s1">[self.filename(fmt) </span><span class="s2">for </span><span class="s1">fmt </span><span class="s2">in </span><span class="s1">self.formats]</span>


<span class="s2">def </span><span class="s1">out_of_date(original</span><span class="s2">, </span><span class="s1">derived</span><span class="s2">, </span><span class="s1">includes=</span><span class="s2">None</span><span class="s1">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Return whether *derived* is out-of-date relative to *original* or any of 
    the RST files included in it using the RST include directive (*includes*). 
    *derived* and *original* are full paths, and *includes* is optionally a 
    list of full paths which may have been included in the *original*. 
    &quot;&quot;&quot;</span>
    <span class="s2">if not </span><span class="s1">os.path.exists(derived):</span>
        <span class="s2">return True</span>

    <span class="s2">if </span><span class="s1">includes </span><span class="s2">is None</span><span class="s1">:</span>
        <span class="s1">includes = []</span>
    <span class="s1">files_to_check = [original</span><span class="s2">, </span><span class="s1">*includes]</span>

    <span class="s2">def </span><span class="s1">out_of_date_one(original</span><span class="s2">, </span><span class="s1">derived_mtime):</span>
        <span class="s2">return </span><span class="s1">(os.path.exists(original) </span><span class="s2">and</span>
                <span class="s1">derived_mtime &lt; os.stat(original).st_mtime)</span>

    <span class="s1">derived_mtime = os.stat(derived).st_mtime</span>
    <span class="s2">return </span><span class="s1">any(out_of_date_one(f</span><span class="s2">, </span><span class="s1">derived_mtime) </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">files_to_check)</span>


<span class="s2">class </span><span class="s1">PlotError(RuntimeError):</span>
    <span class="s2">pass</span>


<span class="s2">def </span><span class="s1">_run_code(code</span><span class="s2">, </span><span class="s1">code_path</span><span class="s2">, </span><span class="s1">ns=</span><span class="s2">None, </span><span class="s1">function_name=</span><span class="s2">None</span><span class="s1">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Import a Python module from a path, and run the function given by 
    name, if function_name is not None. 
    &quot;&quot;&quot;</span>

    <span class="s3"># Change the working directory to the directory of the example, so</span>
    <span class="s3"># it can get at its data files, if any.  Add its path to sys.path</span>
    <span class="s3"># so it can import any helper modules sitting beside it.</span>
    <span class="s1">pwd = os.getcwd()</span>
    <span class="s2">if </span><span class="s1">setup.config.plot_working_directory </span><span class="s2">is not None</span><span class="s1">:</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">os.chdir(setup.config.plot_working_directory)</span>
        <span class="s2">except </span><span class="s1">OSError </span><span class="s2">as </span><span class="s1">err:</span>
            <span class="s2">raise </span><span class="s1">OSError(</span><span class="s4">f'</span><span class="s2">{</span><span class="s1">err</span><span class="s2">}\n</span><span class="s4">`plot_working_directory` option in '</span>
                          <span class="s4">f'Sphinx configuration file must be a valid '</span>
                          <span class="s4">f'directory path'</span><span class="s1">) </span><span class="s2">from </span><span class="s1">err</span>
        <span class="s2">except </span><span class="s1">TypeError </span><span class="s2">as </span><span class="s1">err:</span>
            <span class="s2">raise </span><span class="s1">TypeError(</span><span class="s4">f'</span><span class="s2">{</span><span class="s1">err</span><span class="s2">}\n</span><span class="s4">`plot_working_directory` option in '</span>
                            <span class="s4">f'Sphinx configuration file must be a string or '</span>
                            <span class="s4">f'None'</span><span class="s1">) </span><span class="s2">from </span><span class="s1">err</span>
    <span class="s2">elif </span><span class="s1">code_path </span><span class="s2">is not None</span><span class="s1">:</span>
        <span class="s1">dirname = os.path.abspath(os.path.dirname(code_path))</span>
        <span class="s1">os.chdir(dirname)</span>

    <span class="s2">with </span><span class="s1">cbook._setattr_cm(</span>
            <span class="s1">sys</span><span class="s2">, </span><span class="s1">argv=[code_path]</span><span class="s2">, </span><span class="s1">path=[os.getcwd()</span><span class="s2">, </span><span class="s1">*sys.path])</span><span class="s2">, </span><span class="s1">\</span>
            <span class="s1">contextlib.redirect_stdout(StringIO()):</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s2">if </span><span class="s1">ns </span><span class="s2">is None</span><span class="s1">:</span>
                <span class="s1">ns = {}</span>
            <span class="s2">if not </span><span class="s1">ns:</span>
                <span class="s2">if </span><span class="s1">setup.config.plot_pre_code </span><span class="s2">is None</span><span class="s1">:</span>
                    <span class="s1">exec(</span><span class="s4">'import numpy as np</span><span class="s2">\n</span><span class="s4">'</span>
                         <span class="s4">'from matplotlib import pyplot as plt</span><span class="s2">\n</span><span class="s4">'</span><span class="s2">, </span><span class="s1">ns)</span>
                <span class="s2">else</span><span class="s1">:</span>
                    <span class="s1">exec(str(setup.config.plot_pre_code)</span><span class="s2">, </span><span class="s1">ns)</span>
            <span class="s2">if </span><span class="s4">&quot;__main__&quot; </span><span class="s2">in </span><span class="s1">code:</span>
                <span class="s1">ns[</span><span class="s4">'__name__'</span><span class="s1">] = </span><span class="s4">'__main__'</span>

            <span class="s3"># Patch out non-interactive show() to avoid triggering a warning.</span>
            <span class="s2">with </span><span class="s1">cbook._setattr_cm(FigureManagerBase</span><span class="s2">, </span><span class="s1">show=</span><span class="s2">lambda </span><span class="s1">self: </span><span class="s2">None</span><span class="s1">):</span>
                <span class="s1">exec(code</span><span class="s2">, </span><span class="s1">ns)</span>
                <span class="s2">if </span><span class="s1">function_name </span><span class="s2">is not None</span><span class="s1">:</span>
                    <span class="s1">exec(function_name + </span><span class="s4">&quot;()&quot;</span><span class="s2">, </span><span class="s1">ns)</span>

        <span class="s2">except </span><span class="s1">(Exception</span><span class="s2">, </span><span class="s1">SystemExit) </span><span class="s2">as </span><span class="s1">err:</span>
            <span class="s2">raise </span><span class="s1">PlotError(traceback.format_exc()) </span><span class="s2">from </span><span class="s1">err</span>
        <span class="s2">finally</span><span class="s1">:</span>
            <span class="s1">os.chdir(pwd)</span>
    <span class="s2">return </span><span class="s1">ns</span>


<span class="s2">def </span><span class="s1">clear_state(plot_rcparams</span><span class="s2">, </span><span class="s1">close=</span><span class="s2">True</span><span class="s1">):</span>
    <span class="s2">if </span><span class="s1">close:</span>
        <span class="s1">plt.close(</span><span class="s4">'all'</span><span class="s1">)</span>
    <span class="s1">matplotlib.rc_file_defaults()</span>
    <span class="s1">matplotlib.rcParams.update(plot_rcparams)</span>


<span class="s2">def </span><span class="s1">get_plot_formats(config):</span>
    <span class="s1">default_dpi = {</span><span class="s4">'png'</span><span class="s1">: </span><span class="s5">80</span><span class="s2">, </span><span class="s4">'hires.png'</span><span class="s1">: </span><span class="s5">200</span><span class="s2">, </span><span class="s4">'pdf'</span><span class="s1">: </span><span class="s5">200</span><span class="s1">}</span>
    <span class="s1">formats = []</span>
    <span class="s1">plot_formats = config.plot_formats</span>
    <span class="s2">for </span><span class="s1">fmt </span><span class="s2">in </span><span class="s1">plot_formats:</span>
        <span class="s2">if </span><span class="s1">isinstance(fmt</span><span class="s2">, </span><span class="s1">str):</span>
            <span class="s2">if </span><span class="s4">':' </span><span class="s2">in </span><span class="s1">fmt:</span>
                <span class="s1">suffix</span><span class="s2">, </span><span class="s1">dpi = fmt.split(</span><span class="s4">':'</span><span class="s1">)</span>
                <span class="s1">formats.append((str(suffix)</span><span class="s2">, </span><span class="s1">int(dpi)))</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">formats.append((fmt</span><span class="s2">, </span><span class="s1">default_dpi.get(fmt</span><span class="s2">, </span><span class="s5">80</span><span class="s1">)))</span>
        <span class="s2">elif </span><span class="s1">isinstance(fmt</span><span class="s2">, </span><span class="s1">(tuple</span><span class="s2">, </span><span class="s1">list)) </span><span class="s2">and </span><span class="s1">len(fmt) == </span><span class="s5">2</span><span class="s1">:</span>
            <span class="s1">formats.append((str(fmt[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">int(fmt[</span><span class="s5">1</span><span class="s1">])))</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">raise </span><span class="s1">PlotError(</span><span class="s4">'invalid image format &quot;%r&quot; in plot_formats' </span><span class="s1">% fmt)</span>
    <span class="s2">return </span><span class="s1">formats</span>


<span class="s2">def </span><span class="s1">render_figures(code</span><span class="s2">, </span><span class="s1">code_path</span><span class="s2">, </span><span class="s1">output_dir</span><span class="s2">, </span><span class="s1">output_base</span><span class="s2">, </span><span class="s1">context</span><span class="s2">,</span>
                   <span class="s1">function_name</span><span class="s2">, </span><span class="s1">config</span><span class="s2">, </span><span class="s1">context_reset=</span><span class="s2">False,</span>
                   <span class="s1">close_figs=</span><span class="s2">False,</span>
                   <span class="s1">code_includes=</span><span class="s2">None</span><span class="s1">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Run a pyplot script and save the images in *output_dir*. 
 
    Save the images under *output_dir* with file names derived from 
    *output_base* 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">function_name </span><span class="s2">is not None</span><span class="s1">:</span>
        <span class="s1">output_base = </span><span class="s4">f'</span><span class="s2">{</span><span class="s1">output_base</span><span class="s2">}</span><span class="s4">_</span><span class="s2">{</span><span class="s1">function_name</span><span class="s2">}</span><span class="s4">'</span>
    <span class="s1">formats = get_plot_formats(config)</span>

    <span class="s3"># Try to determine if all images already exist</span>

    <span class="s1">is_doctest</span><span class="s2">, </span><span class="s1">code_pieces = _split_code_at_show(code</span><span class="s2">, </span><span class="s1">function_name)</span>

    <span class="s3"># Look for single-figure output files first</span>
    <span class="s1">img = ImageFile(output_base</span><span class="s2">, </span><span class="s1">output_dir)</span>
    <span class="s2">for </span><span class="s1">format</span><span class="s2">, </span><span class="s1">dpi </span><span class="s2">in </span><span class="s1">formats:</span>
        <span class="s2">if </span><span class="s1">context </span><span class="s2">or </span><span class="s1">out_of_date(code_path</span><span class="s2">, </span><span class="s1">img.filename(format)</span><span class="s2">,</span>
                                  <span class="s1">includes=code_includes):</span>
            <span class="s1">all_exists = </span><span class="s2">False</span>
            <span class="s2">break</span>
        <span class="s1">img.formats.append(format)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">all_exists = </span><span class="s2">True</span>

    <span class="s2">if </span><span class="s1">all_exists:</span>
        <span class="s2">return </span><span class="s1">[(code</span><span class="s2">, </span><span class="s1">[img])]</span>

    <span class="s3"># Then look for multi-figure output files</span>
    <span class="s1">results = []</span>
    <span class="s2">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">code_piece </span><span class="s2">in </span><span class="s1">enumerate(code_pieces):</span>
        <span class="s1">images = []</span>
        <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">itertools.count():</span>
            <span class="s2">if </span><span class="s1">len(code_pieces) &gt; </span><span class="s5">1</span><span class="s1">:</span>
                <span class="s1">img = ImageFile(</span><span class="s4">'%s_%02d_%02d' </span><span class="s1">% (output_base</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j)</span><span class="s2">,</span>
                                <span class="s1">output_dir)</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">img = ImageFile(</span><span class="s4">'%s_%02d' </span><span class="s1">% (output_base</span><span class="s2">, </span><span class="s1">j)</span><span class="s2">, </span><span class="s1">output_dir)</span>
            <span class="s2">for </span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">dpi </span><span class="s2">in </span><span class="s1">formats:</span>
                <span class="s2">if </span><span class="s1">context </span><span class="s2">or </span><span class="s1">out_of_date(code_path</span><span class="s2">, </span><span class="s1">img.filename(fmt)</span><span class="s2">,</span>
                                          <span class="s1">includes=code_includes):</span>
                    <span class="s1">all_exists = </span><span class="s2">False</span>
                    <span class="s2">break</span>
                <span class="s1">img.formats.append(fmt)</span>

            <span class="s3"># assume that if we have one, we have them all</span>
            <span class="s2">if not </span><span class="s1">all_exists:</span>
                <span class="s1">all_exists = (j &gt; </span><span class="s5">0</span><span class="s1">)</span>
                <span class="s2">break</span>
            <span class="s1">images.append(img)</span>
        <span class="s2">if not </span><span class="s1">all_exists:</span>
            <span class="s2">break</span>
        <span class="s1">results.append((code_piece</span><span class="s2">, </span><span class="s1">images))</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">all_exists = </span><span class="s2">True</span>

    <span class="s2">if </span><span class="s1">all_exists:</span>
        <span class="s2">return </span><span class="s1">results</span>

    <span class="s3"># We didn't find the files, so build them</span>

    <span class="s1">results = []</span>
    <span class="s1">ns = plot_context </span><span class="s2">if </span><span class="s1">context </span><span class="s2">else </span><span class="s1">{}</span>

    <span class="s2">if </span><span class="s1">context_reset:</span>
        <span class="s1">clear_state(config.plot_rcparams)</span>
        <span class="s1">plot_context.clear()</span>

    <span class="s1">close_figs = </span><span class="s2">not </span><span class="s1">context </span><span class="s2">or </span><span class="s1">close_figs</span>

    <span class="s2">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">code_piece </span><span class="s2">in </span><span class="s1">enumerate(code_pieces):</span>

        <span class="s2">if not </span><span class="s1">context </span><span class="s2">or </span><span class="s1">config.plot_apply_rcparams:</span>
            <span class="s1">clear_state(config.plot_rcparams</span><span class="s2">, </span><span class="s1">close_figs)</span>
        <span class="s2">elif </span><span class="s1">close_figs:</span>
            <span class="s1">plt.close(</span><span class="s4">'all'</span><span class="s1">)</span>

        <span class="s1">_run_code(doctest.script_from_examples(code_piece) </span><span class="s2">if </span><span class="s1">is_doctest</span>
                  <span class="s2">else </span><span class="s1">code_piece</span><span class="s2">,</span>
                  <span class="s1">code_path</span><span class="s2">, </span><span class="s1">ns</span><span class="s2">, </span><span class="s1">function_name)</span>

        <span class="s1">images = []</span>
        <span class="s1">fig_managers = _pylab_helpers.Gcf.get_all_fig_managers()</span>
        <span class="s2">for </span><span class="s1">j</span><span class="s2">, </span><span class="s1">figman </span><span class="s2">in </span><span class="s1">enumerate(fig_managers):</span>
            <span class="s2">if </span><span class="s1">len(fig_managers) == </span><span class="s5">1 </span><span class="s2">and </span><span class="s1">len(code_pieces) == </span><span class="s5">1</span><span class="s1">:</span>
                <span class="s1">img = ImageFile(output_base</span><span class="s2">, </span><span class="s1">output_dir)</span>
            <span class="s2">elif </span><span class="s1">len(code_pieces) == </span><span class="s5">1</span><span class="s1">:</span>
                <span class="s1">img = ImageFile(</span><span class="s4">&quot;%s_%02d&quot; </span><span class="s1">% (output_base</span><span class="s2">, </span><span class="s1">j)</span><span class="s2">, </span><span class="s1">output_dir)</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">img = ImageFile(</span><span class="s4">&quot;%s_%02d_%02d&quot; </span><span class="s1">% (output_base</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j)</span><span class="s2">,</span>
                                <span class="s1">output_dir)</span>
            <span class="s1">images.append(img)</span>
            <span class="s2">for </span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">dpi </span><span class="s2">in </span><span class="s1">formats:</span>
                <span class="s2">try</span><span class="s1">:</span>
                    <span class="s1">figman.canvas.figure.savefig(img.filename(fmt)</span><span class="s2">, </span><span class="s1">dpi=dpi)</span>
                <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">err:</span>
                    <span class="s2">raise </span><span class="s1">PlotError(traceback.format_exc()) </span><span class="s2">from </span><span class="s1">err</span>
                <span class="s1">img.formats.append(fmt)</span>

        <span class="s1">results.append((code_piece</span><span class="s2">, </span><span class="s1">images))</span>

    <span class="s2">if not </span><span class="s1">context </span><span class="s2">or </span><span class="s1">config.plot_apply_rcparams:</span>
        <span class="s1">clear_state(config.plot_rcparams</span><span class="s2">, </span><span class="s1">close=</span><span class="s2">not </span><span class="s1">context)</span>

    <span class="s2">return </span><span class="s1">results</span>


<span class="s2">def </span><span class="s1">run(arguments</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">options</span><span class="s2">, </span><span class="s1">state_machine</span><span class="s2">, </span><span class="s1">state</span><span class="s2">, </span><span class="s1">lineno):</span>
    <span class="s1">document = state_machine.document</span>
    <span class="s1">config = document.settings.env.config</span>
    <span class="s1">nofigs = </span><span class="s4">'nofigs' </span><span class="s2">in </span><span class="s1">options</span>

    <span class="s1">formats = get_plot_formats(config)</span>
    <span class="s1">default_fmt = formats[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span>

    <span class="s1">options.setdefault(</span><span class="s4">'include-source'</span><span class="s2">, </span><span class="s1">config.plot_include_source)</span>
    <span class="s1">options.setdefault(</span><span class="s4">'show-source-link'</span><span class="s2">, </span><span class="s1">config.plot_html_show_source_link)</span>
    <span class="s2">if </span><span class="s4">'class' </span><span class="s2">in </span><span class="s1">options:</span>
        <span class="s3"># classes are parsed into a list of string, and output by simply</span>
        <span class="s3"># printing the list, abusing the fact that RST guarantees to strip</span>
        <span class="s3"># non-conforming characters</span>
        <span class="s1">options[</span><span class="s4">'class'</span><span class="s1">] = [</span><span class="s4">'plot-directive'</span><span class="s1">] + options[</span><span class="s4">'class'</span><span class="s1">]</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">options.setdefault(</span><span class="s4">'class'</span><span class="s2">, </span><span class="s1">[</span><span class="s4">'plot-directive'</span><span class="s1">])</span>
    <span class="s1">keep_context = </span><span class="s4">'context' </span><span class="s2">in </span><span class="s1">options</span>
    <span class="s1">context_opt = </span><span class="s2">None if not </span><span class="s1">keep_context </span><span class="s2">else </span><span class="s1">options[</span><span class="s4">'context'</span><span class="s1">]</span>

    <span class="s1">rst_file = document.attributes[</span><span class="s4">'source'</span><span class="s1">]</span>
    <span class="s1">rst_dir = os.path.dirname(rst_file)</span>

    <span class="s2">if </span><span class="s1">len(arguments):</span>
        <span class="s2">if not </span><span class="s1">config.plot_basedir:</span>
            <span class="s1">source_file_name = os.path.join(setup.app.builder.srcdir</span><span class="s2">,</span>
                                            <span class="s1">directives.uri(arguments[</span><span class="s5">0</span><span class="s1">]))</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">source_file_name = os.path.join(setup.confdir</span><span class="s2">, </span><span class="s1">config.plot_basedir</span><span class="s2">,</span>
                                            <span class="s1">directives.uri(arguments[</span><span class="s5">0</span><span class="s1">]))</span>

        <span class="s3"># If there is content, it will be passed as a caption.</span>
        <span class="s1">caption = </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">.join(content)</span>

        <span class="s3"># Enforce unambiguous use of captions.</span>
        <span class="s2">if </span><span class="s4">&quot;caption&quot; </span><span class="s2">in </span><span class="s1">options:</span>
            <span class="s2">if </span><span class="s1">caption:</span>
                <span class="s2">raise </span><span class="s1">ValueError(</span>
                    <span class="s4">'Caption specified in both content and options.'</span>
                    <span class="s4">' Please remove ambiguity.'</span>
                <span class="s1">)</span>
            <span class="s3"># Use caption option</span>
            <span class="s1">caption = options[</span><span class="s4">&quot;caption&quot;</span><span class="s1">]</span>

        <span class="s3"># If the optional function name is provided, use it</span>
        <span class="s2">if </span><span class="s1">len(arguments) == </span><span class="s5">2</span><span class="s1">:</span>
            <span class="s1">function_name = arguments[</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">function_name = </span><span class="s2">None</span>

        <span class="s1">code = Path(source_file_name).read_text(encoding=</span><span class="s4">'utf-8'</span><span class="s1">)</span>
        <span class="s1">output_base = os.path.basename(source_file_name)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">source_file_name = rst_file</span>
        <span class="s1">code = textwrap.dedent(</span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s1">.join(map(str</span><span class="s2">, </span><span class="s1">content)))</span>
        <span class="s1">counter = document.attributes.get(</span><span class="s4">'_plot_counter'</span><span class="s2">, </span><span class="s5">0</span><span class="s1">) + </span><span class="s5">1</span>
        <span class="s1">document.attributes[</span><span class="s4">'_plot_counter'</span><span class="s1">] = counter</span>
        <span class="s1">base</span><span class="s2">, </span><span class="s1">ext = os.path.splitext(os.path.basename(source_file_name))</span>
        <span class="s1">output_base = </span><span class="s4">'%s-%d.py' </span><span class="s1">% (base</span><span class="s2">, </span><span class="s1">counter)</span>
        <span class="s1">function_name = </span><span class="s2">None</span>
        <span class="s1">caption = options.get(</span><span class="s4">'caption'</span><span class="s2">, </span><span class="s4">''</span><span class="s1">)</span>

    <span class="s1">base</span><span class="s2">, </span><span class="s1">source_ext = os.path.splitext(output_base)</span>
    <span class="s2">if </span><span class="s1">source_ext </span><span class="s2">in </span><span class="s1">(</span><span class="s4">'.py'</span><span class="s2">, </span><span class="s4">'.rst'</span><span class="s2">, </span><span class="s4">'.txt'</span><span class="s1">):</span>
        <span class="s1">output_base = base</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">source_ext = </span><span class="s4">''</span>

    <span class="s3"># ensure that LaTeX includegraphics doesn't choke in foo.bar.pdf filenames</span>
    <span class="s1">output_base = output_base.replace(</span><span class="s4">'.'</span><span class="s2">, </span><span class="s4">'-'</span><span class="s1">)</span>

    <span class="s3"># is it in doctest format?</span>
    <span class="s1">is_doctest = contains_doctest(code)</span>
    <span class="s2">if </span><span class="s4">'format' </span><span class="s2">in </span><span class="s1">options:</span>
        <span class="s2">if </span><span class="s1">options[</span><span class="s4">'format'</span><span class="s1">] == </span><span class="s4">'python'</span><span class="s1">:</span>
            <span class="s1">is_doctest = </span><span class="s2">False</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">is_doctest = </span><span class="s2">True</span>

    <span class="s3"># determine output directory name fragment</span>
    <span class="s1">source_rel_name = relpath(source_file_name</span><span class="s2">, </span><span class="s1">setup.confdir)</span>
    <span class="s1">source_rel_dir = os.path.dirname(source_rel_name).lstrip(os.path.sep)</span>

    <span class="s3"># build_dir: where to place output files (temporarily)</span>
    <span class="s1">build_dir = os.path.join(os.path.dirname(setup.app.doctreedir)</span><span class="s2">,</span>
                             <span class="s4">'plot_directive'</span><span class="s2">,</span>
                             <span class="s1">source_rel_dir)</span>
    <span class="s3"># get rid of .. in paths, also changes pathsep</span>
    <span class="s3"># see note in Python docs for warning about symbolic links on Windows.</span>
    <span class="s3"># need to compare source and dest paths at end</span>
    <span class="s1">build_dir = os.path.normpath(build_dir)</span>
    <span class="s1">os.makedirs(build_dir</span><span class="s2">, </span><span class="s1">exist_ok=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s3"># how to link to files from the RST file</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">build_dir_link = relpath(build_dir</span><span class="s2">, </span><span class="s1">rst_dir).replace(os.path.sep</span><span class="s2">, </span><span class="s4">'/'</span><span class="s1">)</span>
    <span class="s2">except </span><span class="s1">ValueError:</span>
        <span class="s3"># on Windows, relpath raises ValueError when path and start are on</span>
        <span class="s3"># different mounts/drives</span>
        <span class="s1">build_dir_link = build_dir</span>

    <span class="s3"># get list of included rst files so that the output is updated when any</span>
    <span class="s3"># plots in the included files change. These attributes are modified by the</span>
    <span class="s3"># include directive (see the docutils.parsers.rst.directives.misc module).</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">source_file_includes = [os.path.join(os.getcwd()</span><span class="s2">, </span><span class="s1">t[</span><span class="s5">0</span><span class="s1">])</span>
                                <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">state.document.include_log]</span>
    <span class="s2">except </span><span class="s1">AttributeError:</span>
        <span class="s3"># the document.include_log attribute only exists in docutils &gt;=0.17,</span>
        <span class="s3"># before that we need to inspect the state machine</span>
        <span class="s1">possible_sources = {os.path.join(setup.confdir</span><span class="s2">, </span><span class="s1">t[</span><span class="s5">0</span><span class="s1">])</span>
                            <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">state_machine.input_lines.items}</span>
        <span class="s1">source_file_includes = [f </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">possible_sources</span>
                                <span class="s2">if </span><span class="s1">os.path.isfile(f)]</span>
    <span class="s3"># remove the source file itself from the includes</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">source_file_includes.remove(source_file_name)</span>
    <span class="s2">except </span><span class="s1">ValueError:</span>
        <span class="s2">pass</span>

    <span class="s3"># save script (if necessary)</span>
    <span class="s2">if </span><span class="s1">options[</span><span class="s4">'show-source-link'</span><span class="s1">]:</span>
        <span class="s1">Path(build_dir</span><span class="s2">, </span><span class="s1">output_base + source_ext).write_text(</span>
            <span class="s1">doctest.script_from_examples(code)</span>
            <span class="s2">if </span><span class="s1">source_file_name == rst_file </span><span class="s2">and </span><span class="s1">is_doctest</span>
            <span class="s2">else </span><span class="s1">code</span><span class="s2">,</span>
            <span class="s1">encoding=</span><span class="s4">'utf-8'</span><span class="s1">)</span>

    <span class="s3"># make figures</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">results = render_figures(code=code</span><span class="s2">,</span>
                                 <span class="s1">code_path=source_file_name</span><span class="s2">,</span>
                                 <span class="s1">output_dir=build_dir</span><span class="s2">,</span>
                                 <span class="s1">output_base=output_base</span><span class="s2">,</span>
                                 <span class="s1">context=keep_context</span><span class="s2">,</span>
                                 <span class="s1">function_name=function_name</span><span class="s2">,</span>
                                 <span class="s1">config=config</span><span class="s2">,</span>
                                 <span class="s1">context_reset=context_opt == </span><span class="s4">'reset'</span><span class="s2">,</span>
                                 <span class="s1">close_figs=context_opt == </span><span class="s4">'close-figs'</span><span class="s2">,</span>
                                 <span class="s1">code_includes=source_file_includes)</span>
        <span class="s1">errors = []</span>
    <span class="s2">except </span><span class="s1">PlotError </span><span class="s2">as </span><span class="s1">err:</span>
        <span class="s1">reporter = state.memo.reporter</span>
        <span class="s1">sm = reporter.system_message(</span>
            <span class="s5">2</span><span class="s2">, </span><span class="s4">&quot;Exception occurred in plotting {}</span><span class="s2">\n </span><span class="s4">from {}:</span><span class="s2">\n</span><span class="s4">{}&quot;</span><span class="s1">.format(</span>
                <span class="s1">output_base</span><span class="s2">, </span><span class="s1">source_file_name</span><span class="s2">, </span><span class="s1">err)</span><span class="s2">,</span>
            <span class="s1">line=lineno)</span>
        <span class="s1">results = [(code</span><span class="s2">, </span><span class="s1">[])]</span>
        <span class="s1">errors = [sm]</span>

    <span class="s3"># Properly indent the caption</span>
    <span class="s1">caption = </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">' </span><span class="s1">+ </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">.join(</span><span class="s4">'      ' </span><span class="s1">+ line.strip()</span>
                               <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">caption.split(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">))</span>

    <span class="s3"># generate output restructuredtext</span>
    <span class="s1">total_lines = []</span>
    <span class="s2">for </span><span class="s1">j</span><span class="s2">, </span><span class="s1">(code_piece</span><span class="s2">, </span><span class="s1">images) </span><span class="s2">in </span><span class="s1">enumerate(results):</span>
        <span class="s2">if </span><span class="s1">options[</span><span class="s4">'include-source'</span><span class="s1">]:</span>
            <span class="s2">if </span><span class="s1">is_doctest:</span>
                <span class="s1">lines = [</span><span class="s4">''</span><span class="s2">, </span><span class="s1">*code_piece.splitlines()]</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">lines = [</span><span class="s4">'.. code-block:: python'</span><span class="s2">, </span><span class="s4">''</span><span class="s2">,</span>
                         <span class="s1">*textwrap.indent(code_piece</span><span class="s2">, </span><span class="s4">'    '</span><span class="s1">).splitlines()]</span>
            <span class="s1">source_code = </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s1">.join(lines)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">source_code = </span><span class="s4">&quot;&quot;</span>

        <span class="s2">if </span><span class="s1">nofigs:</span>
            <span class="s1">images = []</span>

        <span class="s1">opts = [</span>
            <span class="s4">':%s: %s' </span><span class="s1">% (key</span><span class="s2">, </span><span class="s1">val) </span><span class="s2">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">val </span><span class="s2">in </span><span class="s1">options.items()</span>
            <span class="s2">if </span><span class="s1">key </span><span class="s2">in </span><span class="s1">(</span><span class="s4">'alt'</span><span class="s2">, </span><span class="s4">'height'</span><span class="s2">, </span><span class="s4">'width'</span><span class="s2">, </span><span class="s4">'scale'</span><span class="s2">, </span><span class="s4">'align'</span><span class="s2">, </span><span class="s4">'class'</span><span class="s1">)]</span>

        <span class="s3"># Not-None src_name signals the need for a source download in the</span>
        <span class="s3"># generated html</span>
        <span class="s2">if </span><span class="s1">j == </span><span class="s5">0 </span><span class="s2">and </span><span class="s1">options[</span><span class="s4">'show-source-link'</span><span class="s1">]:</span>
            <span class="s1">src_name = output_base + source_ext</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">src_name = </span><span class="s2">None</span>

        <span class="s1">result = jinja2.Template(config.plot_template </span><span class="s2">or </span><span class="s1">TEMPLATE).render(</span>
            <span class="s1">default_fmt=default_fmt</span><span class="s2">,</span>
            <span class="s1">build_dir=build_dir_link</span><span class="s2">,</span>
            <span class="s1">src_name=src_name</span><span class="s2">,</span>
            <span class="s1">multi_image=len(images) &gt; </span><span class="s5">1</span><span class="s2">,</span>
            <span class="s1">options=opts</span><span class="s2">,</span>
            <span class="s1">images=images</span><span class="s2">,</span>
            <span class="s1">source_code=source_code</span><span class="s2">,</span>
            <span class="s1">html_show_formats=config.plot_html_show_formats </span><span class="s2">and </span><span class="s1">len(images)</span><span class="s2">,</span>
            <span class="s1">caption=caption)</span>

        <span class="s1">total_lines.extend(result.split(</span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s1">))</span>
        <span class="s1">total_lines.extend(</span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s1">)</span>

    <span class="s2">if </span><span class="s1">total_lines:</span>
        <span class="s1">state_machine.insert_input(total_lines</span><span class="s2">, </span><span class="s1">source=source_file_name)</span>

    <span class="s2">return </span><span class="s1">errors</span>
</pre>
</body>
</html>