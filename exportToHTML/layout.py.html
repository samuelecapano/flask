<html>
<head>
<title>layout.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
layout.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright 2013 Google, Inc. All Rights Reserved.</span>
<span class="s0">#</span>
<span class="s0"># Google Author(s): Behdad Esfahbod, Roozbeh Pournader</span>

<span class="s2">from </span><span class="s1">fontTools </span><span class="s2">import </span><span class="s1">ttLib</span>
<span class="s2">from </span><span class="s1">fontTools.ttLib.tables.DefaultTable </span><span class="s2">import </span><span class="s1">DefaultTable</span>
<span class="s2">from </span><span class="s1">fontTools.ttLib.tables </span><span class="s2">import </span><span class="s1">otTables</span>
<span class="s2">from </span><span class="s1">fontTools.merge.base </span><span class="s2">import </span><span class="s1">add_method</span><span class="s2">, </span><span class="s1">mergeObjects</span>
<span class="s2">from </span><span class="s1">fontTools.merge.util </span><span class="s2">import </span><span class="s1">*</span>
<span class="s2">import </span><span class="s1">logging</span>


<span class="s1">log = logging.getLogger(</span><span class="s3">&quot;fontTools.merge&quot;</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">mergeLookupLists(lst):</span>
	<span class="s0"># TODO Do smarter merge.</span>
	<span class="s2">return </span><span class="s1">sumLists(lst)</span>

<span class="s2">def </span><span class="s1">mergeFeatures(lst):</span>
	<span class="s2">assert </span><span class="s1">lst</span>
	<span class="s1">self = otTables.Feature()</span>
	<span class="s1">self.FeatureParams = </span><span class="s2">None</span>
	<span class="s1">self.LookupListIndex = mergeLookupLists([l.LookupListIndex </span><span class="s2">for </span><span class="s1">l </span><span class="s2">in </span><span class="s1">lst </span><span class="s2">if </span><span class="s1">l.LookupListIndex])</span>
	<span class="s1">self.LookupCount = len(self.LookupListIndex)</span>
	<span class="s2">return </span><span class="s1">self</span>

<span class="s2">def </span><span class="s1">mergeFeatureLists(lst):</span>
	<span class="s1">d = {}</span>
	<span class="s2">for </span><span class="s1">l </span><span class="s2">in </span><span class="s1">lst:</span>
		<span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">l:</span>
			<span class="s1">tag = f.FeatureTag</span>
			<span class="s2">if </span><span class="s1">tag </span><span class="s2">not in </span><span class="s1">d:</span>
				<span class="s1">d[tag] = []</span>
			<span class="s1">d[tag].append(f.Feature)</span>
	<span class="s1">ret = []</span>
	<span class="s2">for </span><span class="s1">tag </span><span class="s2">in </span><span class="s1">sorted(d.keys()):</span>
		<span class="s1">rec = otTables.FeatureRecord()</span>
		<span class="s1">rec.FeatureTag = tag</span>
		<span class="s1">rec.Feature = mergeFeatures(d[tag])</span>
		<span class="s1">ret.append(rec)</span>
	<span class="s2">return </span><span class="s1">ret</span>

<span class="s2">def </span><span class="s1">mergeLangSyses(lst):</span>
	<span class="s2">assert </span><span class="s1">lst</span>

	<span class="s0"># TODO Support merging ReqFeatureIndex</span>
	<span class="s2">assert </span><span class="s1">all(l.ReqFeatureIndex == </span><span class="s4">0xFFFF </span><span class="s2">for </span><span class="s1">l </span><span class="s2">in </span><span class="s1">lst)</span>

	<span class="s1">self = otTables.LangSys()</span>
	<span class="s1">self.LookupOrder = </span><span class="s2">None</span>
	<span class="s1">self.ReqFeatureIndex = </span><span class="s4">0xFFFF</span>
	<span class="s1">self.FeatureIndex = mergeFeatureLists([l.FeatureIndex </span><span class="s2">for </span><span class="s1">l </span><span class="s2">in </span><span class="s1">lst </span><span class="s2">if </span><span class="s1">l.FeatureIndex])</span>
	<span class="s1">self.FeatureCount = len(self.FeatureIndex)</span>
	<span class="s2">return </span><span class="s1">self</span>

<span class="s2">def </span><span class="s1">mergeScripts(lst):</span>
	<span class="s2">assert </span><span class="s1">lst</span>

	<span class="s2">if </span><span class="s1">len(lst) == </span><span class="s4">1</span><span class="s1">:</span>
		<span class="s2">return </span><span class="s1">lst[</span><span class="s4">0</span><span class="s1">]</span>
	<span class="s1">langSyses = {}</span>
	<span class="s2">for </span><span class="s1">sr </span><span class="s2">in </span><span class="s1">lst:</span>
		<span class="s2">for </span><span class="s1">lsr </span><span class="s2">in </span><span class="s1">sr.LangSysRecord:</span>
			<span class="s2">if </span><span class="s1">lsr.LangSysTag </span><span class="s2">not in </span><span class="s1">langSyses:</span>
				<span class="s1">langSyses[lsr.LangSysTag] = []</span>
			<span class="s1">langSyses[lsr.LangSysTag].append(lsr.LangSys)</span>
	<span class="s1">lsrecords = []</span>
	<span class="s2">for </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">langSys_list </span><span class="s2">in </span><span class="s1">sorted(langSyses.items()):</span>
		<span class="s1">lsr = otTables.LangSysRecord()</span>
		<span class="s1">lsr.LangSys = mergeLangSyses(langSys_list)</span>
		<span class="s1">lsr.LangSysTag = tag</span>
		<span class="s1">lsrecords.append(lsr)</span>

	<span class="s1">self = otTables.Script()</span>
	<span class="s1">self.LangSysRecord = lsrecords</span>
	<span class="s1">self.LangSysCount = len(lsrecords)</span>
	<span class="s1">dfltLangSyses = [s.DefaultLangSys </span><span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">lst </span><span class="s2">if </span><span class="s1">s.DefaultLangSys]</span>
	<span class="s2">if </span><span class="s1">dfltLangSyses:</span>
		<span class="s1">self.DefaultLangSys = mergeLangSyses(dfltLangSyses)</span>
	<span class="s2">else</span><span class="s1">:</span>
		<span class="s1">self.DefaultLangSys = </span><span class="s2">None</span>
	<span class="s2">return </span><span class="s1">self</span>

<span class="s2">def </span><span class="s1">mergeScriptRecords(lst):</span>
	<span class="s1">d = {}</span>
	<span class="s2">for </span><span class="s1">l </span><span class="s2">in </span><span class="s1">lst:</span>
		<span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">l:</span>
			<span class="s1">tag = s.ScriptTag</span>
			<span class="s2">if </span><span class="s1">tag </span><span class="s2">not in </span><span class="s1">d:</span>
				<span class="s1">d[tag] = []</span>
			<span class="s1">d[tag].append(s.Script)</span>
	<span class="s1">ret = []</span>
	<span class="s2">for </span><span class="s1">tag </span><span class="s2">in </span><span class="s1">sorted(d.keys()):</span>
		<span class="s1">rec = otTables.ScriptRecord()</span>
		<span class="s1">rec.ScriptTag = tag</span>
		<span class="s1">rec.Script = mergeScripts(d[tag])</span>
		<span class="s1">ret.append(rec)</span>
	<span class="s2">return </span><span class="s1">ret</span>

<span class="s1">otTables.ScriptList.mergeMap = {</span>
	<span class="s3">'ScriptCount'</span><span class="s1">: </span><span class="s2">lambda </span><span class="s1">lst: </span><span class="s2">None, </span><span class="s0"># TODO</span>
	<span class="s3">'ScriptRecord'</span><span class="s1">: mergeScriptRecords</span><span class="s2">,</span>
<span class="s1">}</span>
<span class="s1">otTables.BaseScriptList.mergeMap = {</span>
	<span class="s3">'BaseScriptCount'</span><span class="s1">: </span><span class="s2">lambda </span><span class="s1">lst: </span><span class="s2">None, </span><span class="s0"># TODO</span>
	<span class="s0"># TODO: Merge duplicate entries</span>
	<span class="s3">'BaseScriptRecord'</span><span class="s1">: </span><span class="s2">lambda </span><span class="s1">lst: sorted(sumLists(lst)</span><span class="s2">, </span><span class="s1">key=</span><span class="s2">lambda </span><span class="s1">s: s.BaseScriptTag)</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s1">otTables.FeatureList.mergeMap = {</span>
	<span class="s3">'FeatureCount'</span><span class="s1">: sum</span><span class="s2">,</span>
	<span class="s3">'FeatureRecord'</span><span class="s1">: </span><span class="s2">lambda </span><span class="s1">lst: sorted(sumLists(lst)</span><span class="s2">, </span><span class="s1">key=</span><span class="s2">lambda </span><span class="s1">s: s.FeatureTag)</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s1">otTables.LookupList.mergeMap = {</span>
	<span class="s3">'LookupCount'</span><span class="s1">: sum</span><span class="s2">,</span>
	<span class="s3">'Lookup'</span><span class="s1">: sumLists</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s1">otTables.Coverage.mergeMap = {</span>
	<span class="s3">'Format'</span><span class="s1">: min</span><span class="s2">,</span>
	<span class="s3">'glyphs'</span><span class="s1">: sumLists</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s1">otTables.ClassDef.mergeMap = {</span>
	<span class="s3">'Format'</span><span class="s1">: min</span><span class="s2">,</span>
	<span class="s3">'classDefs'</span><span class="s1">: sumDicts</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s1">otTables.LigCaretList.mergeMap = {</span>
	<span class="s3">'Coverage'</span><span class="s1">: mergeObjects</span><span class="s2">,</span>
	<span class="s3">'LigGlyphCount'</span><span class="s1">: sum</span><span class="s2">,</span>
	<span class="s3">'LigGlyph'</span><span class="s1">: sumLists</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s1">otTables.AttachList.mergeMap = {</span>
	<span class="s3">'Coverage'</span><span class="s1">: mergeObjects</span><span class="s2">,</span>
	<span class="s3">'GlyphCount'</span><span class="s1">: sum</span><span class="s2">,</span>
	<span class="s3">'AttachPoint'</span><span class="s1">: sumLists</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s0"># XXX Renumber MarkFilterSets of lookups</span>
<span class="s1">otTables.MarkGlyphSetsDef.mergeMap = {</span>
	<span class="s3">'MarkSetTableFormat'</span><span class="s1">: equal</span><span class="s2">,</span>
	<span class="s3">'MarkSetCount'</span><span class="s1">: sum</span><span class="s2">,</span>
	<span class="s3">'Coverage'</span><span class="s1">: sumLists</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s1">otTables.Axis.mergeMap = {</span>
	<span class="s3">'*'</span><span class="s1">: mergeObjects</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s0"># XXX Fix BASE table merging</span>
<span class="s1">otTables.BaseTagList.mergeMap = {</span>
	<span class="s3">'BaseTagCount'</span><span class="s1">: sum</span><span class="s2">,</span>
	<span class="s3">'BaselineTag'</span><span class="s1">: sumLists</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s1">otTables.GDEF.mergeMap = \</span>
<span class="s1">otTables.GSUB.mergeMap = \</span>
<span class="s1">otTables.GPOS.mergeMap = \</span>
<span class="s1">otTables.BASE.mergeMap = \</span>
<span class="s1">otTables.JSTF.mergeMap = \</span>
<span class="s1">otTables.MATH.mergeMap = \</span>
<span class="s1">{</span>
	<span class="s3">'*'</span><span class="s1">: mergeObjects</span><span class="s2">,</span>
	<span class="s3">'Version'</span><span class="s1">: max</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s1">ttLib.getTableClass(</span><span class="s3">'GDEF'</span><span class="s1">).mergeMap = \</span>
<span class="s1">ttLib.getTableClass(</span><span class="s3">'GSUB'</span><span class="s1">).mergeMap = \</span>
<span class="s1">ttLib.getTableClass(</span><span class="s3">'GPOS'</span><span class="s1">).mergeMap = \</span>
<span class="s1">ttLib.getTableClass(</span><span class="s3">'BASE'</span><span class="s1">).mergeMap = \</span>
<span class="s1">ttLib.getTableClass(</span><span class="s3">'JSTF'</span><span class="s1">).mergeMap = \</span>
<span class="s1">ttLib.getTableClass(</span><span class="s3">'MATH'</span><span class="s1">).mergeMap = \</span>
<span class="s1">{</span>
	<span class="s3">'tableTag'</span><span class="s1">: onlyExisting(equal)</span><span class="s2">, </span><span class="s0"># XXX clean me up</span>
	<span class="s3">'table'</span><span class="s1">: mergeObjects</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s1">@add_method(ttLib.getTableClass(</span><span class="s3">'GSUB'</span><span class="s1">))</span>
<span class="s2">def </span><span class="s1">merge(self</span><span class="s2">, </span><span class="s1">m</span><span class="s2">, </span><span class="s1">tables):</span>

	<span class="s2">assert </span><span class="s1">len(tables) == len(m.duplicateGlyphsPerFont)</span>
	<span class="s2">for </span><span class="s1">i</span><span class="s2">,</span><span class="s1">(table</span><span class="s2">,</span><span class="s1">dups) </span><span class="s2">in </span><span class="s1">enumerate(zip(tables</span><span class="s2">, </span><span class="s1">m.duplicateGlyphsPerFont)):</span>
		<span class="s2">if not </span><span class="s1">dups: </span><span class="s2">continue</span>
		<span class="s2">if </span><span class="s1">table </span><span class="s2">is None or </span><span class="s1">table </span><span class="s2">is </span><span class="s1">NotImplemented:</span>
			<span class="s1">log.warning(</span><span class="s3">&quot;Have non-identical duplicates to resolve for '%s' but no GSUB. Are duplicates intended?: %s&quot;</span><span class="s2">, </span><span class="s1">m.fonts[i]._merger__name</span><span class="s2">, </span><span class="s1">dups)</span>
			<span class="s2">continue</span>

		<span class="s1">synthFeature = </span><span class="s2">None</span>
		<span class="s1">synthLookup = </span><span class="s2">None</span>
		<span class="s2">for </span><span class="s1">script </span><span class="s2">in </span><span class="s1">table.table.ScriptList.ScriptRecord:</span>
			<span class="s2">if </span><span class="s1">script.ScriptTag == </span><span class="s3">'DFLT'</span><span class="s1">: </span><span class="s2">continue </span><span class="s0"># XXX</span>
			<span class="s2">for </span><span class="s1">langsys </span><span class="s2">in </span><span class="s1">[script.Script.DefaultLangSys] + [l.LangSys </span><span class="s2">for </span><span class="s1">l </span><span class="s2">in </span><span class="s1">script.Script.LangSysRecord]:</span>
				<span class="s2">if </span><span class="s1">langsys </span><span class="s2">is None</span><span class="s1">: </span><span class="s2">continue </span><span class="s0"># XXX Create!</span>
				<span class="s1">feature = [v </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">langsys.FeatureIndex </span><span class="s2">if </span><span class="s1">v.FeatureTag == </span><span class="s3">'locl'</span><span class="s1">]</span>
				<span class="s2">assert </span><span class="s1">len(feature) &lt;= </span><span class="s4">1</span>
				<span class="s2">if </span><span class="s1">feature:</span>
					<span class="s1">feature = feature[</span><span class="s4">0</span><span class="s1">]</span>
				<span class="s2">else</span><span class="s1">:</span>
					<span class="s2">if not </span><span class="s1">synthFeature:</span>
						<span class="s1">synthFeature = otTables.FeatureRecord()</span>
						<span class="s1">synthFeature.FeatureTag = </span><span class="s3">'locl'</span>
						<span class="s1">f = synthFeature.Feature = otTables.Feature()</span>
						<span class="s1">f.FeatureParams = </span><span class="s2">None</span>
						<span class="s1">f.LookupCount = </span><span class="s4">0</span>
						<span class="s1">f.LookupListIndex = []</span>
						<span class="s1">table.table.FeatureList.FeatureRecord.append(synthFeature)</span>
						<span class="s1">table.table.FeatureList.FeatureCount += </span><span class="s4">1</span>
					<span class="s1">feature = synthFeature</span>
					<span class="s1">langsys.FeatureIndex.append(feature)</span>
					<span class="s1">langsys.FeatureIndex.sort(key=</span><span class="s2">lambda </span><span class="s1">v: v.FeatureTag)</span>

				<span class="s2">if not </span><span class="s1">synthLookup:</span>
					<span class="s1">subtable = otTables.SingleSubst()</span>
					<span class="s1">subtable.mapping = dups</span>
					<span class="s1">synthLookup = otTables.Lookup()</span>
					<span class="s1">synthLookup.LookupFlag = </span><span class="s4">0</span>
					<span class="s1">synthLookup.LookupType = </span><span class="s4">1</span>
					<span class="s1">synthLookup.SubTableCount = </span><span class="s4">1</span>
					<span class="s1">synthLookup.SubTable = [subtable]</span>
					<span class="s2">if </span><span class="s1">table.table.LookupList </span><span class="s2">is None</span><span class="s1">:</span>
						<span class="s0"># mtiLib uses None as default value for LookupList,</span>
						<span class="s0"># while feaLib points to an empty array with count 0</span>
						<span class="s0"># TODO: make them do the same</span>
						<span class="s1">table.table.LookupList = otTables.LookupList()</span>
						<span class="s1">table.table.LookupList.Lookup = []</span>
						<span class="s1">table.table.LookupList.LookupCount = </span><span class="s4">0</span>
					<span class="s1">table.table.LookupList.Lookup.append(synthLookup)</span>
					<span class="s1">table.table.LookupList.LookupCount += </span><span class="s4">1</span>

				<span class="s2">if </span><span class="s1">feature.Feature.LookupListIndex[:</span><span class="s4">1</span><span class="s1">] != [synthLookup]:</span>
					<span class="s1">feature.Feature.LookupListIndex[:</span><span class="s4">0</span><span class="s1">] = [synthLookup]</span>
					<span class="s1">feature.Feature.LookupCount += </span><span class="s4">1</span>

	<span class="s1">DefaultTable.merge(self</span><span class="s2">, </span><span class="s1">m</span><span class="s2">, </span><span class="s1">tables)</span>
	<span class="s2">return </span><span class="s1">self</span>

<span class="s1">@add_method(otTables.SingleSubst</span><span class="s2">,</span>
		<span class="s1">otTables.MultipleSubst</span><span class="s2">,</span>
		<span class="s1">otTables.AlternateSubst</span><span class="s2">,</span>
		<span class="s1">otTables.LigatureSubst</span><span class="s2">,</span>
		<span class="s1">otTables.ReverseChainSingleSubst</span><span class="s2">,</span>
		<span class="s1">otTables.SinglePos</span><span class="s2">,</span>
		<span class="s1">otTables.PairPos</span><span class="s2">,</span>
		<span class="s1">otTables.CursivePos</span><span class="s2">,</span>
		<span class="s1">otTables.MarkBasePos</span><span class="s2">,</span>
		<span class="s1">otTables.MarkLigPos</span><span class="s2">,</span>
		<span class="s1">otTables.MarkMarkPos)</span>
<span class="s2">def </span><span class="s1">mapLookups(self</span><span class="s2">, </span><span class="s1">lookupMap):</span>
	<span class="s2">pass</span>

<span class="s0"># Copied and trimmed down from subset.py</span>
<span class="s1">@add_method(otTables.ContextSubst</span><span class="s2">,</span>
		<span class="s1">otTables.ChainContextSubst</span><span class="s2">,</span>
		<span class="s1">otTables.ContextPos</span><span class="s2">,</span>
		<span class="s1">otTables.ChainContextPos)</span>
<span class="s2">def </span><span class="s1">__merge_classify_context(self):</span>

	<span class="s2">class </span><span class="s1">ContextHelper(object):</span>
		<span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">klass</span><span class="s2">, </span><span class="s1">Format):</span>
			<span class="s2">if </span><span class="s1">klass.__name__.endswith(</span><span class="s3">'Subst'</span><span class="s1">):</span>
				<span class="s1">Typ = </span><span class="s3">'Sub'</span>
				<span class="s1">Type = </span><span class="s3">'Subst'</span>
			<span class="s2">else</span><span class="s1">:</span>
				<span class="s1">Typ = </span><span class="s3">'Pos'</span>
				<span class="s1">Type = </span><span class="s3">'Pos'</span>
			<span class="s2">if </span><span class="s1">klass.__name__.startswith(</span><span class="s3">'Chain'</span><span class="s1">):</span>
				<span class="s1">Chain = </span><span class="s3">'Chain'</span>
			<span class="s2">else</span><span class="s1">:</span>
				<span class="s1">Chain = </span><span class="s3">''</span>
			<span class="s1">ChainTyp = Chain+Typ</span>

			<span class="s1">self.Typ = Typ</span>
			<span class="s1">self.Type = Type</span>
			<span class="s1">self.Chain = Chain</span>
			<span class="s1">self.ChainTyp = ChainTyp</span>

			<span class="s1">self.LookupRecord = Type+</span><span class="s3">'LookupRecord'</span>

			<span class="s2">if </span><span class="s1">Format == </span><span class="s4">1</span><span class="s1">:</span>
				<span class="s1">self.Rule = ChainTyp+</span><span class="s3">'Rule'</span>
				<span class="s1">self.RuleSet = ChainTyp+</span><span class="s3">'RuleSet'</span>
			<span class="s2">elif </span><span class="s1">Format == </span><span class="s4">2</span><span class="s1">:</span>
				<span class="s1">self.Rule = ChainTyp+</span><span class="s3">'ClassRule'</span>
				<span class="s1">self.RuleSet = ChainTyp+</span><span class="s3">'ClassSet'</span>

	<span class="s2">if </span><span class="s1">self.Format </span><span class="s2">not in </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">]:</span>
		<span class="s2">return None  </span><span class="s0"># Don't shoot the messenger; let it go</span>
	<span class="s2">if not </span><span class="s1">hasattr(self.__class__</span><span class="s2">, </span><span class="s3">&quot;_merge__ContextHelpers&quot;</span><span class="s1">):</span>
		<span class="s1">self.__class__._merge__ContextHelpers = {}</span>
	<span class="s2">if </span><span class="s1">self.Format </span><span class="s2">not in </span><span class="s1">self.__class__._merge__ContextHelpers:</span>
		<span class="s1">helper = ContextHelper(self.__class__</span><span class="s2">, </span><span class="s1">self.Format)</span>
		<span class="s1">self.__class__._merge__ContextHelpers[self.Format] = helper</span>
	<span class="s2">return </span><span class="s1">self.__class__._merge__ContextHelpers[self.Format]</span>


<span class="s1">@add_method(otTables.ContextSubst</span><span class="s2">,</span>
		<span class="s1">otTables.ChainContextSubst</span><span class="s2">,</span>
		<span class="s1">otTables.ContextPos</span><span class="s2">,</span>
		<span class="s1">otTables.ChainContextPos)</span>
<span class="s2">def </span><span class="s1">mapLookups(self</span><span class="s2">, </span><span class="s1">lookupMap):</span>
	<span class="s1">c = self.__merge_classify_context()</span>

	<span class="s2">if </span><span class="s1">self.Format </span><span class="s2">in </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">]:</span>
		<span class="s2">for </span><span class="s1">rs </span><span class="s2">in </span><span class="s1">getattr(self</span><span class="s2">, </span><span class="s1">c.RuleSet):</span>
			<span class="s2">if not </span><span class="s1">rs: </span><span class="s2">continue</span>
			<span class="s2">for </span><span class="s1">r </span><span class="s2">in </span><span class="s1">getattr(rs</span><span class="s2">, </span><span class="s1">c.Rule):</span>
				<span class="s2">if not </span><span class="s1">r: </span><span class="s2">continue</span>
				<span class="s2">for </span><span class="s1">ll </span><span class="s2">in </span><span class="s1">getattr(r</span><span class="s2">, </span><span class="s1">c.LookupRecord):</span>
					<span class="s2">if not </span><span class="s1">ll: </span><span class="s2">continue</span>
					<span class="s1">ll.LookupListIndex = lookupMap[ll.LookupListIndex]</span>
	<span class="s2">elif </span><span class="s1">self.Format == </span><span class="s4">3</span><span class="s1">:</span>
		<span class="s2">for </span><span class="s1">ll </span><span class="s2">in </span><span class="s1">getattr(self</span><span class="s2">, </span><span class="s1">c.LookupRecord):</span>
			<span class="s2">if not </span><span class="s1">ll: </span><span class="s2">continue</span>
			<span class="s1">ll.LookupListIndex = lookupMap[ll.LookupListIndex]</span>
	<span class="s2">else</span><span class="s1">:</span>
		<span class="s2">assert </span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;unknown format: %s&quot; </span><span class="s1">% self.Format</span>

<span class="s1">@add_method(otTables.ExtensionSubst</span><span class="s2">,</span>
		<span class="s1">otTables.ExtensionPos)</span>
<span class="s2">def </span><span class="s1">mapLookups(self</span><span class="s2">, </span><span class="s1">lookupMap):</span>
	<span class="s2">if </span><span class="s1">self.Format == </span><span class="s4">1</span><span class="s1">:</span>
		<span class="s1">self.ExtSubTable.mapLookups(lookupMap)</span>
	<span class="s2">else</span><span class="s1">:</span>
		<span class="s2">assert </span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;unknown format: %s&quot; </span><span class="s1">% self.Format</span>

<span class="s1">@add_method(otTables.Lookup)</span>
<span class="s2">def </span><span class="s1">mapLookups(self</span><span class="s2">, </span><span class="s1">lookupMap):</span>
	<span class="s2">for </span><span class="s1">st </span><span class="s2">in </span><span class="s1">self.SubTable:</span>
		<span class="s2">if not </span><span class="s1">st: </span><span class="s2">continue</span>
		<span class="s1">st.mapLookups(lookupMap)</span>

<span class="s1">@add_method(otTables.LookupList)</span>
<span class="s2">def </span><span class="s1">mapLookups(self</span><span class="s2">, </span><span class="s1">lookupMap):</span>
	<span class="s2">for </span><span class="s1">l </span><span class="s2">in </span><span class="s1">self.Lookup:</span>
		<span class="s2">if not </span><span class="s1">l: </span><span class="s2">continue</span>
		<span class="s1">l.mapLookups(lookupMap)</span>

<span class="s1">@add_method(otTables.Lookup)</span>
<span class="s2">def </span><span class="s1">mapMarkFilteringSets(self</span><span class="s2">, </span><span class="s1">markFilteringSetMap):</span>
	<span class="s2">if </span><span class="s1">self.LookupFlag &amp; </span><span class="s4">0x0010</span><span class="s1">:</span>
		<span class="s1">self.MarkFilteringSet = markFilteringSetMap[self.MarkFilteringSet]</span>

<span class="s1">@add_method(otTables.LookupList)</span>
<span class="s2">def </span><span class="s1">mapMarkFilteringSets(self</span><span class="s2">, </span><span class="s1">markFilteringSetMap):</span>
	<span class="s2">for </span><span class="s1">l </span><span class="s2">in </span><span class="s1">self.Lookup:</span>
		<span class="s2">if not </span><span class="s1">l: </span><span class="s2">continue</span>
		<span class="s1">l.mapMarkFilteringSets(markFilteringSetMap)</span>

<span class="s1">@add_method(otTables.Feature)</span>
<span class="s2">def </span><span class="s1">mapLookups(self</span><span class="s2">, </span><span class="s1">lookupMap):</span>
	<span class="s1">self.LookupListIndex = [lookupMap[i] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">self.LookupListIndex]</span>

<span class="s1">@add_method(otTables.FeatureList)</span>
<span class="s2">def </span><span class="s1">mapLookups(self</span><span class="s2">, </span><span class="s1">lookupMap):</span>
	<span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">self.FeatureRecord:</span>
		<span class="s2">if not </span><span class="s1">f </span><span class="s2">or not </span><span class="s1">f.Feature: </span><span class="s2">continue</span>
		<span class="s1">f.Feature.mapLookups(lookupMap)</span>

<span class="s1">@add_method(otTables.DefaultLangSys</span><span class="s2">,</span>
		<span class="s1">otTables.LangSys)</span>
<span class="s2">def </span><span class="s1">mapFeatures(self</span><span class="s2">, </span><span class="s1">featureMap):</span>
	<span class="s1">self.FeatureIndex = [featureMap[i] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">self.FeatureIndex]</span>
	<span class="s2">if </span><span class="s1">self.ReqFeatureIndex != </span><span class="s4">65535</span><span class="s1">:</span>
		<span class="s1">self.ReqFeatureIndex = featureMap[self.ReqFeatureIndex]</span>

<span class="s1">@add_method(otTables.Script)</span>
<span class="s2">def </span><span class="s1">mapFeatures(self</span><span class="s2">, </span><span class="s1">featureMap):</span>
	<span class="s2">if </span><span class="s1">self.DefaultLangSys:</span>
		<span class="s1">self.DefaultLangSys.mapFeatures(featureMap)</span>
	<span class="s2">for </span><span class="s1">l </span><span class="s2">in </span><span class="s1">self.LangSysRecord:</span>
		<span class="s2">if not </span><span class="s1">l </span><span class="s2">or not </span><span class="s1">l.LangSys: </span><span class="s2">continue</span>
		<span class="s1">l.LangSys.mapFeatures(featureMap)</span>

<span class="s1">@add_method(otTables.ScriptList)</span>
<span class="s2">def </span><span class="s1">mapFeatures(self</span><span class="s2">, </span><span class="s1">featureMap):</span>
	<span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">self.ScriptRecord:</span>
		<span class="s2">if not </span><span class="s1">s </span><span class="s2">or not </span><span class="s1">s.Script: </span><span class="s2">continue</span>
		<span class="s1">s.Script.mapFeatures(featureMap)</span>

<span class="s2">def </span><span class="s1">layoutPreMerge(font):</span>
		<span class="s0"># Map indices to references</span>

		<span class="s1">GDEF = font.get(</span><span class="s3">'GDEF'</span><span class="s1">)</span>
		<span class="s1">GSUB = font.get(</span><span class="s3">'GSUB'</span><span class="s1">)</span>
		<span class="s1">GPOS = font.get(</span><span class="s3">'GPOS'</span><span class="s1">)</span>

		<span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">[GSUB</span><span class="s2">, </span><span class="s1">GPOS]:</span>
			<span class="s2">if not </span><span class="s1">t: </span><span class="s2">continue</span>

			<span class="s2">if </span><span class="s1">t.table.LookupList:</span>
				<span class="s1">lookupMap = {i:v </span><span class="s2">for </span><span class="s1">i</span><span class="s2">,</span><span class="s1">v </span><span class="s2">in </span><span class="s1">enumerate(t.table.LookupList.Lookup)}</span>
				<span class="s1">t.table.LookupList.mapLookups(lookupMap)</span>
				<span class="s1">t.table.FeatureList.mapLookups(lookupMap)</span>

				<span class="s2">if </span><span class="s1">GDEF </span><span class="s2">and </span><span class="s1">GDEF.table.Version &gt;= </span><span class="s4">0x00010002</span><span class="s1">:</span>
					<span class="s1">markFilteringSetMap = {i:v </span><span class="s2">for </span><span class="s1">i</span><span class="s2">,</span><span class="s1">v </span><span class="s2">in </span><span class="s1">enumerate(GDEF.table.MarkGlyphSetsDef.Coverage)}</span>
					<span class="s1">t.table.LookupList.mapMarkFilteringSets(markFilteringSetMap)</span>

			<span class="s2">if </span><span class="s1">t.table.FeatureList </span><span class="s2">and </span><span class="s1">t.table.ScriptList:</span>
				<span class="s1">featureMap = {i:v </span><span class="s2">for </span><span class="s1">i</span><span class="s2">,</span><span class="s1">v </span><span class="s2">in </span><span class="s1">enumerate(t.table.FeatureList.FeatureRecord)}</span>
				<span class="s1">t.table.ScriptList.mapFeatures(featureMap)</span>

		<span class="s0"># TODO FeatureParams nameIDs</span>

<span class="s2">def </span><span class="s1">layoutPostMerge(font):</span>
		<span class="s0"># Map references back to indices</span>

		<span class="s1">GDEF = font.get(</span><span class="s3">'GDEF'</span><span class="s1">)</span>
		<span class="s1">GSUB = font.get(</span><span class="s3">'GSUB'</span><span class="s1">)</span>
		<span class="s1">GPOS = font.get(</span><span class="s3">'GPOS'</span><span class="s1">)</span>

		<span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">[GSUB</span><span class="s2">, </span><span class="s1">GPOS]:</span>
			<span class="s2">if not </span><span class="s1">t: </span><span class="s2">continue</span>

			<span class="s2">if </span><span class="s1">t.table.FeatureList </span><span class="s2">and </span><span class="s1">t.table.ScriptList:</span>

				<span class="s0"># Collect unregistered (new) features.</span>
				<span class="s1">featureMap = GregariousIdentityDict(t.table.FeatureList.FeatureRecord)</span>
				<span class="s1">t.table.ScriptList.mapFeatures(featureMap)</span>

				<span class="s0"># Record used features.</span>
				<span class="s1">featureMap = AttendanceRecordingIdentityDict(t.table.FeatureList.FeatureRecord)</span>
				<span class="s1">t.table.ScriptList.mapFeatures(featureMap)</span>
				<span class="s1">usedIndices = featureMap.s</span>

				<span class="s0"># Remove unused features</span>
				<span class="s1">t.table.FeatureList.FeatureRecord = [f </span><span class="s2">for </span><span class="s1">i</span><span class="s2">,</span><span class="s1">f </span><span class="s2">in </span><span class="s1">enumerate(t.table.FeatureList.FeatureRecord) </span><span class="s2">if </span><span class="s1">i </span><span class="s2">in </span><span class="s1">usedIndices]</span>

				<span class="s0"># Map back to indices.</span>
				<span class="s1">featureMap = NonhashableDict(t.table.FeatureList.FeatureRecord)</span>
				<span class="s1">t.table.ScriptList.mapFeatures(featureMap)</span>

				<span class="s1">t.table.FeatureList.FeatureCount = len(t.table.FeatureList.FeatureRecord)</span>

			<span class="s2">if </span><span class="s1">t.table.LookupList:</span>

				<span class="s0"># Collect unregistered (new) lookups.</span>
				<span class="s1">lookupMap = GregariousIdentityDict(t.table.LookupList.Lookup)</span>
				<span class="s1">t.table.FeatureList.mapLookups(lookupMap)</span>
				<span class="s1">t.table.LookupList.mapLookups(lookupMap)</span>

				<span class="s0"># Record used lookups.</span>
				<span class="s1">lookupMap = AttendanceRecordingIdentityDict(t.table.LookupList.Lookup)</span>
				<span class="s1">t.table.FeatureList.mapLookups(lookupMap)</span>
				<span class="s1">t.table.LookupList.mapLookups(lookupMap)</span>
				<span class="s1">usedIndices = lookupMap.s</span>

				<span class="s0"># Remove unused lookups</span>
				<span class="s1">t.table.LookupList.Lookup = [l </span><span class="s2">for </span><span class="s1">i</span><span class="s2">,</span><span class="s1">l </span><span class="s2">in </span><span class="s1">enumerate(t.table.LookupList.Lookup) </span><span class="s2">if </span><span class="s1">i </span><span class="s2">in </span><span class="s1">usedIndices]</span>

				<span class="s0"># Map back to indices.</span>
				<span class="s1">lookupMap = NonhashableDict(t.table.LookupList.Lookup)</span>
				<span class="s1">t.table.FeatureList.mapLookups(lookupMap)</span>
				<span class="s1">t.table.LookupList.mapLookups(lookupMap)</span>

				<span class="s1">t.table.LookupList.LookupCount = len(t.table.LookupList.Lookup)</span>

				<span class="s2">if </span><span class="s1">GDEF </span><span class="s2">and </span><span class="s1">GDEF.table.Version &gt;= </span><span class="s4">0x00010002</span><span class="s1">:</span>
					<span class="s1">markFilteringSetMap = NonhashableDict(GDEF.table.MarkGlyphSetsDef.Coverage)</span>
					<span class="s1">t.table.LookupList.mapMarkFilteringSets(markFilteringSetMap)</span>

		<span class="s0"># TODO FeatureParams nameIDs</span>
</pre>
</body>
</html>