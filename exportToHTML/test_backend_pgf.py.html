<html>
<head>
<title>test_backend_pgf.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_backend_pgf.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">BytesIO</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">shutil</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">packaging.version </span><span class="s0">import </span><span class="s1">parse </span><span class="s0">as </span><span class="s1">parse_version</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">import </span><span class="s1">matplotlib.pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">from </span><span class="s1">matplotlib.testing </span><span class="s0">import </span><span class="s1">_has_tex_package</span><span class="s0">, </span><span class="s1">_check_for_pgf</span>
<span class="s0">from </span><span class="s1">matplotlib.testing.compare </span><span class="s0">import </span><span class="s1">compare_images</span><span class="s0">, </span><span class="s1">ImageComparisonFailure</span>
<span class="s0">from </span><span class="s1">matplotlib.backends.backend_pgf </span><span class="s0">import </span><span class="s1">PdfPages</span><span class="s0">, </span><span class="s1">_tex_escape</span>
<span class="s0">from </span><span class="s1">matplotlib.testing.decorators </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">_image_directories</span><span class="s0">, </span><span class="s1">check_figures_equal</span><span class="s0">, </span><span class="s1">image_comparison)</span>
<span class="s0">from </span><span class="s1">matplotlib.testing._markers </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">needs_ghostscript</span><span class="s0">, </span><span class="s1">needs_pgf_lualatex</span><span class="s0">, </span><span class="s1">needs_pgf_pdflatex</span><span class="s0">,</span>
    <span class="s1">needs_pgf_xelatex)</span>


<span class="s1">baseline_dir</span><span class="s0">, </span><span class="s1">result_dir = _image_directories(</span><span class="s0">lambda</span><span class="s1">: </span><span class="s2">'dummy func'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">compare_figure(fname</span><span class="s0">, </span><span class="s1">savefig_kwargs={}</span><span class="s0">, </span><span class="s1">tol=</span><span class="s3">0</span><span class="s1">):</span>
    <span class="s1">actual = os.path.join(result_dir</span><span class="s0">, </span><span class="s1">fname)</span>
    <span class="s1">plt.savefig(actual</span><span class="s0">, </span><span class="s1">**savefig_kwargs)</span>

    <span class="s1">expected = os.path.join(result_dir</span><span class="s0">, </span><span class="s2">&quot;expected_%s&quot; </span><span class="s1">% fname)</span>
    <span class="s1">shutil.copyfile(os.path.join(baseline_dir</span><span class="s0">, </span><span class="s1">fname)</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">err = compare_images(expected</span><span class="s0">, </span><span class="s1">actual</span><span class="s0">, </span><span class="s1">tol=tol)</span>
    <span class="s0">if </span><span class="s1">err:</span>
        <span class="s0">raise </span><span class="s1">ImageComparisonFailure(err)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">'plain_text, escaped_text'</span><span class="s0">, </span><span class="s1">[</span>
    <span class="s1">(</span><span class="s2">r'quad_sum: $\sum x_i^2$'</span><span class="s0">, </span><span class="s2">r'quad_sum: \(\displaystyle \sum x_i^2\)'</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s2">'% not a comment'</span><span class="s0">, </span><span class="s2">r'\% not a comment'</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s2">'^not'</span><span class="s0">, </span><span class="s2">r'\^not'</span><span class="s1">)</span><span class="s0">,</span>
<span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_tex_escape(plain_text</span><span class="s0">, </span><span class="s1">escaped_text):</span>
    <span class="s0">assert </span><span class="s1">_tex_escape(plain_text) == escaped_text</span>


<span class="s1">@needs_pgf_xelatex</span>
<span class="s1">@pytest.mark.backend(</span><span class="s2">'pgf'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_tex_special_chars(tmp_path):</span>
    <span class="s1">fig = plt.figure()</span>
    <span class="s1">fig.text(</span><span class="s3">.5</span><span class="s0">, </span><span class="s3">.5</span><span class="s0">, </span><span class="s2">&quot;_^ $a_b^c$&quot;</span><span class="s1">)</span>
    <span class="s1">fig.savefig(tmp_path / </span><span class="s2">&quot;test.pdf&quot;</span><span class="s1">)  </span><span class="s4"># Should not error.</span>


<span class="s0">def </span><span class="s1">create_figure():</span>
    <span class="s1">plt.figure()</span>
    <span class="s1">x = np.linspace(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span>

    <span class="s4"># line plot</span>
    <span class="s1">plt.plot(x</span><span class="s0">, </span><span class="s1">x ** </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;b-&quot;</span><span class="s1">)</span>

    <span class="s4"># marker</span>
    <span class="s1">plt.plot(x</span><span class="s0">, </span><span class="s3">1 </span><span class="s1">- x**</span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;g&gt;&quot;</span><span class="s1">)</span>

    <span class="s4"># filled paths and patterns</span>
    <span class="s1">plt.fill_between([</span><span class="s3">0.</span><span class="s0">, </span><span class="s3">.4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">.4</span><span class="s0">, </span><span class="s3">0.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">hatch=</span><span class="s2">'//'</span><span class="s0">, </span><span class="s1">facecolor=</span><span class="s2">&quot;lightgray&quot;</span><span class="s0">,</span>
                     <span class="s1">edgecolor=</span><span class="s2">&quot;red&quot;</span><span class="s1">)</span>
    <span class="s1">plt.fill([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">.8</span><span class="s0">, </span><span class="s3">.8</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span>

    <span class="s4"># text and typesetting</span>
    <span class="s1">plt.plot([</span><span class="s3">0.9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;ro&quot;</span><span class="s0">, </span><span class="s1">markersize=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">plt.text(</span><span class="s3">0.9</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s2">'unicode (ü, °, µ) and math ($</span><span class="s0">\\</span><span class="s2">mu_i = x_i^2$)'</span><span class="s0">,</span>
             <span class="s1">ha=</span><span class="s2">'right'</span><span class="s0">, </span><span class="s1">fontsize=</span><span class="s3">20</span><span class="s1">)</span>
    <span class="s1">plt.ylabel(</span><span class="s2">'sans-serif, blue, $</span><span class="s0">\\</span><span class="s2">frac{</span><span class="s0">\\</span><span class="s2">sqrt{x}}{y^2}$..'</span><span class="s0">,</span>
               <span class="s1">family=</span><span class="s2">'sans-serif'</span><span class="s0">, </span><span class="s1">color=</span><span class="s2">'blue'</span><span class="s1">)</span>

    <span class="s1">plt.xlim(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">plt.ylim(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>


<span class="s4"># test compiling a figure to pdf with xelatex</span>
<span class="s1">@needs_pgf_xelatex</span>
<span class="s1">@pytest.mark.backend(</span><span class="s2">'pgf'</span><span class="s1">)</span>
<span class="s1">@image_comparison([</span><span class="s2">'pgf_xelatex.pdf'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">style=</span><span class="s2">'default'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_xelatex():</span>
    <span class="s1">rc_xelatex = {</span><span class="s2">'font.family'</span><span class="s1">: </span><span class="s2">'serif'</span><span class="s0">,</span>
                  <span class="s2">'pgf.rcfonts'</span><span class="s1">: </span><span class="s0">False</span><span class="s1">}</span>
    <span class="s1">mpl.rcParams.update(rc_xelatex)</span>
    <span class="s1">create_figure()</span>


<span class="s0">try</span><span class="s1">:</span>
    <span class="s1">_old_gs_version = \</span>
        <span class="s1">mpl._get_executable_info(</span><span class="s2">'gs'</span><span class="s1">).version &lt; parse_version(</span><span class="s2">'9.50'</span><span class="s1">)</span>
<span class="s0">except </span><span class="s1">mpl.ExecutableNotFoundError:</span>
    <span class="s1">_old_gs_version = </span><span class="s0">True</span>


<span class="s4"># test compiling a figure to pdf with pdflatex</span>
<span class="s1">@needs_pgf_pdflatex</span>
<span class="s1">@pytest.mark.skipif(</span><span class="s0">not </span><span class="s1">_has_tex_package(</span><span class="s2">'ucs'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">reason=</span><span class="s2">'needs ucs.sty'</span><span class="s1">)</span>
<span class="s1">@pytest.mark.backend(</span><span class="s2">'pgf'</span><span class="s1">)</span>
<span class="s1">@image_comparison([</span><span class="s2">'pgf_pdflatex.pdf'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">style=</span><span class="s2">'default'</span><span class="s0">,</span>
                  <span class="s1">tol=</span><span class="s3">11.7 </span><span class="s0">if </span><span class="s1">_old_gs_version </span><span class="s0">else </span><span class="s3">0</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_pdflatex():</span>
    <span class="s0">if </span><span class="s1">os.environ.get(</span><span class="s2">'APPVEYOR'</span><span class="s1">):</span>
        <span class="s1">pytest.xfail(</span><span class="s2">&quot;pdflatex test does not work on appveyor due to missing &quot;</span>
                     <span class="s2">&quot;LaTeX fonts&quot;</span><span class="s1">)</span>

    <span class="s1">rc_pdflatex = {</span><span class="s2">'font.family'</span><span class="s1">: </span><span class="s2">'serif'</span><span class="s0">,</span>
                   <span class="s2">'pgf.rcfonts'</span><span class="s1">: </span><span class="s0">False,</span>
                   <span class="s2">'pgf.texsystem'</span><span class="s1">: </span><span class="s2">'pdflatex'</span><span class="s0">,</span>
                   <span class="s2">'pgf.preamble'</span><span class="s1">: (</span><span class="s2">'</span><span class="s0">\\</span><span class="s2">usepackage[utf8x]{inputenc}'</span>
                                    <span class="s2">'</span><span class="s0">\\</span><span class="s2">usepackage[T1]{fontenc}'</span><span class="s1">)}</span>
    <span class="s1">mpl.rcParams.update(rc_pdflatex)</span>
    <span class="s1">create_figure()</span>


<span class="s4"># test updating the rc parameters for each figure</span>
<span class="s1">@needs_pgf_xelatex</span>
<span class="s1">@needs_pgf_pdflatex</span>
<span class="s1">@mpl.style.context(</span><span class="s2">'default'</span><span class="s1">)</span>
<span class="s1">@pytest.mark.backend(</span><span class="s2">'pgf'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rcupdate():</span>
    <span class="s1">rc_sets = [{</span><span class="s2">'font.family'</span><span class="s1">: </span><span class="s2">'sans-serif'</span><span class="s0">,</span>
                <span class="s2">'font.size'</span><span class="s1">: </span><span class="s3">30</span><span class="s0">,</span>
                <span class="s2">'figure.subplot.left'</span><span class="s1">: </span><span class="s3">.2</span><span class="s0">,</span>
                <span class="s2">'lines.markersize'</span><span class="s1">: </span><span class="s3">10</span><span class="s0">,</span>
                <span class="s2">'pgf.rcfonts'</span><span class="s1">: </span><span class="s0">False,</span>
                <span class="s2">'pgf.texsystem'</span><span class="s1">: </span><span class="s2">'xelatex'</span><span class="s1">}</span><span class="s0">,</span>
               <span class="s1">{</span><span class="s2">'font.family'</span><span class="s1">: </span><span class="s2">'monospace'</span><span class="s0">,</span>
                <span class="s2">'font.size'</span><span class="s1">: </span><span class="s3">10</span><span class="s0">,</span>
                <span class="s2">'figure.subplot.left'</span><span class="s1">: </span><span class="s3">.1</span><span class="s0">,</span>
                <span class="s2">'lines.markersize'</span><span class="s1">: </span><span class="s3">20</span><span class="s0">,</span>
                <span class="s2">'pgf.rcfonts'</span><span class="s1">: </span><span class="s0">False,</span>
                <span class="s2">'pgf.texsystem'</span><span class="s1">: </span><span class="s2">'pdflatex'</span><span class="s0">,</span>
                <span class="s2">'pgf.preamble'</span><span class="s1">: (</span><span class="s2">'</span><span class="s0">\\</span><span class="s2">usepackage[utf8x]{inputenc}'</span>
                                 <span class="s2">'</span><span class="s0">\\</span><span class="s2">usepackage[T1]{fontenc}'</span>
                                 <span class="s2">'</span><span class="s0">\\</span><span class="s2">usepackage{sfmath}'</span><span class="s1">)}]</span>
    <span class="s1">tol = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">13.2</span><span class="s1">] </span><span class="s0">if </span><span class="s1">_old_gs_version </span><span class="s0">else </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span>
    <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">rc_set </span><span class="s0">in </span><span class="s1">enumerate(rc_sets):</span>
        <span class="s0">with </span><span class="s1">mpl.rc_context(rc_set):</span>
            <span class="s0">for </span><span class="s1">substring</span><span class="s0">, </span><span class="s1">pkg </span><span class="s0">in </span><span class="s1">[(</span><span class="s2">'sfmath'</span><span class="s0">, </span><span class="s2">'sfmath'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'utf8x'</span><span class="s0">, </span><span class="s2">'ucs'</span><span class="s1">)]:</span>
                <span class="s0">if </span><span class="s1">(substring </span><span class="s0">in </span><span class="s1">mpl.rcParams[</span><span class="s2">'pgf.preamble'</span><span class="s1">]</span>
                        <span class="s0">and not </span><span class="s1">_has_tex_package(pkg)):</span>
                    <span class="s1">pytest.skip(</span><span class="s2">f'needs </span><span class="s0">{</span><span class="s1">pkg</span><span class="s0">}</span><span class="s2">.sty'</span><span class="s1">)</span>
            <span class="s1">create_figure()</span>
            <span class="s1">compare_figure(</span><span class="s2">f'pgf_rcupdate</span><span class="s0">{</span><span class="s1">i + </span><span class="s3">1</span><span class="s0">}</span><span class="s2">.pdf'</span><span class="s0">, </span><span class="s1">tol=tol[i])</span>


<span class="s4"># test backend-side clipping, since large numbers are not supported by TeX</span>
<span class="s1">@needs_pgf_xelatex</span>
<span class="s1">@mpl.style.context(</span><span class="s2">'default'</span><span class="s1">)</span>
<span class="s1">@pytest.mark.backend(</span><span class="s2">'pgf'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_pathclip():</span>
    <span class="s1">np.random.seed(</span><span class="s3">19680801</span><span class="s1">)</span>
    <span class="s1">mpl.rcParams.update({</span><span class="s2">'font.family'</span><span class="s1">: </span><span class="s2">'serif'</span><span class="s0">, </span><span class="s2">'pgf.rcfonts'</span><span class="s1">: </span><span class="s0">False</span><span class="s1">})</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">axs = plt.subplots(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">axs[</span><span class="s3">0</span><span class="s1">].plot([</span><span class="s3">0.</span><span class="s0">, </span><span class="s3">1e100</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.</span><span class="s0">, </span><span class="s3">1e100</span><span class="s1">])</span>
    <span class="s1">axs[</span><span class="s3">0</span><span class="s1">].set_xlim(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">axs[</span><span class="s3">0</span><span class="s1">].set_ylim(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">axs[</span><span class="s3">1</span><span class="s1">].scatter([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">axs[</span><span class="s3">1</span><span class="s1">].hist(np.random.normal(size=</span><span class="s3">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">bins=</span><span class="s3">20</span><span class="s0">, </span><span class="s1">range=[-</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">])</span>
    <span class="s1">axs[</span><span class="s3">1</span><span class="s1">].set_xscale(</span><span class="s2">'log'</span><span class="s1">)</span>

    <span class="s1">fig.savefig(BytesIO()</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;pdf&quot;</span><span class="s1">)  </span><span class="s4"># No image comparison.</span>


<span class="s4"># test mixed mode rendering</span>
<span class="s1">@needs_pgf_xelatex</span>
<span class="s1">@pytest.mark.backend(</span><span class="s2">'pgf'</span><span class="s1">)</span>
<span class="s1">@image_comparison([</span><span class="s2">'pgf_mixedmode.pdf'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">style=</span><span class="s2">'default'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_mixedmode():</span>
    <span class="s1">mpl.rcParams.update({</span><span class="s2">'font.family'</span><span class="s1">: </span><span class="s2">'serif'</span><span class="s0">, </span><span class="s2">'pgf.rcfonts'</span><span class="s1">: </span><span class="s0">False</span><span class="s1">})</span>
    <span class="s1">Y</span><span class="s0">, </span><span class="s1">X = np.ogrid[-</span><span class="s3">1</span><span class="s1">:</span><span class="s3">1</span><span class="s1">:</span><span class="s3">40j</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">:</span><span class="s3">1</span><span class="s1">:</span><span class="s3">40j</span><span class="s1">]</span>
    <span class="s1">plt.pcolor(X**</span><span class="s3">2 </span><span class="s1">+ Y**</span><span class="s3">2</span><span class="s1">).set_rasterized(</span><span class="s0">True</span><span class="s1">)</span>


<span class="s4"># test bbox_inches clipping</span>
<span class="s1">@needs_pgf_xelatex</span>
<span class="s1">@mpl.style.context(</span><span class="s2">'default'</span><span class="s1">)</span>
<span class="s1">@pytest.mark.backend(</span><span class="s2">'pgf'</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_bbox_inches():</span>
    <span class="s1">mpl.rcParams.update({</span><span class="s2">'font.family'</span><span class="s1">: </span><span class="s2">'serif'</span><span class="s0">, </span><span class="s2">'pgf.rcfonts'</span><span class="s1">: </span><span class="s0">False</span><span class="s1">})</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">(ax1</span><span class="s0">, </span><span class="s1">ax2) = plt.subplots(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">ax1.plot(range(</span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">ax2.plot(range(</span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">plt.tight_layout()</span>
    <span class="s1">bbox = ax1.get_window_extent().transformed(fig.dpi_scale_trans.inverted())</span>
    <span class="s1">compare_figure(</span><span class="s2">'pgf_bbox_inches.pdf'</span><span class="s0">, </span><span class="s1">savefig_kwargs={</span><span class="s2">'bbox_inches'</span><span class="s1">: bbox}</span><span class="s0">,</span>
                   <span class="s1">tol=</span><span class="s3">0</span><span class="s1">)</span>


<span class="s1">@mpl.style.context(</span><span class="s2">'default'</span><span class="s1">)</span>
<span class="s1">@pytest.mark.backend(</span><span class="s2">'pgf'</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">'system'</span><span class="s0">, </span><span class="s1">[</span>
    <span class="s1">pytest.param(</span><span class="s2">'lualatex'</span><span class="s0">, </span><span class="s1">marks=[needs_pgf_lualatex])</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span><span class="s2">'pdflatex'</span><span class="s0">, </span><span class="s1">marks=[needs_pgf_pdflatex])</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span><span class="s2">'xelatex'</span><span class="s0">, </span><span class="s1">marks=[needs_pgf_xelatex])</span><span class="s0">,</span>
<span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_pdf_pages(system):</span>
    <span class="s1">rc_pdflatex = {</span>
        <span class="s2">'font.family'</span><span class="s1">: </span><span class="s2">'serif'</span><span class="s0">,</span>
        <span class="s2">'pgf.rcfonts'</span><span class="s1">: </span><span class="s0">False,</span>
        <span class="s2">'pgf.texsystem'</span><span class="s1">: system</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">mpl.rcParams.update(rc_pdflatex)</span>

    <span class="s1">fig1</span><span class="s0">, </span><span class="s1">ax1 = plt.subplots()</span>
    <span class="s1">ax1.plot(range(</span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">fig1.tight_layout()</span>

    <span class="s1">fig2</span><span class="s0">, </span><span class="s1">ax2 = plt.subplots(figsize=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">ax2.plot(range(</span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">fig2.tight_layout()</span>

    <span class="s1">path = os.path.join(result_dir</span><span class="s0">, </span><span class="s2">f'pdfpages_</span><span class="s0">{</span><span class="s1">system</span><span class="s0">}</span><span class="s2">.pdf'</span><span class="s1">)</span>
    <span class="s1">md = {</span>
        <span class="s2">'Author'</span><span class="s1">: </span><span class="s2">'me'</span><span class="s0">,</span>
        <span class="s2">'Title'</span><span class="s1">: </span><span class="s2">'Multipage PDF with pgf'</span><span class="s0">,</span>
        <span class="s2">'Subject'</span><span class="s1">: </span><span class="s2">'Test page'</span><span class="s0">,</span>
        <span class="s2">'Keywords'</span><span class="s1">: </span><span class="s2">'test,pdf,multipage'</span><span class="s0">,</span>
        <span class="s2">'ModDate'</span><span class="s1">: datetime.datetime(</span>
            <span class="s3">1968</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">tzinfo=datetime.timezone(datetime.timedelta(</span><span class="s3">0</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s2">'Trapped'</span><span class="s1">: </span><span class="s2">'Unknown'</span>
    <span class="s1">}</span>

    <span class="s0">with </span><span class="s1">PdfPages(path</span><span class="s0">, </span><span class="s1">metadata=md) </span><span class="s0">as </span><span class="s1">pdf:</span>
        <span class="s1">pdf.savefig(fig1)</span>
        <span class="s1">pdf.savefig(fig2)</span>
        <span class="s1">pdf.savefig(fig1)</span>

        <span class="s0">assert </span><span class="s1">pdf.get_pagecount() == </span><span class="s3">3</span>


<span class="s1">@mpl.style.context(</span><span class="s2">'default'</span><span class="s1">)</span>
<span class="s1">@pytest.mark.backend(</span><span class="s2">'pgf'</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">'system'</span><span class="s0">, </span><span class="s1">[</span>
    <span class="s1">pytest.param(</span><span class="s2">'lualatex'</span><span class="s0">, </span><span class="s1">marks=[needs_pgf_lualatex])</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span><span class="s2">'pdflatex'</span><span class="s0">, </span><span class="s1">marks=[needs_pgf_pdflatex])</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span><span class="s2">'xelatex'</span><span class="s0">, </span><span class="s1">marks=[needs_pgf_xelatex])</span><span class="s0">,</span>
<span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_pdf_pages_metadata_check(monkeypatch</span><span class="s0">, </span><span class="s1">system):</span>
    <span class="s4"># Basically the same as test_pdf_pages, but we keep it separate to leave</span>
    <span class="s4"># pikepdf as an optional dependency.</span>
    <span class="s1">pikepdf = pytest.importorskip(</span><span class="s2">'pikepdf'</span><span class="s1">)</span>
    <span class="s1">monkeypatch.setenv(</span><span class="s2">'SOURCE_DATE_EPOCH'</span><span class="s0">, </span><span class="s2">'0'</span><span class="s1">)</span>

    <span class="s1">mpl.rcParams.update({</span><span class="s2">'pgf.texsystem'</span><span class="s1">: system})</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.plot(range(</span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">md = {</span>
        <span class="s2">'Author'</span><span class="s1">: </span><span class="s2">'me'</span><span class="s0">,</span>
        <span class="s2">'Title'</span><span class="s1">: </span><span class="s2">'Multipage PDF with pgf'</span><span class="s0">,</span>
        <span class="s2">'Subject'</span><span class="s1">: </span><span class="s2">'Test page'</span><span class="s0">,</span>
        <span class="s2">'Keywords'</span><span class="s1">: </span><span class="s2">'test,pdf,multipage'</span><span class="s0">,</span>
        <span class="s2">'ModDate'</span><span class="s1">: datetime.datetime(</span>
            <span class="s3">1968</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">tzinfo=datetime.timezone(datetime.timedelta(</span><span class="s3">0</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s2">'Trapped'</span><span class="s1">: </span><span class="s2">'True'</span>
    <span class="s1">}</span>
    <span class="s1">path = os.path.join(result_dir</span><span class="s0">, </span><span class="s2">f'pdfpages_meta_check_</span><span class="s0">{</span><span class="s1">system</span><span class="s0">}</span><span class="s2">.pdf'</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">PdfPages(path</span><span class="s0">, </span><span class="s1">metadata=md) </span><span class="s0">as </span><span class="s1">pdf:</span>
        <span class="s1">pdf.savefig(fig)</span>

    <span class="s0">with </span><span class="s1">pikepdf.Pdf.open(path) </span><span class="s0">as </span><span class="s1">pdf:</span>
        <span class="s1">info = {k: str(v) </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">pdf.docinfo.items()}</span>

    <span class="s4"># Not set by us, so don't bother checking.</span>
    <span class="s0">if </span><span class="s2">'/PTEX.FullBanner' </span><span class="s0">in </span><span class="s1">info:</span>
        <span class="s0">del </span><span class="s1">info[</span><span class="s2">'/PTEX.FullBanner'</span><span class="s1">]</span>
    <span class="s0">if </span><span class="s2">'/PTEX.Fullbanner' </span><span class="s0">in </span><span class="s1">info:</span>
        <span class="s0">del </span><span class="s1">info[</span><span class="s2">'/PTEX.Fullbanner'</span><span class="s1">]</span>

    <span class="s4"># Some LaTeX engines ignore this setting, and state themselves as producer.</span>
    <span class="s1">producer = info.pop(</span><span class="s2">'/Producer'</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">producer == </span><span class="s2">f'Matplotlib pgf backend v</span><span class="s0">{</span><span class="s1">mpl.__version__</span><span class="s0">}</span><span class="s2">' </span><span class="s0">or </span><span class="s1">(</span>
            <span class="s1">system == </span><span class="s2">'lualatex' </span><span class="s0">and </span><span class="s2">'LuaTeX' </span><span class="s0">in </span><span class="s1">producer)</span>

    <span class="s0">assert </span><span class="s1">info == {</span>
        <span class="s2">'/Author'</span><span class="s1">: </span><span class="s2">'me'</span><span class="s0">,</span>
        <span class="s2">'/CreationDate'</span><span class="s1">: </span><span class="s2">'D:19700101000000Z'</span><span class="s0">,</span>
        <span class="s2">'/Creator'</span><span class="s1">: </span><span class="s2">f'Matplotlib v</span><span class="s0">{</span><span class="s1">mpl.__version__</span><span class="s0">}</span><span class="s2">, https://matplotlib.org'</span><span class="s0">,</span>
        <span class="s2">'/Keywords'</span><span class="s1">: </span><span class="s2">'test,pdf,multipage'</span><span class="s0">,</span>
        <span class="s2">'/ModDate'</span><span class="s1">: </span><span class="s2">'D:19680801000000Z'</span><span class="s0">,</span>
        <span class="s2">'/Subject'</span><span class="s1">: </span><span class="s2">'Test page'</span><span class="s0">,</span>
        <span class="s2">'/Title'</span><span class="s1">: </span><span class="s2">'Multipage PDF with pgf'</span><span class="s0">,</span>
        <span class="s2">'/Trapped'</span><span class="s1">: </span><span class="s2">'/True'</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s1">@needs_pgf_xelatex</span>
<span class="s0">def </span><span class="s1">test_tex_restart_after_error():</span>
    <span class="s1">fig = plt.figure()</span>
    <span class="s1">fig.suptitle(</span><span class="s2">r&quot;\oops&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">fig.savefig(BytesIO()</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;pgf&quot;</span><span class="s1">)</span>

    <span class="s1">fig = plt.figure()  </span><span class="s4"># start from scratch</span>
    <span class="s1">fig.suptitle(</span><span class="s2">r&quot;this is ok&quot;</span><span class="s1">)</span>
    <span class="s1">fig.savefig(BytesIO()</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;pgf&quot;</span><span class="s1">)</span>


<span class="s1">@needs_pgf_xelatex</span>
<span class="s0">def </span><span class="s1">test_bbox_inches_tight():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]])</span>
    <span class="s1">fig.savefig(BytesIO()</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;pdf&quot;</span><span class="s0">, </span><span class="s1">backend=</span><span class="s2">&quot;pgf&quot;</span><span class="s0">, </span><span class="s1">bbox_inches=</span><span class="s2">&quot;tight&quot;</span><span class="s1">)</span>


<span class="s1">@needs_pgf_xelatex</span>
<span class="s1">@needs_ghostscript</span>
<span class="s0">def </span><span class="s1">test_png_transparency():  </span><span class="s4"># Actually, also just testing that png works.</span>
    <span class="s1">buf = BytesIO()</span>
    <span class="s1">plt.figure().savefig(buf</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;png&quot;</span><span class="s0">, </span><span class="s1">backend=</span><span class="s2">&quot;pgf&quot;</span><span class="s0">, </span><span class="s1">transparent=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">buf.seek(</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">t = plt.imread(buf)</span>
    <span class="s0">assert </span><span class="s1">(t[...</span><span class="s0">, </span><span class="s3">3</span><span class="s1">] == </span><span class="s3">0</span><span class="s1">).all()  </span><span class="s4"># fully transparent.</span>


<span class="s1">@needs_pgf_xelatex</span>
<span class="s0">def </span><span class="s1">test_unknown_font(caplog):</span>
    <span class="s0">with </span><span class="s1">caplog.at_level(</span><span class="s2">&quot;WARNING&quot;</span><span class="s1">):</span>
        <span class="s1">mpl.rcParams[</span><span class="s2">&quot;font.family&quot;</span><span class="s1">] = </span><span class="s2">&quot;this-font-does-not-exist&quot;</span>
        <span class="s1">plt.figtext(</span><span class="s3">.5</span><span class="s0">, </span><span class="s3">.5</span><span class="s0">, </span><span class="s2">&quot;hello, world&quot;</span><span class="s1">)</span>
        <span class="s1">plt.savefig(BytesIO()</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;pgf&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s2">&quot;Ignoring unknown font: this-font-does-not-exist&quot; </span><span class="s0">in </span><span class="s1">[</span>
        <span class="s1">r.getMessage() </span><span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">caplog.records]</span>


<span class="s1">@check_figures_equal(extensions=[</span><span class="s2">&quot;pdf&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;texsystem&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;pdflatex&quot;</span><span class="s0">, </span><span class="s2">&quot;xelatex&quot;</span><span class="s0">, </span><span class="s2">&quot;lualatex&quot;</span><span class="s1">))</span>
<span class="s1">@pytest.mark.backend(</span><span class="s2">&quot;pgf&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_minus_signs_with_tex(fig_test</span><span class="s0">, </span><span class="s1">fig_ref</span><span class="s0">, </span><span class="s1">texsystem):</span>
    <span class="s0">if not </span><span class="s1">_check_for_pgf(texsystem):</span>
        <span class="s1">pytest.skip(texsystem + </span><span class="s2">' + pgf is required'</span><span class="s1">)</span>
    <span class="s1">mpl.rcParams[</span><span class="s2">&quot;pgf.texsystem&quot;</span><span class="s1">] = texsystem</span>
    <span class="s1">fig_test.text(</span><span class="s3">.5</span><span class="s0">, </span><span class="s3">.5</span><span class="s0">, </span><span class="s2">&quot;$-1$&quot;</span><span class="s1">)</span>
    <span class="s1">fig_ref.text(</span><span class="s3">.5</span><span class="s0">, </span><span class="s3">.5</span><span class="s0">, </span><span class="s2">&quot;$</span><span class="s0">\N{MINUS SIGN}</span><span class="s2">1$&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.backend(</span><span class="s2">&quot;pgf&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_sketch_params():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots(figsize=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">ax.set_xticks([])</span>
    <span class="s1">ax.set_yticks([])</span>
    <span class="s1">ax.set_frame_on(</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">handle</span><span class="s0">, </span><span class="s1">= ax.plot([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">handle.set_sketch_params(scale=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">length=</span><span class="s3">30</span><span class="s0">, </span><span class="s1">randomness=</span><span class="s3">42</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'pgf'</span><span class="s1">)</span>
        <span class="s1">buf = fd.getvalue().decode()</span>

    <span class="s1">baseline = </span><span class="s2">r&quot;&quot;&quot;\pgfpathmoveto{\pgfqpoint{0.375000in}{0.300000in}}% 
\pgfpathlineto{\pgfqpoint{2.700000in}{2.700000in}}% 
\usepgfmodule{decorations}% 
\usepgflibrary{decorations.pathmorphing}% 
\pgfkeys{/pgf/decoration/.cd, &quot;&quot;&quot; </span><span class="s1">\</span>
    <span class="s2">r&quot;&quot;&quot;segment length = 0.150000in, amplitude = 0.100000in}% 
\pgfmathsetseed{42}% 
\pgfdecoratecurrentpath{random steps}% 
\pgfusepath{stroke}%&quot;&quot;&quot;</span>
    <span class="s4"># \pgfdecoratecurrentpath must be after the path definition and before the</span>
    <span class="s4"># path is used (\pgfusepath)</span>
    <span class="s0">assert </span><span class="s1">baseline </span><span class="s0">in </span><span class="s1">buf</span>
</pre>
</body>
</html>