<html>
<head>
<title>psOperators.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #a9b7c6;}
.s1 { color: #6897bb;}
.s2 { color: #6a8759;}
.s3 { color: #cc7832;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
psOperators.py</font>
</center></td></tr></table>
<pre><span class="s0">_accessstrings = {</span><span class="s1">0</span><span class="s0">: </span><span class="s2">&quot;&quot;</span><span class="s3">, </span><span class="s1">1</span><span class="s0">: </span><span class="s2">&quot;readonly&quot;</span><span class="s3">, </span><span class="s1">2</span><span class="s0">: </span><span class="s2">&quot;executeonly&quot;</span><span class="s3">, </span><span class="s1">3</span><span class="s0">: </span><span class="s2">&quot;noaccess&quot;</span><span class="s0">}</span>


<span class="s3">class </span><span class="s0">ps_object(object):</span>

	<span class="s0">literal = </span><span class="s1">1</span>
	<span class="s0">access = </span><span class="s1">0</span>
	<span class="s0">value = </span><span class="s3">None</span>

	<span class="s3">def </span><span class="s0">__init__(self</span><span class="s3">, </span><span class="s0">value):</span>
		<span class="s0">self.value = value</span>
		<span class="s0">self.type = self.__class__.__name__[</span><span class="s1">3</span><span class="s0">:] + </span><span class="s2">&quot;type&quot;</span>

	<span class="s3">def </span><span class="s0">__repr__(self):</span>
		<span class="s3">return </span><span class="s2">&quot;&lt;%s %s&gt;&quot; </span><span class="s0">% (self.__class__.__name__[</span><span class="s1">3</span><span class="s0">:]</span><span class="s3">, </span><span class="s0">repr(self.value))</span>


<span class="s3">class </span><span class="s0">ps_operator(ps_object):</span>

	<span class="s0">literal = </span><span class="s1">0</span>

	<span class="s3">def </span><span class="s0">__init__(self</span><span class="s3">, </span><span class="s0">name</span><span class="s3">, </span><span class="s0">function):</span>
		<span class="s0">self.name = name</span>
		<span class="s0">self.function = function</span>
		<span class="s0">self.type = self.__class__.__name__[</span><span class="s1">3</span><span class="s0">:] + </span><span class="s2">&quot;type&quot;</span>
	<span class="s3">def </span><span class="s0">__repr__(self):</span>
		<span class="s3">return </span><span class="s2">&quot;&lt;operator %s&gt;&quot; </span><span class="s0">% self.name</span>

<span class="s3">class </span><span class="s0">ps_procedure(ps_object):</span>
	<span class="s0">literal = </span><span class="s1">0</span>
	<span class="s3">def </span><span class="s0">__repr__(self):</span>
		<span class="s3">return </span><span class="s2">&quot;&lt;procedure&gt;&quot;</span>
	<span class="s3">def </span><span class="s0">__str__(self):</span>
		<span class="s0">psstring = </span><span class="s2">'{'</span>
		<span class="s3">for </span><span class="s0">i </span><span class="s3">in </span><span class="s0">range(len(self.value)):</span>
			<span class="s3">if </span><span class="s0">i:</span>
				<span class="s0">psstring = psstring + </span><span class="s2">' ' </span><span class="s0">+ str(self.value[i])</span>
			<span class="s3">else</span><span class="s0">:</span>
				<span class="s0">psstring = psstring + str(self.value[i])</span>
		<span class="s3">return </span><span class="s0">psstring + </span><span class="s2">'}'</span>

<span class="s3">class </span><span class="s0">ps_name(ps_object):</span>
	<span class="s0">literal = </span><span class="s1">0</span>
	<span class="s3">def </span><span class="s0">__str__(self):</span>
		<span class="s3">if </span><span class="s0">self.literal:</span>
			<span class="s3">return </span><span class="s2">'/' </span><span class="s0">+ self.value</span>
		<span class="s3">else</span><span class="s0">:</span>
			<span class="s3">return </span><span class="s0">self.value</span>

<span class="s3">class </span><span class="s0">ps_literal(ps_object):</span>
	<span class="s3">def </span><span class="s0">__str__(self):</span>
		<span class="s3">return </span><span class="s2">'/' </span><span class="s0">+ self.value</span>

<span class="s3">class </span><span class="s0">ps_array(ps_object):</span>
	<span class="s3">def </span><span class="s0">__str__(self):</span>
		<span class="s0">psstring = </span><span class="s2">'['</span>
		<span class="s3">for </span><span class="s0">i </span><span class="s3">in </span><span class="s0">range(len(self.value)):</span>
			<span class="s0">item = self.value[i]</span>
			<span class="s0">access = _accessstrings[item.access]</span>
			<span class="s3">if </span><span class="s0">access:</span>
				<span class="s0">access = </span><span class="s2">' ' </span><span class="s0">+ access</span>
			<span class="s3">if </span><span class="s0">i:</span>
				<span class="s0">psstring = psstring + </span><span class="s2">' ' </span><span class="s0">+ str(item) + access</span>
			<span class="s3">else</span><span class="s0">:</span>
				<span class="s0">psstring = psstring + str(item) + access</span>
		<span class="s3">return </span><span class="s0">psstring + </span><span class="s2">']'</span>
	<span class="s3">def </span><span class="s0">__repr__(self):</span>
		<span class="s3">return </span><span class="s2">&quot;&lt;array&gt;&quot;</span>

<span class="s0">_type1_pre_eexec_order = [</span>
		<span class="s2">&quot;FontInfo&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;FontName&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;Encoding&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;PaintType&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;FontType&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;FontMatrix&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;FontBBox&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;UniqueID&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;Metrics&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;StrokeWidth&quot;</span>
	<span class="s0">]</span>

<span class="s0">_type1_fontinfo_order = [</span>
		<span class="s2">&quot;version&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;Notice&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;FullName&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;FamilyName&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;Weight&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;ItalicAngle&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;isFixedPitch&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;UnderlinePosition&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;UnderlineThickness&quot;</span>
	<span class="s0">]</span>

<span class="s0">_type1_post_eexec_order = [</span>
		<span class="s2">&quot;Private&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;CharStrings&quot;</span><span class="s3">,</span>
		<span class="s2">&quot;FID&quot;</span>
	<span class="s0">]</span>

<span class="s3">def </span><span class="s0">_type1_item_repr(key</span><span class="s3">, </span><span class="s0">value):</span>
	<span class="s0">psstring = </span><span class="s2">&quot;&quot;</span>
	<span class="s0">access = _accessstrings[value.access]</span>
	<span class="s3">if </span><span class="s0">access:</span>
		<span class="s0">access = access + </span><span class="s2">' '</span>
	<span class="s3">if </span><span class="s0">key == </span><span class="s2">'CharStrings'</span><span class="s0">:</span>
		<span class="s0">psstring = psstring + </span><span class="s2">&quot;/%s %s def</span><span class="s3">\n</span><span class="s2">&quot; </span><span class="s0">% (key</span><span class="s3">, </span><span class="s0">_type1_CharString_repr(value.value))</span>
	<span class="s3">elif </span><span class="s0">key == </span><span class="s2">'Encoding'</span><span class="s0">:</span>
		<span class="s0">psstring = psstring + _type1_Encoding_repr(value</span><span class="s3">, </span><span class="s0">access)</span>
	<span class="s3">else</span><span class="s0">:</span>
		<span class="s0">psstring = psstring + </span><span class="s2">&quot;/%s %s %sdef</span><span class="s3">\n</span><span class="s2">&quot; </span><span class="s0">% (str(key)</span><span class="s3">, </span><span class="s0">str(value)</span><span class="s3">, </span><span class="s0">access)</span>
	<span class="s3">return </span><span class="s0">psstring</span>

<span class="s3">def </span><span class="s0">_type1_Encoding_repr(encoding</span><span class="s3">, </span><span class="s0">access):</span>
	<span class="s0">encoding = encoding.value</span>
	<span class="s0">psstring = </span><span class="s2">&quot;/Encoding 256 array</span><span class="s3">\n</span><span class="s2">0 1 255 {1 index exch /.notdef put} for</span><span class="s3">\n</span><span class="s2">&quot;</span>
	<span class="s3">for </span><span class="s0">i </span><span class="s3">in </span><span class="s0">range(</span><span class="s1">256</span><span class="s0">):</span>
		<span class="s0">name = encoding[i].value</span>
		<span class="s3">if </span><span class="s0">name != </span><span class="s2">'.notdef'</span><span class="s0">:</span>
			<span class="s0">psstring = psstring + </span><span class="s2">&quot;dup %d /%s put</span><span class="s3">\n</span><span class="s2">&quot; </span><span class="s0">% (i</span><span class="s3">, </span><span class="s0">name)</span>
	<span class="s3">return </span><span class="s0">psstring + access + </span><span class="s2">&quot;def</span><span class="s3">\n</span><span class="s2">&quot;</span>

<span class="s3">def </span><span class="s0">_type1_CharString_repr(charstrings):</span>
	<span class="s0">items = sorted(charstrings.items())</span>
	<span class="s3">return </span><span class="s2">'xxx'</span>

<span class="s3">class </span><span class="s0">ps_font(ps_object):</span>
	<span class="s3">def </span><span class="s0">__str__(self):</span>
		<span class="s0">psstring = </span><span class="s2">&quot;%d dict dup begin</span><span class="s3">\n</span><span class="s2">&quot; </span><span class="s0">% len(self.value)</span>
		<span class="s3">for </span><span class="s0">key </span><span class="s3">in </span><span class="s0">_type1_pre_eexec_order:</span>
			<span class="s3">try</span><span class="s0">:</span>
				<span class="s0">value = self.value[key]</span>
			<span class="s3">except </span><span class="s0">KeyError:</span>
				<span class="s3">pass</span>
			<span class="s3">else</span><span class="s0">:</span>
				<span class="s0">psstring = psstring + _type1_item_repr(key</span><span class="s3">, </span><span class="s0">value)</span>
		<span class="s0">items = sorted(self.value.items())</span>
		<span class="s3">for </span><span class="s0">key</span><span class="s3">, </span><span class="s0">value </span><span class="s3">in </span><span class="s0">items:</span>
			<span class="s3">if </span><span class="s0">key </span><span class="s3">not in </span><span class="s0">_type1_pre_eexec_order + _type1_post_eexec_order:</span>
				<span class="s0">psstring = psstring + _type1_item_repr(key</span><span class="s3">, </span><span class="s0">value)</span>
		<span class="s0">psstring = psstring + </span><span class="s2">&quot;currentdict end</span><span class="s3">\n</span><span class="s2">currentfile eexec</span><span class="s3">\n</span><span class="s2">dup &quot;</span>
		<span class="s3">for </span><span class="s0">key </span><span class="s3">in </span><span class="s0">_type1_post_eexec_order:</span>
			<span class="s3">try</span><span class="s0">:</span>
				<span class="s0">value = self.value[key]</span>
			<span class="s3">except </span><span class="s0">KeyError:</span>
				<span class="s3">pass</span>
			<span class="s3">else</span><span class="s0">:</span>
				<span class="s0">psstring = psstring + _type1_item_repr(key</span><span class="s3">, </span><span class="s0">value)</span>
		<span class="s3">return </span><span class="s0">psstring + </span><span class="s2">'dup/FontName get exch definefont pop</span><span class="s3">\n</span><span class="s2">mark currentfile closefile</span><span class="s3">\n</span><span class="s2">' </span><span class="s0">+ \</span>
				<span class="s1">8 </span><span class="s0">* (</span><span class="s1">64 </span><span class="s0">* </span><span class="s2">'0' </span><span class="s0">+ </span><span class="s2">'</span><span class="s3">\n</span><span class="s2">'</span><span class="s0">) + </span><span class="s2">'cleartomark' </span><span class="s0">+ </span><span class="s2">'</span><span class="s3">\n</span><span class="s2">'</span>
	<span class="s3">def </span><span class="s0">__repr__(self):</span>
		<span class="s3">return </span><span class="s2">'&lt;font&gt;'</span>

<span class="s3">class </span><span class="s0">ps_file(ps_object):</span>
	<span class="s3">pass</span>

<span class="s3">class </span><span class="s0">ps_dict(ps_object):</span>
	<span class="s3">def </span><span class="s0">__str__(self):</span>
		<span class="s0">psstring = </span><span class="s2">&quot;%d dict dup begin</span><span class="s3">\n</span><span class="s2">&quot; </span><span class="s0">% len(self.value)</span>
		<span class="s0">items = sorted(self.value.items())</span>
		<span class="s3">for </span><span class="s0">key</span><span class="s3">, </span><span class="s0">value </span><span class="s3">in </span><span class="s0">items:</span>
			<span class="s0">access = _accessstrings[value.access]</span>
			<span class="s3">if </span><span class="s0">access:</span>
				<span class="s0">access = access + </span><span class="s2">' '</span>
			<span class="s0">psstring = psstring + </span><span class="s2">&quot;/%s %s %sdef</span><span class="s3">\n</span><span class="s2">&quot; </span><span class="s0">% (str(key)</span><span class="s3">, </span><span class="s0">str(value)</span><span class="s3">, </span><span class="s0">access)</span>
		<span class="s3">return </span><span class="s0">psstring + </span><span class="s2">'end '</span>
	<span class="s3">def </span><span class="s0">__repr__(self):</span>
		<span class="s3">return </span><span class="s2">&quot;&lt;dict&gt;&quot;</span>

<span class="s3">class </span><span class="s0">ps_mark(ps_object):</span>
	<span class="s3">def </span><span class="s0">__init__(self):</span>
		<span class="s0">self.value = </span><span class="s2">'mark'</span>
		<span class="s0">self.type = self.__class__.__name__[</span><span class="s1">3</span><span class="s0">:] + </span><span class="s2">&quot;type&quot;</span>

<span class="s3">class </span><span class="s0">ps_procmark(ps_object):</span>
	<span class="s3">def </span><span class="s0">__init__(self):</span>
		<span class="s0">self.value = </span><span class="s2">'procmark'</span>
		<span class="s0">self.type = self.__class__.__name__[</span><span class="s1">3</span><span class="s0">:] + </span><span class="s2">&quot;type&quot;</span>

<span class="s3">class </span><span class="s0">ps_null(ps_object):</span>
	<span class="s3">def </span><span class="s0">__init__(self):</span>
		<span class="s0">self.type = self.__class__.__name__[</span><span class="s1">3</span><span class="s0">:] + </span><span class="s2">&quot;type&quot;</span>

<span class="s3">class </span><span class="s0">ps_boolean(ps_object):</span>
	<span class="s3">def </span><span class="s0">__str__(self):</span>
		<span class="s3">if </span><span class="s0">self.value:</span>
			<span class="s3">return </span><span class="s2">'true'</span>
		<span class="s3">else</span><span class="s0">:</span>
			<span class="s3">return </span><span class="s2">'false'</span>

<span class="s3">class </span><span class="s0">ps_string(ps_object):</span>
	<span class="s3">def </span><span class="s0">__str__(self):</span>
		<span class="s3">return </span><span class="s2">&quot;(%s)&quot; </span><span class="s0">% repr(self.value)[</span><span class="s1">1</span><span class="s0">:-</span><span class="s1">1</span><span class="s0">]</span>

<span class="s3">class </span><span class="s0">ps_integer(ps_object):</span>
	<span class="s3">def </span><span class="s0">__str__(self):</span>
		<span class="s3">return </span><span class="s0">repr(self.value)</span>

<span class="s3">class </span><span class="s0">ps_real(ps_object):</span>
	<span class="s3">def </span><span class="s0">__str__(self):</span>
		<span class="s3">return </span><span class="s0">repr(self.value)</span>


<span class="s3">class </span><span class="s0">PSOperators(object):</span>

	<span class="s3">def </span><span class="s0">ps_def(self):</span>
		<span class="s0">obj = self.pop()</span>
		<span class="s0">name = self.pop()</span>
		<span class="s0">self.dictstack[-</span><span class="s1">1</span><span class="s0">][name.value] = obj</span>

	<span class="s3">def </span><span class="s0">ps_bind(self):</span>
		<span class="s0">proc = self.pop(</span><span class="s2">'proceduretype'</span><span class="s0">)</span>
		<span class="s0">self.proc_bind(proc)</span>
		<span class="s0">self.push(proc)</span>

	<span class="s3">def </span><span class="s0">proc_bind(self</span><span class="s3">, </span><span class="s0">proc):</span>
		<span class="s3">for </span><span class="s0">i </span><span class="s3">in </span><span class="s0">range(len(proc.value)):</span>
			<span class="s0">item = proc.value[i]</span>
			<span class="s3">if </span><span class="s0">item.type == </span><span class="s2">'proceduretype'</span><span class="s0">:</span>
				<span class="s0">self.proc_bind(item)</span>
			<span class="s3">else</span><span class="s0">:</span>
				<span class="s3">if not </span><span class="s0">item.literal:</span>
					<span class="s3">try</span><span class="s0">:</span>
						<span class="s0">obj = self.resolve_name(item.value)</span>
					<span class="s3">except</span><span class="s0">:</span>
						<span class="s3">pass</span>
					<span class="s3">else</span><span class="s0">:</span>
						<span class="s3">if </span><span class="s0">obj.type == </span><span class="s2">'operatortype'</span><span class="s0">:</span>
							<span class="s0">proc.value[i] = obj</span>

	<span class="s3">def </span><span class="s0">ps_exch(self):</span>
		<span class="s3">if </span><span class="s0">len(self.stack) &lt; </span><span class="s1">2</span><span class="s0">:</span>
			<span class="s3">raise </span><span class="s0">RuntimeError(</span><span class="s2">'stack underflow'</span><span class="s0">)</span>
		<span class="s0">obj1 = self.pop()</span>
		<span class="s0">obj2 = self.pop()</span>
		<span class="s0">self.push(obj1)</span>
		<span class="s0">self.push(obj2)</span>

	<span class="s3">def </span><span class="s0">ps_dup(self):</span>
		<span class="s3">if not </span><span class="s0">self.stack:</span>
			<span class="s3">raise </span><span class="s0">RuntimeError(</span><span class="s2">'stack underflow'</span><span class="s0">)</span>
		<span class="s0">self.push(self.stack[-</span><span class="s1">1</span><span class="s0">])</span>

	<span class="s3">def </span><span class="s0">ps_exec(self):</span>
		<span class="s0">obj = self.pop()</span>
		<span class="s3">if </span><span class="s0">obj.type == </span><span class="s2">'proceduretype'</span><span class="s0">:</span>
			<span class="s0">self.call_procedure(obj)</span>
		<span class="s3">else</span><span class="s0">:</span>
			<span class="s0">self.handle_object(obj)</span>

	<span class="s3">def </span><span class="s0">ps_count(self):</span>
		<span class="s0">self.push(ps_integer(len(self.stack)))</span>

	<span class="s3">def </span><span class="s0">ps_eq(self):</span>
		<span class="s0">any1 = self.pop()</span>
		<span class="s0">any2 = self.pop()</span>
		<span class="s0">self.push(ps_boolean(any1.value == any2.value))</span>

	<span class="s3">def </span><span class="s0">ps_ne(self):</span>
		<span class="s0">any1 = self.pop()</span>
		<span class="s0">any2 = self.pop()</span>
		<span class="s0">self.push(ps_boolean(any1.value != any2.value))</span>

	<span class="s3">def </span><span class="s0">ps_cvx(self):</span>
		<span class="s0">obj = self.pop()</span>
		<span class="s0">obj.literal = </span><span class="s1">0</span>
		<span class="s0">self.push(obj)</span>

	<span class="s3">def </span><span class="s0">ps_matrix(self):</span>
		<span class="s0">matrix = [ps_real(</span><span class="s1">1.0</span><span class="s0">)</span><span class="s3">, </span><span class="s0">ps_integer(</span><span class="s1">0</span><span class="s0">)</span><span class="s3">, </span><span class="s0">ps_integer(</span><span class="s1">0</span><span class="s0">)</span><span class="s3">, </span><span class="s0">ps_real(</span><span class="s1">1.0</span><span class="s0">)</span><span class="s3">, </span><span class="s0">ps_integer(</span><span class="s1">0</span><span class="s0">)</span><span class="s3">, </span><span class="s0">ps_integer(</span><span class="s1">0</span><span class="s0">)]</span>
		<span class="s0">self.push(ps_array(matrix))</span>

	<span class="s3">def </span><span class="s0">ps_string(self):</span>
		<span class="s0">num = self.pop(</span><span class="s2">'integertype'</span><span class="s0">).value</span>
		<span class="s0">self.push(ps_string(</span><span class="s2">'</span><span class="s3">\0</span><span class="s2">' </span><span class="s0">* num))</span>

	<span class="s3">def </span><span class="s0">ps_type(self):</span>
		<span class="s0">obj = self.pop()</span>
		<span class="s0">self.push(ps_string(obj.type))</span>

	<span class="s3">def </span><span class="s0">ps_store(self):</span>
		<span class="s0">value = self.pop()</span>
		<span class="s0">key = self.pop()</span>
		<span class="s0">name = key.value</span>
		<span class="s3">for </span><span class="s0">i </span><span class="s3">in </span><span class="s0">range(len(self.dictstack)-</span><span class="s1">1</span><span class="s3">, </span><span class="s0">-</span><span class="s1">1</span><span class="s3">, </span><span class="s0">-</span><span class="s1">1</span><span class="s0">):</span>
			<span class="s3">if </span><span class="s0">name </span><span class="s3">in </span><span class="s0">self.dictstack[i]:</span>
				<span class="s0">self.dictstack[i][name] = value</span>
				<span class="s3">break</span>
		<span class="s0">self.dictstack[-</span><span class="s1">1</span><span class="s0">][name] = value</span>

	<span class="s3">def </span><span class="s0">ps_where(self):</span>
		<span class="s0">name = self.pop()</span>
		<span class="s4"># XXX</span>
		<span class="s0">self.push(ps_boolean(</span><span class="s1">0</span><span class="s0">))</span>

	<span class="s3">def </span><span class="s0">ps_systemdict(self):</span>
		<span class="s0">self.push(ps_dict(self.dictstack[</span><span class="s1">0</span><span class="s0">]))</span>

	<span class="s3">def </span><span class="s0">ps_userdict(self):</span>
		<span class="s0">self.push(ps_dict(self.dictstack[</span><span class="s1">1</span><span class="s0">]))</span>

	<span class="s3">def </span><span class="s0">ps_currentdict(self):</span>
		<span class="s0">self.push(ps_dict(self.dictstack[-</span><span class="s1">1</span><span class="s0">]))</span>

	<span class="s3">def </span><span class="s0">ps_currentfile(self):</span>
		<span class="s0">self.push(ps_file(self.tokenizer))</span>

	<span class="s3">def </span><span class="s0">ps_eexec(self):</span>
		<span class="s0">f = self.pop(</span><span class="s2">'filetype'</span><span class="s0">).value</span>
		<span class="s0">f.starteexec()</span>

	<span class="s3">def </span><span class="s0">ps_closefile(self):</span>
		<span class="s0">f = self.pop(</span><span class="s2">'filetype'</span><span class="s0">).value</span>
		<span class="s0">f.skipwhite()</span>
		<span class="s0">f.stopeexec()</span>

	<span class="s3">def </span><span class="s0">ps_cleartomark(self):</span>
		<span class="s0">obj = self.pop()</span>
		<span class="s3">while </span><span class="s0">obj != self.mark:</span>
			<span class="s0">obj = self.pop()</span>

	<span class="s3">def </span><span class="s0">ps_readstring(self</span><span class="s3">,</span>
			<span class="s0">ps_boolean=ps_boolean</span><span class="s3">,</span>
			<span class="s0">len=len):</span>
		<span class="s0">s = self.pop(</span><span class="s2">'stringtype'</span><span class="s0">)</span>
		<span class="s0">oldstr = s.value</span>
		<span class="s0">f = self.pop(</span><span class="s2">'filetype'</span><span class="s0">)</span>
		<span class="s4">#pad = file.value.read(1)</span>
		<span class="s4"># for StringIO, this is faster</span>
		<span class="s0">f.value.pos = f.value.pos + </span><span class="s1">1</span>
		<span class="s0">newstr = f.value.read(len(oldstr))</span>
		<span class="s0">s.value = newstr</span>
		<span class="s0">self.push(s)</span>
		<span class="s0">self.push(ps_boolean(len(oldstr) == len(newstr)))</span>

	<span class="s3">def </span><span class="s0">ps_known(self):</span>
		<span class="s0">key = self.pop()</span>
		<span class="s0">d = self.pop(</span><span class="s2">'dicttype'</span><span class="s3">, </span><span class="s2">'fonttype'</span><span class="s0">)</span>
		<span class="s0">self.push(ps_boolean(key.value </span><span class="s3">in </span><span class="s0">d.value))</span>

	<span class="s3">def </span><span class="s0">ps_if(self):</span>
		<span class="s0">proc = self.pop(</span><span class="s2">'proceduretype'</span><span class="s0">)</span>
		<span class="s3">if </span><span class="s0">self.pop(</span><span class="s2">'booleantype'</span><span class="s0">).value:</span>
			<span class="s0">self.call_procedure(proc)</span>

	<span class="s3">def </span><span class="s0">ps_ifelse(self):</span>
		<span class="s0">proc2 = self.pop(</span><span class="s2">'proceduretype'</span><span class="s0">)</span>
		<span class="s0">proc1 = self.pop(</span><span class="s2">'proceduretype'</span><span class="s0">)</span>
		<span class="s3">if </span><span class="s0">self.pop(</span><span class="s2">'booleantype'</span><span class="s0">).value:</span>
			<span class="s0">self.call_procedure(proc1)</span>
		<span class="s3">else</span><span class="s0">:</span>
			<span class="s0">self.call_procedure(proc2)</span>

	<span class="s3">def </span><span class="s0">ps_readonly(self):</span>
		<span class="s0">obj = self.pop()</span>
		<span class="s3">if </span><span class="s0">obj.access &lt; </span><span class="s1">1</span><span class="s0">:</span>
			<span class="s0">obj.access = </span><span class="s1">1</span>
		<span class="s0">self.push(obj)</span>

	<span class="s3">def </span><span class="s0">ps_executeonly(self):</span>
		<span class="s0">obj = self.pop()</span>
		<span class="s3">if </span><span class="s0">obj.access &lt; </span><span class="s1">2</span><span class="s0">:</span>
			<span class="s0">obj.access = </span><span class="s1">2</span>
		<span class="s0">self.push(obj)</span>

	<span class="s3">def </span><span class="s0">ps_noaccess(self):</span>
		<span class="s0">obj = self.pop()</span>
		<span class="s3">if </span><span class="s0">obj.access &lt; </span><span class="s1">3</span><span class="s0">:</span>
			<span class="s0">obj.access = </span><span class="s1">3</span>
		<span class="s0">self.push(obj)</span>

	<span class="s3">def </span><span class="s0">ps_not(self):</span>
		<span class="s0">obj = self.pop(</span><span class="s2">'booleantype'</span><span class="s3">, </span><span class="s2">'integertype'</span><span class="s0">)</span>
		<span class="s3">if </span><span class="s0">obj.type == </span><span class="s2">'booleantype'</span><span class="s0">:</span>
			<span class="s0">self.push(ps_boolean(</span><span class="s3">not </span><span class="s0">obj.value))</span>
		<span class="s3">else</span><span class="s0">:</span>
			<span class="s0">self.push(ps_integer(~obj.value))</span>

	<span class="s3">def </span><span class="s0">ps_print(self):</span>
		<span class="s0">str = self.pop(</span><span class="s2">'stringtype'</span><span class="s0">)</span>
		<span class="s0">print(</span><span class="s2">'PS output ---&gt;'</span><span class="s3">, </span><span class="s0">str.value)</span>

	<span class="s3">def </span><span class="s0">ps_anchorsearch(self):</span>
		<span class="s0">seek = self.pop(</span><span class="s2">'stringtype'</span><span class="s0">)</span>
		<span class="s0">s = self.pop(</span><span class="s2">'stringtype'</span><span class="s0">)</span>
		<span class="s0">seeklen = len(seek.value)</span>
		<span class="s3">if </span><span class="s0">s.value[:seeklen] == seek.value:</span>
			<span class="s0">self.push(ps_string(s.value[seeklen:]))</span>
			<span class="s0">self.push(seek)</span>
			<span class="s0">self.push(ps_boolean(</span><span class="s1">1</span><span class="s0">))</span>
		<span class="s3">else</span><span class="s0">:</span>
			<span class="s0">self.push(s)</span>
			<span class="s0">self.push(ps_boolean(</span><span class="s1">0</span><span class="s0">))</span>

	<span class="s3">def </span><span class="s0">ps_array(self):</span>
		<span class="s0">num = self.pop(</span><span class="s2">'integertype'</span><span class="s0">)</span>
		<span class="s0">array = ps_array([</span><span class="s3">None</span><span class="s0">] * num.value)</span>
		<span class="s0">self.push(array)</span>

	<span class="s3">def </span><span class="s0">ps_astore(self):</span>
		<span class="s0">array = self.pop(</span><span class="s2">'arraytype'</span><span class="s0">)</span>
		<span class="s3">for </span><span class="s0">i </span><span class="s3">in </span><span class="s0">range(len(array.value)-</span><span class="s1">1</span><span class="s3">, </span><span class="s0">-</span><span class="s1">1</span><span class="s3">, </span><span class="s0">-</span><span class="s1">1</span><span class="s0">):</span>
			<span class="s0">array.value[i] = self.pop()</span>
		<span class="s0">self.push(array)</span>

	<span class="s3">def </span><span class="s0">ps_load(self):</span>
		<span class="s0">name = self.pop()</span>
		<span class="s0">self.push(self.resolve_name(name.value))</span>

	<span class="s3">def </span><span class="s0">ps_put(self):</span>
		<span class="s0">obj1 = self.pop()</span>
		<span class="s0">obj2 = self.pop()</span>
		<span class="s0">obj3 = self.pop(</span><span class="s2">'arraytype'</span><span class="s3">, </span><span class="s2">'dicttype'</span><span class="s3">, </span><span class="s2">'stringtype'</span><span class="s3">, </span><span class="s2">'proceduretype'</span><span class="s0">)</span>
		<span class="s0">tp = obj3.type</span>
		<span class="s3">if </span><span class="s0">tp == </span><span class="s2">'arraytype' </span><span class="s3">or </span><span class="s0">tp == </span><span class="s2">'proceduretype'</span><span class="s0">:</span>
			<span class="s0">obj3.value[obj2.value] = obj1</span>
		<span class="s3">elif </span><span class="s0">tp == </span><span class="s2">'dicttype'</span><span class="s0">:</span>
			<span class="s0">obj3.value[obj2.value] = obj1</span>
		<span class="s3">elif </span><span class="s0">tp == </span><span class="s2">'stringtype'</span><span class="s0">:</span>
			<span class="s0">index = obj2.value</span>
			<span class="s0">obj3.value = obj3.value[:index] + chr(obj1.value) + obj3.value[index+</span><span class="s1">1</span><span class="s0">:]</span>

	<span class="s3">def </span><span class="s0">ps_get(self):</span>
		<span class="s0">obj1 = self.pop()</span>
		<span class="s3">if </span><span class="s0">obj1.value == </span><span class="s2">&quot;Encoding&quot;</span><span class="s0">:</span>
			<span class="s3">pass</span>
		<span class="s0">obj2 = self.pop(</span><span class="s2">'arraytype'</span><span class="s3">, </span><span class="s2">'dicttype'</span><span class="s3">, </span><span class="s2">'stringtype'</span><span class="s3">, </span><span class="s2">'proceduretype'</span><span class="s3">, </span><span class="s2">'fonttype'</span><span class="s0">)</span>
		<span class="s0">tp = obj2.type</span>
		<span class="s3">if </span><span class="s0">tp </span><span class="s3">in </span><span class="s0">(</span><span class="s2">'arraytype'</span><span class="s3">, </span><span class="s2">'proceduretype'</span><span class="s0">):</span>
			<span class="s0">self.push(obj2.value[obj1.value])</span>
		<span class="s3">elif </span><span class="s0">tp </span><span class="s3">in </span><span class="s0">(</span><span class="s2">'dicttype'</span><span class="s3">, </span><span class="s2">'fonttype'</span><span class="s0">):</span>
			<span class="s0">self.push(obj2.value[obj1.value])</span>
		<span class="s3">elif </span><span class="s0">tp == </span><span class="s2">'stringtype'</span><span class="s0">:</span>
			<span class="s0">self.push(ps_integer(ord(obj2.value[obj1.value])))</span>
		<span class="s3">else</span><span class="s0">:</span>
			<span class="s3">assert False, </span><span class="s2">&quot;shouldn't get here&quot;</span>

	<span class="s3">def </span><span class="s0">ps_getinterval(self):</span>
		<span class="s0">obj1 = self.pop(</span><span class="s2">'integertype'</span><span class="s0">)</span>
		<span class="s0">obj2 = self.pop(</span><span class="s2">'integertype'</span><span class="s0">)</span>
		<span class="s0">obj3 = self.pop(</span><span class="s2">'arraytype'</span><span class="s3">, </span><span class="s2">'stringtype'</span><span class="s0">)</span>
		<span class="s0">tp = obj3.type</span>
		<span class="s3">if </span><span class="s0">tp == </span><span class="s2">'arraytype'</span><span class="s0">:</span>
			<span class="s0">self.push(ps_array(obj3.value[obj2.value:obj2.value + obj1.value]))</span>
		<span class="s3">elif </span><span class="s0">tp == </span><span class="s2">'stringtype'</span><span class="s0">:</span>
			<span class="s0">self.push(ps_string(obj3.value[obj2.value:obj2.value + obj1.value]))</span>

	<span class="s3">def </span><span class="s0">ps_putinterval(self):</span>
		<span class="s0">obj1 = self.pop(</span><span class="s2">'arraytype'</span><span class="s3">, </span><span class="s2">'stringtype'</span><span class="s0">)</span>
		<span class="s0">obj2 = self.pop(</span><span class="s2">'integertype'</span><span class="s0">)</span>
		<span class="s0">obj3 = self.pop(</span><span class="s2">'arraytype'</span><span class="s3">, </span><span class="s2">'stringtype'</span><span class="s0">)</span>
		<span class="s0">tp = obj3.type</span>
		<span class="s3">if </span><span class="s0">tp == </span><span class="s2">'arraytype'</span><span class="s0">:</span>
			<span class="s0">obj3.value[obj2.value:obj2.value + len(obj1.value)] = obj1.value</span>
		<span class="s3">elif </span><span class="s0">tp == </span><span class="s2">'stringtype'</span><span class="s0">:</span>
			<span class="s0">newstr = obj3.value[:obj2.value]</span>
			<span class="s0">newstr = newstr + obj1.value</span>
			<span class="s0">newstr = newstr + obj3.value[obj2.value + len(obj1.value):]</span>
			<span class="s0">obj3.value = newstr</span>

	<span class="s3">def </span><span class="s0">ps_cvn(self):</span>
		<span class="s0">self.push(ps_name(self.pop(</span><span class="s2">'stringtype'</span><span class="s0">).value))</span>

	<span class="s3">def </span><span class="s0">ps_index(self):</span>
		<span class="s0">n = self.pop(</span><span class="s2">'integertype'</span><span class="s0">).value</span>
		<span class="s3">if </span><span class="s0">n &lt; </span><span class="s1">0</span><span class="s0">:</span>
			<span class="s3">raise </span><span class="s0">RuntimeError(</span><span class="s2">'index may not be negative'</span><span class="s0">)</span>
		<span class="s0">self.push(self.stack[-</span><span class="s1">1</span><span class="s0">-n])</span>

	<span class="s3">def </span><span class="s0">ps_for(self):</span>
		<span class="s0">proc = self.pop(</span><span class="s2">'proceduretype'</span><span class="s0">)</span>
		<span class="s0">limit = self.pop(</span><span class="s2">'integertype'</span><span class="s3">, </span><span class="s2">'realtype'</span><span class="s0">).value</span>
		<span class="s0">increment = self.pop(</span><span class="s2">'integertype'</span><span class="s3">, </span><span class="s2">'realtype'</span><span class="s0">).value</span>
		<span class="s0">i = self.pop(</span><span class="s2">'integertype'</span><span class="s3">, </span><span class="s2">'realtype'</span><span class="s0">).value</span>
		<span class="s3">while </span><span class="s1">1</span><span class="s0">:</span>
			<span class="s3">if </span><span class="s0">increment &gt; </span><span class="s1">0</span><span class="s0">:</span>
				<span class="s3">if </span><span class="s0">i &gt; limit:</span>
					<span class="s3">break</span>
			<span class="s3">else</span><span class="s0">:</span>
				<span class="s3">if </span><span class="s0">i &lt; limit:</span>
					<span class="s3">break</span>
			<span class="s3">if </span><span class="s0">type(i) == type(</span><span class="s1">0.0</span><span class="s0">):</span>
				<span class="s0">self.push(ps_real(i))</span>
			<span class="s3">else</span><span class="s0">:</span>
				<span class="s0">self.push(ps_integer(i))</span>
			<span class="s0">self.call_procedure(proc)</span>
			<span class="s0">i = i + increment</span>

	<span class="s3">def </span><span class="s0">ps_forall(self):</span>
		<span class="s0">proc = self.pop(</span><span class="s2">'proceduretype'</span><span class="s0">)</span>
		<span class="s0">obj = self.pop(</span><span class="s2">'arraytype'</span><span class="s3">, </span><span class="s2">'stringtype'</span><span class="s3">, </span><span class="s2">'dicttype'</span><span class="s0">)</span>
		<span class="s0">tp = obj.type</span>
		<span class="s3">if </span><span class="s0">tp == </span><span class="s2">'arraytype'</span><span class="s0">:</span>
			<span class="s3">for </span><span class="s0">item </span><span class="s3">in </span><span class="s0">obj.value:</span>
				<span class="s0">self.push(item)</span>
				<span class="s0">self.call_procedure(proc)</span>
		<span class="s3">elif </span><span class="s0">tp == </span><span class="s2">'stringtype'</span><span class="s0">:</span>
			<span class="s3">for </span><span class="s0">item </span><span class="s3">in </span><span class="s0">obj.value:</span>
				<span class="s0">self.push(ps_integer(ord(item)))</span>
				<span class="s0">self.call_procedure(proc)</span>
		<span class="s3">elif </span><span class="s0">tp == </span><span class="s2">'dicttype'</span><span class="s0">:</span>
			<span class="s3">for </span><span class="s0">key</span><span class="s3">, </span><span class="s0">value </span><span class="s3">in </span><span class="s0">obj.value.items():</span>
				<span class="s0">self.push(ps_name(key))</span>
				<span class="s0">self.push(value)</span>
				<span class="s0">self.call_procedure(proc)</span>

	<span class="s3">def </span><span class="s0">ps_definefont(self):</span>
		<span class="s0">font = self.pop(</span><span class="s2">'dicttype'</span><span class="s0">)</span>
		<span class="s0">name = self.pop()</span>
		<span class="s0">font = ps_font(font.value)</span>
		<span class="s0">self.dictstack[</span><span class="s1">0</span><span class="s0">][</span><span class="s2">'FontDirectory'</span><span class="s0">].value[name.value] = font</span>
		<span class="s0">self.push(font)</span>

	<span class="s3">def </span><span class="s0">ps_findfont(self):</span>
		<span class="s0">name = self.pop()</span>
		<span class="s0">font = self.dictstack[</span><span class="s1">0</span><span class="s0">][</span><span class="s2">'FontDirectory'</span><span class="s0">].value[name.value]</span>
		<span class="s0">self.push(font)</span>

	<span class="s3">def </span><span class="s0">ps_pop(self):</span>
		<span class="s0">self.pop()</span>

	<span class="s3">def </span><span class="s0">ps_dict(self):</span>
		<span class="s0">self.pop(</span><span class="s2">'integertype'</span><span class="s0">)</span>
		<span class="s0">self.push(ps_dict({}))</span>

	<span class="s3">def </span><span class="s0">ps_begin(self):</span>
		<span class="s0">self.dictstack.append(self.pop(</span><span class="s2">'dicttype'</span><span class="s0">).value)</span>

	<span class="s3">def </span><span class="s0">ps_end(self):</span>
		<span class="s3">if </span><span class="s0">len(self.dictstack) &gt; </span><span class="s1">2</span><span class="s0">:</span>
			<span class="s3">del </span><span class="s0">self.dictstack[-</span><span class="s1">1</span><span class="s0">]</span>
		<span class="s3">else</span><span class="s0">:</span>
			<span class="s3">raise </span><span class="s0">RuntimeError(</span><span class="s2">'dictstack underflow'</span><span class="s0">)</span>

<span class="s0">notdef = </span><span class="s2">'.notdef'</span>
<span class="s3">from </span><span class="s0">fontTools.encodings.StandardEncoding </span><span class="s3">import </span><span class="s0">StandardEncoding</span>
<span class="s0">ps_StandardEncoding = list(map(ps_name</span><span class="s3">, </span><span class="s0">StandardEncoding))</span>
</pre>
</body>
</html>