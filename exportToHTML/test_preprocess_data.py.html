<html>
<head>
<title>test_preprocess_data.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_preprocess_data.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">import </span><span class="s1">sys</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">_preprocess_data</span>
<span class="s0">from </span><span class="s1">matplotlib.axes </span><span class="s0">import </span><span class="s1">Axes</span>
<span class="s0">from </span><span class="s1">matplotlib.testing.decorators </span><span class="s0">import </span><span class="s1">check_figures_equal</span>

<span class="s2"># Notes on testing the plotting functions itself</span>
<span class="s2"># *   the individual decorated plotting functions are tested in 'test_axes.py'</span>
<span class="s2"># *   that pyplot functions accept a data kwarg is only tested in</span>
<span class="s2">#     test_axes.test_pie_linewidth_0</span>


<span class="s2"># this gets used in multiple tests, so define it here</span>
<span class="s1">@_preprocess_data(replace_names=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">label_namer=</span><span class="s3">&quot;y&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">plot_func(ax</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">ls=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s0">None, </span><span class="s1">w=</span><span class="s3">&quot;xyz&quot;</span><span class="s1">):</span>
    <span class="s0">return </span><span class="s1">(</span><span class="s3">&quot;x: %s, y: %s, ls: %s, w: %s, label: %s&quot; </span><span class="s1">% (</span>
        <span class="s1">list(x)</span><span class="s0">, </span><span class="s1">list(y)</span><span class="s0">, </span><span class="s1">ls</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">label))</span>


<span class="s1">all_funcs = [plot_func]</span>
<span class="s1">all_func_ids = [</span><span class="s3">'plot_func'</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_compiletime_checks():</span>
    <span class="s4">&quot;&quot;&quot;Test decorator invocations -&gt; no replacements.&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">func(ax</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y): </span><span class="s0">pass</span>
    <span class="s0">def </span><span class="s1">func_args(ax</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">*args): </span><span class="s0">pass</span>
    <span class="s0">def </span><span class="s1">func_kwargs(ax</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">**kwargs): </span><span class="s0">pass</span>
    <span class="s0">def </span><span class="s1">func_no_ax_args(*args</span><span class="s0">, </span><span class="s1">**kwargs): </span><span class="s0">pass</span>

    <span class="s2"># this is ok</span>
    <span class="s1">_preprocess_data(replace_names=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">])(func)</span>
    <span class="s1">_preprocess_data(replace_names=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">])(func_kwargs)</span>
    <span class="s2"># this has &quot;enough&quot; information to do all the replaces</span>
    <span class="s1">_preprocess_data(replace_names=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">])(func_args)</span>

    <span class="s2"># no positional_parameter_names but needed due to replaces</span>
    <span class="s0">with </span><span class="s1">pytest.raises(AssertionError):</span>
        <span class="s2"># z is unknown</span>
        <span class="s1">_preprocess_data(replace_names=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">])(func_args)</span>

    <span class="s2"># no replacements at all -&gt; all ok...</span>
    <span class="s1">_preprocess_data(replace_names=[]</span><span class="s0">, </span><span class="s1">label_namer=</span><span class="s0">None</span><span class="s1">)(func)</span>
    <span class="s1">_preprocess_data(replace_names=[]</span><span class="s0">, </span><span class="s1">label_namer=</span><span class="s0">None</span><span class="s1">)(func_args)</span>
    <span class="s1">_preprocess_data(replace_names=[]</span><span class="s0">, </span><span class="s1">label_namer=</span><span class="s0">None</span><span class="s1">)(func_kwargs)</span>
    <span class="s1">_preprocess_data(replace_names=[]</span><span class="s0">, </span><span class="s1">label_namer=</span><span class="s0">None</span><span class="s1">)(func_no_ax_args)</span>

    <span class="s2"># label namer is unknown</span>
    <span class="s0">with </span><span class="s1">pytest.raises(AssertionError):</span>
        <span class="s1">_preprocess_data(label_namer=</span><span class="s3">&quot;z&quot;</span><span class="s1">)(func)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(AssertionError):</span>
        <span class="s1">_preprocess_data(label_namer=</span><span class="s3">&quot;z&quot;</span><span class="s1">)(func_args)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'func'</span><span class="s0">, </span><span class="s1">all_funcs</span><span class="s0">, </span><span class="s1">ids=all_func_ids)</span>
<span class="s0">def </span><span class="s1">test_function_call_without_data(func):</span>
    <span class="s4">&quot;&quot;&quot;Test without data -&gt; no replacements.&quot;&quot;&quot;</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">) ==</span>
            <span class="s3">&quot;x: ['x'], y: ['y'], ls: x, w: xyz, label: None&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;y&quot;</span><span class="s1">) ==</span>
            <span class="s3">&quot;x: ['x'], y: ['y'], ls: x, w: xyz, label: None&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;&quot;</span><span class="s1">) ==</span>
            <span class="s3">&quot;x: ['x'], y: ['y'], ls: x, w: xyz, label: &quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;text&quot;</span><span class="s1">) ==</span>
            <span class="s3">&quot;x: ['x'], y: ['y'], ls: x, w: xyz, label: text&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;&quot;</span><span class="s1">) ==</span>
            <span class="s3">&quot;x: ['x'], y: ['y'], ls: x, w: xyz, label: &quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;text&quot;</span><span class="s1">) ==</span>
            <span class="s3">&quot;x: ['x'], y: ['y'], ls: x, w: xyz, label: text&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'func'</span><span class="s0">, </span><span class="s1">all_funcs</span><span class="s0">, </span><span class="s1">ids=all_func_ids)</span>
<span class="s0">def </span><span class="s1">test_function_call_with_dict_input(func):</span>
    <span class="s4">&quot;&quot;&quot;Tests with dict input, unpacking via preprocess_pipeline&quot;&quot;&quot;</span>
    <span class="s1">data = {</span><span class="s3">'a'</span><span class="s1">: </span><span class="s5">1</span><span class="s0">, </span><span class="s3">'b'</span><span class="s1">: </span><span class="s5">2</span><span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s1">data.keys()</span><span class="s0">, </span><span class="s1">data.values()) ==</span>
            <span class="s3">&quot;x: ['a', 'b'], y: [1, 2], ls: x, w: xyz, label: None&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'func'</span><span class="s0">, </span><span class="s1">all_funcs</span><span class="s0">, </span><span class="s1">ids=all_func_ids)</span>
<span class="s0">def </span><span class="s1">test_function_call_with_dict_data(func):</span>
    <span class="s4">&quot;&quot;&quot;Test with dict data -&gt; label comes from the value of 'x' parameter.&quot;&quot;&quot;</span>
    <span class="s1">data = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s5">8</span><span class="s0">, </span><span class="s5">9</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;w&quot;</span><span class="s1">: </span><span class="s3">&quot;NOT&quot;</span><span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: b&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: b&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: &quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;text&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: text&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: &quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;text&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: text&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'func'</span><span class="s0">, </span><span class="s1">all_funcs</span><span class="s0">, </span><span class="s1">ids=all_func_ids)</span>
<span class="s0">def </span><span class="s1">test_function_call_with_dict_data_not_in_data(func):</span>
    <span class="s4">&quot;&quot;&quot;Test the case that one var is not in data -&gt; half replaces, half kept&quot;&quot;&quot;</span>
    <span class="s1">data = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;w&quot;</span><span class="s1">: </span><span class="s3">&quot;NOT&quot;</span><span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: ['b'], ls: x, w: xyz, label: b&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: ['b'], ls: x, w: xyz, label: b&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: ['b'], ls: x, w: xyz, label: &quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;text&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: ['b'], ls: x, w: xyz, label: text&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: ['b'], ls: x, w: xyz, label: &quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;text&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: ['b'], ls: x, w: xyz, label: text&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'func'</span><span class="s0">, </span><span class="s1">all_funcs</span><span class="s0">, </span><span class="s1">ids=all_func_ids)</span>
<span class="s0">def </span><span class="s1">test_function_call_with_pandas_data(func</span><span class="s0">, </span><span class="s1">pd):</span>
    <span class="s4">&quot;&quot;&quot;Test with pandas dataframe -&gt; label comes from ``data[&quot;col&quot;].name``.&quot;&quot;&quot;</span>
    <span class="s1">data = pd.DataFrame({</span><span class="s3">&quot;a&quot;</span><span class="s1">: np.array([</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">,</span>
                         <span class="s3">&quot;b&quot;</span><span class="s1">: np.array([</span><span class="s5">8</span><span class="s0">, </span><span class="s5">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">,</span>
                         <span class="s3">&quot;w&quot;</span><span class="s1">: [</span><span class="s3">&quot;NOT&quot;</span><span class="s0">, </span><span class="s3">&quot;NOT&quot;</span><span class="s1">]})</span>

    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: b&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: b&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: &quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;text&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: text&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: &quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;text&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: text&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_function_call_replace_all():</span>
    <span class="s4">&quot;&quot;&quot;Test without a &quot;replace_names&quot; argument, all vars should be replaced.&quot;&quot;&quot;</span>
    <span class="s1">data = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s5">8</span><span class="s0">, </span><span class="s5">9</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">: </span><span class="s3">&quot;xyz&quot;</span><span class="s1">}</span>

    <span class="s1">@_preprocess_data(label_namer=</span><span class="s3">&quot;y&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">func_replace_all(ax</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">ls=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s0">None, </span><span class="s1">w=</span><span class="s3">&quot;NOT&quot;</span><span class="s1">):</span>
        <span class="s0">return </span><span class="s3">&quot;x: %s, y: %s, ls: %s, w: %s, label: %s&quot; </span><span class="s1">% (</span>
            <span class="s1">list(x)</span><span class="s0">, </span><span class="s1">list(y)</span><span class="s0">, </span><span class="s1">ls</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">label)</span>

    <span class="s0">assert </span><span class="s1">(func_replace_all(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">w=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: b&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func_replace_all(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">w=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: b&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func_replace_all(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">w=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: &quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">func_replace_all(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">w=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;text&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
        <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: text&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">func_replace_all(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">w=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
        <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: &quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">func_replace_all(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">w=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;text&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
        <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: text&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_no_label_replacements():</span>
    <span class="s4">&quot;&quot;&quot;Test with &quot;label_namer=None&quot; -&gt; no label replacement at all.&quot;&quot;&quot;</span>

    <span class="s1">@_preprocess_data(replace_names=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">label_namer=</span><span class="s0">None</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">func_no_label(ax</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">ls=</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s0">None, </span><span class="s1">w=</span><span class="s3">&quot;xyz&quot;</span><span class="s1">):</span>
        <span class="s0">return </span><span class="s3">&quot;x: %s, y: %s, ls: %s, w: %s, label: %s&quot; </span><span class="s1">% (</span>
            <span class="s1">list(x)</span><span class="s0">, </span><span class="s1">list(y)</span><span class="s0">, </span><span class="s1">ls</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">label)</span>

    <span class="s1">data = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s5">8</span><span class="s0">, </span><span class="s5">9</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;w&quot;</span><span class="s1">: </span><span class="s3">&quot;NOT&quot;</span><span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">(func_no_label(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: None&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func_no_label(</span><span class="s0">None, </span><span class="s1">x=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">y=</span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: None&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func_no_label(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: &quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(func_no_label(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">label=</span><span class="s3">&quot;text&quot;</span><span class="s0">, </span><span class="s1">data=data) ==</span>
            <span class="s3">&quot;x: [1, 2], y: [8, 9], ls: x, w: xyz, label: text&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_more_args_than_pos_parameter():</span>
    <span class="s1">@_preprocess_data(replace_names=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">label_namer=</span><span class="s3">&quot;y&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">func(ax</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z=</span><span class="s5">1</span><span class="s1">):</span>
        <span class="s0">pass</span>

    <span class="s1">data = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: [</span><span class="s5">8</span><span class="s0">, </span><span class="s5">9</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;w&quot;</span><span class="s1">: </span><span class="s3">&quot;NOT&quot;</span><span class="s1">}</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">func(</span><span class="s0">None, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s0">, </span><span class="s1">data=data)</span>


<span class="s0">def </span><span class="s1">test_docstring_addition():</span>
    <span class="s1">@_preprocess_data()</span>
    <span class="s0">def </span><span class="s1">funcy(ax</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s4">&quot;&quot;&quot; 
        Parameters 
        ---------- 
        data : indexable object, optional 
            DATA_PARAMETER_PLACEHOLDER 
        &quot;&quot;&quot;</span>

    <span class="s0">assert </span><span class="s1">re.search(</span><span class="s3">r&quot;all parameters also accept a string&quot;</span><span class="s0">, </span><span class="s1">funcy.__doc__)</span>
    <span class="s0">assert not </span><span class="s1">re.search(</span><span class="s3">r&quot;the following parameters&quot;</span><span class="s0">, </span><span class="s1">funcy.__doc__)</span>

    <span class="s1">@_preprocess_data(replace_names=[])</span>
    <span class="s0">def </span><span class="s1">funcy(ax</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z</span><span class="s0">, </span><span class="s1">bar=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Parameters 
        ---------- 
        data : indexable object, optional 
            DATA_PARAMETER_PLACEHOLDER 
        &quot;&quot;&quot;</span>

    <span class="s0">assert not </span><span class="s1">re.search(</span><span class="s3">r&quot;all parameters also accept a string&quot;</span><span class="s0">, </span><span class="s1">funcy.__doc__)</span>
    <span class="s0">assert not </span><span class="s1">re.search(</span><span class="s3">r&quot;the following parameters&quot;</span><span class="s0">, </span><span class="s1">funcy.__doc__)</span>

    <span class="s1">@_preprocess_data(replace_names=[</span><span class="s3">&quot;bar&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">funcy(ax</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z</span><span class="s0">, </span><span class="s1">bar=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Parameters 
        ---------- 
        data : indexable object, optional 
            DATA_PARAMETER_PLACEHOLDER 
        &quot;&quot;&quot;</span>

    <span class="s0">assert not </span><span class="s1">re.search(</span><span class="s3">r&quot;all parameters also accept a string&quot;</span><span class="s0">, </span><span class="s1">funcy.__doc__)</span>
    <span class="s0">assert not </span><span class="s1">re.search(</span><span class="s3">r&quot;the following parameters .*: \*bar\*\.&quot;</span><span class="s0">,</span>
                         <span class="s1">funcy.__doc__)</span>

    <span class="s1">@_preprocess_data(replace_names=[</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;t&quot;</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">funcy(ax</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z</span><span class="s0">, </span><span class="s1">t=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Parameters 
        ---------- 
        data : indexable object, optional 
            DATA_PARAMETER_PLACEHOLDER 
        &quot;&quot;&quot;</span>

    <span class="s0">assert not </span><span class="s1">re.search(</span><span class="s3">r&quot;all parameters also accept a string&quot;</span><span class="s0">, </span><span class="s1">funcy.__doc__)</span>
    <span class="s0">assert not </span><span class="s1">re.search(</span><span class="s3">r&quot;the following parameters .*: \*x\*, \*t\*\.&quot;</span><span class="s0">,</span>
                         <span class="s1">funcy.__doc__)</span>


<span class="s0">def </span><span class="s1">test_data_parameter_replacement():</span>
    <span class="s4">&quot;&quot;&quot; 
    Test that the docstring contains the correct *data* parameter stub 
    for all methods that we run _preprocess_data() on. 
    &quot;&quot;&quot;</span>
    <span class="s1">program = (</span>
        <span class="s3">&quot;import logging; &quot;</span>
        <span class="s3">&quot;logging.basicConfig(level=logging.DEBUG); &quot;</span>
        <span class="s3">&quot;import matplotlib.pyplot as plt&quot;</span>
    <span class="s1">)</span>
    <span class="s1">cmd = [sys.executable</span><span class="s0">, </span><span class="s3">&quot;-c&quot;</span><span class="s0">, </span><span class="s1">program]</span>
    <span class="s1">completed_proc = subprocess.run(cmd</span><span class="s0">, </span><span class="s1">text=</span><span class="s0">True, </span><span class="s1">capture_output=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s3">'data parameter docstring error' </span><span class="s0">not in </span><span class="s1">completed_proc.stderr</span>


<span class="s0">class </span><span class="s1">TestPlotTypes:</span>

    <span class="s1">plotters = [Axes.scatter</span><span class="s0">, </span><span class="s1">Axes.bar</span><span class="s0">, </span><span class="s1">Axes.plot]</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'plotter'</span><span class="s0">, </span><span class="s1">plotters)</span>
    <span class="s1">@check_figures_equal(extensions=[</span><span class="s3">'png'</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_dict_unpack(self</span><span class="s0">, </span><span class="s1">plotter</span><span class="s0">, </span><span class="s1">fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
        <span class="s1">x = [</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">]</span>
        <span class="s1">y = [</span><span class="s5">4</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">6</span><span class="s1">]</span>
        <span class="s1">ddict = dict(zip(x</span><span class="s0">, </span><span class="s1">y))</span>

        <span class="s1">plotter(fig_test.subplots()</span><span class="s0">,</span>
                <span class="s1">ddict.keys()</span><span class="s0">, </span><span class="s1">ddict.values())</span>
        <span class="s1">plotter(fig_ref.subplots()</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'plotter'</span><span class="s0">, </span><span class="s1">plotters)</span>
    <span class="s1">@check_figures_equal(extensions=[</span><span class="s3">'png'</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_data_kwarg(self</span><span class="s0">, </span><span class="s1">plotter</span><span class="s0">, </span><span class="s1">fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
        <span class="s1">x = [</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">]</span>
        <span class="s1">y = [</span><span class="s5">4</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">6</span><span class="s1">]</span>

        <span class="s1">plotter(fig_test.subplots()</span><span class="s0">, </span><span class="s3">'xval'</span><span class="s0">, </span><span class="s3">'yval'</span><span class="s0">,</span>
                <span class="s1">data={</span><span class="s3">'xval'</span><span class="s1">: x</span><span class="s0">, </span><span class="s3">'yval'</span><span class="s1">: y})</span>
        <span class="s1">plotter(fig_ref.subplots()</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y)</span>
</pre>
</body>
</html>