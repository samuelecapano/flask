<html>
<head>
<title>test_backend_pdf.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #a5c261;}
.s5 { color: #808080;}
.s6 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_backend_pdf.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">import </span><span class="s1">decimal</span>
<span class="s0">import </span><span class="s1">io</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">from </span><span class="s1">tempfile </span><span class="s0">import </span><span class="s1">NamedTemporaryFile</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span><span class="s0">, </span><span class="s1">rcParams</span><span class="s0">, </span><span class="s1">font_manager </span><span class="s0">as </span><span class="s1">fm</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">matplotlib.cbook </span><span class="s0">import </span><span class="s1">_get_data_path</span>
<span class="s0">from </span><span class="s1">matplotlib.ft2font </span><span class="s0">import </span><span class="s1">FT2Font</span>
<span class="s0">from </span><span class="s1">matplotlib.font_manager </span><span class="s0">import </span><span class="s1">findfont</span><span class="s0">, </span><span class="s1">FontProperties</span>
<span class="s0">from </span><span class="s1">matplotlib.backends._backend_pdf_ps </span><span class="s0">import </span><span class="s1">get_glyphs_subset</span>
<span class="s0">from </span><span class="s1">matplotlib.backends.backend_pdf </span><span class="s0">import </span><span class="s1">PdfPages</span>
<span class="s0">from </span><span class="s1">matplotlib.patches </span><span class="s0">import </span><span class="s1">Rectangle</span>
<span class="s0">from </span><span class="s1">matplotlib.testing.decorators </span><span class="s0">import </span><span class="s1">check_figures_equal</span><span class="s0">, </span><span class="s1">image_comparison</span>
<span class="s0">from </span><span class="s1">matplotlib.testing._markers </span><span class="s0">import </span><span class="s1">needs_usetex</span>


<span class="s1">@image_comparison([</span><span class="s2">'pdf_use14corefonts.pdf'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_use14corefonts():</span>
    <span class="s1">rcParams[</span><span class="s2">'pdf.use14corefonts'</span><span class="s1">] = </span><span class="s0">True</span>
    <span class="s1">rcParams[</span><span class="s2">'font.family'</span><span class="s1">] = </span><span class="s2">'sans-serif'</span>
    <span class="s1">rcParams[</span><span class="s2">'font.size'</span><span class="s1">] = </span><span class="s3">8</span>
    <span class="s1">rcParams[</span><span class="s2">'font.sans-serif'</span><span class="s1">] = [</span><span class="s2">'Helvetica'</span><span class="s1">]</span>
    <span class="s1">rcParams[</span><span class="s2">'pdf.compression'</span><span class="s1">] = </span><span class="s3">0</span>

    <span class="s1">text = </span><span class="s2">'''A three-line text positioned just above a blue line 
and containing some French characters and the euro symbol: 
&quot;Merci pépé pour les 10 €&quot;'''</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.set_title(</span><span class="s2">'Test PDF backend with option use14corefonts=True'</span><span class="s1">)</span>
    <span class="s1">ax.text(</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">text</span><span class="s0">, </span><span class="s1">horizontalalignment=</span><span class="s2">'center'</span><span class="s0">,</span>
            <span class="s1">verticalalignment=</span><span class="s2">'bottom'</span><span class="s0">,</span>
            <span class="s1">fontsize=</span><span class="s3">14</span><span class="s1">)</span>
    <span class="s1">ax.axhline(</span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">linewidth=</span><span class="s3">0.5</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">'fontname, fontfile'</span><span class="s0">, </span><span class="s1">[</span>
    <span class="s1">(</span><span class="s2">'DejaVu Sans'</span><span class="s0">, </span><span class="s2">'DejaVuSans.ttf'</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">(</span><span class="s2">'WenQuanYi Zen Hei'</span><span class="s0">, </span><span class="s2">'wqy-zenhei.ttc'</span><span class="s1">)</span><span class="s0">,</span>
<span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">'fonttype'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">42</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_embed_fonts(fontname</span><span class="s0">, </span><span class="s1">fontfile</span><span class="s0">, </span><span class="s1">fonttype):</span>
    <span class="s0">if </span><span class="s1">Path(findfont(FontProperties(family=[fontname]))).name != fontfile:</span>
        <span class="s1">pytest.skip(</span><span class="s2">f'Font </span><span class="s0">{</span><span class="s1">fontname</span><span class="s0">!r} </span><span class="s2">may be missing'</span><span class="s1">)</span>

    <span class="s1">rcParams[</span><span class="s2">'pdf.fonttype'</span><span class="s1">] = fonttype</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.plot([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">ax.set_title(</span><span class="s2">'Axes Title'</span><span class="s0">, </span><span class="s1">font=fontname)</span>
    <span class="s1">fig.savefig(io.BytesIO()</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'pdf'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_multipage_pagecount():</span>
    <span class="s0">with </span><span class="s1">PdfPages(io.BytesIO()) </span><span class="s0">as </span><span class="s1">pdf:</span>
        <span class="s0">assert </span><span class="s1">pdf.get_pagecount() == </span><span class="s3">0</span>
        <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
        <span class="s1">ax.plot([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">fig.savefig(pdf</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;pdf&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">pdf.get_pagecount() == </span><span class="s3">1</span>
        <span class="s1">pdf.savefig()</span>
        <span class="s0">assert </span><span class="s1">pdf.get_pagecount() == </span><span class="s3">2</span>


<span class="s0">def </span><span class="s1">test_multipage_properfinalize():</span>
    <span class="s1">pdfio = io.BytesIO()</span>
    <span class="s0">with </span><span class="s1">PdfPages(pdfio) </span><span class="s0">as </span><span class="s1">pdf:</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">10</span><span class="s1">):</span>
            <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
            <span class="s1">ax.set_title(</span><span class="s2">'This is a long title'</span><span class="s1">)</span>
            <span class="s1">fig.savefig(pdf</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;pdf&quot;</span><span class="s1">)</span>
    <span class="s1">s = pdfio.getvalue()</span>
    <span class="s0">assert </span><span class="s1">s.count(</span><span class="s4">b'startxref'</span><span class="s1">) == </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">len(s) &lt; </span><span class="s3">40000</span>


<span class="s0">def </span><span class="s1">test_multipage_keep_empty():</span>
    <span class="s5"># test empty pdf files</span>
    <span class="s5"># test that an empty pdf is left behind with keep_empty=True (default)</span>
    <span class="s0">with </span><span class="s1">NamedTemporaryFile(delete=</span><span class="s0">False</span><span class="s1">) </span><span class="s0">as </span><span class="s1">tmp:</span>
        <span class="s0">with </span><span class="s1">PdfPages(tmp) </span><span class="s0">as </span><span class="s1">pdf:</span>
            <span class="s1">filename = pdf._file.fh.name</span>
        <span class="s0">assert </span><span class="s1">os.path.exists(filename)</span>
    <span class="s1">os.remove(filename)</span>
    <span class="s5"># test if an empty pdf is deleting itself afterwards with keep_empty=False</span>
    <span class="s0">with </span><span class="s1">PdfPages(filename</span><span class="s0">, </span><span class="s1">keep_empty=</span><span class="s0">False</span><span class="s1">) </span><span class="s0">as </span><span class="s1">pdf:</span>
        <span class="s0">pass</span>
    <span class="s0">assert not </span><span class="s1">os.path.exists(filename)</span>
    <span class="s5"># test pdf files with content, they should never be deleted</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.plot([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s5"># test that a non-empty pdf is left behind with keep_empty=True (default)</span>
    <span class="s0">with </span><span class="s1">NamedTemporaryFile(delete=</span><span class="s0">False</span><span class="s1">) </span><span class="s0">as </span><span class="s1">tmp:</span>
        <span class="s0">with </span><span class="s1">PdfPages(tmp) </span><span class="s0">as </span><span class="s1">pdf:</span>
            <span class="s1">filename = pdf._file.fh.name</span>
            <span class="s1">pdf.savefig()</span>
        <span class="s0">assert </span><span class="s1">os.path.exists(filename)</span>
    <span class="s1">os.remove(filename)</span>
    <span class="s5"># test that a non-empty pdf is left behind with keep_empty=False</span>
    <span class="s0">with </span><span class="s1">NamedTemporaryFile(delete=</span><span class="s0">False</span><span class="s1">) </span><span class="s0">as </span><span class="s1">tmp:</span>
        <span class="s0">with </span><span class="s1">PdfPages(tmp</span><span class="s0">, </span><span class="s1">keep_empty=</span><span class="s0">False</span><span class="s1">) </span><span class="s0">as </span><span class="s1">pdf:</span>
            <span class="s1">filename = pdf._file.fh.name</span>
            <span class="s1">pdf.savefig()</span>
        <span class="s0">assert </span><span class="s1">os.path.exists(filename)</span>
    <span class="s1">os.remove(filename)</span>


<span class="s0">def </span><span class="s1">test_composite_image():</span>
    <span class="s5"># Test that figures can be saved with and without combining multiple images</span>
    <span class="s5"># (on a single set of axes) into a single composite image.</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">Y = np.meshgrid(np.arange(-</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(-</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">Z = np.sin(Y ** </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.set_xlim(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">ax.imshow(Z</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">ax.imshow(Z[::-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">extent=[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">plt.rcParams[</span><span class="s2">'image.composite_image'</span><span class="s1">] = </span><span class="s0">True</span>
    <span class="s0">with </span><span class="s1">PdfPages(io.BytesIO()) </span><span class="s0">as </span><span class="s1">pdf:</span>
        <span class="s1">fig.savefig(pdf</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;pdf&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">len(pdf._file._images) == </span><span class="s3">1</span>
    <span class="s1">plt.rcParams[</span><span class="s2">'image.composite_image'</span><span class="s1">] = </span><span class="s0">False</span>
    <span class="s0">with </span><span class="s1">PdfPages(io.BytesIO()) </span><span class="s0">as </span><span class="s1">pdf:</span>
        <span class="s1">fig.savefig(pdf</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;pdf&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">len(pdf._file._images) == </span><span class="s3">2</span>


<span class="s0">def </span><span class="s1">test_savefig_metadata(monkeypatch):</span>
    <span class="s1">pikepdf = pytest.importorskip(</span><span class="s2">'pikepdf'</span><span class="s1">)</span>
    <span class="s1">monkeypatch.setenv(</span><span class="s2">'SOURCE_DATE_EPOCH'</span><span class="s0">, </span><span class="s2">'0'</span><span class="s1">)</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.plot(range(</span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">md = {</span>
        <span class="s2">'Author'</span><span class="s1">: </span><span class="s2">'me'</span><span class="s0">,</span>
        <span class="s2">'Title'</span><span class="s1">: </span><span class="s2">'Multipage PDF'</span><span class="s0">,</span>
        <span class="s2">'Subject'</span><span class="s1">: </span><span class="s2">'Test page'</span><span class="s0">,</span>
        <span class="s2">'Keywords'</span><span class="s1">: </span><span class="s2">'test,pdf,multipage'</span><span class="s0">,</span>
        <span class="s2">'ModDate'</span><span class="s1">: datetime.datetime(</span>
            <span class="s3">1968</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">tzinfo=datetime.timezone(datetime.timedelta(</span><span class="s3">0</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s2">'Trapped'</span><span class="s1">: </span><span class="s2">'True'</span>
    <span class="s1">}</span>
    <span class="s1">buf = io.BytesIO()</span>
    <span class="s1">fig.savefig(buf</span><span class="s0">, </span><span class="s1">metadata=md</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'pdf'</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pikepdf.Pdf.open(buf) </span><span class="s0">as </span><span class="s1">pdf:</span>
        <span class="s1">info = {k: str(v) </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">pdf.docinfo.items()}</span>

    <span class="s0">assert </span><span class="s1">info == {</span>
        <span class="s2">'/Author'</span><span class="s1">: </span><span class="s2">'me'</span><span class="s0">,</span>
        <span class="s2">'/CreationDate'</span><span class="s1">: </span><span class="s2">'D:19700101000000Z'</span><span class="s0">,</span>
        <span class="s2">'/Creator'</span><span class="s1">: </span><span class="s2">f'Matplotlib v</span><span class="s0">{</span><span class="s1">mpl.__version__</span><span class="s0">}</span><span class="s2">, https://matplotlib.org'</span><span class="s0">,</span>
        <span class="s2">'/Keywords'</span><span class="s1">: </span><span class="s2">'test,pdf,multipage'</span><span class="s0">,</span>
        <span class="s2">'/ModDate'</span><span class="s1">: </span><span class="s2">'D:19680801000000Z'</span><span class="s0">,</span>
        <span class="s2">'/Producer'</span><span class="s1">: </span><span class="s2">f'Matplotlib pdf backend v</span><span class="s0">{</span><span class="s1">mpl.__version__</span><span class="s0">}</span><span class="s2">'</span><span class="s0">,</span>
        <span class="s2">'/Subject'</span><span class="s1">: </span><span class="s2">'Test page'</span><span class="s0">,</span>
        <span class="s2">'/Title'</span><span class="s1">: </span><span class="s2">'Multipage PDF'</span><span class="s0">,</span>
        <span class="s2">'/Trapped'</span><span class="s1">: </span><span class="s2">'/True'</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">def </span><span class="s1">test_invalid_metadata():</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>

    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">,</span>
                      <span class="s1">match=</span><span class="s2">&quot;Unknown infodict keyword: 'foobar'.&quot;</span><span class="s1">):</span>
        <span class="s1">fig.savefig(io.BytesIO()</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'pdf'</span><span class="s0">, </span><span class="s1">metadata={</span><span class="s2">'foobar'</span><span class="s1">: </span><span class="s2">'invalid'</span><span class="s1">})</span>

    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">,</span>
                      <span class="s1">match=</span><span class="s2">'not an instance of datetime.datetime.'</span><span class="s1">):</span>
        <span class="s1">fig.savefig(io.BytesIO()</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'pdf'</span><span class="s0">,</span>
                    <span class="s1">metadata={</span><span class="s2">'ModDate'</span><span class="s1">: </span><span class="s2">'1968-08-01'</span><span class="s1">})</span>

    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">,</span>
                      <span class="s1">match=</span><span class="s2">'not one of {&quot;True&quot;, &quot;False&quot;, &quot;Unknown&quot;}'</span><span class="s1">):</span>
        <span class="s1">fig.savefig(io.BytesIO()</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'pdf'</span><span class="s0">, </span><span class="s1">metadata={</span><span class="s2">'Trapped'</span><span class="s1">: </span><span class="s2">'foo'</span><span class="s1">})</span>

    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">'not an instance of str.'</span><span class="s1">):</span>
        <span class="s1">fig.savefig(io.BytesIO()</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'pdf'</span><span class="s0">, </span><span class="s1">metadata={</span><span class="s2">'Title'</span><span class="s1">: </span><span class="s3">1234</span><span class="s1">})</span>


<span class="s0">def </span><span class="s1">test_multipage_metadata(monkeypatch):</span>
    <span class="s1">pikepdf = pytest.importorskip(</span><span class="s2">'pikepdf'</span><span class="s1">)</span>
    <span class="s1">monkeypatch.setenv(</span><span class="s2">'SOURCE_DATE_EPOCH'</span><span class="s0">, </span><span class="s2">'0'</span><span class="s1">)</span>

    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.plot(range(</span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">md = {</span>
        <span class="s2">'Author'</span><span class="s1">: </span><span class="s2">'me'</span><span class="s0">,</span>
        <span class="s2">'Title'</span><span class="s1">: </span><span class="s2">'Multipage PDF'</span><span class="s0">,</span>
        <span class="s2">'Subject'</span><span class="s1">: </span><span class="s2">'Test page'</span><span class="s0">,</span>
        <span class="s2">'Keywords'</span><span class="s1">: </span><span class="s2">'test,pdf,multipage'</span><span class="s0">,</span>
        <span class="s2">'ModDate'</span><span class="s1">: datetime.datetime(</span>
            <span class="s3">1968</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">tzinfo=datetime.timezone(datetime.timedelta(</span><span class="s3">0</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s2">'Trapped'</span><span class="s1">: </span><span class="s2">'True'</span>
    <span class="s1">}</span>
    <span class="s1">buf = io.BytesIO()</span>
    <span class="s0">with </span><span class="s1">PdfPages(buf</span><span class="s0">, </span><span class="s1">metadata=md) </span><span class="s0">as </span><span class="s1">pdf:</span>
        <span class="s1">pdf.savefig(fig)</span>
        <span class="s1">pdf.savefig(fig)</span>

    <span class="s0">with </span><span class="s1">pikepdf.Pdf.open(buf) </span><span class="s0">as </span><span class="s1">pdf:</span>
        <span class="s1">info = {k: str(v) </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">pdf.docinfo.items()}</span>

    <span class="s0">assert </span><span class="s1">info == {</span>
        <span class="s2">'/Author'</span><span class="s1">: </span><span class="s2">'me'</span><span class="s0">,</span>
        <span class="s2">'/CreationDate'</span><span class="s1">: </span><span class="s2">'D:19700101000000Z'</span><span class="s0">,</span>
        <span class="s2">'/Creator'</span><span class="s1">: </span><span class="s2">f'Matplotlib v</span><span class="s0">{</span><span class="s1">mpl.__version__</span><span class="s0">}</span><span class="s2">, https://matplotlib.org'</span><span class="s0">,</span>
        <span class="s2">'/Keywords'</span><span class="s1">: </span><span class="s2">'test,pdf,multipage'</span><span class="s0">,</span>
        <span class="s2">'/ModDate'</span><span class="s1">: </span><span class="s2">'D:19680801000000Z'</span><span class="s0">,</span>
        <span class="s2">'/Producer'</span><span class="s1">: </span><span class="s2">f'Matplotlib pdf backend v</span><span class="s0">{</span><span class="s1">mpl.__version__</span><span class="s0">}</span><span class="s2">'</span><span class="s0">,</span>
        <span class="s2">'/Subject'</span><span class="s1">: </span><span class="s2">'Test page'</span><span class="s0">,</span>
        <span class="s2">'/Title'</span><span class="s1">: </span><span class="s2">'Multipage PDF'</span><span class="s0">,</span>
        <span class="s2">'/Trapped'</span><span class="s1">: </span><span class="s2">'/True'</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">def </span><span class="s1">test_text_urls():</span>
    <span class="s1">pikepdf = pytest.importorskip(</span><span class="s2">'pikepdf'</span><span class="s1">)</span>

    <span class="s1">test_url = </span><span class="s2">'https://test_text_urls.matplotlib.org/'</span>

    <span class="s1">fig = plt.figure(figsize=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">fig.text(</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s2">'test plain 123'</span><span class="s0">, </span><span class="s1">url=</span><span class="s2">f'</span><span class="s0">{</span><span class="s1">test_url</span><span class="s0">}</span><span class="s2">plain'</span><span class="s1">)</span>
    <span class="s1">fig.text(</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.4</span><span class="s0">, </span><span class="s2">'test mathtext $123$'</span><span class="s0">, </span><span class="s1">url=</span><span class="s2">f'</span><span class="s0">{</span><span class="s1">test_url</span><span class="s0">}</span><span class="s2">mathtext'</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">io.BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'pdf'</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pikepdf.Pdf.open(fd) </span><span class="s0">as </span><span class="s1">pdf:</span>
            <span class="s1">annots = pdf.pages[</span><span class="s3">0</span><span class="s1">].Annots</span>

            <span class="s5"># Iteration over Annots must occur within the context manager,</span>
            <span class="s5"># otherwise it may fail depending on the pdf structure.</span>
            <span class="s0">for </span><span class="s1">y</span><span class="s0">, </span><span class="s1">fragment </span><span class="s0">in </span><span class="s1">[(</span><span class="s2">'0.1'</span><span class="s0">, </span><span class="s2">'plain'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">'0.4'</span><span class="s0">, </span><span class="s2">'mathtext'</span><span class="s1">)]:</span>
                <span class="s1">annot = next(</span>
                    <span class="s1">(a </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">annots </span><span class="s0">if </span><span class="s1">a.A.URI == </span><span class="s2">f'</span><span class="s0">{</span><span class="s1">test_url</span><span class="s0">}{</span><span class="s1">fragment</span><span class="s0">}</span><span class="s2">'</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s0">None</span><span class="s1">)</span>
                <span class="s0">assert </span><span class="s1">annot </span><span class="s0">is not None</span>
                <span class="s0">assert </span><span class="s1">getattr(annot</span><span class="s0">, </span><span class="s2">'QuadPoints'</span><span class="s0">, None</span><span class="s1">) </span><span class="s0">is None</span>
                <span class="s5"># Positions in points (72 per inch.)</span>
                <span class="s0">assert </span><span class="s1">annot.Rect[</span><span class="s3">1</span><span class="s1">] == decimal.Decimal(y) * </span><span class="s3">72</span>


<span class="s0">def </span><span class="s1">test_text_rotated_urls():</span>
    <span class="s1">pikepdf = pytest.importorskip(</span><span class="s2">'pikepdf'</span><span class="s1">)</span>

    <span class="s1">test_url = </span><span class="s2">'https://test_text_urls.matplotlib.org/'</span>

    <span class="s1">fig = plt.figure(figsize=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">fig.text(</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s2">'N'</span><span class="s0">, </span><span class="s1">rotation=</span><span class="s3">45</span><span class="s0">, </span><span class="s1">url=</span><span class="s2">f'</span><span class="s0">{</span><span class="s1">test_url</span><span class="s0">}</span><span class="s2">'</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">io.BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'pdf'</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pikepdf.Pdf.open(fd) </span><span class="s0">as </span><span class="s1">pdf:</span>
            <span class="s1">annots = pdf.pages[</span><span class="s3">0</span><span class="s1">].Annots</span>

            <span class="s5"># Iteration over Annots must occur within the context manager,</span>
            <span class="s5"># otherwise it may fail depending on the pdf structure.</span>
            <span class="s1">annot = next(</span>
                <span class="s1">(a </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">annots </span><span class="s0">if </span><span class="s1">a.A.URI == </span><span class="s2">f'</span><span class="s0">{</span><span class="s1">test_url</span><span class="s0">}</span><span class="s2">'</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s0">None</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">annot </span><span class="s0">is not None</span>
            <span class="s0">assert </span><span class="s1">getattr(annot</span><span class="s0">, </span><span class="s2">'QuadPoints'</span><span class="s0">, None</span><span class="s1">) </span><span class="s0">is not None</span>
            <span class="s5"># Positions in points (72 per inch)</span>
            <span class="s0">assert </span><span class="s1">annot.Rect[</span><span class="s3">0</span><span class="s1">] == \</span>
               <span class="s1">annot.QuadPoints[</span><span class="s3">6</span><span class="s1">] - decimal.Decimal(</span><span class="s2">'0.00001'</span><span class="s1">)</span>


<span class="s1">@needs_usetex</span>
<span class="s0">def </span><span class="s1">test_text_urls_tex():</span>
    <span class="s1">pikepdf = pytest.importorskip(</span><span class="s2">'pikepdf'</span><span class="s1">)</span>

    <span class="s1">test_url = </span><span class="s2">'https://test_text_urls.matplotlib.org/'</span>

    <span class="s1">fig = plt.figure(figsize=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">fig.text(</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.7</span><span class="s0">, </span><span class="s2">'test tex $123$'</span><span class="s0">, </span><span class="s1">usetex=</span><span class="s0">True, </span><span class="s1">url=</span><span class="s2">f'</span><span class="s0">{</span><span class="s1">test_url</span><span class="s0">}</span><span class="s2">tex'</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">io.BytesIO() </span><span class="s0">as </span><span class="s1">fd:</span>
        <span class="s1">fig.savefig(fd</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'pdf'</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pikepdf.Pdf.open(fd) </span><span class="s0">as </span><span class="s1">pdf:</span>
            <span class="s1">annots = pdf.pages[</span><span class="s3">0</span><span class="s1">].Annots</span>

            <span class="s5"># Iteration over Annots must occur within the context manager,</span>
            <span class="s5"># otherwise it may fail depending on the pdf structure.</span>
            <span class="s1">annot = next(</span>
                <span class="s1">(a </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">annots </span><span class="s0">if </span><span class="s1">a.A.URI == </span><span class="s2">f'</span><span class="s0">{</span><span class="s1">test_url</span><span class="s0">}</span><span class="s2">tex'</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s0">None</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">annot </span><span class="s0">is not None</span>
            <span class="s5"># Positions in points (72 per inch.)</span>
            <span class="s0">assert </span><span class="s1">annot.Rect[</span><span class="s3">1</span><span class="s1">] == decimal.Decimal(</span><span class="s2">'0.7'</span><span class="s1">) * </span><span class="s3">72</span>


<span class="s0">def </span><span class="s1">test_pdfpages_fspath():</span>
    <span class="s0">with </span><span class="s1">PdfPages(Path(os.devnull)) </span><span class="s0">as </span><span class="s1">pdf:</span>
        <span class="s1">pdf.savefig(plt.figure())</span>


<span class="s1">@image_comparison([</span><span class="s2">'hatching_legend.pdf'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_hatching_legend():</span>
    <span class="s6">&quot;&quot;&quot;Test for correct hatching on patches in legend&quot;&quot;&quot;</span>
    <span class="s1">fig = plt.figure(figsize=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">a = Rectangle([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">facecolor=</span><span class="s2">&quot;green&quot;</span><span class="s0">, </span><span class="s1">hatch=</span><span class="s2">&quot;XXXX&quot;</span><span class="s1">)</span>
    <span class="s1">b = Rectangle([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">facecolor=</span><span class="s2">&quot;blue&quot;</span><span class="s0">, </span><span class="s1">hatch=</span><span class="s2">&quot;XXXX&quot;</span><span class="s1">)</span>

    <span class="s1">fig.legend([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s1">])</span>


<span class="s1">@image_comparison([</span><span class="s2">'grayscale_alpha.pdf'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_grayscale_alpha():</span>
    <span class="s6">&quot;&quot;&quot;Masking images with NaN did not work for grayscale images&quot;&quot;&quot;</span>
    <span class="s1">x</span><span class="s0">, </span><span class="s1">y = np.ogrid[-</span><span class="s3">2</span><span class="s1">:</span><span class="s3">2</span><span class="s1">:</span><span class="s3">.1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">:</span><span class="s3">2</span><span class="s1">:</span><span class="s3">.1</span><span class="s1">]</span>
    <span class="s1">dd = np.exp(-(x**</span><span class="s3">2 </span><span class="s1">+ y**</span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">dd[dd &lt; </span><span class="s3">.1</span><span class="s1">] = np.nan</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.imshow(dd</span><span class="s0">, </span><span class="s1">interpolation=</span><span class="s2">'none'</span><span class="s0">, </span><span class="s1">cmap=</span><span class="s2">'gray_r'</span><span class="s1">)</span>
    <span class="s1">ax.set_xticks([])</span>
    <span class="s1">ax.set_yticks([])</span>


<span class="s1">@mpl.style.context(</span><span class="s2">'default'</span><span class="s1">)</span>
<span class="s1">@check_figures_equal(extensions=[</span><span class="s2">&quot;pdf&quot;</span><span class="s0">, </span><span class="s2">&quot;eps&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_pdf_eps_savefig_when_color_is_none(fig_test</span><span class="s0">, </span><span class="s1">fig_ref):</span>
    <span class="s1">ax_test = fig_test.add_subplot()</span>
    <span class="s1">ax_test.set_axis_off()</span>
    <span class="s1">ax_test.plot(np.sin(np.linspace(-</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">100</span><span class="s1">))</span><span class="s0">, </span><span class="s2">&quot;v&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s1">ax_ref = fig_ref.add_subplot()</span>
    <span class="s1">ax_ref.set_axis_off()</span>


<span class="s1">@needs_usetex</span>
<span class="s0">def </span><span class="s1">test_failing_latex():</span>
    <span class="s6">&quot;&quot;&quot;Test failing latex subprocess call&quot;&quot;&quot;</span>
    <span class="s1">plt.xlabel(</span><span class="s2">&quot;$22_2_2$&quot;</span><span class="s0">, </span><span class="s1">usetex=</span><span class="s0">True</span><span class="s1">)  </span><span class="s5"># This fails with &quot;Double subscript&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(RuntimeError):</span>
        <span class="s1">plt.savefig(io.BytesIO()</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;pdf&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_empty_rasterized():</span>
    <span class="s5"># Check that empty figures that are rasterised save to pdf files fine</span>
    <span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>
    <span class="s1">ax.plot([]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">rasterized=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">fig.savefig(io.BytesIO()</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">&quot;pdf&quot;</span><span class="s1">)</span>


<span class="s1">@image_comparison([</span><span class="s2">'kerning.pdf'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_kerning():</span>
    <span class="s1">fig = plt.figure()</span>
    <span class="s1">s = </span><span class="s2">&quot;AVAVAVAVAVAVAVAV€AAVV&quot;</span>
    <span class="s1">fig.text(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">.25</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">fig.text(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">.75</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">20</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_glyphs_subset():</span>
    <span class="s1">fpath = str(_get_data_path(</span><span class="s2">&quot;fonts/ttf/DejaVuSerif.ttf&quot;</span><span class="s1">))</span>
    <span class="s1">chars = </span><span class="s2">&quot;these should be subsetted! 1234567890&quot;</span>

    <span class="s5"># non-subsetted FT2Font</span>
    <span class="s1">nosubfont = FT2Font(fpath)</span>
    <span class="s1">nosubfont.set_text(chars)</span>

    <span class="s5"># subsetted FT2Font</span>
    <span class="s1">subfont = FT2Font(get_glyphs_subset(fpath</span><span class="s0">, </span><span class="s1">chars))</span>
    <span class="s1">subfont.set_text(chars)</span>

    <span class="s1">nosubcmap = nosubfont.get_charmap()</span>
    <span class="s1">subcmap = subfont.get_charmap()</span>

    <span class="s5"># all unique chars must be available in subsetted font</span>
    <span class="s0">assert </span><span class="s1">set(chars) == set(chr(key) </span><span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">subcmap.keys())</span>

    <span class="s5"># subsetted font's charmap should have less entries</span>
    <span class="s0">assert </span><span class="s1">len(subcmap) &lt; len(nosubcmap)</span>

    <span class="s5"># since both objects are assigned same characters</span>
    <span class="s0">assert </span><span class="s1">subfont.get_num_glyphs() == nosubfont.get_num_glyphs()</span>


<span class="s1">@image_comparison([</span><span class="s2">&quot;multi_font_type3.pdf&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">tol=</span><span class="s3">4.6</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_multi_font_type3():</span>
    <span class="s1">fp = fm.FontProperties(family=[</span><span class="s2">&quot;WenQuanYi Zen Hei&quot;</span><span class="s1">])</span>
    <span class="s0">if </span><span class="s1">Path(fm.findfont(fp)).name != </span><span class="s2">&quot;wqy-zenhei.ttc&quot;</span><span class="s1">:</span>
        <span class="s1">pytest.skip(</span><span class="s2">&quot;Font may be missing&quot;</span><span class="s1">)</span>

    <span class="s1">plt.rc(</span><span class="s2">'font'</span><span class="s0">, </span><span class="s1">family=[</span><span class="s2">'DejaVu Sans'</span><span class="s0">, </span><span class="s2">'WenQuanYi Zen Hei'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">27</span><span class="s1">)</span>
    <span class="s1">plt.rc(</span><span class="s2">'pdf'</span><span class="s0">, </span><span class="s1">fonttype=</span><span class="s3">3</span><span class="s1">)</span>

    <span class="s1">fig = plt.figure()</span>
    <span class="s1">fig.text(</span><span class="s3">0.15</span><span class="s0">, </span><span class="s3">0.475</span><span class="s0">, </span><span class="s2">&quot;There are 几个汉字 in between!&quot;</span><span class="s1">)</span>


<span class="s1">@image_comparison([</span><span class="s2">&quot;multi_font_type42.pdf&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">tol=</span><span class="s3">2.2</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_multi_font_type42():</span>
    <span class="s1">fp = fm.FontProperties(family=[</span><span class="s2">&quot;WenQuanYi Zen Hei&quot;</span><span class="s1">])</span>
    <span class="s0">if </span><span class="s1">Path(fm.findfont(fp)).name != </span><span class="s2">&quot;wqy-zenhei.ttc&quot;</span><span class="s1">:</span>
        <span class="s1">pytest.skip(</span><span class="s2">&quot;Font may be missing&quot;</span><span class="s1">)</span>

    <span class="s1">plt.rc(</span><span class="s2">'font'</span><span class="s0">, </span><span class="s1">family=[</span><span class="s2">'DejaVu Sans'</span><span class="s0">, </span><span class="s2">'WenQuanYi Zen Hei'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">27</span><span class="s1">)</span>
    <span class="s1">plt.rc(</span><span class="s2">'pdf'</span><span class="s0">, </span><span class="s1">fonttype=</span><span class="s3">42</span><span class="s1">)</span>

    <span class="s1">fig = plt.figure()</span>
    <span class="s1">fig.text(</span><span class="s3">0.15</span><span class="s0">, </span><span class="s3">0.475</span><span class="s0">, </span><span class="s2">&quot;There are 几个汉字 in between!&quot;</span><span class="s1">)</span>
</pre>
</body>
</html>