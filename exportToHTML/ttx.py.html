<html>
<head>
<title>ttx.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #808080;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ttx.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;\ 
usage: ttx [options] inputfile1 [... inputfileN] 
 
TTX -- From OpenType To XML And Back 
 
If an input file is a TrueType or OpenType font file, it will be 
decompiled to a TTX file (an XML-based text format). 
If an input file is a TTX file, it will be compiled to whatever  
format the data is in, a TrueType or OpenType/CFF font file. 
 
Output files are created so they are unique: an existing file is 
never overwritten. 
 
General options 
=============== 
 
-h Help            print this message. 
--version          show version and exit. 
-d &lt;outputfolder&gt;  Specify a directory where the output files are 
                   to be created. 
-o &lt;outputfile&gt;    Specify a file to write the output to. A special 
                   value of - would use the standard output. 
-f                 Overwrite existing output file(s), ie. don't append 
                   numbers. 
-v                 Verbose: more messages will be written to stdout 
                   about what is being done. 
-q                 Quiet: No messages will be written to stdout about 
                   what is being done. 
-a                 allow virtual glyphs ID's on compile or decompile. 
 
Dump options 
============ 
 
-l           List table info: instead of dumping to a TTX file, list 
             some minimal info about each table. 
-t &lt;table&gt;   Specify a table to dump. Multiple -t options 
             are allowed. When no -t option is specified, all tables 
             will be dumped. 
-x &lt;table&gt;   Specify a table to exclude from the dump. Multiple 
             -x options are allowed. -t and -x are mutually exclusive. 
-s           Split tables: save the TTX data into separate TTX files per 
             table and write one small TTX file that contains references 
             to the individual table dumps. This file can be used as 
             input to ttx, as long as the table files are in the 
             same directory. 
-g           Split glyf table: Save the glyf data into separate TTX files 
             per glyph and write a small TTX for the glyf table which 
             contains references to the individual TTGlyph elements. 
             NOTE: specifying -g implies -s (no need for -s together 
             with -g) 
-i           Do NOT disassemble TT instructions: when this option is 
             given, all TrueType programs (glyph programs, the font 
             program and the pre-program) will be written to the TTX 
             file as hex data instead of assembly. This saves some time 
             and makes the TTX file smaller. 
-z &lt;format&gt;  Specify a bitmap data export option for EBDT: 
             {'raw', 'row', 'bitwise', 'extfile'} or for the CBDT: 
             {'raw', 'extfile'} Each option does one of the following: 
 
             -z raw 
               export the bitmap data as a hex dump 
             -z row 
               export each row as hex data 
             -z bitwise 
               export each row as binary in an ASCII art style 
             -z extfile 
               export the data as external files with XML references 
 
             If no export format is specified 'raw' format is used. 
-e           Don't ignore decompilation errors, but show a full traceback 
             and abort. 
-y &lt;number&gt;  Select font number for TrueType Collection (.ttc/.otc), 
             starting from 0. 
--unicodedata &lt;UnicodeData.txt&gt; 
             Use custom database file to write character names in the 
             comments of the cmap TTX output. 
--newline &lt;value&gt; 
             Control how line endings are written in the XML file. It 
             can be 'LF', 'CR', or 'CRLF'. If not specified, the 
             default platform-specific line endings are used. 
 
Compile options 
=============== 
 
-m           Merge with TrueType-input-file: specify a TrueType or 
             OpenType font file to be merged with the TTX file. This 
             option is only valid when at most one TTX file is specified. 
-b           Don't recalc glyph bounding boxes: use the values in the 
             TTX file as-is. 
--recalc-timestamp 
             Set font 'modified' timestamp to current time. 
             By default, the modification time of the TTX file will be 
             used. 
--no-recalc-timestamp 
             Keep the original font 'modified' timestamp. 
--flavor &lt;type&gt; 
             Specify flavor of output font file. May be 'woff' or 'woff2'. 
             Note that WOFF2 requires the Brotli Python extension, 
             available at https://github.com/google/brotli 
--with-zopfli 
             Use Zopfli instead of Zlib to compress WOFF. The Python 
             extension is available at https://pypi.python.org/pypi/zopfli 
&quot;&quot;&quot;</span>


<span class="s2">from </span><span class="s1">fontTools.ttLib </span><span class="s2">import </span><span class="s1">TTFont</span><span class="s2">, </span><span class="s1">TTLibError</span>
<span class="s2">from </span><span class="s1">fontTools.misc.macCreatorType </span><span class="s2">import </span><span class="s1">getMacCreatorAndType</span>
<span class="s2">from </span><span class="s1">fontTools.unicode </span><span class="s2">import </span><span class="s1">setUnicodeData</span>
<span class="s2">from </span><span class="s1">fontTools.misc.textTools </span><span class="s2">import </span><span class="s1">Tag</span><span class="s2">, </span><span class="s1">tostr</span>
<span class="s2">from </span><span class="s1">fontTools.misc.timeTools </span><span class="s2">import </span><span class="s1">timestampSinceEpoch</span>
<span class="s2">from </span><span class="s1">fontTools.misc.loggingTools </span><span class="s2">import </span><span class="s1">Timer</span>
<span class="s2">from </span><span class="s1">fontTools.misc.cliTools </span><span class="s2">import </span><span class="s1">makeOutputFileName</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">getopt</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">logging</span>


<span class="s1">log = logging.getLogger(</span><span class="s3">&quot;fontTools.ttx&quot;</span><span class="s1">)</span>

<span class="s1">opentypeheaderRE = re.compile(</span><span class="s3">'''sfntVersion=['&quot;]OTTO[&quot;']'''</span><span class="s1">)</span>


<span class="s2">class </span><span class="s1">Options(object):</span>

	<span class="s1">listTables = </span><span class="s2">False</span>
	<span class="s1">outputDir = </span><span class="s2">None</span>
	<span class="s1">outputFile = </span><span class="s2">None</span>
	<span class="s1">overWrite = </span><span class="s2">False</span>
	<span class="s1">verbose = </span><span class="s2">False</span>
	<span class="s1">quiet = </span><span class="s2">False</span>
	<span class="s1">splitTables = </span><span class="s2">False</span>
	<span class="s1">splitGlyphs = </span><span class="s2">False</span>
	<span class="s1">disassembleInstructions = </span><span class="s2">True</span>
	<span class="s1">mergeFile = </span><span class="s2">None</span>
	<span class="s1">recalcBBoxes = </span><span class="s2">True</span>
	<span class="s1">ignoreDecompileErrors = </span><span class="s2">True</span>
	<span class="s1">bitmapGlyphDataFormat = </span><span class="s3">'raw'</span>
	<span class="s1">unicodedata = </span><span class="s2">None</span>
	<span class="s1">newlinestr = </span><span class="s3">&quot;</span><span class="s2">\n</span><span class="s3">&quot;</span>
	<span class="s1">recalcTimestamp = </span><span class="s2">None</span>
	<span class="s1">flavor = </span><span class="s2">None</span>
	<span class="s1">useZopfli = </span><span class="s2">False</span>

	<span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">rawOptions</span><span class="s2">, </span><span class="s1">numFiles):</span>
		<span class="s1">self.onlyTables = []</span>
		<span class="s1">self.skipTables = []</span>
		<span class="s1">self.fontNumber = -</span><span class="s4">1</span>
		<span class="s2">for </span><span class="s1">option</span><span class="s2">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">rawOptions:</span>
			<span class="s5"># general options</span>
			<span class="s2">if </span><span class="s1">option == </span><span class="s3">&quot;-h&quot;</span><span class="s1">:</span>
				<span class="s1">print(__doc__)</span>
				<span class="s1">sys.exit(</span><span class="s4">0</span><span class="s1">)</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;--version&quot;</span><span class="s1">:</span>
				<span class="s2">from </span><span class="s1">fontTools </span><span class="s2">import </span><span class="s1">version</span>
				<span class="s1">print(version)</span>
				<span class="s1">sys.exit(</span><span class="s4">0</span><span class="s1">)</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-d&quot;</span><span class="s1">:</span>
				<span class="s2">if not </span><span class="s1">os.path.isdir(value):</span>
					<span class="s2">raise </span><span class="s1">getopt.GetoptError(</span><span class="s3">&quot;The -d option value must be an existing directory&quot;</span><span class="s1">)</span>
				<span class="s1">self.outputDir = value</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-o&quot;</span><span class="s1">:</span>
				<span class="s1">self.outputFile = value</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-f&quot;</span><span class="s1">:</span>
				<span class="s1">self.overWrite = </span><span class="s2">True</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-v&quot;</span><span class="s1">:</span>
				<span class="s1">self.verbose = </span><span class="s2">True</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-q&quot;</span><span class="s1">:</span>
				<span class="s1">self.quiet = </span><span class="s2">True</span>
			<span class="s5"># dump options</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-l&quot;</span><span class="s1">:</span>
				<span class="s1">self.listTables = </span><span class="s2">True</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-t&quot;</span><span class="s1">:</span>
				<span class="s5"># pad with space if table tag length is less than 4</span>
				<span class="s1">value = value.ljust(</span><span class="s4">4</span><span class="s1">)</span>
				<span class="s1">self.onlyTables.append(value)</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-x&quot;</span><span class="s1">:</span>
				<span class="s5"># pad with space if table tag length is less than 4</span>
				<span class="s1">value = value.ljust(</span><span class="s4">4</span><span class="s1">)</span>
				<span class="s1">self.skipTables.append(value)</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-s&quot;</span><span class="s1">:</span>
				<span class="s1">self.splitTables = </span><span class="s2">True</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-g&quot;</span><span class="s1">:</span>
				<span class="s5"># -g implies (and forces) splitTables</span>
				<span class="s1">self.splitGlyphs = </span><span class="s2">True</span>
				<span class="s1">self.splitTables = </span><span class="s2">True</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-i&quot;</span><span class="s1">:</span>
				<span class="s1">self.disassembleInstructions = </span><span class="s2">False</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-z&quot;</span><span class="s1">:</span>
				<span class="s1">validOptions = (</span><span class="s3">'raw'</span><span class="s2">, </span><span class="s3">'row'</span><span class="s2">, </span><span class="s3">'bitwise'</span><span class="s2">, </span><span class="s3">'extfile'</span><span class="s1">)</span>
				<span class="s2">if </span><span class="s1">value </span><span class="s2">not in </span><span class="s1">validOptions:</span>
					<span class="s2">raise </span><span class="s1">getopt.GetoptError(</span>
						<span class="s3">&quot;-z does not allow %s as a format. Use %s&quot; </span><span class="s1">% (option</span><span class="s2">, </span><span class="s1">validOptions))</span>
				<span class="s1">self.bitmapGlyphDataFormat = value</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-y&quot;</span><span class="s1">:</span>
				<span class="s1">self.fontNumber = int(value)</span>
			<span class="s5"># compile options</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-m&quot;</span><span class="s1">:</span>
				<span class="s1">self.mergeFile = value</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-b&quot;</span><span class="s1">:</span>
				<span class="s1">self.recalcBBoxes = </span><span class="s2">False</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;-e&quot;</span><span class="s1">:</span>
				<span class="s1">self.ignoreDecompileErrors = </span><span class="s2">False</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;--unicodedata&quot;</span><span class="s1">:</span>
				<span class="s1">self.unicodedata = value</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;--newline&quot;</span><span class="s1">:</span>
				<span class="s1">validOptions = (</span><span class="s3">'LF'</span><span class="s2">, </span><span class="s3">'CR'</span><span class="s2">, </span><span class="s3">'CRLF'</span><span class="s1">)</span>
				<span class="s2">if </span><span class="s1">value == </span><span class="s3">&quot;LF&quot;</span><span class="s1">:</span>
					<span class="s1">self.newlinestr = </span><span class="s3">&quot;</span><span class="s2">\n</span><span class="s3">&quot;</span>
				<span class="s2">elif </span><span class="s1">value == </span><span class="s3">&quot;CR&quot;</span><span class="s1">:</span>
					<span class="s1">self.newlinestr = </span><span class="s3">&quot;</span><span class="s2">\r</span><span class="s3">&quot;</span>
				<span class="s2">elif </span><span class="s1">value == </span><span class="s3">&quot;CRLF&quot;</span><span class="s1">:</span>
					<span class="s1">self.newlinestr = </span><span class="s3">&quot;</span><span class="s2">\r\n</span><span class="s3">&quot;</span>
				<span class="s2">else</span><span class="s1">:</span>
					<span class="s2">raise </span><span class="s1">getopt.GetoptError(</span>
						<span class="s3">&quot;Invalid choice for --newline: %r (choose from %s)&quot;</span>
						<span class="s1">% (value</span><span class="s2">, </span><span class="s3">&quot;, &quot;</span><span class="s1">.join(map(repr</span><span class="s2">, </span><span class="s1">validOptions))))</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;--recalc-timestamp&quot;</span><span class="s1">:</span>
				<span class="s1">self.recalcTimestamp = </span><span class="s2">True</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;--no-recalc-timestamp&quot;</span><span class="s1">:</span>
				<span class="s1">self.recalcTimestamp = </span><span class="s2">False</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;--flavor&quot;</span><span class="s1">:</span>
				<span class="s1">self.flavor = value</span>
			<span class="s2">elif </span><span class="s1">option == </span><span class="s3">&quot;--with-zopfli&quot;</span><span class="s1">:</span>
				<span class="s1">self.useZopfli = </span><span class="s2">True</span>
		<span class="s2">if </span><span class="s1">self.verbose </span><span class="s2">and </span><span class="s1">self.quiet:</span>
			<span class="s2">raise </span><span class="s1">getopt.GetoptError(</span><span class="s3">&quot;-q and -v options are mutually exclusive&quot;</span><span class="s1">)</span>
		<span class="s2">if </span><span class="s1">self.verbose:</span>
			<span class="s1">self.logLevel = logging.DEBUG</span>
		<span class="s2">elif </span><span class="s1">self.quiet:</span>
			<span class="s1">self.logLevel = logging.WARNING</span>
		<span class="s2">else</span><span class="s1">:</span>
			<span class="s1">self.logLevel = logging.INFO</span>
		<span class="s2">if </span><span class="s1">self.mergeFile </span><span class="s2">and </span><span class="s1">self.flavor:</span>
			<span class="s2">raise </span><span class="s1">getopt.GetoptError(</span><span class="s3">&quot;-m and --flavor options are mutually exclusive&quot;</span><span class="s1">)</span>
		<span class="s2">if </span><span class="s1">self.onlyTables </span><span class="s2">and </span><span class="s1">self.skipTables:</span>
			<span class="s2">raise </span><span class="s1">getopt.GetoptError(</span><span class="s3">&quot;-t and -x options are mutually exclusive&quot;</span><span class="s1">)</span>
		<span class="s2">if </span><span class="s1">self.mergeFile </span><span class="s2">and </span><span class="s1">numFiles &gt; </span><span class="s4">1</span><span class="s1">:</span>
			<span class="s2">raise </span><span class="s1">getopt.GetoptError(</span><span class="s3">&quot;Must specify exactly one TTX source file when using -m&quot;</span><span class="s1">)</span>
		<span class="s2">if </span><span class="s1">self.flavor != </span><span class="s3">'woff' </span><span class="s2">and </span><span class="s1">self.useZopfli:</span>
			<span class="s2">raise </span><span class="s1">getopt.GetoptError(</span><span class="s3">&quot;--with-zopfli option requires --flavor 'woff'&quot;</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">ttList(input</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">options):</span>
	<span class="s1">ttf = TTFont(input</span><span class="s2">, </span><span class="s1">fontNumber=options.fontNumber</span><span class="s2">, </span><span class="s1">lazy=</span><span class="s2">True</span><span class="s1">)</span>
	<span class="s1">reader = ttf.reader</span>
	<span class="s1">tags = sorted(reader.keys())</span>
	<span class="s1">print(</span><span class="s3">'Listing table info for &quot;%s&quot;:' </span><span class="s1">% input)</span>
	<span class="s1">format = </span><span class="s3">&quot;    %4s  %10s  %8s  %8s&quot;</span>
	<span class="s1">print(format % (</span><span class="s3">&quot;tag &quot;</span><span class="s2">, </span><span class="s3">&quot;  checksum&quot;</span><span class="s2">, </span><span class="s3">&quot;  length&quot;</span><span class="s2">, </span><span class="s3">&quot;  offset&quot;</span><span class="s1">))</span>
	<span class="s1">print(format % (</span><span class="s3">&quot;----&quot;</span><span class="s2">, </span><span class="s3">&quot;----------&quot;</span><span class="s2">, </span><span class="s3">&quot;--------&quot;</span><span class="s2">, </span><span class="s3">&quot;--------&quot;</span><span class="s1">))</span>
	<span class="s2">for </span><span class="s1">tag </span><span class="s2">in </span><span class="s1">tags:</span>
		<span class="s1">entry = reader.tables[tag]</span>
		<span class="s2">if </span><span class="s1">ttf.flavor == </span><span class="s3">&quot;woff2&quot;</span><span class="s1">:</span>
			<span class="s5"># WOFF2 doesn't store table checksums, so they must be calculated</span>
			<span class="s2">from </span><span class="s1">fontTools.ttLib.sfnt </span><span class="s2">import </span><span class="s1">calcChecksum</span>
			<span class="s1">data = entry.loadData(reader.transformBuffer)</span>
			<span class="s1">checkSum = calcChecksum(data)</span>
		<span class="s2">else</span><span class="s1">:</span>
			<span class="s1">checkSum = int(entry.checkSum)</span>
		<span class="s2">if </span><span class="s1">checkSum &lt; </span><span class="s4">0</span><span class="s1">:</span>
			<span class="s1">checkSum = checkSum + </span><span class="s4">0x100000000</span>
		<span class="s1">checksum = </span><span class="s3">&quot;0x%08X&quot; </span><span class="s1">% checkSum</span>
		<span class="s1">print(format % (tag</span><span class="s2">, </span><span class="s1">checksum</span><span class="s2">, </span><span class="s1">entry.length</span><span class="s2">, </span><span class="s1">entry.offset))</span>
	<span class="s1">print()</span>
	<span class="s1">ttf.close()</span>


<span class="s1">@Timer(log</span><span class="s2">, </span><span class="s3">'Done dumping TTX in %(time).3f seconds'</span><span class="s1">)</span>
<span class="s2">def </span><span class="s1">ttDump(input</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">options):</span>
	<span class="s1">log.info(</span><span class="s3">'Dumping &quot;%s&quot; to &quot;%s&quot;...'</span><span class="s2">, </span><span class="s1">input</span><span class="s2">, </span><span class="s1">output)</span>
	<span class="s2">if </span><span class="s1">options.unicodedata:</span>
		<span class="s1">setUnicodeData(options.unicodedata)</span>
	<span class="s1">ttf = TTFont(input</span><span class="s2">, </span><span class="s4">0</span><span class="s2">,</span>
			<span class="s1">ignoreDecompileErrors=options.ignoreDecompileErrors</span><span class="s2">,</span>
			<span class="s1">fontNumber=options.fontNumber)</span>
	<span class="s1">ttf.saveXML(output</span><span class="s2">,</span>
			<span class="s1">tables=options.onlyTables</span><span class="s2">,</span>
			<span class="s1">skipTables=options.skipTables</span><span class="s2">,</span>
			<span class="s1">splitTables=options.splitTables</span><span class="s2">,</span>
			<span class="s1">splitGlyphs=options.splitGlyphs</span><span class="s2">,</span>
			<span class="s1">disassembleInstructions=options.disassembleInstructions</span><span class="s2">,</span>
			<span class="s1">bitmapGlyphDataFormat=options.bitmapGlyphDataFormat</span><span class="s2">,</span>
			<span class="s1">newlinestr=options.newlinestr)</span>
	<span class="s1">ttf.close()</span>


<span class="s1">@Timer(log</span><span class="s2">, </span><span class="s3">'Done compiling TTX in %(time).3f seconds'</span><span class="s1">)</span>
<span class="s2">def </span><span class="s1">ttCompile(input</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">options):</span>
	<span class="s1">log.info(</span><span class="s3">'Compiling &quot;%s&quot; to &quot;%s&quot;...' </span><span class="s1">% (input</span><span class="s2">, </span><span class="s1">output))</span>
	<span class="s2">if </span><span class="s1">options.useZopfli:</span>
		<span class="s2">from </span><span class="s1">fontTools.ttLib </span><span class="s2">import </span><span class="s1">sfnt</span>
		<span class="s1">sfnt.USE_ZOPFLI = </span><span class="s2">True</span>
	<span class="s1">ttf = TTFont(options.mergeFile</span><span class="s2">, </span><span class="s1">flavor=options.flavor</span><span class="s2">,</span>
			<span class="s1">recalcBBoxes=options.recalcBBoxes</span><span class="s2">,</span>
			<span class="s1">recalcTimestamp=options.recalcTimestamp)</span>
	<span class="s1">ttf.importXML(input)</span>

	<span class="s2">if </span><span class="s1">options.recalcTimestamp </span><span class="s2">is None and </span><span class="s3">'head' </span><span class="s2">in </span><span class="s1">ttf:</span>
		<span class="s5"># use TTX file modification time for head &quot;modified&quot; timestamp</span>
		<span class="s1">mtime = os.path.getmtime(input)</span>
		<span class="s1">ttf[</span><span class="s3">'head'</span><span class="s1">].modified = timestampSinceEpoch(mtime)</span>

	<span class="s1">ttf.save(output)</span>


<span class="s2">def </span><span class="s1">guessFileType(fileName):</span>
	<span class="s1">base</span><span class="s2">, </span><span class="s1">ext = os.path.splitext(fileName)</span>
	<span class="s2">try</span><span class="s1">:</span>
		<span class="s2">with </span><span class="s1">open(fileName</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
			<span class="s1">header = f.read(</span><span class="s4">256</span><span class="s1">)</span>
	<span class="s2">except </span><span class="s1">IOError:</span>
		<span class="s2">return None</span>

	<span class="s2">if </span><span class="s1">header.startswith(</span><span class="s6">b'</span><span class="s2">\xef\xbb\xbf</span><span class="s6">&lt;?xml'</span><span class="s1">):</span>
		<span class="s1">header = header.lstrip(</span><span class="s6">b'</span><span class="s2">\xef\xbb\xbf</span><span class="s6">'</span><span class="s1">)</span>
	<span class="s1">cr</span><span class="s2">, </span><span class="s1">tp = getMacCreatorAndType(fileName)</span>
	<span class="s2">if </span><span class="s1">tp </span><span class="s2">in </span><span class="s1">(</span><span class="s3">&quot;sfnt&quot;</span><span class="s2">, </span><span class="s3">&quot;FFIL&quot;</span><span class="s1">):</span>
		<span class="s2">return </span><span class="s3">&quot;TTF&quot;</span>
	<span class="s2">if </span><span class="s1">ext == </span><span class="s3">&quot;.dfont&quot;</span><span class="s1">:</span>
		<span class="s2">return </span><span class="s3">&quot;TTF&quot;</span>
	<span class="s1">head = Tag(header[:</span><span class="s4">4</span><span class="s1">])</span>
	<span class="s2">if </span><span class="s1">head == </span><span class="s3">&quot;OTTO&quot;</span><span class="s1">:</span>
		<span class="s2">return </span><span class="s3">&quot;OTF&quot;</span>
	<span class="s2">elif </span><span class="s1">head == </span><span class="s3">&quot;ttcf&quot;</span><span class="s1">:</span>
		<span class="s2">return </span><span class="s3">&quot;TTC&quot;</span>
	<span class="s2">elif </span><span class="s1">head </span><span class="s2">in </span><span class="s1">(</span><span class="s3">&quot;</span><span class="s2">\0\1\0\0</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;true&quot;</span><span class="s1">):</span>
		<span class="s2">return </span><span class="s3">&quot;TTF&quot;</span>
	<span class="s2">elif </span><span class="s1">head == </span><span class="s3">&quot;wOFF&quot;</span><span class="s1">:</span>
		<span class="s2">return </span><span class="s3">&quot;WOFF&quot;</span>
	<span class="s2">elif </span><span class="s1">head == </span><span class="s3">&quot;wOF2&quot;</span><span class="s1">:</span>
		<span class="s2">return </span><span class="s3">&quot;WOFF2&quot;</span>
	<span class="s2">elif </span><span class="s1">head == </span><span class="s3">&quot;&lt;?xm&quot;</span><span class="s1">:</span>
		<span class="s5"># Use 'latin1' because that can't fail.</span>
		<span class="s1">header = tostr(header</span><span class="s2">, </span><span class="s3">'latin1'</span><span class="s1">)</span>
		<span class="s2">if </span><span class="s1">opentypeheaderRE.search(header):</span>
			<span class="s2">return </span><span class="s3">&quot;OTX&quot;</span>
		<span class="s2">else</span><span class="s1">:</span>
			<span class="s2">return </span><span class="s3">&quot;TTX&quot;</span>
	<span class="s2">return None</span>


<span class="s2">def </span><span class="s1">parseOptions(args):</span>
	<span class="s1">rawOptions</span><span class="s2">, </span><span class="s1">files = getopt.getopt(args</span><span class="s2">, </span><span class="s3">&quot;ld:o:fvqht:x:sgim:z:baey:&quot;</span><span class="s2">,</span>
			<span class="s1">[</span><span class="s3">'unicodedata='</span><span class="s2">, </span><span class="s3">&quot;recalc-timestamp&quot;</span><span class="s2">, </span><span class="s3">&quot;no-recalc-timestamp&quot;</span><span class="s2">,</span>
			 <span class="s3">'flavor='</span><span class="s2">, </span><span class="s3">'version'</span><span class="s2">, </span><span class="s3">'with-zopfli'</span><span class="s2">, </span><span class="s3">'newline='</span><span class="s1">])</span>

	<span class="s1">options = Options(rawOptions</span><span class="s2">, </span><span class="s1">len(files))</span>
	<span class="s1">jobs = []</span>

	<span class="s2">if not </span><span class="s1">files:</span>
		<span class="s2">raise </span><span class="s1">getopt.GetoptError(</span><span class="s3">'Must specify at least one input file'</span><span class="s1">)</span>

	<span class="s2">for </span><span class="s1">input </span><span class="s2">in </span><span class="s1">files:</span>
		<span class="s2">if not </span><span class="s1">os.path.isfile(input):</span>
			<span class="s2">raise </span><span class="s1">getopt.GetoptError(</span><span class="s3">'File not found: &quot;%s&quot;' </span><span class="s1">% input)</span>
		<span class="s1">tp = guessFileType(input)</span>
		<span class="s2">if </span><span class="s1">tp </span><span class="s2">in </span><span class="s1">(</span><span class="s3">&quot;OTF&quot;</span><span class="s2">, </span><span class="s3">&quot;TTF&quot;</span><span class="s2">, </span><span class="s3">&quot;TTC&quot;</span><span class="s2">, </span><span class="s3">&quot;WOFF&quot;</span><span class="s2">, </span><span class="s3">&quot;WOFF2&quot;</span><span class="s1">):</span>
			<span class="s1">extension = </span><span class="s3">&quot;.ttx&quot;</span>
			<span class="s2">if </span><span class="s1">options.listTables:</span>
				<span class="s1">action = ttList</span>
			<span class="s2">else</span><span class="s1">:</span>
				<span class="s1">action = ttDump</span>
		<span class="s2">elif </span><span class="s1">tp == </span><span class="s3">&quot;TTX&quot;</span><span class="s1">:</span>
			<span class="s1">extension = </span><span class="s3">&quot;.&quot;</span><span class="s1">+options.flavor </span><span class="s2">if </span><span class="s1">options.flavor </span><span class="s2">else </span><span class="s3">&quot;.ttf&quot;</span>
			<span class="s1">action = ttCompile</span>
		<span class="s2">elif </span><span class="s1">tp == </span><span class="s3">&quot;OTX&quot;</span><span class="s1">:</span>
			<span class="s1">extension = </span><span class="s3">&quot;.&quot;</span><span class="s1">+options.flavor </span><span class="s2">if </span><span class="s1">options.flavor </span><span class="s2">else </span><span class="s3">&quot;.otf&quot;</span>
			<span class="s1">action = ttCompile</span>
		<span class="s2">else</span><span class="s1">:</span>
			<span class="s2">raise </span><span class="s1">getopt.GetoptError(</span><span class="s3">'Unknown file type: &quot;%s&quot;' </span><span class="s1">% input)</span>

		<span class="s2">if </span><span class="s1">options.outputFile:</span>
			<span class="s1">output = options.outputFile</span>
		<span class="s2">else</span><span class="s1">:</span>
			<span class="s1">output = makeOutputFileName(input</span><span class="s2">, </span><span class="s1">options.outputDir</span><span class="s2">, </span><span class="s1">extension</span><span class="s2">, </span><span class="s1">options.overWrite)</span>
			<span class="s5"># 'touch' output file to avoid race condition in choosing file names</span>
			<span class="s2">if </span><span class="s1">action != ttList:</span>
				<span class="s1">open(output</span><span class="s2">, </span><span class="s3">'a'</span><span class="s1">).close()</span>
		<span class="s1">jobs.append((action</span><span class="s2">, </span><span class="s1">input</span><span class="s2">, </span><span class="s1">output))</span>
	<span class="s2">return </span><span class="s1">jobs</span><span class="s2">, </span><span class="s1">options</span>


<span class="s2">def </span><span class="s1">process(jobs</span><span class="s2">, </span><span class="s1">options):</span>
	<span class="s2">for </span><span class="s1">action</span><span class="s2">, </span><span class="s1">input</span><span class="s2">, </span><span class="s1">output </span><span class="s2">in </span><span class="s1">jobs:</span>
		<span class="s1">action(input</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">options)</span>


<span class="s2">def </span><span class="s1">main(args=</span><span class="s2">None</span><span class="s1">):</span>
	<span class="s0">&quot;&quot;&quot;Convert OpenType fonts to XML and back&quot;&quot;&quot;</span>
	<span class="s2">from </span><span class="s1">fontTools </span><span class="s2">import </span><span class="s1">configLogger</span>

	<span class="s2">if </span><span class="s1">args </span><span class="s2">is None</span><span class="s1">:</span>
		<span class="s1">args = sys.argv[</span><span class="s4">1</span><span class="s1">:]</span>
	<span class="s2">try</span><span class="s1">:</span>
		<span class="s1">jobs</span><span class="s2">, </span><span class="s1">options = parseOptions(args)</span>
	<span class="s2">except </span><span class="s1">getopt.GetoptError </span><span class="s2">as </span><span class="s1">e:</span>
		<span class="s1">print(</span><span class="s3">&quot;%s</span><span class="s2">\n</span><span class="s3">ERROR: %s&quot; </span><span class="s1">% (__doc__</span><span class="s2">, </span><span class="s1">e)</span><span class="s2">, </span><span class="s1">file=sys.stderr)</span>
		<span class="s1">sys.exit(</span><span class="s4">2</span><span class="s1">)</span>

	<span class="s1">configLogger(level=options.logLevel)</span>

	<span class="s2">try</span><span class="s1">:</span>
		<span class="s1">process(jobs</span><span class="s2">, </span><span class="s1">options)</span>
	<span class="s2">except </span><span class="s1">KeyboardInterrupt:</span>
		<span class="s1">log.error(</span><span class="s3">&quot;(Cancelled.)&quot;</span><span class="s1">)</span>
		<span class="s1">sys.exit(</span><span class="s4">1</span><span class="s1">)</span>
	<span class="s2">except </span><span class="s1">SystemExit:</span>
		<span class="s2">raise</span>
	<span class="s2">except </span><span class="s1">TTLibError </span><span class="s2">as </span><span class="s1">e:</span>
		<span class="s1">log.error(e)</span>
		<span class="s1">sys.exit(</span><span class="s4">1</span><span class="s1">)</span>
	<span class="s2">except</span><span class="s1">:</span>
		<span class="s1">log.exception(</span><span class="s3">'Unhandled exception has occurred'</span><span class="s1">)</span>
		<span class="s1">sys.exit(</span><span class="s4">1</span><span class="s1">)</span>


<span class="s2">if </span><span class="s1">__name__ == </span><span class="s3">&quot;__main__&quot;</span><span class="s1">:</span>
	<span class="s1">sys.exit(main())</span>
</pre>
</body>
</html>